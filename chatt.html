<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmileX - Live Social Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; object-src 'none';">

 
  <style>
      :root {
          --primary-color: #6a11cb;
          --secondary-color: #2575fc;
          --background-color: #f4f7f6;
          --text-color: #333;
          --accent-color: #00b4db;
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          scrollbar-width: thick;
          scrollbar-color: auto;
      }

      body {
          font-family: 'Orbitron', sans-serif;
          background: black;
          color: white;
              user-select: none;
            
      }

      .chat-preloader {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: black;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          pointer-events: none;
          font-family: 'Orbitron', sans-serif;
      }

      .loader-container {
          background: transparent;
          pointer-events: none;
          text-align: center;
      }

      .chat-bubble-wrapper {
          position: relative;
          width: 200px;
          height: 200px;
          margin: 0 auto 20px;
      }

      .chat-bubble {
          position: absolute;
          width: 150px;
          height: 150px;
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          border-radius: 50% 50% 50% 10%;
          box-shadow: 
              0 15px 30px rgba(0,0,0,0.2),
              inset 0 -5px 15px rgba(255,255,255,0.1);
          animation: 
              float 3s ease-in-out infinite,
              pulse 2s ease-in-out infinite alternate;
          transform-origin: center;
      }

      .chat-bubble::before {
          content: '';
          position: absolute;
          bottom: -30px;
          left: 50%;
          transform: translateX(-50%);
          width: 100px;
          height: 50px;
          background: rgba(255,255,255,0.2);
          border-radius: 50%;
          filter: blur(10px);
      }

      .loading-text {
          font-size: 24px;
          font-weight: 600;
          color: white;
          letter-spacing: 1px;
          text-transform: uppercase;
          background: linear-gradient(to right, var(--primary-color), var(--accent-color));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          margin-bottom: 20px;
      }

      .progress-container {
          width: 350px;
          height: 15px;
          background: rgba(255,255,255,0.1);
          border-radius: 20px;
          overflow: hidden;
          margin: 0 auto 20px;
      }

      .progress-bar {
          width: 0;
          height: 100%;
          background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
          border-radius: 20px;
          animation: progress 2s ease-in-out infinite;
      }

      .dots {
          display: flex;
          gap: 10px;
          justify-content: center;
      }

      .dot {
          width: 15px;
          height: 15px;
          background: var(--primary-color);
          border-radius: 50%;
          animation: dot-pulse 1.5s ease-in-out infinite;
      }

      .dot:nth-child(2) { animation-delay: 0.3s; }
      .dot:nth-child(3) { animation-delay: 0.6s; }

      @keyframes float {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-20px); }
      }

      @keyframes pulse {
          0% { transform: scale(0.95); }
          100% { transform: scale(1.05); }
      }

      @keyframes progress {
          0% { width: 0; }
          50% { width: 100%; }
          100% { width: 0; }
      }

      @keyframes dot-pulse {
          0%, 100% { transform: scale(1); opacity: 0.7; }
          50% { transform: scale(1.2); opacity: 1; }
      }

      .overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .onboarding-container {
          position: relative;
          max-width: 700px;
          width: 90%;
          max-height: 80vh;
          margin: 0 auto;
          background: white;
          color: black;
          border-radius: 15px;
          overflow-y: auto;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.2);
          padding: 40px;
          transform: scale(0.7);
          opacity: 0;
          transition: all 0.3s ease;
          font-family: 'Orbitron', sans-serif;
      }

      .overlay.active {
          opacity: 1;
          visibility: visible;
      }

      .overlay.active .onboarding-container {
          transform: scale(1);
          opacity: 1;
      }

      .onboarding-header {
          background: var(--primary-color);
          color: white;
          text-align: center;
          padding: 20px;
          margin: -40px -40px 20px -40px;
          border-radius: 15px 15px 0 0;
      }

      .form-control, .form-select {
          width: 100%;
          padding: 12px;
          border: 1px solid #ddd;
          border-radius: 8px;
          margin-bottom: 15px;
          font-family: 'Orbitron', sans-serif;
      }

      .consent-section {
          background-color: #f4f6f7;
          border-radius: 10px;
          padding: 15px;
          margin-top: 20px;
      }

      .consent-item {
          display: flex;
          align-items: center;
          margin-bottom: 10px;
      }

      .consent-item input {
          margin-right: 10px;
      }

      #submitBtn {
          background: linear-gradient(135deg, #00ff88, #00cc6a);
          border: none;
          color: white;
          padding: 12px 24px;
          border-radius: 25px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 100%;
      }

      #submitBtn:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
      }

      #submitBtn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }

      .post-card {
          transition: all 0.3s ease;
      }

      .post-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .vote-button {
          transition: all 0.2s ease;
          cursor: pointer;
      }

      .vote-button:hover {
          transform: scale(1.1);
      }

      .vote-button.voted-up {
          color: #8b5cf6 !important;
      }

      .vote-button.voted-down {
          color: #3b82f6 !important;
      }

      .fade-in {
          animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .chat-container {
          position: fixed;
          bottom: 80px;
          right: 20px;
          width: 350px;
          max-height: 500px;
          background: #1a1a1a;
          border-radius: 12px;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
          display: flex;
          flex-direction: column;
          z-index: 1000;
          transform: translateY(20px);
          opacity: 0;
          transition: all 0.3s ease;
          border: 1px solid #333;
      }

      .chat-container.active {
          transform: translateY(0);
          opacity: 1;
      }

      .chat-header {
          padding: 15px;
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          color: white;
          border-top-left-radius: 12px;
          border-top-right-radius: 12px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .chat-close {
          background: none;
          border: none;
          color: white;
          font-size: 18px;
          cursor: pointer;
      }

      .chat-messages {
          flex: 1;
          padding: 15px;
          overflow-y: auto;
          background: #1a1a1a;
          max-height: 300px;
      }

      .message {
          margin-bottom: 15px;
          display: flex;
          flex-direction: column;
      }

      .message-user {
          font-weight: 600;
          font-size: 12px;
          color: #8b5cf6;
          margin-bottom: 5px;
      }

      .message-text {
          background: #2d2d37;
          padding: 10px 15px;
          border-radius: 18px;
          font-size: 14px;
          max-width: 80%;
          word-wrap: break-word;
          color: white;
      }

      .message-time {
          font-size: 10px;
          color: #777;
          margin-top: 5px;
          align-self: flex-end;
      }

      .chat-input-container {
          padding: 15px;
          background: #22222a;
          border-bottom-left-radius: 12px;
          border-bottom-right-radius: 12px;
          display: flex;
          align-items: center;
      }

      .chat-input {
          flex: 1;
          padding: 10px 15px;
          border-radius: 20px;
          border: none;
          background: #383844;
          color: white;
          font-family: 'Orbitron', sans-serif;
          font-size: 14px;
          outline: none;
      }

      .chat-send {
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          border: none;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          margin-left: 10px;
          color: white;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
      }

      .chat-send:hover {
          transform: scale(1.05);
      }

      .chat-toggle {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 24px;
          cursor: pointer;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
          z-index: 1000;
          transition: all 0.3s ease;
          border: none;
      }

      .chat-toggle:hover {
          transform: scale(1.1);
      }

      .chat-toggle.active {
          transform: rotate(180deg);
      }

      .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #00ff88, #00cc6a);
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
          z-index: 10001;
          transform: translateX(400px);
          transition: transform 0.3s ease;
      }

      .notification.show {
          transform: translateX(0);
      }

      .gradient-text {
          background: linear-gradient(90deg, #f43f5e 0%, #8b5cf6 100%);
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
      }

      ::-webkit-scrollbar {
          width: 8px;
          height: 8px;
      }

      ::-webkit-scrollbar-track {
          background: #1a1a1a;
      }

      ::-webkit-scrollbar-thumb {
          background: #6a11cb;
          border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
          background: #2575fc;
      }

      .badge {
          display: inline-flex;
          align-items: center;
          padding: 0.15rem 0.5rem;
          border-radius: 9999px;
          font-size: 0.75rem;
          font-weight: 500;
      }

      .badge-private {
          background-color: #f97316;
          color: white;
      }

      .badge-public {
          background-color: #10b981;
          color: white;
      }

      .community-card {
          transition: all 0.3s ease;
      }

      .community-card:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2);
      }

      .tab-button {
          padding: 0.75rem 1rem;
          border-radius: 0.5rem;
          font-weight: 500;
          transition: all 0.2s ease;
      }

      .tab-button.active {
          background-color: #6a11cb;
          color: white;
      }

      .tab-button:not(.active):hover {
          background-color: rgba(106, 17, 203, 0.1);
      }

      @media (max-width: 640px) {
          .chat-container {
              width: 90%;
              right: 5%;
              bottom: 100px;
              max-height: 60vh;
          }
          
          .onboarding-container {
              width: 95%;
              padding: 20px;
              max-height: 90vh;
          }
      }

        /* Preloader */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: all 0.8s ease;
        }

        .preloader-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: bounce 2s infinite;
        }

        .preloader-text {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-top: 2rem;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Onboarding Modal */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .onboarding-container {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .onboarding-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: #8b5cf6;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 12px;
            margin: 8px 0 16px 0;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .consent-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .consent-item {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }

        .consent-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #404040;
            cursor: not-allowed;
            transform: none;
        }

        /* Navigation */
        nav {
            background: #000000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #8b5cf6;
        }

        .logo i {
            margin-right: 0.5rem;
            font-size: 2rem;
        }

        .nav-search {
            position: relative;
            display: none;
        }

        @media (min-width: 768px) {
            .nav-search {
                display: block;
            }
        }

        .nav-search input {
            width: 300px;
            padding: 8px 12px 8px 40px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 25px;
            color: #ffffff;
            font-size: 14px;
        }

        .nav-search i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-button {
            padding: 8px;
            background: #1a1a1a;
            border-radius: 50%;
            color: #ccc;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            background: #2a2a2a;
            color: #8b5cf6;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8b5cf6, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Main Layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        /* Sidebar */
        .sidebar {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 80px;
            display: none;
        }

        @media (min-width: 1024px) {
            .sidebar {
                display: block;
            }
        }

        .sidebar h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #8b5cf6;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: 0.5rem;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            color: #ccc;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover {
            background: #2a2a2a;
            color: #8b5cf6;
        }

        .community-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        /* Main Feed */
        .main-feed {
            min-height: 100vh;
        }

        .create-post-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .create-post-input {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .create-post-input input {
            flex: 1;
            padding: 12px 16px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 25px;
            color: #ffffff;
            cursor: pointer;
        }

        .post-type-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .post-type-button {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            color: #ccc;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .post-type-button:hover {
            background: #2a2a2a;
            color: #8b5cf6;
        }

        /* Post Sorting */
        .sort-buttons {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
        }

        .sort-button {
            padding: 8px 16px;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .sort-button.active {
            background: #8b5cf6;
            color: white;
        }

        .sort-button:not(.active) {
            background: #2a2a2a;
            color: #ccc;
        }

        .sort-button:not(.active):hover {
            background: #404040;
        }

        /* Posts */
        .post-card {
            background: #1a1a1a;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .post-content {
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        .vote-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .vote-button {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .vote-button:hover {
            background: #2a2a2a;
        }

        .vote-button.voted-up {
            color: #8b5cf6;
        }

        .vote-button.voted-down {
            color: #3b82f6;
        }

        .vote-count {
            font-weight: bold;
            color: #ccc;
        }

        .post-main {
            flex: 1;
        }

        .post-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 12px;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .post-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #ffffff;
        }

        .post-text {
            color: #ccc;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-action-buttons {
            display: flex;
            gap: 1rem;
        }

        .post-action-button {
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .post-action-button:hover {
            background: #2a2a2a;
            color: #8b5cf6;
        }

        /* Comments Section */
        .comments-section {
            border-top: 1px solid #2a2a2a;
            padding: 1rem 1.5rem;
            display: none;
        }

        .comments-section.active {
            display: block;
        }

        .comment-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .comment-input input {
            flex: 1;
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 20px;
            color: #ffffff;
        }

        .comment {
            background: #2a2a2a;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            font-weight: bold;
            color: #8b5cf6;
            font-size: 12px;
            margin-bottom: 0.25rem;
        }

        .comment-text {
            color: #ccc;
            font-size: 14px;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.3rem;
            color: #ffffff;
        }

        .modal-close {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #2a2a2a;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Image Upload */
        .image-upload-area {
            border: 2px dashed #404040;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .image-upload-area.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* Chat */
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8b5cf6, #3b82f6);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
        }

        .chat-container {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: #1a1a1a;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 99;
        }

        .chat-container.active {
            transform: translateY(0);
            opacity: 1;
        }

        .chat-header {
            padding: 1rem;
            background: #8b5cf6;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            color: white;
            font-size: 1rem;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .message-user {
            font-weight: bold;
            color: #8b5cf6;
            font-size: 12px;
            margin-bottom: 0.25rem;
        }

        .message-text {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 0.25rem;
        }

        .message-time {
            font-size: 11px;
            color: #666;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #2a2a2a;
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 20px;
            color: #ffffff;
        }

        .chat-send {
            background: #8b5cf6;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border-top: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 64px;
            z-index: 50;
        }

        @media (min-width: 1024px) {
            .mobile-nav {
                display: none;
            }
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .mobile-nav-item.active {
            color: #8b5cf6;
        }

        .mobile-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .mobile-nav-item span {
            font-size: 10px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #8b5cf6;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        /* Community Colors */
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-green-500 { background-color: #10b981; }
        .bg-purple-500 { background-color: #8b5cf6; }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-yellow-500 { background-color: #f59e0b; }
        .bg-pink-500 { background-color: #ec4899; }
        .bg-indigo-500 { background-color: #6366f1; }

        /* Poll Styles */
        .poll-container {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .poll-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #404040;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .poll-option:hover {
            background: #505050;
        }

        .poll-option-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #3b82f6);
            opacity: 0.3;
            transition: width 0.5s ease;
        }

        .poll-option-text {
            position: relative;
            z-index: 1;
        }

        .poll-option-percentage {
            position: relative;
            z-index: 1;
            font-size: 12px;
            color: #ccc;
        }

        .poll-stats {
            margin-top: 0.5rem;
            font-size: 11px;
            color: #666;
            text-align: center;
        }

        .delete-community-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-community-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* My Communities Tabs */
        .my-communities-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .my-communities-tab {
            padding: 0.5rem 1rem;
            background: #2a2a2a;
            border: none;
            border-radius: 8px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .my-communities-tab.active {
            background: #8b5cf6;
            color: white;
        }

        .my-communities-tab:hover:not(.active) {
            background: #404040;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem 0.5rem;
                padding-bottom: 80px;
            }
            
            .post-content {
                padding: 1rem;
            }
            
            .chat-container {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div id="preloader" class="preloader">
        <div class="preloader-logo">
            <i class="fas fa-smile-beam"></i>
        </div>
        <div class="preloader-text">SmileX</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Onboarding Modal -->
    <div class="overlay" id="onboardingOverlay">
        <div class="onboarding-container">
            <div class="onboarding-header">
                <h2><i class="fas fa-user-circle"></i> Welcome to SmileX</h2>
                <p>Complete your profile to join our community</p>
            </div>

            <form id="registrationForm">
                <div>
                    <label><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" class="form-control" name="fullName" placeholder="Enter your full name" required>
                </div>

                <div>
                    <label><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" class="form-control" name="email" placeholder="your.email@example.com" required>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label><i class="fas fa-venus-mars"></i> Gender</label>
                        <select class="form-select" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label><i class="fas fa-globe"></i> Country</label>
                        <select class="form-select" name="country" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="IN">India</option>
                            <option value="BR">Brazil</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="consent-section">
                    <h4><i class="fas fa-shield-alt"></i> Platform Consent</h4>
                    <div class="consent-item">
                        <input type="checkbox" name="ageConsent" required>
                        <label>I am 13 years or older</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" name="termsConsent" required>
                        <label>I agree to the Terms of Service</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" name="privacyConsent" required>
                        <label>I consent to privacy policy</label>
                    </div>
                </div>

                <button type="submit" id="submitBtn" disabled>
                    <i class="fas fa-paper-plane"></i> Join SmileX
                </button>
            </form>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-smile-beam"></i>
                <span>SmileX</span>
            </div>

            <div class="nav-search">
                <input type="text" id="searchInput" placeholder="Search Communities...">
                <i class="fas fa-search"></i>
                <div id="searchResults" class="hidden"></div>
            </div>

            <div class="nav-actions">
                <button class="nav-button" id="notificationBtn">
                    <i class="fas fa-bell"></i>
                </button>
                <div class="user-avatar" id="userAvatar">
                    <span id="userInitial">U</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <h3><i class="fas fa-users"></i> My Communities</h3>
            
            <!-- My Communities Tabs -->
            <div class="my-communities-tabs">
                <button class="my-communities-tab active" data-tab="created">Created</button>
                <button class="my-communities-tab" data-tab="joined">Joined</button>
            </div>
            
            <div id="createdCommunitiesList" class="communities-tab-content">
                <ul id="createdCommunitiesUL"></ul>
            </div>
            
            <div id="joinedCommunitiesList" class="communities-tab-content hidden">
                <ul id="joinedCommunitiesUL"></ul>
            </div>
            
            <button id="createCommunityBtn" style="width: 100%; margin-top: 1rem;">
                <i class="fas fa-plus"></i> Create Community
            </button>

            <div style="margin-top: 2rem;">
                <h3><i class="fas fa-compass"></i> Explore</h3>
                <button id="browseCommunityBtn" style="width: 100%;">
                    <i class="fas fa-globe"></i> Browse Communities
                </button>
            </div>
        </div>

        <!-- Main Feed -->
        <div class="main-feed">
            <!-- Create Post Card -->
            <div class="create-post-card">
                <div class="create-post-input">
                    <div class="user-avatar">
                        <span id="createPostUserInitial">U</span>
                    </div>
                    <input type="text" placeholder="Create a post..." id="createPostInput">
                </div>
                <div class="post-type-buttons">
                    <button class="post-type-button" data-post-type="image">
                        <i class="far fa-image"></i> Image
                    </button>
                    <button class="post-type-button" data-post-type="link">
                        <i class="fas fa-link"></i> Link
                    </button>
                    <button class="post-type-button" data-post-type="text">
                        <i class="far fa-file-alt"></i> Text
                    </button>
                    <button class="post-type-button" data-post-type="poll">
                        <i class="fas fa-poll"></i> Poll
                    </button>
                </div>
            </div>

            <!-- Post Sorting -->
            <div class="sort-buttons">
                <button class="sort-button active" data-sort="hot">
                    <i class="fas fa-bolt"></i> Hot
                </button>
                <button class="sort-button" data-sort="new">
                    <i class="fas fa-certificate"></i> New
                </button>
                <button class="sort-button" data-sort="top">
                    <i class="fas fa-arrow-trend-up"></i> Top
                </button>
            </div>

            <!-- Feed Filter -->
            <div class="create-post-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>Viewing:</span>
                        <select id="feedFilter" class="form-select" style="width: auto; margin: 0;">
                            <option value="all">All Posts</option>
                            <option value="general">General Feed</option>
                            <option value="mycommunities">My Communities</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Posts Feed -->
            <div id="posts-feed"></div>

            <!-- Load More Button -->
            <div class="text-center">
                <button id="loadMoreBtn">Load more posts</button>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar">
            <h3><i class="fas fa-compass"></i> Discover</h3>
            <div id="recommendedCommunities"></div>

            <!-- Premium Ad -->
            <div style="background: linear-gradient(45deg, #8b5cf6, #3b82f6); border-radius: 12px; padding: 1.5rem; margin-top: 2rem; color: white;">
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <i class="fas fa-crown" style="margin-right: 0.5rem;"></i>
                    <h4>SmileX Premium</h4>
                </div>
                <p style="font-size: 14px; margin-bottom: 1rem;">Get ad-free browsing, exclusive awards, and support SmileX.</p>
                <button id="premiumBtn" style="width: 100%; background: white; color: #8b5cf6;">
                    TRY PREMIUM
                </button>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="create-post-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create a post</h3>
                <button id="closeCreatePostModal" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <form id="createPostForm">
                    <div class="mb-4">
                        <label>Post type</label>
                        <select class="form-select" name="postType" id="postType" required>
                            <option value="text">Text Post</option>
                            <option value="image">Image Post</option>
                            <option value="poll">Poll</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label>Post visibility</label>
                        <select class="form-select" name="visibility" id="postVisibility" required>
                            <option value="general">General (visible to everyone)</option>
                            <option value="community">Community (visible to members)</option>
                        </select>
                    </div>

                    <div class="mb-4 hidden" id="postCommunityContainer">
                        <label>Choose a community</label>
                        <select class="form-select" name="community" id="postCommunity">
                            <option value="">Select a community</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <input type="text" name="title" placeholder="Title" class="form-control" required>
                    </div>

                    <div class="mb-4" id="contentContainer">
                        <textarea name="content" placeholder="What are your thoughts?" rows="6" class="form-control"></textarea>
                    </div>

                    <!-- Poll Options Container -->
                    <div class="mb-4 hidden" id="pollOptionsContainer">
                        <label>Poll Options</label>
                        <div id="pollOptions">
                            <input type="text" class="form-control poll-option-input" placeholder="Option 1" style="margin-bottom: 0.5rem;">
                            <input type="text" class="form-control poll-option-input" placeholder="Option 2" style="margin-bottom: 0.5rem;">
                        </div>
                        <button type="button" id="addPollOption" style="background: #2a2a2a; margin-top: 0.5rem;">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>

                    <div class="mb-4" id="imageUploadContainer">
                        <div class="image-upload-area" id="imageUploadArea">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #666; margin-bottom: 0.5rem;"></i>
                            <p>Click or drag images here to upload</p>
                            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                        </div>
                        <div id="imagePreviewContainer"></div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" id="cancelCreatePost">Cancel</button>
                <button type="submit" form="createPostForm">Post</button>
            </div>
        </div>
    </div>

    <!-- Create Community Modal -->
    <div id="create-community-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create a Community</h3>
                <button id="closeCreateCommunityModal" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <form id="createCommunityForm">
                    <div class="mb-4">
                        <label>Community Name</label>
                        <input type="text" name="name" placeholder="Enter community name" class="form-control" required>
                        <p style="font-size: 12px; color: #666; margin-top: 0.25rem;">Community names can't contain spaces. Use 3-21 characters.</p>
                    </div>

                    <div class="mb-4">
                        <label>Display Name</label>
                        <input type="text" name="displayName" placeholder="Enter display name" class="form-control" required>
                    </div>

                    <div class="mb-4">
                        <label>Description</label>
                        <textarea name="description" placeholder="What's your community about?" rows="4" class="form-control"></textarea>
                    </div>

                    <div class="mb-4">
                        <label>Community Type</label>
                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                            <div style="display: flex; align-items: center;">
                                <input type="radio" id="typePublic" name="type" value="public" checked style="margin-right: 0.5rem;">
                                <label for="typePublic">Public</label>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <input type="radio" id="typePrivate" name="type" value="private" style="margin-right: 0.5rem;">
                                <label for="typePrivate">Private</label>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 0.25rem;">Private communities require members to be approved by moderators.</p>
                    </div>

                    <div class="mb-4">
                        <label>Community Topics (optional)</label>
                        <input type="text" name="topics" placeholder="Enter topics separated by commas" class="form-control">
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" id="cancelCreateCommunity">Cancel</button>
                <button type="submit" form="createCommunityForm">Create Community</button>
            </div>
        </div>
    </div>

    <!-- Browse Communities Modal -->
    <div id="browse-communities-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Browse Communities</h3>
                <button id="closeBrowseCommunitiesModal" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div style="padding: 1rem; border-bottom: 1px solid #2a2a2a;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="position: relative; flex: 1;">
                        <input type="text" id="communitySearchInput" placeholder="Search for communities..." class="form-control">
                        <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #666;"></i>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="sort-button active" data-tab="all">All</button>
                        <button class="sort-button" data-tab="public">Public</button>
                        <button class="sort-button" data-tab="private">Private</button>
                    </div>
                </div>
            </div>

            <div class="modal-body">
                <div id="communitiesBrowseList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;"></div>
                <div id="noCommunitiesMessage" class="text-center hidden">
                    <i class="fas fa-users" style="font-size: 3rem; color: #666; margin-bottom: 1rem;"></i>
                    <p style="color: #666;">No communities found</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Community Detail Modal -->
    <div id="community-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div id="communityDetailHeader" class="modal-header" style="position: relative;"></div>

            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem;">About this Community</h3>
                        <div id="communityDetailDescription" style="color: #ccc; margin-bottom: 2rem;"></div>
                        
                        <h3 style="margin-bottom: 1rem;">Recent Posts</h3>
                        <div id="communityPosts"></div>
                    </div>
                    <div>
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 1rem;">Community Info</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 14px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;">Created by</span>
                                    <span id="communityCreator"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;">Created</span>
                                    <span id="communityCreationDate"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;">Members</span>
                                    <span id="communityMemberCount"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;">Type</span>
                                    <span id="communityType"></span>
                                </div>
                            </div>
                        </div>

                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem;">Topics</h4>
                            <div id="communityTopics"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="closeCommunityDetailModal">Close</button>
                <button id="joinLeaveButton">Join</button>
                <button id="deleteCommunityButton" class="delete-community-btn hidden">Delete Community</button>
            </div>
        </div>
    </div>

    <!-- Live Chat Toggle Button -->
    <button id="chat-toggle-btn" class="chat-toggle">
        <i class="fas fa-comment-dots"></i>
    </button>

    <!-- Live Chat Container -->
    <div id="chat-container" class="chat-container">
        <div class="chat-header">
            <h3>Live Chat Support</h3>
            <button id="chat-close-btn" class="chat-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message">
                <div class="message-user">Support Agent</div>
                <div class="message-text">Hello! How can we help you today?</div>
                <div class="message-time">Just now</div>
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" class="chat-input" placeholder="Type your message...">
            <button id="chat-send-btn" class="chat-send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <a href="#" class="mobile-nav-item active">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileBrowseBtn">
            <i class="fas fa-compass"></i>
            <span>Explore</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileCreatePost">
            <i class="fas fa-plus-circle"></i>
            <span>Create</span>
        </a>
        <a href="#" class="mobile-nav-item">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileCreateCommunity">
            <i class="fas fa-users"></i>
            <span>Community</span>
        </a>
    </div>
<script>
    // Firebase Configuration
const firebaseConfig = {
    apiKey: "your-api-key-here",
    authDomain: "your-project.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project.appspot.com",
    messagingSenderId: "123456789",
    appId: "your-app-id"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
const auth = firebase.auth();

// OpenAI Configuration
const OPENAI_API_KEY = 'your-openai-api-key-here';
const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';

// Global variables
let currentUser = null;
let posts = [];
let communities = [];
let currentSort = 'hot';
let currentFeedFilter = 'all';
let currentCommunityTab = 'all';
let currentCommunity = null;
let userMemberships = [];
let uploadedImages = [];
let userCreatedCommunities = [];
let livePolls = [];

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    // Check if user is already registered
    const userData = localStorage.getItem('userData');
    const isRegistered = localStorage.getItem('userRegistered');

    if (userData && isRegistered === 'true') {
        currentUser = JSON.parse(userData);
        hideOnboarding();
        loadUserInterface();
    } else {
        showOnboarding();
    }

    // Initialize event listeners
    initializeEventListeners();
    
    // Load initial data
    loadInitialPosts();
    loadInitialCommunities();
    loadUserMemberships();
    loadUserCreatedCommunities();
    loadLivePolls();
    updateCommunityLists();
    
    // Start preloader
    startPreloader();
    
    // Auto-save data every 30 seconds
    setInterval(saveAllDataToStorage, 30000);
}

function startPreloader() {
    setTimeout(() => {
        const preloader = document.getElementById('preloader');
        preloader.style.transition = 'all 0.8s ease';
        preloader.style.opacity = '0';
        preloader.style.transform = 'scale(0.8)';
        
        setTimeout(() => {
            preloader.style.display = 'none';
            
            // Show onboarding if user not registered
            if (!currentUser) {
                showOnboarding();
            }
        }, 800);
    }, 3000);
}

function showOnboarding() {
    document.getElementById('onboardingOverlay').classList.add('active');
}

function hideOnboarding() {
    document.getElementById('onboardingOverlay').classList.remove('active');
}

function loadUserInterface() {
    if (currentUser) {
        const initial = currentUser.fullName.charAt(0).toUpperCase();
        document.getElementById('userInitial').textContent = initial;
        document.getElementById('createPostUserInitial').textContent = initial;
    }
}

function initializeEventListeners() {
    // Registration form
    const registrationForm = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const inputs = registrationForm.querySelectorAll('input, select');
    const checkboxes = registrationForm.querySelectorAll('input[type="checkbox"]');

    // Form validation
    function validateForm() {
        const allInputsFilled = Array.from(inputs).filter(input => input.type !== 'checkbox').every(input => input.value.trim() !== '');
        const allCheckboxesChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
        submitBtn.disabled = !(allInputsFilled && allCheckboxesChecked);
    }

    inputs.forEach(input => {
        input.addEventListener('input', validateForm);
        input.addEventListener('change', validateForm);
    });

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', validateForm);
    });

    // Form submission
    registrationForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const userData = Object.fromEntries(formData.entries());
        
        // Remove consent checkboxes from stored data
        delete userData.ageConsent;
        delete userData.termsConsent;
        delete userData.privacyConsent;

        // Add unique user ID
        userData.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        currentUser = userData;
        
        localStorage.setItem('userData', JSON.stringify(userData));
        localStorage.setItem('userRegistered', 'true');

        // Save user to Firebase
        try {
            await db.collection('users').doc(userData.userId).set({
                ...userData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (error) {
            console.error('Error saving user to Firebase:', error);
        }

        hideOnboarding();
        loadUserInterface();
        showNotification('Welcome to SmileX! Your profile is now complete.');
    });

    // Create post functionality
    document.getElementById('createPostInput').addEventListener('click', () => {
        openCreatePostModal();
    });

    document.getElementById('mobileCreatePost').addEventListener('click', (e) => {
        e.preventDefault();
        openCreatePostModal();
    });

    document.getElementById('closeCreatePostModal').addEventListener('click', () => {
        document.getElementById('create-post-modal').classList.remove('active');
    });

    document.getElementById('cancelCreatePost').addEventListener('click', () => {
        document.getElementById('create-post-modal').classList.remove('active');
    });

    // Post visibility change
    document.getElementById('postVisibility').addEventListener('change', function() {
        const communityContainer = document.getElementById('postCommunityContainer');
        if (this.value === 'community') {
            communityContainer.classList.remove('hidden');
            populateUserCommunities('postCommunity');
        } else {
            communityContainer.classList.add('hidden');
        }
    });

    // Image upload functionality
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');

    imageUploadArea.addEventListener('click', () => {
        imageInput.click();
    });

    imageUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploadArea.classList.add('dragover');
    });

    imageUploadArea.addEventListener('dragleave', () => {
        imageUploadArea.classList.remove('dragover');
    });

    imageUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handleImageFiles(files);
    });

    imageInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleImageFiles(files);
    });

    // Create post form submission
    document.getElementById('createPostForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const postData = Object.fromEntries(formData.entries());
        
        await createNewPost(postData);
        this.reset();
        uploadedImages = [];
        imagePreviewContainer.innerHTML = '';
        document.getElementById('create-post-modal').classList.remove('active');
        showNotification('Post created successfully!');
    });

    // Post type buttons
    document.querySelectorAll('[data-post-type]').forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.dataset.postType === 'poll') {
                openCreatePollModal();
            } else {
                openCreatePostModal();
            }
        });
    });

    // Sort buttons
    document.querySelectorAll('[data-sort]').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('[data-sort]').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            currentSort = this.dataset.sort;
            sortAndDisplayPosts();
        });
    });

    // Feed filter change
    document.getElementById('feedFilter').addEventListener('change', function() {
        currentFeedFilter = this.value;
        filterAndDisplayPosts();
    });

    // Load more posts
    document.getElementById('loadMoreBtn').addEventListener('click', loadMorePosts);

    // Create community
    document.getElementById('createCommunityBtn').addEventListener('click', () => {
        document.getElementById('create-community-modal').classList.add('active');
    });

    document.getElementById('mobileCreateCommunity').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('create-community-modal').classList.add('active');
    });

    document.getElementById('closeCreateCommunityModal').addEventListener('click', () => {
        document.getElementById('create-community-modal').classList.remove('active');
    });

    document.getElementById('cancelCreateCommunity').addEventListener('click', () => {
        document.getElementById('create-community-modal').classList.remove('active');
    });

    // Create community form submission
    document.getElementById('createCommunityForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const communityData = Object.fromEntries(formData.entries());
        
        await createNewCommunity(communityData);
        this.reset();
        document.getElementById('create-community-modal').classList.remove('active');
    });

    // Browse communities
    document.getElementById('browseCommunityBtn').addEventListener('click', () => {
        openBrowseCommunitiesModal();
    });

    document.getElementById('mobileBrowseBtn').addEventListener('click', (e) => {
        e.preventDefault();
        openBrowseCommunitiesModal();
    });

    document.getElementById('closeBrowseCommunitiesModal').addEventListener('click', () => {
        document.getElementById('browse-communities-modal').classList.remove('active');
    });

    // Browse communities tabs
    document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentCommunityTab = this.dataset.tab;
            filterBrowseCommunities();
        });
    });

    // Community search
    document.getElementById('communitySearchInput').addEventListener('input', function() {
        filterBrowseCommunities();
    });

    // Close community detail modal
    document.getElementById('closeCommunityDetailModal').addEventListener('click', () => {
        document.getElementById('community-detail-modal').classList.remove('active');
    });

    // Join/Leave community button
    document.getElementById('joinLeaveButton').addEventListener('click', async function() {
        if (!currentCommunity) return;
        
        const isMember = userMemberships.includes(currentCommunity.id);
        if (isMember) {
            await leaveCommunity(currentCommunity.id);
        } else {
            await joinCommunity(currentCommunity.id);
        }
        
        updateJoinLeaveButton();
        updateCommunityLists();
    });

    // Chat functionality
    const chatToggleBtn = document.getElementById('chat-toggle-btn');
    const chatCloseBtn = document.getElementById('chat-close-btn');
    const chatContainer = document.getElementById('chat-container');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');

    chatToggleBtn.addEventListener('click', () => {
        chatContainer.classList.toggle('active');
        showNotification('Chat feature activated!');
    });

    chatCloseBtn.addEventListener('click', () => {
        chatContainer.classList.remove('active');
    });

    chatSendBtn.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        if (query.length > 1) {
            const results = communities.filter(c => 
                c.name.toLowerCase().includes(query) || 
                c.displayName.toLowerCase().includes(query) ||
                (c.description && c.description.toLowerCase().includes(query))
            );
            
            if (results.length > 0) {
                searchResults.innerHTML = results.map(community => `
                    <div style="padding: 0.75rem; background: #2a2a2a; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer;" onclick="viewCommunityDetails('${community.id}')">
                        <div style="display: flex; align-items: center;">
                            <span class="community-icon ${getCommunityColor(community.name)}">
                                ${community.name.charAt(0)}
                            </span>
                            <span>${community.displayName}</span>
                            <span style="margin-left: 0.5rem; padding: 2px 6px; background: ${community.type === 'private' ? '#ef4444' : '#10b981'}; border-radius: 4px; font-size: 10px;">
                                ${community.type}
                            </span>
                        </div>
                    </div>
                `).join('');
                searchResults.classList.remove('hidden');
            } else {
                searchResults.innerHTML = `<div style="padding: 0.75rem; color: #666;">No communities found</div>`;
                searchResults.classList.remove('hidden');
            }
        } else {
            searchResults.classList.add('hidden');
        }
    });
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
        }
    });

    // Premium button
    document.getElementById('premiumBtn').addEventListener('click', () => {
        showNotification('Premium features coming soon!');
    });

    // Notification button
    document.getElementById('notificationBtn').addEventListener('click', () => {
        showNotification('No new notifications');
    });
}

// Enhanced data persistence functions
function saveAllDataToStorage() {
    try {
        localStorage.setItem('communities', JSON.stringify(communities));
        localStorage.setItem('posts', JSON.stringify(posts));
        localStorage.setItem('userMemberships', JSON.stringify(userMemberships));
        localStorage.setItem('userCreatedCommunities', JSON.stringify(userCreatedCommunities));
        localStorage.setItem('livePolls', JSON.stringify(livePolls));
        console.log('Data saved to localStorage');
    } catch (error) {
        console.error('Error saving data to localStorage:', error);
    }
}

function loadUserCreatedCommunities() {
    const stored = localStorage.getItem('userCreatedCommunities');
    if (stored) {
        userCreatedCommunities = JSON.parse(stored);
    } else {
        userCreatedCommunities = [];
    }
}

function loadLivePolls() {
    const stored = localStorage.getItem('livePolls');
    if (stored) {
        livePolls = JSON.parse(stored);
    } else {
        livePolls = [];
    }
}

// Handle image file uploads
function handleImageFiles(files) {
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                uploadedImages.push({
                    file: file,
                    url: imageUrl,
                    name: file.name
                });
                
                const imagePreview = document.createElement('div');
                imagePreview.style.cssText = 'position: relative; display: inline-block; margin: 0.5rem;';
                imagePreview.innerHTML = `
                    <img src="${imageUrl}" class="image-preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                    <button onclick="removeImage(${uploadedImages.length - 1})" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                imagePreviewContainer.appendChild(imagePreview);
            };
            reader.readAsDataURL(file);
        }
    });
}

function removeImage(index) {
    uploadedImages.splice(index, 1);
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    imagePreviewContainer.innerHTML = '';
    
    // Re-render remaining images
    uploadedImages.forEach((img, i) => {
        const imagePreview = document.createElement('div');
        imagePreview.style.cssText = 'position: relative; display: inline-block; margin: 0.5rem;';
        imagePreview.innerHTML = `
            <img src="${img.url}" class="image-preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
            <button onclick="removeImage(${i})" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        `;
        imagePreviewContainer.appendChild(imagePreview);
    });
}

// Upload images to Firebase Storage
async function uploadImagesToFirebase(images) {
    const uploadPromises = images.map(async (img, index) => {
        const storageRef = storage.ref(`posts/${Date.now()}_${index}_${img.name}`);
        const snapshot = await storageRef.put(img.file);
        return await snapshot.ref.getDownloadURL();
    });
    
    return await Promise.all(uploadPromises);
}

// Enhanced community management
async function loadInitialCommunities() {
    try {
        // Load from localStorage first for immediate display
        const storedCommunities = localStorage.getItem('communities');
        if (storedCommunities) {
            communities = JSON.parse(storedCommunities);
        }

        // Try to load from Firebase
        const snapshot = await db.collection('communities').get();
        if (!snapshot.empty) {
            const firebaseCommunities = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // Merge with local data, prioritizing Firebase
            communities = mergeCommunitiesData(communities, firebaseCommunities);
        } else if (communities.length === 0) {
            // Create default communities if none exist
            await createDefaultCommunities();
        }
    } catch (error) {
        console.error('Error loading communities from Firebase:', error);
        // Use localStorage data if available
        if (communities.length === 0) {
            await createDefaultCommunities();
        }
    }

    displayRecommendedCommunities();
    saveAllDataToStorage();
}

function mergeCommunitiesData(localCommunities, firebaseCommunities) {
    const merged = [...firebaseCommunities];
    
    // Add local communities that don't exist in Firebase
    localCommunities.forEach(localCommunity => {
        if (!firebaseCommunities.find(fc => fc.id === localCommunity.id)) {
            merged.push(localCommunity);
        }
    });
    
    return merged;
}

async function createDefaultCommunities() {
    const defaultCommunities = [
        {
            id: 'c1',
            name: 'SmileX',
            displayName: 'SmileX Official',
            description: 'The official community for SmileX platform updates and announcements.',
            type: 'public',
            createdBy: 'SmileX Team',
            createdByUserId: 'system',
            createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
            memberCount: 15420,
            topics: ['news', 'updates', 'announcements'],
            members: ['system']
        },
        {
            id: 'c2',
            name: 'Gaming',
            displayName: 'Gaming Zone',
            description: 'A community for all gamers to share their experiences, tips, and discuss the latest releases.',
            type: 'public',
            createdBy: 'GameMaster',
            createdByUserId: 'system',
            createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
            memberCount: 8763,
            topics: ['games', 'esports', 'console', 'pc'],
            members: ['system']
        },
        {
            id: 'c3',
            name: 'TechTalks',
            displayName: 'Tech Talks',
            description: 'Discuss the latest in technology, programming, and AI developments.',
            type: 'public',
            createdBy: 'TechGuru',
            createdByUserId: 'system',
            createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            memberCount: 6214,
            topics: ['technology', 'programming', 'ai', 'gadgets'],
            members: ['system']
        },
        {
            id: 'c4',
            name: 'ArtistsLounge',
            displayName: 'Artists Lounge',
            description: 'A private community for artists to share their work and get feedback.',
            type: 'private',
            createdBy: 'ArtMaster',
            createdByUserId: 'system',
            createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            memberCount: 842,
            topics: ['art', 'drawing', 'design', 'critiques'],
            members: ['system']
        }
    ];

    communities = defaultCommunities;
    
    // Save to Firebase
    try {
        const batch = db.batch();
        defaultCommunities.forEach(community => {
            const docRef = db.collection('communities').doc(community.id);
            batch.set(docRef, community);
        });
        await batch.commit();
    } catch (error) {
        console.error('Error saving default communities to Firebase:', error);
    }
    
    saveAllDataToStorage();
}

function loadUserMemberships() {
    const memberships = localStorage.getItem('userMemberships');
    if (memberships) {
        userMemberships = JSON.parse(memberships);
    } else {
        userMemberships = ['c1']; // Auto-join SmileX official community
        localStorage.setItem('userMemberships', JSON.stringify(userMemberships));
    }
}

async function loadInitialPosts() {
    try {
        // Load from localStorage first
        const storedPosts = localStorage.getItem('posts');
        if (storedPosts) {
            posts = JSON.parse(storedPosts).map(post => ({
                ...post,
                timestamp: new Date(post.timestamp)
            }));
        }

        // Try to load from Firebase
        const snapshot = await db.collection('posts').orderBy('timestamp', 'desc').limit(20).get();
        if (!snapshot.empty) {
            const firebasePosts = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp.toDate()
            }));
            
            // Merge with local data
            posts = mergePostsData(posts, firebasePosts);
        } else if (posts.length === 0) {
            await createDefaultPosts();
        }
    } catch (error) {
        console.error('Error loading posts from Firebase:', error);
        if (posts.length === 0) {
            await createDefaultPosts();
        }
    }
    
    filterAndDisplayPosts();
    saveAllDataToStorage();
}

function mergePostsData(localPosts, firebasePosts) {
    const merged = [...firebasePosts];
    
    // Add local posts that don't exist in Firebase
    localPosts.forEach(localPost => {
        if (!firebasePosts.find(fp => fp.id === localPost.id)) {
            merged.push(localPost);
        }
    });
    
    return merged.sort((a, b) => b.timestamp - a.timestamp);
}

async function createDefaultPosts() {
    const defaultPosts = [
        {
            id: '1',
            title: "WELCOME EVERYONE",
            content: "Welcome, everyone and those viewing this message to explore and have fun on this page, but remember the rules and regulations",
            author: "SmileX Team",
            authorId: "system",
            community: "SmileX",
            communityId: "c1",
            visibility: "general",
            votes: 5400,
            comments: 1400,
            timestamp: new Date(Date.now() - 3600000),
            type: "text",
            images: []
        },
        {
            id: '2',
            title: "New Gaming Setup Showcase",
            content: "Check out my latest gaming setup! What do you think?",
            author: "GamerPro",
            authorId: "user_gamer",
            community: "Gaming",
            communityId: "c2",
            visibility: "community",
            votes: 2700,
            comments: 423,
            timestamp: new Date(Date.now() - 7200000),
            type: "image",
            images: ["https://source.unsplash.com/800x600/?gaming,setup"]
        },
        {
            id: '3',
            title: "What programming language should I learn next?",
            content: "I'm looking to expand my programming skills. What would you recommend?",
            author: "CodeNewbie",
            authorId: "user_coder",
            community: "TechTalks",
            communityId: "c3",
            visibility: "community",
            votes: 1850,
            comments: 234,
            timestamp: new Date(Date.now() - 10800000),
            type: "poll",
            images: [],
            pollOptions: [
                { text: "Python", votes: 450, percentage: 35, voters: [] },
                { text: "JavaScript", votes: 380, percentage: 30, voters: [] },
                { text: "Rust", votes: 260, percentage: 20, voters: [] },
                { text: "Go", votes: 190, percentage: 15, voters: [] }
            ],
            pollId: 'poll_1',
            pollActive: true
        },
        {
            id: '4',
            title: "Beautiful sunset photography tips",
            content: "Here are some tips for capturing amazing sunset photos that I've learned over the years...",
            author: "PhotoMaster",
            authorId: "user_photo",
            community: "General",
            communityId: null,
            visibility: "general",
            votes: 1240,
            comments: 89,
            timestamp: new Date(Date.now() - 14400000),
            type: "text",
            images: []
        }
    ];

    posts = defaultPosts;

    // Save to Firebase
    try {
        const batch = db.batch();
        defaultPosts.forEach(post => {
            const docRef = db.collection('posts').doc(post.id);
            batch.set(docRef, {
                ...post,
                timestamp: firebase.firestore.Timestamp.fromDate(post.timestamp)
            });
        });
        await batch.commit();
    } catch (error) {
        console.error('Error saving default posts to Firebase:', error);
    }
    
    saveAllDataToStorage();
}

function openCreatePostModal() {
    document.getElementById('create-post-modal').classList.add('active');
    populateUserCommunities('postCommunity');
}

function openCreatePollModal() {
    // Create poll modal HTML if it doesn't exist
    if (!document.getElementById('create-poll-modal')) {
        const pollModalHTML = `
            <div id="create-poll-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Create a Live Poll</h3>
                        <button id="closeCreatePollModal" class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="createPollForm">
                            <div class="mb-4">
                                <label>Poll visibility</label>
                                <select class="form-select" name="visibility" id="pollVisibility" required>
                                    <option value="general">General (visible to everyone)</option>
                                    <option value="community">Community (visible to members)</option>
                                </select>
                            </div>
                            <div class="mb-4 hidden" id="pollCommunityContainer">
                                <label>Choose a community</label>
                                <select class="form-select" name="community" id="pollCommunity">
                                    <option value="">Select a community</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <input type="text" name="question" placeholder="What's your poll question?" class="form-control" required>
                            </div>
                            <div class="mb-4">
                                <label>Poll Options</label>
                                <div id="pollOptionsContainer">
                                    <input type="text" name="option1" placeholder="Option 1" class="form-control mb-2" required>
                                    <input type="text" name="option2" placeholder="Option 2" class="form-control mb-2" required>
                                </div>
                                <button type="button" id="addPollOption" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 8px;">
                                    <i class="fas fa-plus"></i> Add Option
                                </button>
                            </div>
                            <div class="mb-4">
                                <label>Poll Duration</label>
                                <select class="form-select" name="duration" required>
                                    <option value="1">1 Hour</option>
                                    <option value="6">6 Hours</option>
                                    <option value="24">1 Day</option>
                                    <option value="168">1 Week</option>
                                    <option value="0">No Expiration</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancelCreatePoll">Cancel</button>
                        <button type="submit" form="createPollForm">Create Poll</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', pollModalHTML);
        
        // Add event listeners for poll modal
        document.getElementById('closeCreatePollModal').addEventListener('click', () => {
            document.getElementById('create-poll-modal').classList.remove('active');
        });
        
        document.getElementById('cancelCreatePoll').addEventListener('click', () => {
            document.getElementById('create-poll-modal').classList.remove('active');
        });
        
        document.getElementById('pollVisibility').addEventListener('change', function() {
            const communityContainer = document.getElementById('pollCommunityContainer');
            if (this.value === 'community') {
                communityContainer.classList.remove('hidden');
                populateUserCommunities('pollCommunity');
            } else {
                communityContainer.classList.add('hidden');
            }
        });
        
        document.getElementById('addPollOption').addEventListener('click', () => {
            const container = document.getElementById('pollOptionsContainer');
            const optionCount = container.children.length + 1;
            if (optionCount <= 6) {
                const newOption = document.createElement('input');
                newOption.type = 'text';
                newOption.name = `option${optionCount}`;
                newOption.placeholder = `Option ${optionCount}`;
                newOption.className = 'form-control mb-2';
                container.appendChild(newOption);
            } else {
                showNotification('Maximum 6 options allowed');
            }
        });
        
        document.getElementById('createPollForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const pollData = Object.fromEntries(formData.entries());
            
            await createNewPoll(pollData);
            this.reset();
            // Reset options container
            document.getElementById('pollOptionsContainer').innerHTML = `
                <input type="text" name="option1" placeholder="Option 1" class="form-control mb-2" required>
                <input type="text" name="option2" placeholder="Option 2" class="form-control mb-2" required>
            `;
            document.getElementById('create-poll-modal').classList.remove('active');
            showNotification('Live poll created successfully!');
        });
    }
    
    document.getElementById('create-poll-modal').classList.add('active');
    populateUserCommunities('pollCommunity');
}

function populateUserCommunities(selectId) {
    const select = document.getElementById(selectId);
    const userCommunities = communities.filter(c => userMemberships.includes(c.id));
    
    select.innerHTML = '<option value="">Select a community</option>';
    userCommunities.forEach(community => {
        const option = document.createElement('option');
        option.value = community.id;
        option.textContent = community.displayName;
        select.appendChild(option);
    });
}

async function createNewPost(postData) {
    let imageUrls = [];
    
    // Upload images if any
    if (uploadedImages.length > 0) {
        try {
            imageUrls = await uploadImagesToFirebase(uploadedImages);
        } catch (error) {
            console.error('Error uploading images:', error);
            showNotification('Error uploading images. Post created without images.');
        }
    }

    const newPost = {
        id: Date.now().toString(),
        title: postData.title,
        content: postData.content,
        author: currentUser ? currentUser.fullName : "Anonymous",
        authorId: currentUser ? currentUser.userId : "anonymous",
        visibility: postData.visibility,
        votes: 0,
        comments: 0,
        timestamp: new Date(),
        type: imageUrls.length > 0 ? "image" : "text",
        images: imageUrls
    };

    if (postData.visibility === 'community' && postData.community) {
        const community = communities.find(c => c.id === postData.community);
        if (community) {
            newPost.community = community.displayName;
            newPost.communityId = community.id;
        }
    } else {
        newPost.community = "General";
        newPost.communityId = null;
    }
    
    // Save to Firebase
    try {
        await db.collection('posts').doc(newPost.id).set({
            ...newPost,
            timestamp: firebase.firestore.Timestamp.fromDate(newPost.timestamp)
        });
    } catch (error) {
        console.error('Error saving post to Firebase:', error);
    }

    posts.unshift(newPost);
    filterAndDisplayPosts();
    saveAllDataToStorage();
}

async function createNewPoll(pollData) {
    const options = [];
    let optionIndex = 1;
    
    // Extract poll options
    while (pollData[`option${optionIndex}`]) {
        if (pollData[`option${optionIndex}`].trim()) {
            options.push({
                text: pollData[`option${optionIndex}`].trim(),
                votes: 0,
                percentage: 0,
                voters: []
            });
        }
        optionIndex++;
    }
    
    if (options.length < 2) {
        showNotification('Poll must have at least 2 options');
        return;
    }

    const pollId = 'poll_' + Date.now();
    const expiresAt = pollData.duration === '0' ? null : new Date(Date.now() + (parseInt(pollData.duration) * 60 * 60 * 1000));

    const newPoll = {
        id: Date.now().toString(),
        title: pollData.question,
        content: "",
        author: currentUser ? currentUser.fullName : "Anonymous",
        authorId: currentUser ? currentUser.userId : "anonymous",
        visibility: pollData.visibility,
        votes: 0,
        comments: 0,
        timestamp: new Date(),
        type: "poll",
        images: [],
        pollOptions: options,
        pollId: pollId,
        pollActive: true,
        pollExpiresAt: expiresAt,
        totalVotes: 0
    };

    if (pollData.visibility === 'community' && pollData.community) {
        const community = communities.find(c => c.id === pollData.community);
        if (community) {
            newPoll.community = community.displayName;
            newPoll.communityId = community.id;
        }
    } else {
        newPoll.community = "General";
        newPoll.communityId = null;
    }
    
    // Add to live polls tracking
    livePolls.push({
        id: pollId,
        postId: newPoll.id,
        question: pollData.question,
        options: options,
        active: true,
        expiresAt: expiresAt,
        createdBy: currentUser ? currentUser.userId : "anonymous",
        totalVotes: 0
    });
    
    // Save to Firebase
    try {
        await db.collection('posts').doc(newPoll.id).set({
            ...newPoll,
            timestamp: firebase.firestore.Timestamp.fromDate(newPoll.timestamp),
            pollExpiresAt: expiresAt ? firebase.firestore.Timestamp.fromDate(expiresAt) : null
        });
    } catch (error) {
        console.error('Error saving poll to Firebase:', error);
    }

    posts.unshift(newPoll);
    filterAndDisplayPosts();
    saveAllDataToStorage();
}

async function createNewCommunity(communityData) {
    // Validate community name
    const communityName = communityData.name.replace(/\s+/g, '').toLowerCase();
    if (communities.find(c => c.name.toLowerCase() === communityName)) {
        showNotification('Community name already exists!');
        return;
    }

    const newCommunity = {
        id: 'c' + Date.now(),
        name: communityName,
        displayName: communityData.displayName,
        description: communityData.description,
        type: communityData.type,
        createdBy: currentUser ? currentUser.fullName : "Anonymous",
        createdByUserId: currentUser ? currentUser.userId : "anonymous",
        createdAt: new Date().toISOString(),
        memberCount: 1,
        topics: communityData.topics ? communityData.topics.split(',').map(t => t.trim()) : [],
        members: [currentUser ? currentUser.userId : "anonymous"]
    };

    communities.push(newCommunity);
    
    // Auto-join the creator to the community
    if (!userMemberships.includes(newCommunity.id)) {
        userMemberships.push(newCommunity.id);
    }
    
    // Add to user's created communities
    if (!userCreatedCommunities.includes(newCommunity.id)) {
        userCreatedCommunities.push(newCommunity.id);
    }

    // Save to Firebase
    try {
        await db.collection('communities').doc(newCommunity.id).set(newCommunity);
    } catch (error) {
        console.error('Error saving community to Firebase:', error);
    }

    updateCommunityLists();
    saveAllDataToStorage();
    showNotification(`Community "${communityData.displayName}" created successfully!`);
}

function updateCommunityLists() {
    // Update left sidebar communities list
    const communitiesList = document.getElementById('communitiesList');
    const userCommunities = communities.filter(c => userMemberships.includes(c.id));
    
    communitiesList.innerHTML = `
        <div style="margin-bottom: 1rem;">
            <h4 style="color: #8b5cf6; font-size: 0.9rem; margin-bottom: 0.5rem;">My Communities</h4>
            ${userCommunities.map(community => {
                const isCreator = userCreatedCommunities.includes(community.id);
                return `
                    <div style="display: flex; align-items: center; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 8px; transition: all 0.3s ease; cursor: pointer;" 
                         onclick="viewCommunityDetails('${community.id}')"
                         onmouseover="this.style.background='#2a2a2a'"
                         onmouseout="this.style.background='transparent'">
                        <span class="community-icon ${getCommunityColor(community.name)}" style="margin-right: 0.5rem;">
                            ${community.name.charAt(0)}
                        </span>
                        <span style="flex: 1; font-size: 0.9rem;">${community.displayName}</span>
                        ${community.type === 'private' ? '<i class="fas fa-lock" style="font-size: 10px; color: #666; margin-right: 0.25rem;"></i>' : ''}
                        ${isCreator ? '<i class="fas fa-crown" style="font-size: 10px; color: #ffd700;" title="You created this community"></i>' : ''}
                    </div>
                `;
            }).join('')}
        </div>
    `;

    // Update recommended communities
    displayRecommendedCommunities();
}

function displayRecommendedCommunities() {
    const container = document.getElementById('recommendedCommunities');
    const nonMemberCommunities = communities.filter(c => !userMemberships.includes(c.id) && c.type === 'public').slice(0, 3);
    
    container.innerHTML = nonMemberCommunities.map(community => `
        <div style="background: #2a2a2a; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s ease;" onclick="viewCommunityDetails('${community.id}')">
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                <span class="community-icon ${getCommunityColor(community.name)}">
                    ${community.name.charAt(0)}
                </span>
                <div style="flex: 1; margin-left: 0.5rem;">
                    <h4 style="margin: 0; font-size: 14px;">${community.displayName}</h4>
                    <p style="margin: 0; font-size: 12px; color: #666;">${formatNumber(community.memberCount)} members</p>
                </div>
                <span style="padding: 2px 6px; background: ${community.type === 'private' ? '#ef4444' : '#10b981'}; border-radius: 4px; font-size: 10px;">
                    ${community.type}
                </span>
            </div>
            <p style="font-size: 12px; color: #ccc; margin: 0; line-height: 1.4;">${community.description}</p>
        </div>
    `).join('');
}

function openBrowseCommunitiesModal() {
    document.getElementById('browse-communities-modal').classList.add('active');
    filterBrowseCommunities();
}

function filterBrowseCommunities() {
    const searchQuery = document.getElementById('communitySearchInput').value.toLowerCase();
    let filteredCommunities = communities;

    // Filter by tab
    if (currentCommunityTab !== 'all') {
        filteredCommunities = filteredCommunities.filter(c => c.type === currentCommunityTab);
    }

    // Filter by search query
    if (searchQuery) {
        filteredCommunities = filteredCommunities.filter(c => 
            c.name.toLowerCase().includes(searchQuery) ||
            c.displayName.toLowerCase().includes(searchQuery) ||
            (c.description && c.description.toLowerCase().includes(searchQuery)) ||
            (c.topics && c.topics.some(topic => topic.toLowerCase().includes(searchQuery)))
        );
    }

    displayBrowseCommunities(filteredCommunities);
}

function displayBrowseCommunities(communitiesToShow) {
    const container = document.getElementById('communitiesBrowseList');
    const noCommunitiesMessage = document.getElementById('noCommunitiesMessage');

    if (communitiesToShow.length === 0) {
        container.innerHTML = '';
        noCommunitiesMessage.classList.remove('hidden');
        return;
    }

    noCommunitiesMessage.classList.add('hidden');
    container.innerHTML = communitiesToShow.map(community => {
        const isMember = userMemberships.includes(community.id);
        const isCreator = userCreatedCommunities.includes(community.id);
        return `
            <div style="background: #2a2a2a; border-radius: 8px; padding: 1.5rem; position: relative;">
                <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center;">
                        <span class="community-icon ${getCommunityColor(community.name)}" style="width: 40px; height: 40px; font-size: 16px;">
                            ${community.name.charAt(0)}
                        </span>
                        <div style="margin-left: 1rem;">
                            <h3 style="margin: 0; font-size: 16px; display: flex; align-items: center; gap: 0.5rem;">
                                ${community.displayName}
                                ${isCreator ? '<i class="fas fa-crown" style="color: #ffd700; font-size: 12px;" title="You created this community"></i>' : ''}
                            </h3>
                            <p style="margin: 0; font-size: 12px; color: #666;">${formatNumber(community.memberCount)} members • Created by ${community.createdBy}</p>
                        </div>
                    </div>
                    <span style="padding: 4px 8px; background: ${community.type === 'private' ? '#ef4444' : '#10b981'}; border-radius: 4px; font-size: 10px;">
                        ${community.type}
                    </span>
                </div>
                
                <p style="font-size: 14px; color: #ccc; margin-bottom: 1rem; line-height: 1.4;">${community.description}</p>
                
                ${community.topics && community.topics.length > 0 ? `
                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 1rem;">
                        ${community.topics.slice(0, 3).map(topic => `
                            <span style="padding: 2px 6px; background: #404040; border-radius: 12px; font-size: 10px;">${topic}</span>
                        `).join('')}
                        ${community.topics.length > 3 ? `<span style="font-size: 10px; color: #666;">+${community.topics.length - 3} more</span>` : ''}
                    </div>
                ` : ''}
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button onclick="viewCommunityDetails('${community.id}')" style="background: none; border: none; color: #8b5cf6; font-size: 12px; cursor: pointer;">
                        View Details
                    </button>
                    <div style="display: flex; gap: 0.5rem;">
                        ${isCreator ? `
                            <button onclick="deleteCommunity('${community.id}')" 
                                    style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;"
                                    title="Delete Community">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                        <button onclick="${isMember ? `leaveCommunity('${community.id}')` : `joinCommunity('${community.id}')`}" 
                                style="padding: 6px 12px; background: ${isMember ? '#666' : '#8b5cf6'}; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            ${isMember ? 'Leave' : 'Join'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function deleteCommunity(communityId) {
    if (!confirm('Are you sure you want to delete this community? This action cannot be undone.')) {
        return;
    }

    const community = communities.find(c => c.id === communityId);
    if (!community) return;

    // Check if user is the creator
    if (community.createdByUserId !== (currentUser ? currentUser.userId : "anonymous")) {
        showNotification('You can only delete communities you created!');
        return;
    }

    try {
        // Remove from Firebase
        await db.collection('communities').doc(communityId).delete();
        
        // Remove all posts from this community
        const communityPosts = posts.filter(p => p.communityId === communityId);
        for (const post of communityPosts) {
            await db.collection('posts').doc(post.id).delete();
        }
        
        showNotification('Community deleted successfully!');
    } catch (error) {
        console.error('Error deleting community from Firebase:', error);
        showNotification('Community deleted locally!');
    }

    // Remove from local arrays
    communities = communities.filter(c => c.id !== communityId);
    posts = posts.filter(p => p.communityId !== communityId);
    userMemberships = userMemberships.filter(id => id !== communityId);
    userCreatedCommunities = userCreatedCommunities.filter(id => id !== communityId);

    // Update UI
    updateCommunityLists();
    filterAndDisplayPosts();
    filterBrowseCommunities();
    saveAllDataToStorage();
}

function viewCommunityDetails(communityId) {
    const community = communities.find(c => c.id === communityId);
    if (!community) return;

    currentCommunity = community;
    const isMember = userMemberships.includes(communityId);
    const isCreator = userCreatedCommunities.includes(communityId);

    // Update community detail modal
    document.getElementById('communityDetailHeader').innerHTML = `
        <button onclick="document.getElementById('community-detail-modal').classList.remove('active')" 
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #666; font-size: 1.2rem; cursor: pointer;">
            <i class="fas fa-times"></i>
        </button>
        <div style="display: flex; align-items: center;">
            <span class="community-icon ${getCommunityColor(community.name)}" style="width: 64px; height: 64px; font-size: 24px; margin-right: 1rem;">
                ${community.name.charAt(0)}
            </span>
            <div>
                <h2 style="margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    ${community.displayName}
                    ${isCreator ? '<i class="fas fa-crown" style="color: #ffd700;" title="You created this community"></i>' : ''}
                </h2>
                <p style="margin: 0; color: #666;">c/${community.name}</p>
                <div style="display: flex; align-items: center; margin-top: 0.5rem;">
                    <span style="padding: 4px 8px; background: ${community.type === 'private' ? '#ef4444' : '#10b981'}; border-radius: 4px; font-size: 10px; margin-right: 0.5rem;">
                        ${community.type}
                    </span>
                    <span style="font-size: 12px; color: #666;">${formatNumber(community.memberCount)} members</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById('communityDetailDescription').textContent = community.description || 'No description available.';
    document.getElementById('communityCreationDate').textContent = new Date(community.createdAt).toLocaleDateString();
    document.getElementById('communityMemberCount').textContent = formatNumber(community.memberCount);
    document.getElementById('communityType').innerHTML = `
        <span style="padding: 4px 8px; background: ${community.type === 'private' ? '#ef4444' : '#10b981'}; border-radius: 4px; font-size: 10px;">
            ${community.type}
        </span>
    `;

    // Display topics
    const topicsContainer = document.getElementById('communityTopics');
    if (community.topics && community.topics.length > 0) {
        topicsContainer.innerHTML = community.topics.map(topic => `
            <span style="padding: 4px 8px; background: #404040; border-radius: 12px; font-size: 10px; margin-right: 0.25rem; margin-bottom: 0.25rem; display: inline-block;">${topic}</span>
        `).join('');
    } else {
        topicsContainer.innerHTML = '<span style="color: #666; font-size: 12px;">No topics specified</span>';
    }

    // Display community posts
    const communityPosts = posts.filter(p => p.communityId === communityId).slice(0, 3);
    const postsContainer = document.getElementById('communityPosts');
    
    if (communityPosts.length > 0) {
        postsContainer.innerHTML = communityPosts.map(post => `
            <div style="background: #2a2a2a; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                <h4 style="margin: 0 0 0.25rem 0; font-size: 14px;">${post.title}</h4>
                <p style="margin: 0; font-size: 12px; color: #666;">by ${post.author} • ${getTimeAgo(post.timestamp)}</p>
                <div style="display: flex; align-items: center; margin-top: 0.5rem; font-size: 11px; color: #666;">
                    <span>${formatNumber(post.votes)} votes</span>
                    <span style="margin: 0 0.5rem;">•</span>
                    <span>${formatNumber(post.comments)} comments</span>
                </div>
            </div>
        `).join('');
    } else {
        postsContainer.innerHTML = '<p style="color: #666;">No posts yet in this community.</p>';
    }

    updateJoinLeaveButton();
    document.getElementById('community-detail-modal').classList.add('active');
}

function updateJoinLeaveButton() {
    if (!currentCommunity) return;
    
    const button = document.getElementById('joinLeaveButton');
    const isMember = userMemberships.includes(currentCommunity.id);
    
    if (isMember) {
        button.textContent = 'Leave';
        button.style.background = '#666';
    } else {
        button.textContent = 'Join';
        button.style.background = '#8b5cf6';
    }
}

async function joinCommunity(communityId) {
    if (!userMemberships.includes(communityId)) {
        userMemberships.push(communityId);
        
        // Update member count and members list
        const community = communities.find(c => c.id === communityId);
        if (community) {
            community.memberCount++;
            if (!community.members) community.members = [];
            if (currentUser && !community.members.includes(currentUser.userId)) {
                community.members.push(currentUser.userId);
            }
            
            // Update in Firebase
            try {
                await db.collection('communities').doc(communityId).update({
                    memberCount: firebase.firestore.FieldValue.increment(1),
                    members: firebase.firestore.FieldValue.arrayUnion(currentUser ? currentUser.userId : "anonymous")
                });
            } catch (error) {
                console.error('Error updating member count in Firebase:', error);
            }
        }
        
        updateCommunityLists();
        filterBrowseCommunities();
        saveAllDataToStorage();
        showNotification(`Joined ${community ? community.displayName : 'community'} successfully!`);
    }
}

async function leaveCommunity(communityId) {
    const index = userMemberships.indexOf(communityId);
    if (index > -1) {
        userMemberships.splice(index, 1);
        
        // Update member count and members list
        const community = communities.find(c => c.id === communityId);
        if (community && community.memberCount > 0) {
            community.memberCount--;
            if (community.members && currentUser) {
                community.members = community.members.filter(id => id !== currentUser.userId);
            }
            
            // Update in Firebase
            try {
                await db.collection('communities').doc(communityId).update({
                    memberCount: firebase.firestore.FieldValue.increment(-1),
                    members: firebase.firestore.FieldValue.arrayRemove(currentUser ? currentUser.userId : "anonymous")
                });
            } catch (error) {
                console.error('Error updating member count in Firebase:', error);
            }
        }
        
        updateCommunityLists();
        filterBrowseCommunities();
        saveAllDataToStorage();
        showNotification(`Left ${community ? community.displayName : 'community'}`);
    }
}

function filterAndDisplayPosts() {
    let filteredPosts = [...posts];

    // Filter by feed type
    switch (currentFeedFilter) {
        case 'general':
            filteredPosts = filteredPosts.filter(p => p.visibility === 'general');
            break;
        case 'mycommunities':
            filteredPosts = filteredPosts.filter(p => 
                p.visibility === 'community' && 
                p.communityId && 
                userMemberships.includes(p.communityId)
            );
            break;
        case 'all':
        default:
            // Show general posts and community posts from joined communities
            filteredPosts = filteredPosts.filter(p => 
                p.visibility === 'general' || 
                (p.visibility === 'community' && p.communityId && userMemberships.includes(p.communityId))
            );
            break;
    }

    displayPosts(filteredPosts);
}

function sortAndDisplayPosts() {
    let sortedPosts = [...posts];
    
    switch (currentSort) {
        case 'hot':
            sortedPosts.sort((a, b) => {
                const aScore = a.votes + a.comments * 2;
                const bScore = b.votes + b.comments * 2;
                return bScore - aScore;
            });
            break;
        case 'new':
            sortedPosts.sort((a, b) => b.timestamp - a.timestamp);
            break;
        case 'top':
            sortedPosts.sort((a, b) => b.votes - a.votes);
            break;
    }
    
    // Apply current filter
    let filteredPosts = sortedPosts;
    switch (currentFeedFilter) {
        case 'general':
            filteredPosts = sortedPosts.filter(p => p.visibility === 'general');
            break;
        case 'mycommunities':
            filteredPosts = sortedPosts.filter(p => 
                p.visibility === 'community' && 
                p.communityId && 
                userMemberships.includes(p.communityId)
            );
            break;
        case 'all':
        default:
            filteredPosts = sortedPosts.filter(p => 
                p.visibility === 'general' || 
                (p.visibility === 'community' && p.communityId && userMemberships.includes(p.communityId))
            );
            break;
    }
    
    displayPosts(filteredPosts);
}

function displayPosts(postsToDisplay) {
    const container = document.getElementById('posts-feed');
    container.innerHTML = postsToDisplay.map(post => createPostHTML(post)).join('');
    
    // Attach event listeners to vote buttons
    attachVoteListeners();
}

function createPostHTML(post) {
    const timeAgo = getTimeAgo(post.timestamp);
    const communityInitial = post.community ? post.community.charAt(0) : 'G';
    const communityColor = getCommunityColor(post.community || 'General');
    
    let contentHTML = '';
    
    if (post.type === 'image' && post.images && post.images.length > 0) {
        contentHTML = `
            <div class="mb-4">
                ${post.images.map(imageUrl => `
                    <img src="${imageUrl}" alt="${post.title}" class="post-image">
                `).join('')}
            </div>
        `;
    } else if (post.type === 'poll' && post.pollOptions) {
        const isPollActive = post.pollActive && (!post.pollExpiresAt || new Date() < new Date(post.pollExpiresAt));
        const totalVotes = post.pollOptions.reduce((sum, option) => sum + option.votes, 0);
        
        contentHTML = `
            <div class="mb-4">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${post.pollOptions.map((option, index) => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #2a2a2a; border-radius: 8px; cursor: ${isPollActive ? 'pointer' : 'default'}; position: relative; overflow: hidden;" 
                             onclick="${isPollActive ? `voteInPoll('${post.id}', ${index})` : ''}">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; background: rgba(139, 92, 246, 0.2); width: ${option.percentage}%; transition: width 0.3s ease;"></div>
                            <span style="position: relative; z-index: 1;">${option.text}</span>
                            <span style="position: relative; z-index: 1; font-size: 12px; color: #666;">${option.percentage}% (${formatNumber(option.votes)} votes)</span>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 0.5rem; font-size: 11px; color: #666; display: flex; justify-content: space-between; align-items: center;">
                    <span>${formatNumber(totalVotes)} total votes</span>
                    <span>${isPollActive ? 'Poll active' : 'Poll ended'}</span>
                    ${post.pollExpiresAt ? `<span>Expires: ${new Date(post.pollExpiresAt).toLocaleDateString()}</span>` : '<span>No expiration</span>'}
                </div>
            </div>
        `;
    } else if (post.content) {
        contentHTML = `
            <div class="post-text">
                <p>${post.content}</p>
            </div>
        `;
    }

    return `
        <div class="post-card">
            <div class="post-content">
                <div class="vote-section">
                    <button class="vote-button" data-post-id="${post.id}" data-vote="up">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <span class="vote-count">${formatNumber(post.votes)}</span>
                    <button class="vote-button" data-post-id="${post.id}" data-vote="down">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>

                <div class="post-main">
                    <div class="post-meta">
                        <span class="community-icon ${communityColor}">${communityInitial}</span>
                        <span style="cursor: pointer;" onclick="${post.communityId ? `viewCommunityDetails('${post.communityId}')` : ''}">${post.community || 'General'}</span>
                        ${post.visibility === 'community' ? '<i class="fas fa-users" title="Community post"></i>' : '<i class="fas fa-globe" title="Public post"></i>'}
                        <span>•</span>
                        <span>Posted by ${post.author}</span>
                        <span>•</span>
                        <span>${timeAgo}</span>
                        ${post.type === 'poll' ? '<i class="fas fa-poll" title="Live Poll" style="color: #8b5cf6;"></i>' : ''}
                    </div>

                    <h3 class="post-title">${post.title}</h3>

                    ${contentHTML}

                    <div class="post-actions">
                        <div class="post-action-buttons">
                            <button class="post-action-button" onclick="toggleComments('${post.id}')">
                                <i class="far fa-comment"></i>
                                <span>${formatNumber(post.comments)} Comments</span>
                            </button>
                            <button class="post-action-button" onclick="sharePost('${post.id}')">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </button>
                            <button class="post-action-button" onclick="savePost('${post.id}')">
                                <i class="far fa-bookmark"></i>
                                <span>Save</span>
                            </button>
                        </div>
                        <button class="post-action-button" onclick="showPostOptions('${post.id}')">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Comments Section -->
            <div class="comments-section" id="comments-${post.id}">
                <div class="comment-input">
                    <input type="text" placeholder="Add a comment..." id="comment-input-${post.id}">
                    <button onclick="addComment('${post.id}')" style="background: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 20px; cursor: pointer;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div id="comments-list-${post.id}">
                    <!-- Comments will be loaded here -->
                </div>
            </div>
        </div>
    `;
}

function attachVoteListeners() {
    document.querySelectorAll('.vote-button').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            const voteType = this.dataset.vote;
            handleVote(postId, voteType, this);
        });
    });
}

async function handleVote(postId, voteType, buttonElement) {
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    const voteContainer = buttonElement.closest('.vote-section');
    const countElement = voteContainer.querySelector('.vote-count');
    const upButton = voteContainer.querySelector('[data-vote="up"]');
    const downButton = voteContainer.querySelector('[data-vote="down"]');

    // Remove existing votes
    const wasUpvoted = upButton.classList.contains('voted-up');
    const wasDownvoted = downButton.classList.contains('voted-down');

    upButton.classList.remove('voted-up');
    downButton.classList.remove('voted-down');

    if (voteType === 'up') {
        if (wasUpvoted) {
            post.votes--;
        } else {
            if (wasDownvoted) post.votes += 2;
            else post.votes++;
            upButton.classList.add('voted-up');
        }
    } else {
        if (wasDownvoted) {
            post.votes++;
        } else {
            if (wasUpvoted) post.votes -= 2;
            else post.votes--;
            downButton.classList.add('voted-down');
        }
    }

    countElement.textContent = formatNumber(post.votes);

    // Update in Firebase
    try {
        await db.collection('posts').doc(postId).update({
            votes: post.votes
        });
    } catch (error) {
        console.error('Error updating vote in Firebase:', error);
    }
    
    saveAllDataToStorage();
    showNotification('Vote recorded!');
}

async function voteInPoll(postId, optionIndex) {
    const post = posts.find(p => p.id === postId);
    if (!post || !post.pollOptions || !currentUser) return;

    const userId = currentUser.userId;
    const option = post.pollOptions[optionIndex];

    // Check if poll is still active
    const isPollActive = post.pollActive && (!post.pollExpiresAt || new Date() < new Date(post.pollExpiresAt));
    if (!isPollActive) {
        showNotification('This poll has ended');
        return;
    }

    // Check if user already voted
    const hasVoted = post.pollOptions.some(opt => opt.voters && opt.voters.includes(userId));
    if (hasVoted) {
        showNotification('You have already voted in this poll');
        return;
    }

    // Add vote
    if (!option.voters) option.voters = [];
    option.voters.push(userId);
    option.votes++;

    // Recalculate percentages
    const totalVotes = post.pollOptions.reduce((sum, opt) => sum + opt.votes, 0);
    post.pollOptions.forEach(opt => {
        opt.percentage = totalVotes > 0 ? Math.round((opt.votes / totalVotes) * 100) : 0;
    });

    // Update live poll tracking
    const livePoll = livePolls.find(p => p.postId === postId);
    if (livePoll) {
        livePoll.options = post.pollOptions;
        livePoll.totalVotes = totalVotes;
    }

    // Update in Firebase
    try {
        await db.collection('posts').doc(postId).update({
            pollOptions: post.pollOptions
        });
    } catch (error) {
        console.error('Error updating poll in Firebase:', error);
    }

    // Refresh display
    filterAndDisplayPosts();
    saveAllDataToStorage();
    showNotification(`Voted for: ${option.text}`);
}

function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    commentsSection.classList.toggle('active');
    
    if (commentsSection.classList.contains('active')) {
        loadComments(postId);
    }
}

async function loadComments(postId) {
    try {
        const snapshot = await db.collection('posts').doc(postId).collection('comments').orderBy('timestamp', 'desc').get();
        const comments = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            timestamp: doc.data().timestamp.toDate()
        }));
        
        displayComments(postId, comments);
    } catch (error) {
        console.error('Error loading comments:', error);
        // Show placeholder comments
        displayComments(postId, []);
    }
}

function displayComments(postId, comments) {
    const commentsList = document.getElementById(`comments-list-${postId}`);
    
    if (comments.length === 0) {
        commentsList.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">No comments yet. Be the first to comment!</p>';
        return;
    }
    
    commentsList.innerHTML = comments.map(comment => `
        <div class="comment">
            <div class="comment-author">${comment.author}</div>
            <div class="comment-text">${comment.text}</div>
            <div style="font-size: 11px; color: #666; margin-top: 0.25rem;">${getTimeAgo(comment.timestamp)}</div>
        </div>
    `).join('');
}

async function addComment(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();
    
    if (!commentText) return;
    
    const comment = {
        id: Date.now().toString(),
        text: commentText,
        author: currentUser ? currentUser.fullName : 'Anonymous',
        authorId: currentUser ? currentUser.userId : 'anonymous',
        timestamp: new Date()
    };
    
    // Save to Firebase
    try {
        await db.collection('posts').doc(postId).collection('comments').doc(comment.id).set({
            ...comment,
            timestamp: firebase.firestore.Timestamp.fromDate(comment.timestamp)
        });
        
        // Update comment count
        const post = posts.find(p => p.id === postId);
        if (post) {
            post.comments++;
            await db.collection('posts').doc(postId).update({
                comments: firebase.firestore.FieldValue.increment(1)
            });
        }
    } catch (error) {
        console.error('Error adding comment:', error);
    }
    
    input.value = '';
    loadComments(postId);
    saveAllDataToStorage();
    showNotification('Comment added successfully!');
}

async function loadMorePosts() {
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    loadMoreBtn.textContent = 'Loading...';
    loadMoreBtn.disabled = true;

    try {
        // Load more posts from Firebase
        const snapshot = await db.collection('posts')
            .orderBy('timestamp', 'desc')
            .startAfter(posts[posts.length - 1]?.timestamp || new Date())
            .limit(5)
            .get();
        
        if (!snapshot.empty) {
            const newPosts = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp.toDate()
            }));
            
            posts.push(...newPosts);
        } else {
            // Generate some sample posts if no more in Firebase
            const samplePosts = [
                {
                    id: Date.now().toString(),
                    title: "Amazing sunset photography tips",
                    content: "Here are some tips for capturing the perfect sunset photo...",
                    author: "PhotoPro",
                    authorId: "user_photo_pro",
                    community: "General",
                    communityId: null,
                    visibility: "general",
                    votes: 1250,
                    comments: 89,
                    timestamp: new Date(Date.now() - 14400000),
                    type: "text",
                    images: []
                },
                {
                    id: (Date.now() + 1).toString(),
                    title: "New AI breakthrough in machine learning",
                    content: "Researchers have made significant progress in developing more efficient neural networks...",
                    author: "TechExpert",
                    authorId: "user_tech_expert",
                    community: "TechTalks",
                    communityId: "c3",
                    visibility: "community",
                    votes: 3400,
                    comments: 234,
                    timestamp: new Date(Date.now() - 18000000),
                    type: "text",
                    images: []
                }
            ];
            
            posts.push(...samplePosts);
        }
        
        filterAndDisplayPosts();
        saveAllDataToStorage();
    } catch (error) {
        console.error('Error loading more posts:', error);
        showNotification('Error loading more posts');
    }

    loadMoreBtn.textContent = 'Load more posts';
    loadMoreBtn.disabled = false;
}

async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (message) {
        addChatMessage(currentUser ? currentUser.fullName : 'You', message);
        input.value = '';
        
        // Send to OpenAI API
        try {
            const response = await fetch(OPENAI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are a helpful customer support agent for SmileX, a social media platform. Be friendly, helpful, and concise in your responses.'
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ],
                    max_tokens: 150,
                    temperature: 0.7
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                const botResponse = data.choices[0].message.content;
                setTimeout(() => {
                    addChatMessage('Support Agent', botResponse);
                }, 1000);
            } else {
                throw new Error('API request failed');
            }
        } catch (error) {
            console.error('Error calling OpenAI API:', error);
            // Fallback responses
            setTimeout(() => {
                const responses = [
                    "Thanks for your message! How can I help you with SmileX today?",
                    "I'll look into that for you. Is there anything specific about SmileX you'd like to know?",
                    "Our support team is here to help! What questions do you have about using SmileX?",
                    "That's a great question! Let me help you with that.",
                    "I'm here to assist you with any SmileX-related questions.",
                    "Is there anything specific about communities, posts, or features you'd like to know?",
                    "I appreciate you reaching out to us! How can I make your SmileX experience better?"
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage('Support Agent', randomResponse);
            }, 1000 + Math.random() * 2000);
        }
    }
}

function addChatMessage(user, text) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    
    messageDiv.innerHTML = `
        <div class="message-user">${user}</div>
        <div class="message-text">${text}</div>
        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Utility functions
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'k';
    }
    return num.toString();
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
    if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    return 'Just now';
}

function getCommunityColor(community) {
    const colors = {
        'SmileX': 'bg-blue-500',
        'Gaming': 'bg-red-500',
        'TechTalks': 'bg-green-500',
        'ArtistsLounge': 'bg-purple-500',
        'General': 'bg-gray-500'
    };
    
    // Generate color based on community name hash if not predefined
    if (!colors[community]) {
        const hash = community.split('').reduce((a, b) => {
            a = ((a << 5) - a) + b.charCodeAt(0);
            return a & a;
        }, 0);
        const colorOptions = ['bg-blue-500', 'bg-red-500', 'bg-green-500', 'bg-purple-500', 'bg-yellow-500', 'bg-pink-500', 'bg-indigo-500'];
        return colorOptions[Math.abs(hash) % colorOptions.length];
    }
    
    return colors[community];
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.innerHTML = `
        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Post interaction functions
function sharePost(postId) {
    if (navigator.share) {
        navigator.share({
            title: 'Check out this post on SmileX',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href);
        showNotification('Link copied to clipboard!');
    }
}

function savePost(postId) {
    const savedPosts = JSON.parse(localStorage.getItem('savedPosts') || '[]');
    if (!savedPosts.includes(postId)) {
        savedPosts.push(postId);
        localStorage.setItem('savedPosts', JSON.stringify(savedPosts));
        showNotification('Post saved!');
    } else {
        showNotification('Post already saved!');
    }
}

function showPostOptions(postId) {
    showNotification('Post options coming soon!');
}

// Prevent right-click context menu
document.addEventListener('contextmenu', e => e.preventDefault());

// Auto-save data when page is about to unload
window.addEventListener('beforeunload', function() {
    saveAllDataToStorage();
});

// Check for expired polls periodically
setInterval(() => {
    const now = new Date();
    posts.forEach(post => {
        if (post.type === 'poll' && post.pollActive && post.pollExpiresAt) {
            if (now >= new Date(post.pollExpiresAt)) {
                post.pollActive = false;
                const livePoll = livePolls.find(p => p.postId === post.id);
                if (livePoll) {
                    livePoll.active = false;
                }
            }
        }
    });
    saveAllDataToStorage();
}, 60000); // Check every minute
</script>
</body>
</html>