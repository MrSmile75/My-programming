<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmileX - Advanced Social Platform</title>
    <meta name="description" content="SmileX - A modern social platform for connecting communities and sharing experiences">
    <meta name="keywords" content="social media, communities, chat, posts, networking">
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Color Variables */
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --accent-color: #00b4db;
            --background-color: #000000;
            --surface-color: #1a1a1a;
            --surface-secondary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #666666;
            --border-color: #404040;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --premium-gold: #ffd700;
            --premium-gradient: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            
            /* Spacing Variables */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Typography Variables */
            --font-primary: 'Orbitron', sans-serif;
            --font-secondary: 'Poppins', sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 2rem;
            
            /* Border Radius Variables */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            
            /* Shadow Variables */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            /* Transition Variables */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Accessibility Improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Styles for Accessibility */
        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Skip Link for Screen Readers */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: var(--radius-md);
            z-index: 10000;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Preloader Styles */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: var(--transition-slow);
        }

        .preloader-logo {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--spacing-md);
            animation: bounce 2s infinite;
        }

        .preloader-text {
            font-size: var(--font-size-2xl);
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-top: var(--spacing-xl);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Premium Animations */
        @keyframes disco {
            0% { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
            16% { color: #ff8000; text-shadow: 0 0 10px #ff8000; }
            33% { color: #ffff00; text-shadow: 0 0 10px #ffff00; }
            50% { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
            66% { color: #0080ff; text-shadow: 0 0 10px #0080ff; }
            83% { color: #8000ff; text-shadow: 0 0 10px #8000ff; }
            100% { color: #ff0080; text-shadow: 0 0 10px #ff0080; }
        }

        @keyframes premium-glow {
            0%, 100% { box-shadow: 0 0 20px var(--premium-gold); }
            50% { box-shadow: 0 0 40px var(--premium-gold), 0 0 60px var(--premium-gold); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px var(--warning-color); }
            to { text-shadow: 0 0 20px var(--warning-color), 0 0 30px var(--warning-color); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Premium Styles */
        .premium-user {
            position: relative;
        }

        .premium-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--premium-gradient);
            color: #000;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: bold;
            animation: premium-glow 2s ease-in-out infinite;
        }

        .disco-text {
            animation: disco 2s linear infinite;
            font-weight: bold;
        }

        .premium-emoji {
            font-size: 1.2em;
            animation: float 2s ease-in-out infinite;
        }

        /* Modal Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Onboarding Modal */
        .onboarding-container {
            background: var(--surface-color);
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: scale(0.9);
            transition: var(--transition-normal);
        }

        .overlay.active .onboarding-container {
            transform: scale(1);
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .onboarding-header h2 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-sm);
            color: var(--primary-color);
        }

        /* Profile Picture Upload */
        .profile-upload-section {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto var(--spacing-md);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-size-3xl);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .profile-preview:hover {
            transform: scale(1.05);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition-fast);
            border-radius: 50%;
        }

        .profile-preview:hover .profile-upload-overlay {
            opacity: 1;
        }

        .profile-upload-buttons {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            transition: var(--transition-fast);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .name-validation {
            margin-top: var(--spacing-xs);
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .name-available {
            color: var(--success-color);
        }

        .name-taken {
            color: var(--error-color);
        }

        /* Consent Section */
        .consent-section {
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-md);
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
        }

        .consent-item {
            display: flex;
            align-items: center;
            margin: var(--spacing-sm) 0;
        }

        .consent-item input[type="checkbox"] {
            margin-right: var(--spacing-sm);
            width: 16px;
            height: 16px;
        }

        .consent-item label {
            cursor: pointer;
            user-select: none;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
            gap: var(--spacing-xs);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a0fb8;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-premium {
            background: var(--premium-gradient);
            color: #000;
            font-weight: bold;
            animation: premium-glow 2s ease-in-out infinite;
        }

        .btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Navigation */
        nav {
            background: var(--background-color);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
        }

        .logo i {
            margin-right: var(--spacing-sm);
            font-size: var(--font-size-2xl);
        }

        .nav-search {
            position: relative;
            display: none;
        }

        @media (min-width: 768px) {
            .nav-search {
                display: block;
            }
        }

        .nav-search input {
            width: 300px;
            padding: 8px 12px 8px 40px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .nav-search i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
        }

        .search-result-item {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .search-result-item:hover {
            background: var(--surface-secondary);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-type {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: bold;
        }

        .search-result-title {
            font-weight: 500;
            margin: var(--spacing-xs) 0;
        }

        .search-result-description {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-button {
            padding: var(--spacing-sm);
            background: var(--surface-color);
            border: none;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .nav-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: var(--font-size-sm);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-avatar.premium {
            border: 2px solid var(--premium-gold);
            animation: premium-glow 2s ease-in-out infinite;
        }

        /* Main Layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg) var(--spacing-md);
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }

        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            height: fit-content;
            position: sticky;
            top: 80px;
            display: none;
        }

        @media (min-width: 1024px) {
            .sidebar {
                display: block;
            }
        }

        .sidebar h3 {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: var(--spacing-sm);
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: var(--spacing-sm);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
        }

        .sidebar a:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Community Icons */
        .community-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-size-xs);
            font-weight: bold;
        }

        /* Main Feed */
        .main-feed {
            min-height: 100vh;
        }

        /* Create Post Card */
        .create-post-card {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .create-post-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .create-post-input input {
            flex: 1;
            padding: 12px 16px;
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
            cursor: pointer;
        }

        .post-type-buttons {
            display: flex;
            gap: var(--spacing-sm);
        }

        .post-type-button {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: var(--font-size-sm);
        }

        .post-type-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Sort Buttons */
        .sort-buttons {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-sm);
            overflow-x: auto;
        }

        .sort-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            border: none;
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .sort-button.active {
            background: var(--primary-color);
            color: white;
        }

        .sort-button:not(.active) {
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }

        .sort-button:not(.active):hover {
            background: var(--border-color);
        }

        /* Post Cards */
        .post-card {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
            animation: fadeIn 0.5s ease;
            cursor: pointer;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .post-content {
            padding: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-md);
        }

        /* Vote Section */
        .vote-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .vote-button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vote-button:hover {
            background: var(--surface-secondary);
        }

        .vote-button.voted-up {
            color: var(--primary-color);
        }

        .vote-button.voted-down {
            color: var(--secondary-color);
        }

        .vote-count {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Post Main Content */
        .post-main {
            flex: 1;
        }

        .post-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
        }

        .post-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            line-height: 1.4;
        }

        .post-text {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }

        .post-image, .post-video {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            cursor: pointer;
        }

        .media-grid {
            display: grid;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .media-grid.single {
            grid-template-columns: 1fr;
        }

        .media-grid.double {
            grid-template-columns: 1fr 1fr;
        }

        .media-grid.multiple {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Post Actions */
        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-action-buttons {
            display: flex;
            gap: var(--spacing-md);
        }

        .post-action-button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-sm);
            cursor: pointer;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .post-action-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Comments Section */
        .comments-section {
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-lg);
            display: none;
        }

        .comments-section.active {
            display: block;
        }

        .comment-input {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            align-items: center;
        }

        .comment-input input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
        }

        .emoji-picker-btn {
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-sm);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .emoji-picker-btn:hover {
            background: var(--border-color);
            color: var(--primary-color);
        }

        .emoji-picker {
            position: absolute;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: var(--spacing-xs);
            z-index: 100;
            max-width: 300px;
        }

        .emoji-picker.active {
            display: grid;
        }

        .emoji-item {
            padding: var(--spacing-xs);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            text-align: center;
        }

        .emoji-item:hover {
            background: var(--surface-secondary);
        }

        .comment {
            background: var(--surface-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            position: relative;
        }

        .comment.reply {
            margin-left: var(--spacing-xl);
            border-left: 2px solid var(--primary-color);
        }

        .comment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-xs);
        }

        .comment-author {
            font-weight: bold;
            color: var(--primary-color);
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .comment-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .comment-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xs);
        }

        .comment-actions {
            display: flex;
            gap: var(--spacing-md);
            font-size: 11px;
        }

        .comment-action {
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .comment-action:hover {
            color: var(--primary-color);
        }

        /* Precise Timestamp */
        .precise-timestamp {
            font-size: 10px;
            color: var(--text-muted);
            font-family: monospace;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: var(--font-size-xl);
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--surface-secondary);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* Image/Video Upload Area */
        .media-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            text-align: center;
            margin: var(--spacing-md) 0;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .media-upload-area:hover,
        .media-upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(106, 17, 203, 0.1);
        }

        .media-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-md);
            margin: var(--spacing-md) 0;
        }

        .media-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }

        .media-preview-item {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .media-preview-item img,
        .media-preview-item video {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .media-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Chat Styles */
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            font-size: var(--font-size-xl);
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-fast);
            z-index: 100;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
        }

        .chat-container {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            opacity: 0;
            transition: var(--transition-normal);
            z-index: 99;
            border: 1px solid var(--border-color);
        }

        .chat-container.active {
            transform: translateY(0);
            opacity: 1;
        }

        .chat-header {
            padding: var(--spacing-md);
            background: var(--primary-color);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            color: white;
            font-size: var(--font-size-base);
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
        }

        .message {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
        }

        .message.user {
            background: var(--primary-color);
            margin-left: var(--spacing-lg);
        }

        .message.agent {
            background: var(--surface-secondary);
            margin-right: var(--spacing-lg);
        }

        .message-user {
            font-weight: bold;
            color: var(--primary-color);
            font-size: var(--font-size-xs);
            margin-bottom: var(--spacing-xs);
        }

        .message.user .message-user {
            color: white;
        }

        .message-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xs);
        }

        .message.user .message-text {
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .message.user .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-input-container {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-sm);
        }

        .chat-input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
        }

        .chat-send {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .chat-send:hover {
            background: #5a0fb8;
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 64px;
            z-index: 50;
        }

        @media (min-width: 1024px) {
            .mobile-nav {
                display: none;
            }
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition-fast);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
        }

        .mobile-nav-item.active,
        .mobile-nav-item:hover {
            color: var(--primary-color);
        }

        .mobile-nav-item i {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xs);
        }

        .mobile-nav-item span {
            font-size: 10px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition-normal);
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        /* Poll Styles */
        .poll-container {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
        }

        .poll-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            background: var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .poll-option:hover {
            background: #505050;
        }

        .poll-option.voted {
            cursor: default;
        }

        .poll-option-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            opacity: 0.3;
            transition: width 0.5s ease;
        }

        .poll-option-text,
        .poll-option-percentage {
            position: relative;
            z-index: 1;
        }

        .poll-option-percentage {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .poll-stats {
            margin-top: var(--spacing-sm);
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        /* Community Colors */
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-green-500 { background-color: var(--success-color); }
        .bg-purple-500 { background-color: var(--primary-color); }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-yellow-500 { background-color: var(--warning-color); }
        .bg-pink-500 { background-color: #ec4899; }
        .bg-indigo-500 { background-color: #6366f1; }

        /* Live Features */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--error-color);
            font-size: var(--font-size-xs);
            font-weight: bold;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--error-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Premium Features */
        .premium-section {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-xl);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .premium-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        .premium-content {
            position: relative;
            z-index: 1;
        }

        /* Camera Modal */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .camera-container {
            position: relative;
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            max-width: 500px;
            width: 90%;
        }

        .camera-video {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: var(--radius-md);
            background: #000;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .camera-btn {
            padding: var(--spacing-md);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: var(--font-size-lg);
        }

        .capture-btn {
            background: var(--error-color);
            color: white;
            width: 60px;
            height: 60px;
        }

        .capture-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .cancel-camera-btn {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            width: 50px;
            height: 50px;
        }

        .cancel-camera-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* Story Features */
        .stories-container {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            overflow-x: auto;
        }

        .stories-list {
            display: flex;
            gap: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
        }

        .story-item {
            flex-shrink: 0;
            width: 80px;
            text-align: center;
            cursor: pointer;
        }

        .story-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 0 auto var(--spacing-xs);
            position: relative;
            border: 3px solid transparent;
            background-clip: padding-box;
        }

        .story-avatar.has-story {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            animation: gradient 3s ease infinite;
        }

        .story-avatar.add-story {
            background: var(--surface-secondary);
            border: 2px dashed var(--border-color);
        }

        .story-avatar.add-story:hover {
            border-color: var(--primary-color);
        }

        .story-name {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Trending Section */
        .trending-section {
            background: var(--surface-secondary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-xl);
        }

        .trending-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .trending-item:hover {
            background: var(--surface-color);
        }

        .trending-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            font-weight: bold;
            margin-right: var(--spacing-sm);
        }

        .trending-content {
            flex: 1;
        }

        .trending-title {
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin-bottom: 2px;
        }

        .trending-stats {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-sm);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-fast);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--border-color);
            color: var(--primary-color);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: var(--spacing-md);
        }

        .mt-4 {
            margin-top: var(--spacing-md);
        }

        /* Feature Badges */
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: bold;
        }

        .trending-indicator {
            color: var(--warning-color);
            animation: glow 2s ease-in-out infinite alternate;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: var(--spacing-md) var(--spacing-sm);
                padding-bottom: 80px;
            }
            
            .post-content {
                padding: var(--spacing-md);
            }
            
            .chat-container {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }

            .modal-content {
                width: 95%;
                margin: var(--spacing-md);
            }

            .stories-container {
                padding: var(--spacing-md);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --text-primary: #ffffff;
                --text-secondary: #ffffff;
                --background-color: #000000;
                --surface-color: #000000;
                --border-color: #ffffff;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Video Player Controls */
        .video-container {
            position: relative;
            display: inline-block;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-container:hover .video-controls {
            opacity: 1;
        }

        .play-pause-btn {
            background: none;
            border: none;
            color: white;
            font-size: var(--font-size-lg);
            cursor: pointer;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.1s ease;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .volume-slider {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        /* Real-time Updates */
        .update-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .update-indicator.show {
            transform: translateX(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Skip Link for Screen Readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Preloader -->
    <div id="preloader" class="preloader" role="status" aria-label="Loading SmileX">
        <div class="preloader-logo" aria-hidden="true">
            <i class="fas fa-smile-beam"></i>
        </div>
        <div class="preloader-text">SmileX</div>
        <div class="loading-spinner"></div>
        <span class="sr-only">Loading application...</span>
    </div>

    <!-- Onboarding Modal -->
    <div class="overlay" id="onboardingOverlay" role="dialog" aria-labelledby="onboarding-title" aria-modal="true">
        <div class="onboarding-container">
            <header class="onboarding-header">
                <h2 id="onboarding-title">
                    <i class="fas fa-user-circle" aria-hidden="true"></i> 
                    Welcome to SmileX
                </h2>
                <p>Complete your profile to join our community</p>
            </header>

            <form id="registrationForm" novalidate>
                <!-- Profile Picture Upload Section -->
                <div class="profile-upload-section">
                    <div class="profile-preview" id="profilePreview" onclick="showProfileUploadOptions()">
                        <span id="profileInitial">?</span>
                        <div class="profile-upload-overlay">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="profile-upload-buttons">
                        <button type="button" class="btn btn-secondary" onclick="openCamera()">
                            <i class="fas fa-camera"></i> Camera
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="openFileUpload()">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </div>
                    <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(event)">
                </div>

                <div class="form-group">
                    <label for="fullName" class="form-label">
                        <i class="fas fa-user" aria-hidden="true"></i> Full Name
                    </label>
                    <input type="text" 
                           id="fullName" 
                           name="fullName" 
                           class="form-control" 
                           placeholder="Enter your full name" 
                           required 
                           oninput="checkNameAvailability(this.value)"
                           aria-describedby="fullName-error">
                    <div id="nameValidation" class="name-validation" style="display: none;"></div>
                    <div id="fullName-error" class="sr-only" role="alert"></div>
                </div>

                <div class="form-group">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope" aria-hidden="true"></i> Email Address
                    </label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           class="form-control" 
                           placeholder="your.email@example.com" 
                           required 
                           aria-describedby="email-error">
                    <div id="email-error" class="sr-only" role="alert"></div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="gender" class="form-label">
                            <i class="fas fa-venus-mars" aria-hidden="true"></i> Gender
</label>
                        <select id="gender" name="gender" class="form-select" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="country" class="form-label">
                            <i class="fas fa-globe" aria-hidden="true"></i> Country
                        </label>
                        <select id="country" name="country" class="form-select" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="IN">India</option>
                            <option value="BR">Brazil</option>
                            <option value="NG">Nigeria</option>
                            <option value="ZA">South Africa</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <fieldset class="consent-section">
                    <legend>
                        <h4><i class="fas fa-shield-alt" aria-hidden="true"></i> Platform Consent</h4>
                    </legend>
                    <div class="consent-item">
                        <input type="checkbox" id="ageConsent" name="ageConsent" required>
                        <label for="ageConsent">I am 13 years or older</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" id="termsConsent" name="termsConsent" required>
                        <label for="termsConsent">I agree to the Terms of Service</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" id="privacyConsent" name="privacyConsent" required>
                        <label for="privacyConsent">I consent to privacy policy</label>
                    </div>
                </fieldset>

                <button type="submit" id="submitBtn" class="btn btn-primary" disabled style="width: 100%;">
                    <i class="fas fa-paper-plane" aria-hidden="true"></i> Join SmileX
                </button>
            </form>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="camera-modal hidden">
        <div class="camera-container">
            <video id="cameraVideo" class="camera-video" autoplay muted></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div class="camera-controls">
                <button class="camera-btn cancel-camera-btn" onclick="closeCamera()">
                    <i class="fas fa-times"></i>
                </button>
                <button class="camera-btn capture-btn" onclick="capturePhoto()">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav role="navigation" aria-label="Main navigation">
        <div class="nav-container">
            <a href="#" class="logo" aria-label="SmileX Home">
                <i class="fas fa-smile-beam" aria-hidden="true"></i>
                <span>SmileX</span>
            </a>

            <div class="nav-search" role="search">
                <label for="searchInput" class="sr-only">Search Everything</label>
                <input type="text" 
                       id="searchInput" 
                       placeholder="Search posts, communities, users..." 
                       aria-describedby="search-results"
                       oninput="performGlobalSearch(this.value)">
                <i class="fas fa-search" aria-hidden="true"></i>
                <div id="searchResults" class="search-results hidden" role="listbox" aria-label="Search results"></div>
            </div>

            <div class="nav-actions">
                <button class="theme-toggle" 
                        id="themeToggle" 
                        aria-label="Toggle dark mode"
                        title="Toggle Theme">
                    <i class="fas fa-moon" aria-hidden="true"></i>
                </button>
                <button class="nav-button" 
                        id="notificationBtn" 
                        aria-label="View notifications"
                        title="Notifications">
                    <i class="fas fa-bell" aria-hidden="true"></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <div class="user-avatar" 
                     id="userAvatar" 
                     role="img" 
                     aria-label="User avatar"
                     onclick="toggleUserMenu()">
                    <span id="userInitial">U</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="Community navigation">
            <section>
                <h3><i class="fas fa-users" aria-hidden="true"></i> My Communities</h3>
                
                <div class="my-communities-tabs" role="tablist">
                    <button class="sort-button active" 
                            role="tab" 
                            aria-selected="true" 
                            aria-controls="createdCommunitiesList" 
                            data-tab="created">
                        Created
                    </button>
                    <button class="sort-button" 
                            role="tab" 
                            aria-selected="false" 
                            aria-controls="joinedCommunitiesList" 
                            data-tab="joined">
                        Joined
                    </button>
                </div>
                
                <div id="createdCommunitiesList" 
                     class="communities-tab-content" 
                     role="tabpanel" 
                     aria-labelledby="created-tab">
                    <ul id="createdCommunitiesUL" role="list"></ul>
                </div>
                
                <div id="joinedCommunitiesList" 
                     class="communities-tab-content hidden" 
                     role="tabpanel" 
                     aria-labelledby="joined-tab">
                    <ul id="joinedCommunitiesUL" role="list"></ul>
                </div>
                
                <button id="createCommunityBtn" 
                        class="btn btn-primary" 
                        style="width: 100%; margin-top: var(--spacing-md);">
                    <i class="fas fa-plus" aria-hidden="true"></i> Create Community
                </button>
            </section>

            <section style="margin-top: var(--spacing-xl);">
                <h3><i class="fas fa-compass" aria-hidden="true"></i> Explore</h3>
                <button id="browseCommunityBtn" class="btn btn-secondary" style="width: 100%;">
                    <i class="fas fa-globe" aria-hidden="true"></i> Browse Communities
                </button>
            </section>
        </aside>

        <!-- Main Feed -->
        <main class="main-feed" role="main" aria-label="Posts feed">
            <!-- Stories Section -->
            <section class="stories-container" aria-label="Stories">
                <h3 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-lg);">
                    <i class="fas fa-play-circle" aria-hidden="true"></i> Stories
                </h3>
                <div class="stories-list" role="list">
                    <div class="story-item" role="listitem">
                        <div class="story-avatar add-story" onclick="createStory()">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="story-name">Add Story</div>
                    </div>
                    <div class="story-item" role="listitem">
                        <div class="story-avatar has-story" onclick="viewStory('user1')">
                            <span>J</span>
                        </div>
                        <div class="story-name">John Doe</div>
                    </div>
                    <div class="story-item" role="listitem">
                        <div class="story-avatar has-story" onclick="viewStory('user2')">
                            <span>S</span>
                        </div>
                        <div class="story-name">Sarah</div>
                    </div>
                    <div class="story-item" role="listitem">
                        <div class="story-avatar has-story" onclick="viewStory('user3')">
                            <span>M</span>
                        </div>
                        <div class="story-name">Mike</div>
                    </div>
                </div>
            </section>

            <!-- Create Post Card -->
            <section class="create-post-card" aria-label="Create new post">
                <div class="create-post-input">
                    <div class="user-avatar" role="img" aria-label="Your avatar">
                        <span id="createPostUserInitial">U</span>
                    </div>
                    <button id="createPostInput" 
                            class="form-control" 
                            style="text-align: left; cursor: pointer; border: none;"
                            aria-label="Create a new post">
                        What's on your mind?
                    </button>
                </div>
                <div class="post-type-buttons" role="group" aria-label="Post type options">
                    <button class="post-type-button" 
                            data-post-type="image" 
                            aria-label="Create image post">
                        <i class="far fa-image" aria-hidden="true"></i> Image
                    </button>
                    <button class="post-type-button" 
                            data-post-type="video" 
                            aria-label="Create video post">
                        <i class="fas fa-video" aria-hidden="true"></i> Video
                    </button>
                    <button class="post-type-button" 
                            data-post-type="text" 
                            aria-label="Create text post">
                        <i class="far fa-file-alt" aria-hidden="true"></i> Text
                    </button>
                    <button class="post-type-button" 
                            data-post-type="poll" 
                            aria-label="Create poll">
                        <i class="fas fa-poll" aria-hidden="true"></i> Poll
                    </button>
                    <button class="post-type-button" 
                            data-post-type="story" 
                            aria-label="Create story">
                        <i class="fas fa-play-circle" aria-hidden="true"></i> Story
                    </button>
                </div>
            </section>

            <!-- Post Sorting -->
            <section class="sort-buttons" role="group" aria-label="Sort posts">
                <button class="sort-button active" 
                        data-sort="hot" 
                        aria-pressed="true">
                    <i class="fas fa-bolt" aria-hidden="true"></i> Hot
                </button>
                <button class="sort-button" 
                        data-sort="new" 
                        aria-pressed="false">
                    <i class="fas fa-certificate" aria-hidden="true"></i> New
                </button>
                <button class="sort-button" 
                        data-sort="top" 
                        aria-pressed="false">
                    <i class="fas fa-arrow-trend-up" aria-hidden="true"></i> Top
                </button>
                <button class="sort-button" 
                        data-sort="trending" 
                        aria-pressed="false">
                    <i class="fas fa-fire trending-indicator" aria-hidden="true"></i> Trending
                </button>
                <button class="sort-button" 
                        data-sort="live" 
                        aria-pressed="false">
                    <i class="fas fa-broadcast-tower" aria-hidden="true"></i> Live
                </button>
            </section>

            <!-- Feed Filter -->
            <section class="create-post-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        <label for="feedFilter">Viewing:</label>
                        <select id="feedFilter" class="form-select" style="width: auto; margin: 0;">
                            <option value="all">All Posts</option>
                            <option value="general">General Feed</option>
                            <option value="mycommunities">My Communities</option>
                            <option value="following">Following</option>
                        </select>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        LIVE
                    </div>
                </div>
            </section>

            <!-- Posts Feed -->
            <section id="posts-feed" role="feed" aria-label="Social media posts"></section>

            <!-- Load More Button -->
            <div class="text-center">
                <button id="loadMoreBtn" class="btn btn-secondary">Load more posts</button>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="Discover and premium">
            <section>
                <h3><i class="fas fa-compass" aria-hidden="true"></i> Discover</h3>
                <div id="recommendedCommunities" role="list" aria-label="Recommended communities"></div>
            </section>

            <!-- Trending Section -->
            <section class="trending-section">
                <h4 style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <i class="fas fa-fire trending-indicator" aria-hidden="true"></i>
                    Trending Now
                </h4>
                <div id="trendingTopics" role="list" aria-label="Trending topics">
                    <div class="trending-item" role="listitem">
                        <div class="trending-number">1</div>
                        <div class="trending-content">
                            <div class="trending-title">#TechNews</div>
                            <div class="trending-stats">15.2k posts • Trending in Technology</div>
                        </div>
                    </div>
                    <div class="trending-item" role="listitem">
                        <div class="trending-number">2</div>
                        <div class="trending-content">
                            <div class="trending-title">#SmileXUpdate</div>
                            <div class="trending-stats">8.7k posts • Trending in Social</div>
                        </div>
                    </div>
                    <div class="trending-item" role="listitem">
                        <div class="trending-number">3</div>
                        <div class="trending-content">
                            <div class="trending-title">#Gaming</div>
                            <div class="trending-stats">12.1k posts • Trending in Entertainment</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Live Stats -->
            <section style="background: var(--surface-secondary); border-radius: var(--radius-xl); padding: var(--spacing-lg); margin-top: var(--spacing-xl);">
                <h4 style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    Live Stats
                </h4>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); font-size: var(--font-size-sm);">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Online Users:</span>
                        <span id="onlineUsers" style="color: var(--success-color); font-weight: bold;">127,543</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Active Polls:</span>
                        <span id="activePolls" style="color: var(--primary-color); font-weight: bold;">1,247</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Posts Today:</span>
                        <span id="postsToday" style="color: var(--warning-color); font-weight: bold;">45,678</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Communities:</span>
                        <span id="totalCommunities" style="color: var(--accent-color); font-weight: bold;">8,934</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Live Stories:</span>
                        <span id="liveStories" style="color: var(--error-color); font-weight: bold;">2,156</span>
                    </div>
                </div>
            </section>

            <!-- Premium Section -->
            <section class="premium-section">
                <div class="premium-content">
                    <div style="display: flex; align-items: center; margin-bottom: var(--spacing-sm);">
                        <i class="fas fa-crown" style="margin-right: var(--spacing-sm); color: var(--premium-gold);" aria-hidden="true"></i>
                        <h4>SmileX Premium</h4>
                        <span class="premium-badge" style="margin-left: var(--spacing-sm);">
                            <i class="fas fa-star"></i> VIP
                        </span>
                    </div>
                    <p style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">
                        Unlock exclusive features: <span class="disco-text">Disco Text</span>, 
                        <span class="premium-emoji">🎉</span> Premium Emojis, 
                        Ad-free experience, Stories+, and more!
                    </p>
                    <button id="premiumBtn" class="btn btn-premium" style="width: 100%;">
                        <i class="fas fa-crown"></i> UPGRADE TO PREMIUM
                    </button>
                </div>
            </section>
        </aside>
    </main>

    <!-- Create Post Modal -->
    <div id="create-post-modal" class="modal" role="dialog" aria-labelledby="create-post-title" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 id="create-post-title">Create a post</h3>
                <button id="closeCreatePostModal" 
                        class="modal-close" 
                        aria-label="Close create post modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div class="modal-body">
                <form id="createPostForm" novalidate>
                    <div class="form-group">
                        <label for="postType" class="form-label">Post type</label>
                        <select id="postType" name="postType" class="form-select" required>
                            <option value="text">Text Post</option>
                            <option value="image">Image Post</option>
                            <option value="video">Video Post</option>
                            <option value="poll">Poll</option>
                            <option value="story">Story</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="postVisibility" class="form-label">Post visibility</label>
                        <select id="postVisibility" name="visibility" class="form-select" required>
                            <option value="general">General (visible to everyone)</option>
                            <option value="community">Community (visible to members)</option>
                            <option value="followers">Followers only</option>
                        </select>
                    </div>

                    <div class="form-group hidden" id="postCommunityContainer">
                        <label for="postCommunity" class="form-label">Choose a community</label>
                        <select id="postCommunity" name="community" class="form-select">
                            <option value="">Select a community</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="postTitle" class="form-label">Title</label>
                        <input type="text" 
                               id="postTitle" 
                               name="title" 
                               placeholder="Title" 
                               class="form-control" 
                               required>
                    </div>

                    <div class="form-group" id="contentContainer">
                        <label for="postContent" class="form-label">Content</label>
                        <textarea id="postContent" 
                                  name="content" 
                                  placeholder="What are your thoughts?" 
                                  rows="6" 
                                  class="form-control"></textarea>
                    </div>

                    <!-- Poll Options Container -->
                    <div class="form-group hidden" id="pollOptionsContainer">
                        <label class="form-label">Poll Options</label>
                        <div id="pollOptions">
                            <input type="text" 
                                   class="form-control poll-option-input" 
                                   placeholder="Option 1" 
                                   style="margin-bottom: var(--spacing-sm);">
                            <input type="text" 
                                   class="form-control poll-option-input" 
                                   placeholder="Option 2" 
                                   style="margin-bottom: var(--spacing-sm);">
                        </div>
                        <button type="button" 
                                id="addPollOption" 
                                class="btn btn-secondary" 
                                style="margin-top: var(--spacing-sm);">
                            <i class="fas fa-plus" aria-hidden="true"></i> Add Option
                        </button>
                    </div>

                    <div class="form-group" id="mediaUploadContainer">
                        <label class="form-label">Media Upload</label>
                        <div class="media-upload-area" 
                             id="mediaUploadArea" 
                             role="button" 
                             tabindex="0" 
                             aria-label="Click or drag media files here to upload">
                            <i class="fas fa-cloud-upload-alt" 
                               style="font-size: var(--font-size-2xl); color: var(--text-muted); margin-bottom: var(--spacing-sm);" 
                               aria-hidden="true"></i>
                            <p>Click or drag images/videos here to upload</p>
                            <p style="font-size: var(--font-size-xs); color: var(--text-muted);">
                                Supports: JPG, PNG, GIF, MP4, WebM (Max 50MB)
                            </p>
                            <input type="file" 
                                   id="mediaInput" 
                                   accept="image/*,video/*" 
                                   multiple 
                                   style="display: none;" 
                                   aria-label="Select media files to upload">
                        </div>
                        <div id="mediaPreviewContainer" class="media-preview-container" role="list" aria-label="Selected media files"></div>
                    </div>
                </form>
            </div>

            <footer class="modal-footer">
                <button type="button" id="cancelCreatePost" class="btn btn-secondary">Cancel</button>
                <button type="submit" form="createPostForm" class="btn btn-primary">Post</button>
            </footer>
        </div>
    </div>

    <!-- Create Community Modal -->
    <div id="create-community-modal" class="modal" role="dialog" aria-labelledby="create-community-title" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 id="create-community-title">Create a Community</h3>
                <button id="closeCreateCommunityModal" 
                        class="modal-close" 
                        aria-label="Close create community modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div class="modal-body">
                <form id="createCommunityForm" novalidate>
                    <div class="form-group">
                        <label for="communityName" class="form-label">Community Name</label>
                        <input type="text" 
                               id="communityName" 
                               name="name" 
                               placeholder="Enter community name" 
                               class="form-control" 
                               required 
                               oninput="validateCommunityName(this.value)"
                               aria-describedby="community-name-help">
                        <div id="communityNameValidation" class="name-validation" style="display: none;"></div>
                        <p id="community-name-help" style="font-size: var(--font-size-xs); color: var(--text-muted); margin-top: var(--spacing-xs);">
                            Community names can't contain spaces or words related to "smile/smilex". Use 3-21 characters.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="communityDisplayName" class="form-label">Display Name</label>
                        <input type="text" 
                               id="communityDisplayName" 
                               name="displayName" 
                               placeholder="Enter display name" 
                               class="form-control" 
                               required>
                    </div>

                    <div class="form-group">
                        <label for="communityDescription" class="form-label">Description</label>
                        <textarea id="communityDescription" 
                                  name="description" 
                                  placeholder="What's your community about?" 
                                  rows="4" 
                                  class="form-control"></textarea>
                    </div>

                    <fieldset class="form-group">
                        <legend class="form-label">Community Type</legend>
                        <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-sm);">
                            <div style="display: flex; align-items: center;">
                                <input type="radio" 
                                       id="typePublic" 
                                       name="type" 
                                       value="public" 
                                       checked 
                                       style="margin-right: var(--spacing-sm);">
                                <label for="typePublic">Public</label>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <input type="radio" 
                                       id="typePrivate" 
                                       name="type" 
                                       value="private" 
                                       style="margin-right: var(--spacing-sm);">
                                <label for="typePrivate">Private</label>
                            </div>
                        </div>
                        <p style="font-size: var(--font-size-xs); color: var(--text-muted); margin-top: var(--spacing-xs);">
                            Private communities require members to be approved by moderators.
                        </p>
                    </fieldset>

                    <div class="form-group">
                        <label for="communityTopics" class="form-label">Community Topics (optional)</label>
                        <input type="text" 
                               id="communityTopics" 
                               name="topics" 
                               placeholder="Enter topics separated by commas" 
                               class="form-control">
                    </div>
                </form>
            </div>

            <footer class="modal-footer">
                <button type="button" id="cancelCreateCommunity" class="btn btn-secondary">Cancel</button>
                <button type="submit" form="createCommunityForm" class="btn btn-primary">Create Community</button>
            </footer>
        </div>
    </div>

    <!-- Browse Communities Modal -->
    <div id="browse-communities-modal" class="modal" role="dialog" aria-labelledby="browse-communities-title" aria-modal="true">
        <div class="modal-content" style="max-width: 800px;">
            <header class="modal-header">
                <h3 id="browse-communities-title">Browse Communities</h3>
                <button id="closeBrowseCommunitiesModal" 
                        class="modal-close" 
                        aria-label="Close browse communities modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div style="padding: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div style="position: relative; flex: 1;">
                        <label for="communitySearchInput" class="sr-only">Search for communities</label>
                        <input type="text" 
                               id="communitySearchInput" 
                               placeholder="Search for communities..." 
                               class="form-control" 
                               style="padding-left: 40px;"
                               oninput="searchCommunities(this.value)">
                        <i class="fas fa-search" 
                           style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" 
                           aria-hidden="true"></i>
                    </div>
                    <div style="display: flex; gap: var(--spacing-sm);" role="tablist">
                        <button class="sort-button active" 
                                data-tab="all" 
                                role="tab" 
                                aria-selected="true"
                                onclick="filterCommunities('all')">All</button>
                        <button class="sort-button" 
                                data-tab="public" 
                                role="tab" 
                                aria-selected="false"
                                onclick="filterCommunities('public')">Public</button>
                        <button class="sort-button" 
                                data-tab="private" 
                                role="tab" 
                                aria-selected="false"
                                onclick="filterCommunities('private')">Private</button>
                    </div>
                </div>
            </div>

            <div class="modal-body">
                <div id="communitiesBrowseList" 
                     style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-md);" 
                     role="list" 
                     aria-label="Available communities"></div>
                <div id="noCommunitiesMessage" class="text-center hidden">
                    <i class="fas fa-users" 
                       style="font-size: var(--font-size-3xl); color: var(--text-muted); margin-bottom: var(--spacing-md);" 
                       aria-hidden="true"></i>
                    <p style="color: var(--text-muted);">No communities found</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Community Detail Modal -->
    <div id="community-detail-modal" class="modal" role="dialog" aria-labelledby="community-detail-title" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div id="communityDetailHeader" class="modal-header" style="position: relative;"></div>

            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-xl);">
                    <div>
                        <h3 style="margin-bottom: var(--spacing-md);">About this Community</h3>
                        <div id="communityDetailDescription" 
                             style="color: var(--text-secondary); margin-bottom: var(--spacing-xl);"></div>
                        
                        <h3 style="margin-bottom: var(--spacing-md);">Recent Posts</h3>
                        <div id="communityPosts" role="list" aria-label="Recent community posts"></div>
                    </div>
                    <div>
                        <div style="background: var(--surface-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <h4 style="margin-bottom: var(--spacing-md);">Community Info</h4>
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); font-size: var(--font-size-sm);">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Created by</span>
                                    <span id="communityCreator"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Created</span>
                                    <span id="communityCreationDate"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Members</span>
                                    <span id="communityMemberCount"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Type</span>
                                    <span id="communityType"></span>
                                </div>
                            </div>
                        </div>

                        <div style="background: var(--surface-secondary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                            <h4 style="margin-bottom: var(--spacing-md);">Topics</h4>
                            <div id="communityTopics" role="list" aria-label="Community topics"></div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="modal-footer">
                <button id="closeCommunityDetailModal" class="btn btn-secondary">Close</button>
                <button id="joinLeaveButton" class="btn btn-primary">Join</button>
                <button id="deleteCommunityButton" class="btn hidden" style="background: var(--error-color);">Delete Community</button>
            </footer>
        </div>
    </div>

    <!-- Post Detail Modal -->
    <div id="post-detail-modal" class="modal" role="dialog" aria-labelledby="post-detail-title" aria-modal="true">
        <div class="modal-content" style="max-width: 800px;">
            <div id="postDetailContent"></div>
        </div>
    </div>

    <!-- Media Viewer Modal -->
    <div id="media-viewer-modal" class="modal" role="dialog" aria-labelledby="media-viewer-title" aria-modal="true">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 0; background: transparent; box-shadow: none;">
            <div style="position: relative; display: flex; align-items: center; justify-content: center; height: 90vh;">
                <button id="closeMediaViewer" 
                        style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 18px; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>
                <div id="mediaViewerContent" style="max-width: 100%; max-height: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Story Viewer Modal -->
    <div id="story-viewer-modal" class="modal" role="dialog" aria-labelledby="story-viewer-title" aria-modal="true">
        <div class="modal-content" style="max-width: 400px; height: 80vh; padding: 0; background: transparent; box-shadow: none;">
            <div style="position: relative; height: 100%; background: var(--surface-color); border-radius: var(--radius-xl); overflow: hidden;">
                <div id="storyProgress" style="position: absolute; top: 10px; left: 10px; right: 10px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; z-index: 10;">
                    <div style="height: 100%; background: white; width: 0%; transition: width 0.1s ease; border-radius: 2px;"></div>
                </div>
                <button id="closeStoryViewer" 
                        style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 14px; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>
                <div id="storyContent" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></div>
                <div style="position: absolute; bottom: 20px; left: 20px; right: 20px; z-index: 10;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div class="user-avatar" style="width: 32px; height: 32px;">
                            <span id="storyAuthorInitial">U</span>
                        </div>
                        <div>
                            <div id="storyAuthor" style="font-weight: bold; font-size: 14px;"></div>
                            <div id="storyTime" style="font-size: 12px; color: rgba(255,255,255,0.7);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emoji Picker -->
    <div id="emojiPicker" class="emoji-picker">
        <div class="emoji-item" onclick="insertEmoji('😀')">😀</div>
        <div class="emoji-item" onclick="insertEmoji('😂')">😂</div>
        <div class="emoji-item" onclick="insertEmoji('😍')">😍</div>
        <div class="emoji-item" onclick="insertEmoji('🤔')">🤔</div>
        <div class="emoji-item" onclick="insertEmoji('😎')">😎</div>
        <div class="emoji-item" onclick="insertEmoji('🔥')">🔥</div>
        <div class="emoji-item" onclick="insertEmoji('💯')">💯</div>
        <div class="emoji-item" onclick="insertEmoji('👍')">👍</div>
        <div class="emoji-item" onclick="insertEmoji('👎')">👎</div>
        <div class="emoji-item" onclick="insertEmoji('❤️')">❤️</div>
        <div class="emoji-item" onclick="insertEmoji('💔')">💔</div>
        <div class="emoji-item" onclick="insertEmoji('🎉')">🎉</div>
        <div class="emoji-item" onclick="insertEmoji('🚀')">🚀</div>
        <div class="emoji-item" onclick="insertEmoji('⭐')">⭐</div>
        <div class="emoji-item" onclick="insertEmoji('💎')">💎</div>
        <div class="emoji-item" onclick="insertEmoji('🌟')">🌟</div>
    </div>

    <!-- Live Chat Toggle Button -->
    <button id="chat-toggle-btn" 
            class="chat-toggle" 
            aria-label="Toggle live chat" 
            title="Live Chat Support">
        <i class="fas fa-comment-dots" aria-hidden="true"></i>
    </button>

    <!-- Live Chat Container -->
    <div id="chat-container" class="chat-container" role="dialog" aria-labelledby="chat-title">
        <header class="chat-header">
            <h3 id="chat-title">Live Chat Support</h3>
            <button id="chat-close-btn" 
                    class="chat-close" 
                    aria-label="Close chat">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </header>
        <div class="chat-messages" 
             id="chat-messages" 
             role="log" 
             aria-live="polite" 
             aria-label="Chat messages">
            <div class="message agent">
                <div class="message-user">Support Agent</div>
                <div class="message-text">Hello! How can we help you today?</div>
                <div class="message-time">Just now</div>
            </div>
        </div>
        <div class="chat-input-container">
            <label for="chat-input" class="sr-only">Type your message</label>
            <input type="text" 
                   id="chat-input" 
                   class="chat-input" 
                   placeholder="Type your message..." 
                   aria-describedby="chat-send-btn">
            <button id="chat-send-btn" 
                    class="chat-send" 
                    aria-label="Send message">
                <i class="fas fa-paper-plane" aria-hidden="true"></i>
            </button>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" role="navigation" aria-label="Mobile navigation">
        <a href="#" class="mobile-nav-item active" aria-current="page">
            <i class="fas fa-home" aria-hidden="true"></i>
            <span>Home</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileBrowseBtn">
            <i class="fas fa-compass" aria-hidden="true"></i>
            <span>Explore</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileCreatePost">
            <i class="fas fa-plus-circle" aria-hidden="true"></i>
            <span>Create</span>
        </a>
        <a href="#" class="mobile-nav-item">
            <i class="fas fa-bell" aria-hidden="true"></i>
            <span>Notifications</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileCreateCommunity">
            <i class="fas fa-users" aria-hidden="true"></i>
            <span>Community</span>
        </a>
    </nav>

    <!-- Update Indicator -->
    <div id="update-indicator" class="update-indicator">
        <i class="fas fa-sync-alt" aria-hidden="true"></i>
        New content available
    </div>

    <!-- Notification Container -->
    <div id="notification-container" 
         role="status" 
         aria-live="polite" 
         aria-atomic="true" 
         style="position: fixed; top: 20px; right: 20px; z-index: 1001;"></div>

    <script>
        // Advanced Social Media Platform - Complete Implementation
        
        // Global Configuration
        const CONFIG = {
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            SUPPORTED_IMAGE_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
            SUPPORTED_VIDEO_TYPES: ['video/mp4', 'video/webm', 'video/ogg'],
            AUTO_SAVE_INTERVAL: 30000, // 30 seconds
            LIVE_UPDATE_INTERVAL: 5000, // 5 seconds
            MAX_POLL_OPTIONS: 6,
            MAX_POST_LENGTH: 10000,
            MAX_COMMENT_LENGTH: 1000,
            STORY_DURATION: 15000, // 15 seconds
            PREMIUM_EMOJIS: ['✨', '💎', '👑', '🌟', '🔥', '💫', '🎭', '🎪', '🎨', '🎯'],
            RESTRICTED_NAMES: ['smile', 'smilex', 'smiles', 'smiling', 'admin', 'moderator', 'system']
        };

        // Global State Management
        class StateManager {
            constructor() {
                this.state = {
                    currentUser: null,
                    posts: [],
                    stories: [],
                    communities: [],
                    userMemberships: [],
                    userCreatedCommunities: [],
                    userFollowing: [],
                    userFollowers: [],
                    livePolls: [],
                    uploadedMedia: [],
                    currentSort: 'hot',
                    currentFeedFilter: 'all',
                    currentCommunityTab: 'all',
                    currentCommunity: null,
                    onlineUsers: 127543,
                    activePolls: 1247,
                    postsToday: 45678,
                    totalCommunities: 8934,
                    liveStories: 2156,
                    isLiveMode: true,
                    registeredUsers: [],
                    activityLog: [],
                    searchIndex: {},
                    premiumUsers: [],
                    currentEmojiTarget: null,
                    notifications: [],
                    trendingTopics: [],
                    darkMode: false
                };
                
                this.subscribers = [];
                this.loadFromStorage();
                this.buildSearchIndex();
                this.initializeSampleData();
            }

            subscribe(callback) {
                this.subscribers.push(callback);
            }

            setState(updates) {
                this.state = { ...this.state, ...updates };
                this.saveToStorage();
                this.notifySubscribers();
                this.logActivity(updates);
            }

            getState() {
                return { ...this.state };
            }

            notifySubscribers() {
                this.subscribers.forEach(callback => callback(this.state));
            }

            logActivity(updates) {
                const activity = {
                    timestamp: new Date(),
                    type: 'state_update',
                    data: updates,
                    userId: this.state.currentUser ? this.state.currentUser.userId : 'anonymous'
                };
                
                this.state.activityLog.push(activity);
                
                // Keep only last 1000 activities
                if (this.state.activityLog.length > 1000) {
                    this.state.activityLog = this.state.activityLog.slice(-1000);
                }
            }

            buildSearchIndex() {
                this.state.searchIndex = {
                    posts: {},
                    communities: {},
                    users: {}
                };

                // Index posts
                this.state.posts.forEach(post => {
                    const searchText = `${post.title} ${post.content} ${post.author}`.toLowerCase();
                    const words = searchText.split(/\s+/);
                    words.forEach(word => {
                        if (word.length > 2) {
                            if (!this.state.searchIndex.posts[word]) {
                                this.state.searchIndex.posts[word] = [];
                            }
                            this.state.searchIndex.posts[word].push(post.id);
                        }
                    });
                });

                // Index communities
                this.state.communities.forEach(community => {
                    const searchText = `${community.name} ${community.displayName} ${community.description}`.toLowerCase();
                    const words = searchText.split(/\s+/);
                    words.forEach(word => {
                        if (word.length > 2) {
                            if (!this.state.searchIndex.communities[word]) {
                                this.state.searchIndex.communities[word] = [];
                            }
                            this.state.searchIndex.communities[word].push(community.id);
                        }
                    });
                });
            }

            initializeSampleData() {
                if (this.state.posts.length === 0) {
                    // Add sample posts
                    const samplePosts = [
                        {
                            id: utils.generateId(),
                            title: "🎉 WELCOME TO SMILEX! 🎉",
                            content: "Welcome everyone to the most advanced social media platform! Explore features like live polls, stories, premium content, real-time chat, community management, and so much more. This is the future of social networking!",
                            author: "SmileX Team",
                            authorId: "system",
                            visibility: "general",
                            votes: 15420,
                            comments: 3247,
                            timestamp: new Date(Date.now() - 3600000),
                            type: "text",
                            media: [],
                            userVotes: [],
                            commentsData: [
                                {
                                    id: utils.generateId(),
                                    author: "TechEnthusiast",
                                    authorId: "user1",
                                    text: "This platform is absolutely incredible! The features are mind-blowing! 🚀",
                                    timestamp: new Date(Date.now() - 3000000),
                                    votes: 45,
                                    replies: [],
                                    isPremium: false
                                },
                                {
                                    id: utils.generateId(),
                                    author: "CommunityBuilder",
                                    authorId: "user2",
                                    text: "Already created my first community! The management tools are **amazing**! ✨",
                                    timestamp: new Date(Date.now() - 2800000),
                                    votes: 32,
                                    replies: [],
                                    isPremium: true
                                }
                            ],
                            isPremium: true,
                            community: "SmileX Official",
                            communityId: "c1"
                        },
                        {
                            id: utils.generateId(),
                            title: "🔥 What's your favorite SmileX feature?",
                            content: "",
                            author: "FeatureExplorer",
                            authorId: "user3",
                            visibility: "general",
                            votes: 234,
                            comments: 89,
                            timestamp: new Date(Date.now() - 7200000),
                            type: "poll",
                            media: [],
                            pollOptions: [
                                { text: "Live Polls & Real-time Updates", votes: 145, percentage: 35, voters: [] },
                                { text: "Advanced Search System", votes: 98, percentage: 24, voters: [] },
                                { text: "Community Management", votes: 87, percentage: 21, voters: [] },
                                { text: "Premium Features & Disco Text", votes: 54, percentage: 13, voters: [] },
                                { text: "Stories & Media Sharing", votes: 28, percentage: 7, voters: [] }
                            ],
                            pollActive: true,
                            totalVotes: 412,
                            userVotes: [],
                            commentsData: [],
                            isPremium: false,
                            community: "General",
                            communityId: null
                        },
                        {
                            id: utils.generateId(),
                            title: "💎 Premium Features Showcase",
                            content: "Check out these **amazing premium features** that make SmileX stand out! ✨🎉💫 Premium users get access to disco text, exclusive emojis, ad-free experience, priority support, and custom themes!",
                            author: "PremiumUser",
                            authorId: "premium1",
                            visibility: "general",
                            votes: 567,
                            comments: 123,
                            timestamp: new Date(Date.now() - 10800000),
                            type: "text",
                            media: [],
                            userVotes: [],
                            commentsData: [],
                            isPremium: true,
                            community: "Premium Lounge",
                            communityId: "c2"
                        },
                        {
                            id: utils.generateId(),
                            title: "🚀 Advanced Search Demo",
                            content: "Try searching for anything in the search bar above! You can search for posts, communities, users, and get instant results with relevance scoring. The search system indexes everything in real-time!",
                            author: "SearchMaster",
                            authorId: "user5",
                            visibility: "general",
                            votes: 189,
                            comments: 45,
                            timestamp: new Date(Date.now() - 14400000),
                            type: "text",
                            media: [],
                            userVotes: [],
                            commentsData: [],
                            isPremium: false,
                            community: "Tech Talk",
                            communityId: "c3"
                        },
                        {
                            id: utils.generateId(),
                            title: "📊 Live Stats are Amazing!",
                            content: "Look at the live stats in the sidebar! Over 127,000 users online right now, thousands of active polls, and posts being created every minute. This platform is truly alive! 📈",
                            author: "StatsLover",
                            authorId: "user6",
                            visibility: "general",
                            votes: 345,
                            comments: 67,
                            timestamp: new Date(Date.now() - 18000000),
                            type: "text",
                            media: [],
                            userVotes: [],
                            commentsData: [],
                            isPremium: false,
                            community: "General",
                            communityId: null
                        }
                    ];

                    // Add sample communities
                    const sampleCommunities = [
                        {
                            id: "c1",
                            name: "smilex-official",
                            displayName: "SmileX Official",
                            description: "Official announcements, updates, and discussions about SmileX platform features and improvements.",
                            type: "public",
                            createdBy: "SmileX Team",
                            createdByUserId: "system",
                            createdAt: new Date(Date.now() - 86400000 * 30).toISOString(),
                            memberCount: 15420,
                            topics: ["announcements", "updates", "platform", "official"],
                            members: ["system"]
                        },
                        {
                            id: "c2",
                            name: "premium-lounge",
                            displayName: "Premium Lounge",
                            description: "Exclusive community for premium members to discuss features, share feedback, and connect with other premium users.",
                            type: "private",
                            createdBy: "SmileX Team",
                            createdByUserId: "system",
                            createdAt: new Date(Date.now() - 86400000 * 25).toISOString(),
                            memberCount: 2847,
                            topics: ["premium", "exclusive", "features", "vip"],
                            members: ["system"]
                        },
                        {
                            id: "c3",
                            name: "tech-talk",
                            displayName: "Tech Talk",
                            description: "Discuss the latest in technology, programming, AI, and digital innovations. Share your projects and get feedback from the community.",
                            type: "public",
                            createdBy: "TechGuru",
                            createdByUserId: "user7",
                            createdAt: new Date(Date.now() - 86400000 * 20).toISOString(),
                            memberCount: 8934,
                            topics: ["technology", "programming", "ai", "innovation"],
                            members: ["user7"]
                        },
                        {
                            id: "c4",
                            name: "creative-corner",
                            displayName: "Creative Corner",
                            description: "A space for artists, designers, writers, and creators to share their work, get inspiration, and collaborate on projects.",
                            type: "public",
                            createdBy: "ArtisticSoul",
                            createdByUserId: "user8",
                            createdAt: new Date(Date.now() - 86400000 * 15).toISOString(),
                            memberCount: 5672,
                            topics: ["art", "design", "creativity", "inspiration"],
                            members: ["user8"]
                        },
                        {
                            id: "c5",
                            name: "gaming-hub",
                            displayName: "Gaming Hub",
                            description: "Connect with fellow gamers, discuss the latest games, share gameplay clips, and organize gaming sessions.",
                            type: "public",
                            createdBy: "GameMaster",
                            createdByUserId: "user9",
                            createdAt: new Date(Date.now() - 86400000 * 10).toISOString(),
                            memberCount: 12456,
                            topics: ["gaming", "esports", "reviews", "community"],
                            members: ["user9"]
                        }
                    ];

                    // Add sample stories
                    const sampleStories = [
                        {
                            id: utils.generateId(),
                            author: "John Doe",
                            authorId: "user1",
                            content: "Having an amazing day exploring the new SmileX features! 🎉",
                            media: {
                                url: "/placeholder.svg?height=600&width=400",
                                type: "image"
                            },
                            timestamp: new Date(Date.now() - 1800000),
                            expiresAt: new Date(Date.now() + 86400000 - 1800000),
                            views: 145,
                            viewers: []
                        },
                        {
                            id: utils.generateId(),
                            author: "Sarah",
                            authorId: "user2",
                            content: "Just created my first community on SmileX! 🚀",
                            media: {
                                url: "/placeholder.svg?height=600&width=400",
                                type: "image"
                            },
                            timestamp: new Date(Date.now() - 3600000),
                            expiresAt: new Date(Date.now() + 86400000 - 3600000),
                            views: 89,
                            viewers: []
                        },
                        {
                            id: utils.generateId(),
                            author: "Mike",
                            authorId: "user3",
                            content: "Testing out the premium features - they're incredible! ✨",
                            media: {
                                url: "/placeholder.svg?height=600&width=400",
                                type: "image"
                            },
                            timestamp: new Date(Date.now() - 5400000),
                            expiresAt: new Date(Date.now() + 86400000 - 5400000),
                            views: 234,
                            viewers: []
                        }
                    ];

                    this.setState({
                        posts: samplePosts,
                        communities: sampleCommunities,
                        stories: sampleStories,
                        totalCommunities: sampleCommunities.length
                    });
                }
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('smileXState');
                    if (stored) {
                        const parsedState = JSON.parse(stored);
                        // Convert timestamp strings back to Date objects
                        if (parsedState.posts) {
                            parsedState.posts = parsedState.posts.map(post => ({
                                ...post,
                                timestamp: new Date(post.timestamp)
                            }));
                        }
                        if (parsedState.stories) {
                            parsedState.stories = parsedState.stories.map(story => ({
                                ...story,
                                timestamp: new Date(story.timestamp),
                                expiresAt: new Date(story.expiresAt)
                            }));
                        }
                        if (parsedState.activityLog) {
                            parsedState.activityLog = parsedState.activityLog.map(activity => ({
                                ...activity,
                                timestamp: new Date(activity.timestamp)
                            }));
                        }
                        this.state = { ...this.state, ...parsedState };
                    }
                } catch (error) {
                    console.error('Error loading state from storage:', error);
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem('smileXState', JSON.stringify(this.state));
                } catch (error) {
                    console.error('Error saving state to storage:', error);
                }
            }
        }

        // Initialize State Manager
        const stateManager = new StateManager();

        // Utility Functions
        const utils = {
            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'k';
                }
                return num.toString();
            },

            getPreciseTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) {
                    return `${diffInSeconds}s ago`;
                } else if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    const seconds = diffInSeconds % 60;
                    return `${minutes}m ${seconds}s ago`;
                } else if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    const minutes = Math.floor((diffInSeconds % 3600) / 60);
                    return `${hours}h ${minutes}m ago`;
                } else {
                    const days = Math.floor(diffInSeconds / 86400);
                    const hours = Math.floor((diffInSeconds % 86400) / 3600);
                    return `${days}d ${hours}h ago`;
                }
            },

            getTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) {
                    return 'Just now';
                } else if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 2592000) {
                    const days = Math.floor(diffInSeconds / 86400);
                    return `${days} day${days !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 31536000) {
                    const months = Math.floor(diffInSeconds / 2592000);
                    return `${months} month${months !== 1 ? 's' : ''} ago`;
                } else {
                    const years = Math.floor(diffInSeconds / 31536000);
                    return `${years} year${years !== 1 ? 's' : ''} ago`;
                }
            },

            getCommunityColor(name) {
                const colors = [
                    'bg-blue-500', 'bg-red-500', 'bg-green-500', 'bg-purple-500',
                    'bg-gray-500', 'bg-yellow-500', 'bg-pink-500', 'bg-indigo-500'
                ];
                
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                
                return colors[Math.abs(hash) % colors.length];
            },

            generateId() {
                return Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
            },

            validateFile(file) {
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    throw new Error(`File size must be less than ${CONFIG.MAX_FILE_SIZE / (1024 * 1024)}MB`);
                }

                const isImage = CONFIG.SUPPORTED_IMAGE_TYPES.includes(file.type);
                const isVideo = CONFIG.SUPPORTED_VIDEO_TYPES.includes(file.type);

                if (!isImage && !isVideo) {
                    throw new Error('Unsupported file type. Please use JPG, PNG, GIF, MP4, or WebM files.');
                }

                return { isImage, isVideo };
            },

            createMediaPreview(file, onRemove) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const { isImage, isVideo } = utils.validateFile(file);
                        const mediaUrl = e.target.result;
                        
                        const previewItem = document.createElement('div');
                        previewItem.className = 'media-preview-item';
                        
                        if (isImage) {
                            previewItem.innerHTML = `
                                <img src="${mediaUrl}" alt="Preview of ${file.name}" loading="lazy">
                                <button class="media-remove-btn" onclick="removeMedia('${file.name}')" aria-label="Remove ${file.name}">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        } else if (isVideo) {
                            previewItem.innerHTML = `
                                <video src="${mediaUrl}" muted>
                                    <source src="${mediaUrl}" type="${file.type}">
                                    Your browser does not support the video tag.
                                </video>
                                <button class="media-remove-btn" onclick="removeMedia('${file.name}')" aria-label="Remove ${file.name}">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        }
                        
                        resolve({
                            element: previewItem,
                            file: file,
                            url: mediaUrl,
                            type: isImage ? 'image' : 'video'
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 1001;
                    transform: translateX(100%);
                    opacity: 0;
                    transition: all 0.3s ease;
                    max-width: 300px;
                    word-wrap: break-word;
                `;
                
                // Set background color based on type
                switch (type) {
                    case 'success':
                        notification.style.background = '#10b981';
                        break;
                    case 'error':
                        notification.style.background = '#ef4444';
                        break;
                    case 'warning':
                        notification.style.background = '#f59e0b';
                        break;
                    default:
                        notification.style.background = '#6366f1';
                }
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Trigger animation
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                    notification.style.opacity = '1';
                }, 100);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);

                // Add to notifications state
                const state = stateManager.getState();
                const newNotification = {
                    id: utils.generateId(),
                    message: message,
                    type: type,
                    timestamp: new Date(),
                    read: false
                };
                
                const updatedNotifications = [newNotification, ...state.notifications].slice(0, 50);
                stateManager.setState({ notifications: updatedNotifications });
                
                // Update notification badge
                updateNotificationBadge();
            },

            calculateHotScore(post) {
                const hoursOld = (Date.now() - post.timestamp.getTime()) / (1000 * 60 * 60);
                const score = post.votes / Math.pow(hoursOld + 2, 1.8);
                return score;
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            isNameRestricted(name) {
                const lowerName = name.toLowerCase();
                return CONFIG.RESTRICTED_NAMES.some(restricted => 
                    lowerName.includes(restricted)
                );
            },

            isNameTaken(name) {
                const state = stateManager.getState();
                return state.registeredUsers.some(user => 
            user.fullName.toLowerCase() === name.toLowerCase()
        ) || state.communities.some(community => 
            community.name.toLowerCase() === name.toLowerCase() ||
            community.displayName.toLowerCase() === name.toLowerCase()
        );
    },

    generateUniqueNameSuggestions(baseName) {
        const suggestions = [];
        for (let i = 1; i <= 5; i++) {
            const suggestion = `${baseName}${Math.floor(Math.random() * 1000) + i}`;
            if (!this.isNameTaken(suggestion)) {
                suggestions.push(suggestion);
            }
        }
        return suggestions;
    },

    isPremiumUser(userId) {
        const state = stateManager.getState();
        return state.premiumUsers.includes(userId);
    }
};

// Profile Picture Management
class ProfileManager {
    constructor() {
        this.currentStream = null;
    }

    async openCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 },
                audio: false 
            });
            
            this.currentStream = stream;
            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;
            
            document.getElementById('cameraModal').classList.remove('hidden');
        } catch (error) {
            utils.showNotification('Camera access denied or not available', 'error');
        }
    }

    closeCamera() {
        if (this.currentStream) {
            this.currentStream.getTracks().forEach(track => track.stop());
            this.currentStream = null;
        }
        document.getElementById('cameraModal').classList.add('hidden');
    }

    capturePhoto() {
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('cameraCanvas');
        const context = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        
        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
        this.setProfileImage(dataURL);
        this.closeCamera();
    }

    handleFileUpload(file) {
        if (!file) return;
        
        try {
            utils.validateFile(file);
            const reader = new FileReader();
            reader.onload = (e) => {
                this.setProfileImage(e.target.result);
            };
            reader.readAsDataURL(file);
        } catch (error) {
            utils.showNotification(error.message, 'error');
        }
    }

    setProfileImage(imageDataURL) {
        const preview = document.getElementById('profilePreview');
        
        preview.innerHTML = `
            <img src="${imageDataURL}" alt="Profile picture">
            <div class="profile-upload-overlay">
                <i class="fas fa-camera"></i>
            </div>
        `;
        
        // Store in user data
        const state = stateManager.getState();
        if (state.currentUser) {
            state.currentUser.profileImage = imageDataURL;
            stateManager.setState({ currentUser: state.currentUser });
            localStorage.setItem('smilex_user', JSON.stringify(state.currentUser));
        }
        
        utils.showNotification('Profile picture updated!', 'success');
    }
}

// Initialize Profile Manager
const profileManager = new ProfileManager();

// Name Validation System
class NameValidator {
    checkAvailability(name) {
        if (!name || name.length < 3) {
            return { 
                available: false, 
                message: 'Name must be at least 3 characters long',
                type: 'error'
            };
        }

        if (utils.isNameRestricted(name)) {
            return {
                available: false,
                message: 'This name contains restricted words',
                type: 'error',
                suggestions: utils.generateUniqueNameSuggestions(name.replace(/smile|smilex/gi, ''))
            };
        }

        if (utils.isNameTaken(name)) {
            return {
                available: false,
                message: 'This name is already taken',
                type: 'error',
                suggestions: utils.generateUniqueNameSuggestions(name)
            };
        }

        return {
            available: true,
            message: 'Name is available!',
            type: 'success'
        };
    }

    displayValidation(elementId, result) {
        const validationDiv = document.getElementById(elementId);
        if (!validationDiv) return;

        validationDiv.style.display = 'flex';
        validationDiv.className = `name-validation ${result.available ? 'name-available' : 'name-taken'}`;
        
        let html = `
            <i class="fas fa-${result.available ? 'check' : 'times'}"></i>
            <span>${result.message}</span>
        `;

        if (result.suggestions && result.suggestions.length > 0) {
            html += `
                <div style="margin-top: 0.5rem; font-size: 11px;">
                    Suggestions: ${result.suggestions.map(suggestion => 
                        `<span style="background: var(--primary-color); color: white; padding: 2px 6px; border-radius: 4px; margin-right: 4px; cursor: pointer;" onclick="applySuggestion('${suggestion}')">${suggestion}</span>`
                    ).join('')}
                </div>
            `;
        }

        validationDiv.innerHTML = html;
    }
}

// Initialize Name Validator
const nameValidator = new NameValidator();

// Advanced Search System
class SearchSystem {
    constructor() {
        this.searchResults = [];
        this.currentQuery = '';
    }

    performSearch(query) {
        if (!query || query.length < 2) {
            this.hideSearchResults();
            return;
        }

        this.currentQuery = query.toLowerCase();
        const state = stateManager.getState();
        const results = [];

        // Search posts
        const postResults = this.searchPosts(query, state);
        results.push(...postResults);

        // Search communities
        const communityResults = this.searchCommunities(query, state);
        results.push(...communityResults);

        // Search users
        const userResults = this.searchUsers(query, state);
        results.push(...userResults);

        this.displaySearchResults(results);
    }

    searchPosts(query, state) {
        const results = [];
        const queryWords = query.toLowerCase().split(/\s+/);
        
        state.posts.forEach(post => {
            let relevanceScore = 0;
            const searchText = `${post.title} ${post.content} ${post.author}`.toLowerCase();
            
            queryWords.forEach(word => {
                if (searchText.includes(word)) {
                    relevanceScore += post.title.toLowerCase().includes(word) ? 3 : 1;
                    relevanceScore += post.votes * 0.01; // Boost popular posts
                }
            });

            if (relevanceScore > 0) {
                results.push({
                    type: 'post',
                    id: post.id,
                    title: post.title,
                    description: post.content.substring(0, 100) + '...',
                    author: post.author,
                    community: post.community,
                    relevance: relevanceScore,
                    data: post
                });
            }
        });

        return results.sort((a, b) => b.relevance - a.relevance).slice(0, 5);
    }

    searchCommunities(query, state) {
        const results = [];
        const queryWords = query.toLowerCase().split(/\s+/);
        
        state.communities.forEach(community => {
            let relevanceScore = 0;
            const searchText = `${community.name} ${community.displayName} ${community.description}`.toLowerCase();
            
            queryWords.forEach(word => {
                if (searchText.includes(word)) {
                    relevanceScore += community.name.toLowerCase().includes(word) ? 3 : 1;
                    relevanceScore += community.memberCount * 0.001; // Boost popular communities
                }
            });

            if (relevanceScore > 0) {
                results.push({
                    type: 'community',
                    id: community.id,
                    title: community.displayName,
                    description: community.description || 'No description available',
                    memberCount: community.memberCount,
                    relevance: relevanceScore,
                    data: community
                });
            }
        });

        return results.sort((a, b) => b.relevance - a.relevance).slice(0, 3);
    }

    searchUsers(query, state) {
        const results = [];
        const queryLower = query.toLowerCase();
        
        state.registeredUsers.forEach(user => {
            if (user.fullName.toLowerCase().includes(queryLower)) {
                results.push({
                    type: 'user',
                    id: user.userId,
                    title: user.fullName,
                    description: `User since ${new Date(user.createdAt).toLocaleDateString()}`,
                    relevance: user.fullName.toLowerCase().indexOf(queryLower) === 0 ? 2 : 1,
                    data: user
                });
            }
        });

        return results.sort((a, b) => b.relevance - a.relevance).slice(0, 3);
    }

    displaySearchResults(results) {
        const container = document.getElementById('searchResults');
        if (!container) return;

        if (results.length === 0) {
            container.innerHTML = '<div class="search-result-item">No results found</div>';
        } else {
            container.innerHTML = results.map(result => `
                <div class="search-result-item" onclick="navigateToResult('${result.type}', '${result.id}')">
                    <div class="search-result-type">${result.type}</div>
                    <div class="search-result-title">${this.highlightQuery(result.title)}</div>
                    <div class="search-result-description">${this.highlightQuery(result.description)}</div>
                    ${result.type === 'community' ? `<div style="font-size: 10px; color: #666;">${utils.formatNumber(result.memberCount)} members</div>` : ''}
                </div>
            `).join('');
        }

        container.classList.remove('hidden');
    }

    highlightQuery(text) {
        if (!this.currentQuery) return text;
        
        const regex = new RegExp(`(${this.currentQuery})`, 'gi');
        return text.replace(regex, '<mark style="background: var(--primary-color); color: white; padding: 1px 2px; border-radius: 2px;">$1</mark>');
    }

    hideSearchResults() {
        const container = document.getElementById('searchResults');
        if (container) {
            container.classList.add('hidden');
        }
    }
}

// Initialize Search System
const searchSystem = new SearchSystem();

// Media Management
class MediaManager {
    constructor() {
        this.uploadedMedia = [];
    }

    async handleFiles(files) {
        const validFiles = [];
        const errors = [];

        for (const file of files) {
            try {
                utils.validateFile(file);
                validFiles.push(file);
            } catch (error) {
                errors.push(`${file.name}: ${error.message}`);
            }
        }

        if (errors.length > 0) {
            utils.showNotification(`Some files were rejected: ${errors.join(', ')}`, 'warning');
        }

        const previews = await Promise.all(
            validFiles.map(file => utils.createMediaPreview(file, this.removeMedia.bind(this)))
        );

        this.uploadedMedia.push(...previews);
        this.updatePreviewContainer();
        
        return previews;
    }

    removeMedia(fileName) {
        this.uploadedMedia = this.uploadedMedia.filter(media => media.file.name !== fileName);
        this.updatePreviewContainer();
    }

    updatePreviewContainer() {
        const container = document.getElementById('mediaPreviewContainer');
        if (!container) return;

        container.innerHTML = '';
        this.uploadedMedia.forEach(media => {
            container.appendChild(media.element);
        });
    }

    clearAll() {
        this.uploadedMedia = [];
        this.updatePreviewContainer();
    }

    getMediaData() {
        return this.uploadedMedia.map(media => ({
            url: media.url,
            type: media.type,
            name: media.file.name
        }));
    }
}

// Initialize Media Manager
const mediaManager = new MediaManager();

// Story Management
class StoryManager {
    constructor() {
        this.currentStoryIndex = 0;
        this.storyTimer = null;
        this.isViewingStory = false;
    }

    createStory() {
        showModal('create-post-modal');
        // Set post type to story
        const postTypeSelect = document.getElementById('postType');
        if (postTypeSelect) {
            postTypeSelect.value = 'story';
            handlePostTypeChange({ target: { value: 'story' } });
        }
    }

    viewStory(userId) {
        const state = stateManager.getState();
        const userStories = state.stories.filter(story => 
            story.authorId === userId && new Date() < story.expiresAt
        );

        if (userStories.length === 0) {
            utils.showNotification('No active stories from this user', 'info');
            return;
        }

        this.currentStoryIndex = 0;
        this.isViewingStory = true;
        this.displayStory(userStories[0]);
        showModal('story-viewer-modal');
        this.startStoryTimer(userStories);
    }

    displayStory(story) {
        const storyContent = document.getElementById('storyContent');
        const storyAuthor = document.getElementById('storyAuthor');
        const storyAuthorInitial = document.getElementById('storyAuthorInitial');
        const storyTime = document.getElementById('storyTime');

        if (story.media.type === 'image') {
            storyContent.innerHTML = `
                <img src="${story.media.url}" alt="Story" style="width: 100%; height: 100%; object-fit: cover;">
                <div style="position: absolute; bottom: 80px; left: 20px; right: 20px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">
                    <p style="font-size: 16px; margin: 0;">${story.content}</p>
                </div>
            `;
        } else if (story.media.type === 'video') {
            storyContent.innerHTML = `
                <video src="${story.media.url}" style="width: 100%; height: 100%; object-fit: cover;" autoplay muted>
                    <source src="${story.media.url}" type="video/mp4">
                </video>
                <div style="position: absolute; bottom: 80px; left: 20px; right: 20px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">
                    <p style="font-size: 16px; margin: 0;">${story.content}</p>
                </div>
            `;
        }

        storyAuthor.textContent = story.author;
        storyAuthorInitial.textContent = story.author.charAt(0);
        storyTime.textContent = utils.getTimeAgo(story.timestamp);

        // Mark as viewed
        if (!story.viewers.includes(stateManager.getState().currentUser?.userId)) {
            story.viewers.push(stateManager.getState().currentUser?.userId || 'anonymous');
            story.views++;
        }
    }

    startStoryTimer(stories) {
        const progressBar = document.querySelector('#storyProgress > div');
        let progress = 0;
        const duration = CONFIG.STORY_DURATION;
        const interval = 50;

        this.storyTimer = setInterval(() => {
            progress += (interval / duration) * 100;
            progressBar.style.width = `${progress}%`;

            if (progress >= 100) {
                this.nextStory(stories);
            }
        }, interval);
    }

    nextStory(stories) {
        if (this.storyTimer) {
            clearInterval(this.storyTimer);
        }

        this.currentStoryIndex++;
        if (this.currentStoryIndex >= stories.length) {
            this.closeStoryViewer();
            return;
        }

        this.displayStory(stories[this.currentStoryIndex]);
        this.startStoryTimer(stories);
    }

    closeStoryViewer() {
        if (this.storyTimer) {
            clearInterval(this.storyTimer);
        }
        this.isViewingStory = false;
        hideModal('story-viewer-modal');
    }
}

// Initialize Story Manager
const storyManager = new StoryManager();

// Comments System
class CommentsSystem {
    constructor() {
        this.currentEmojiTarget = null;
    }

    addComment(postId, commentText, inputElement, parentCommentId = null) {
        if (!commentText.trim()) return;

        const state = stateManager.getState();
        const post = state.posts.find(p => p.id === postId);
        
        if (!post) return;

        const newComment = {
            id: utils.generateId(),
            author: state.currentUser ? state.currentUser.fullName : "Anonymous",
            authorId: state.currentUser ? state.currentUser.userId : "anonymous",
            text: commentText.trim(),
            timestamp: new Date(),
            votes: 0,
            parentId: parentCommentId,
            replies: [],
            isPremium: utils.isPremiumUser(state.currentUser ? state.currentUser.userId : null)
        };

        if (!post.commentsData) {
            post.commentsData = [];
        }
        
        if (parentCommentId) {
            // Find parent comment and add reply
            const parentComment = post.commentsData.find(c => c.id === parentCommentId);
            if (parentComment) {
                if (!parentComment.replies) parentComment.replies = [];
                parentComment.replies.push(newComment);
            }
        } else {
            post.commentsData.push(newComment);
        }
        
        post.comments++;

        stateManager.setState({ posts: state.posts });
        
        if (inputElement) {
            inputElement.value = '';
        }
        
        this.renderComments(postId, post.commentsData);
        utils.showNotification('Comment added!', 'success');
        
        return newComment;
    }

    renderComments(postId, comments) {
        const container = document.getElementById(`comments-list-${postId}`);
        if (!container) return;

        if (!comments || comments.length === 0) {
            container.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">No comments yet. Be the first to comment!</p>';
            return;
        }

        container.innerHTML = comments.map(comment => this.renderComment(comment, postId)).join('');
    }

    renderComment(comment, postId, isReply = false) {
        const timeAgo = utils.getPreciseTimeAgo(comment.timestamp);
        const premiumBadge = comment.isPremium ? '<span class="premium-badge"><i class="fas fa-crown"></i> Premium</span>' : '';
        
        let html = `
            <div class="comment ${isReply ? 'reply' : ''}" data-comment-id="${comment.id}">
                <div class="comment-header">
                    <div class="comment-author">
                        ${comment.author} ${premiumBadge}
                    </div>
                    <div class="comment-time precise-timestamp">${timeAgo}</div>
                </div>
                <div class="comment-text">${this.formatCommentText(comment.text, comment.isPremium)}</div>
                <div class="comment-actions">
                    <span class="comment-action" onclick="likeComment('${comment.id}')">
                        <i class="fas fa-heart"></i> ${comment.votes || 0}
                    </span>
                    <span class="comment-action" onclick="showReplyInput('${comment.id}', '${postId}')">
                        <i class="fas fa-reply"></i> Reply
                    </span>
                    <span class="comment-action" onclick="commentsSystem.showEmojiPicker(event, 'comment-${comment.id}')">
                        <i class="fas fa-smile"></i> React
                    </span>
                </div>
                <div id="reply-input-${comment.id}" class="comment-input" style="display: none; margin-top: 0.5rem;">
                    <input type="text" placeholder="Write a reply..." onkeypress="if(event.key==='Enter') addReply('${postId}', '${comment.id}', this.value, this)">
                    <button onclick="addReply('${postId}', '${comment.id}', this.previousElementSibling.value, this.previousElementSibling)" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Reply</button>
                </div>
        `;

        // Add replies
        if (comment.replies && comment.replies.length > 0) {
            html += '<div class="replies">';
            comment.replies.forEach(reply => {
                html += this.renderComment(reply, postId, true);
            });
            html += '</div>';
        }

        html += '</div>';
        return html;
    }

    formatCommentText(text, isPremium) {
        if (isPremium) {
            // Apply premium formatting
            text = text.replace(/\*\*(.*?)\*\*/g, '<span class="disco-text">$1</span>');
            
            // Replace premium emojis
            CONFIG.PREMIUM_EMOJIS.forEach(emoji => {
                text = text.replace(new RegExp(emoji, 'g'), `<span class="premium-emoji">${emoji}</span>`);
            });
        }
        
        return text;
    }

    showEmojiPicker(event, targetId) {
        event.stopPropagation();
        const picker = document.getElementById('emojiPicker');
        const rect = event.target.getBoundingClientRect();
        
        picker.style.position = 'absolute';
        picker.style.top = `${rect.bottom + 5}px`;
        picker.style.left = `${rect.left}px`;
        picker.classList.add('active');
        
        this.currentEmojiTarget = targetId;
        
        // Close picker when clicking outside
        setTimeout(() => {
            document.addEventListener('click', this.closeEmojiPicker.bind(this), { once: true });
        }, 100);
    }

    closeEmojiPicker() {
        const picker = document.getElementById('emojiPicker');
        picker.classList.remove('active');
        this.currentEmojiTarget = null;
    }

    insertEmoji(emoji) {
        if (this.currentEmojiTarget) {
            if (this.currentEmojiTarget.startsWith('comment-')) {
                // Add emoji reaction to comment
                const commentId = this.currentEmojiTarget.replace('comment-', '');
                this.addEmojiReaction(commentId, emoji);
            } else {
                // Insert emoji into input field
                const input = document.querySelector(`#${this.currentEmojiTarget} input, #${this.currentEmojiTarget}`);
                if (input) {
                    input.value += emoji;
                    input.focus();
                }
            }
        }
        this.closeEmojiPicker();
    }

    addEmojiReaction(commentId, emoji) {
        utils.showNotification(`Reacted with ${emoji}!`, 'success');
    }
}

// Initialize Comments System
const commentsSystem = new CommentsSystem();

// Post Management
class PostManager {
    constructor() {
        this.posts = stateManager.getState().posts;
    }

    async createPost(postData) {
        const state = stateManager.getState();
        const mediaData = mediaManager.getMediaData();

        // Handle story creation
        if (postData.postType === 'story') {
            return this.createStory(postData, mediaData);
        }

        // Handle poll creation
        if (postData.postType === 'poll') {
            return this.createPoll(postData);
        }

        const newPost = {
            id: utils.generateId(),
            title: postData.title,
            content: postData.content || "",
            author: state.currentUser ? state.currentUser.fullName : "Anonymous",
            authorId: state.currentUser ? state.currentUser.userId : "anonymous",
            visibility: postData.visibility,
            votes: 0,
            comments: 0,
            timestamp: new Date(),
            type: this.determinePostType(postData.postType, mediaData),
            media: mediaData,
            userVotes: [],
            commentsData: [],
            isPremium: utils.isPremiumUser(state.currentUser ? state.currentUser.userId : null)
        };

        if (postData.visibility === 'community' && postData.community) {
            const community = state.communities.find(c => c.id === postData.community);
            if (community) {
                newPost.community = community.displayName;
                newPost.communityId = community.id;
            }
        } else {
            newPost.community = "General";
            newPost.communityId = null;
        }

        const updatedPosts = [newPost, ...state.posts];
        stateManager.setState({ 
            posts: updatedPosts,
            postsToday: state.postsToday + 1
        });

        mediaManager.clearAll();
        utils.showNotification('Post created successfully!', 'success');
        
        return newPost;
    }

    createStory(postData, mediaData) {
        const state = stateManager.getState();

        if (mediaData.length === 0) {
            throw new Error('Stories require at least one image or video');
        }

        const newStory = {
            id: utils.generateId(),
            author: state.currentUser ? state.currentUser.fullName : "Anonymous",
            authorId: state.currentUser ? state.currentUser.userId : "anonymous",
            content: postData.content || "",
            media: mediaData[0], // Stories only support one media item
            timestamp: new Date(),
            expiresAt: new Date(Date.now() + 86400000), // 24 hours from now
            views: 0,
            viewers: []
        };

        const updatedStories = [newStory, ...state.stories];
        stateManager.setState({ 
            stories: updatedStories,
            liveStories: state.liveStories + 1
        });

        mediaManager.clearAll();
        utils.showNotification('Story created successfully!', 'success');
        
        return newStory;
    }

    createPoll(pollData) {
        const state = stateManager.getState();
        const pollOptions = this.extractPollOptions(pollData);

        if (pollOptions.length < 2) {
            throw new Error('Poll must have at least 2 options');
        }

        const pollId = utils.generateId();
        const newPost = {
            id: utils.generateId(),
            title: pollData.title,
            content: pollData.content || "",
            author: state.currentUser ? state.currentUser.fullName : "Anonymous",
            authorId: state.currentUser ? state.currentUser.userId : "anonymous",
            visibility: pollData.visibility,
            votes: 0,
            comments: 0,
            timestamp: new Date(),
            type: "poll",
            media: [],
            pollOptions: pollOptions,
            pollId: pollId,
            pollActive: true,
            totalVotes: 0,
            userVotes: [],
            commentsData: [],
            isPremium: utils.isPremiumUser(state.currentUser ? state.currentUser.userId : null)
        };

        if (pollData.visibility === 'community' && pollData.community) {
            const community = state.communities.find(c => c.id === pollData.community);
            if (community) {
                newPost.community = community.displayName;
                newPost.communityId = community.id;
            }
        } else {
            newPost.community = "General";
            newPost.communityId = null;
        }

        const updatedLivePolls = [...state.livePolls, {
            id: pollId,
            postId: newPost.id,
            question: pollData.title,
            options: pollOptions,
            active: true,
            createdBy: state.currentUser ? state.currentUser.userId : "anonymous",
            totalVotes: 0
        }];

        const updatedPosts = [newPost, ...state.posts];
        stateManager.setState({ 
            posts: updatedPosts,
            livePolls: updatedLivePolls,
            activePolls: state.activePolls + 1,
            postsToday: state.postsToday + 1
        });

        utils.showNotification('Live poll created successfully!', 'success');
        return newPost;
    }

    extractPollOptions(pollData) {
        const options = [];
        let optionIndex = 1;
        
        // Extract poll options from form data
        while (pollData[`option${optionIndex}`]) {
            if (pollData[`option${optionIndex}`].trim()) {
                options.push({
                    text: pollData[`option${optionIndex}`].trim(),
                    votes: 0,
                    percentage: 0,
                    voters: []
                });
            }
            optionIndex++;
        }

        // Also check for poll option inputs in the DOM
        const pollInputs = document.querySelectorAll('.poll-option-input');
        pollInputs.forEach(input => {
            if (input.value.trim() && !options.find(opt => opt.text === input.value.trim())) {
                options.push({
                    text: input.value.trim(),
                    votes: 0,
                    percentage: 0,
                    voters: []
                });
            }
        });

        return options;
    }

    determinePostType(selectedType, mediaData) {
        if (selectedType === 'poll') return 'poll';
        if (selectedType === 'story') return 'story';
        if (mediaData.length > 0) {
            const hasVideo = mediaData.some(media => media.type === 'video');
            return hasVideo ? 'video' : 'image';
        }
        return 'text';
    }

    voteOnPost(postId, direction) {
        const state = stateManager.getState();
        const post = state.posts.find(p => p.id === postId);
        if (!post || !state.currentUser) return;

        const userId = state.currentUser.userId;
        const existingVote = post.userVotes.find(v => v.userId === userId);

        if (existingVote) {
            // Remove existing vote
            post.votes -= existingVote.direction === 'up' ? 1 : -1;
            post.userVotes = post.userVotes.filter(v => v.userId !== userId);
            
            // Add new vote if different direction
            if (existingVote.direction !== direction) {
                post.votes += direction === 'up' ? 1 : -1;
                post.userVotes.push({ userId, direction });
            }
        } else {
            // Add new vote
            post.votes += direction === 'up' ? 1 : -1;
            post.userVotes.push({ userId, direction });
        }

        stateManager.setState({ posts: state.posts });
        this.updatePostVoteDisplay(postId, post.votes);
    }

    voteOnPoll(postId, optionIndex) {
        const state = stateManager.getState();
        const post = state.posts.find(p => p.id === postId);
        
        if (!post || !post.pollOptions || !post.pollActive || !state.currentUser) {
            utils.showNotification('Unable to vote on this poll', 'error');
            return;
        }

        const userId = state.currentUser.userId;
        
        // Check if user has already voted
        const hasVoted = post.pollOptions.some(option => 
            option.voters && option.voters.includes(userId)
        );

        if (hasVoted) {
            utils.showNotification('You have already voted in this poll', 'warning');
            return;
        }

        // Add vote
        if (!post.pollOptions[optionIndex].voters) {
            post.pollOptions[optionIndex].voters = [];
        }
        
        post.pollOptions[optionIndex].voters.push(userId);
        post.pollOptions[optionIndex].votes++;

        // Recalculate percentages
        const totalVotes = post.pollOptions.reduce((sum, option) => sum + option.votes, 0);
        post.pollOptions.forEach(option => {
            option.percentage = totalVotes > 0 ? Math.round((option.votes / totalVotes) * 100) : 0;
        });

        post.totalVotes = totalVotes;

        // Update live polls tracking
        const livePoll = state.livePolls.find(p => p.postId === postId);
        if (livePoll) {
            livePoll.options = post.pollOptions;
            livePoll.totalVotes = totalVotes;
        }

        stateManager.setState({ 
            posts: state.posts,
            livePolls: state.livePolls
        });

        utils.showNotification('Vote recorded!', 'success');
        this.renderPosts();
    }

    updatePostVoteDisplay(postId, newVoteCount) {
        const voteCountElement = document.querySelector(`[data-post-id="${postId}"] .vote-count`);
        if (voteCountElement) {
            voteCountElement.textContent = utils.formatNumber(newVoteCount);
        }

            }

    renderPosts() {
        const state = stateManager.getState();
        const container = document.getElementById('posts-feed');
        if (!container) return;

        let filteredPosts = this.filterPosts(state.posts, state.currentFeedFilter);
        filteredPosts = this.sortPosts(filteredPosts, state.currentSort);

        if (filteredPosts.length === 0) {
            container.innerHTML = `
                <div class="post-card">
                    <div class="post-content" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-comments" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--text-secondary); margin-bottom: 0.5rem;">No posts yet</h3>
                        <p style="color: var(--text-muted);">Be the first to share something with the community!</p>
                        <button class="btn btn-primary" onclick="showModal('create-post-modal')" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Create Post
                        </button>
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = filteredPosts.map(post => this.renderPost(post)).join('');
    }

    filterPosts(posts, filter) {
        const state = stateManager.getState();
        
        switch (filter) {
            case 'general':
                return posts.filter(post => !post.communityId);
            case 'mycommunities':
                const userCommunities = [...state.userMemberships, ...state.userCreatedCommunities];
                return posts.filter(post => 
                    post.communityId && userCommunities.includes(post.communityId)
                );
            case 'following':
                return posts.filter(post => 
                    state.userFollowing.includes(post.authorId)
                );
            default:
                return posts;
        }
    }

    sortPosts(posts, sortType) {
        switch (sortType) {
            case 'new':
                return [...posts].sort((a, b) => b.timestamp - a.timestamp);
            case 'top':
                return [...posts].sort((a, b) => b.votes - a.votes);
            case 'trending':
                return [...posts].sort((a, b) => {
                    const aScore = utils.calculateHotScore(a) + (a.comments * 0.5);
                    const bScore = utils.calculateHotScore(b) + (b.comments * 0.5);
                    return bScore - aScore;
                });
            case 'live':
                return [...posts].filter(post => post.type === 'poll' && post.pollActive)
                    .sort((a, b) => b.timestamp - a.timestamp);
            case 'hot':
            default:
                return [...posts].sort((a, b) => utils.calculateHotScore(b) - utils.calculateHotScore(a));
        }
    }

    renderPost(post) {
        const timeAgo = utils.getTimeAgo(post.timestamp);
        const preciseTimeAgo = utils.getPreciseTimeAgo(post.timestamp);
        const userVote = post.userVotes?.find(v => v.userId === stateManager.getState().currentUser?.userId);
        const premiumBadge = post.isPremium ? '<span class="premium-badge"><i class="fas fa-crown"></i> Premium</span>' : '';
        
        let mediaContent = '';
        if (post.media && post.media.length > 0) {
            mediaContent = this.renderMediaContent(post.media, post.id);
        }

        let pollContent = '';
        if (post.type === 'poll' && post.pollOptions) {
            pollContent = this.renderPollContent(post);
        }

        return `
            <article class="post-card" data-post-id="${post.id}" role="article" aria-labelledby="post-title-${post.id}">
                <div class="post-content">
                    <div class="vote-section" role="group" aria-label="Vote on post">
                        <button class="vote-button ${userVote?.direction === 'up' ? 'voted-up' : ''}" 
                                onclick="postManager.voteOnPost('${post.id}', 'up')"
                                aria-label="Upvote post">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <div class="vote-count" aria-label="Vote count">${utils.formatNumber(post.votes)}</div>
                        <button class="vote-button ${userVote?.direction === 'down' ? 'voted-down' : ''}" 
                                onclick="postManager.voteOnPost('${post.id}', 'down')"
                                aria-label="Downvote post">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    
                    <div class="post-main">
                        <div class="post-meta">
                            <span class="community-icon ${utils.getCommunityColor(post.community || 'general')}">${(post.community || 'G').charAt(0)}</span>
                            <span>${post.community || 'General'}</span>
                            <span>•</span>
                            <span>Posted by ${post.author} ${premiumBadge}</span>
                            <span>•</span>
                            <time datetime="${post.timestamp.toISOString()}" title="${preciseTimeAgo}">${timeAgo}</time>
                            ${post.type === 'poll' && post.pollActive ? '<span class="live-indicator"><div class="live-dot"></div>LIVE POLL</span>' : ''}
                        </div>
                        
                        <h2 id="post-title-${post.id}" class="post-title">${this.formatPostContent(post.title, post.isPremium)}</h2>
                        
                        ${post.content ? `<div class="post-text">${this.formatPostContent(post.content, post.isPremium)}</div>` : ''}
                        
                        ${mediaContent}
                        ${pollContent}
                        
                        <div class="post-actions">
                            <div class="post-action-buttons">
                                <button class="post-action-button" onclick="toggleComments('${post.id}')" aria-label="View comments">
                                    <i class="far fa-comment"></i>
                                    <span>${utils.formatNumber(post.comments)} Comments</span>
                                </button>
                                <button class="post-action-button" onclick="sharePost('${post.id}')" aria-label="Share post">
                                    <i class="fas fa-share"></i>
                                    <span>Share</span>
                                </button>
                                <button class="post-action-button" onclick="savePost('${post.id}')" aria-label="Save post">
                                    <i class="far fa-bookmark"></i>
                                    <span>Save</span>
                                </button>
                                <button class="post-action-button" onclick="showPostDetail('${post.id}')" aria-label="View full post">
                                    <i class="fas fa-expand"></i>
                                    <span>Expand</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="comments-${post.id}" class="comments-section">
                    <div class="comment-input">
                        <div class="user-avatar">
                            <span>${stateManager.getState().currentUser?.fullName?.charAt(0) || 'U'}</span>
                        </div>
                        <input type="text" 
                               placeholder="Add a comment..." 
                               onkeypress="if(event.key==='Enter') commentsSystem.addComment('${post.id}', this.value, this)"
                               aria-label="Add a comment">
                        <button class="emoji-picker-btn" 
                                onclick="commentsSystem.showEmojiPicker(event, 'comments-${post.id}')"
                                aria-label="Add emoji">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="btn btn-primary" 
                                onclick="commentsSystem.addComment('${post.id}', this.previousElementSibling.previousElementSibling.value, this.previousElementSibling.previousElementSibling)"
                                style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            Post
                        </button>
                    </div>
                    <div id="comments-list-${post.id}" role="list" aria-label="Comments">
                        ${this.renderCommentsForPost(post)}
                    </div>
                </div>
            </article>
        `;
    }

    renderMediaContent(media, postId) {
        if (media.length === 1) {
            const item = media[0];
            if (item.type === 'image') {
                return `
                    <div class="media-grid single">
                        <img src="${item.url}" 
                             alt="${item.name}" 
                             class="post-image" 
                             onclick="openMediaViewer('${item.url}', 'image')"
                             loading="lazy">
                    </div>
                `;
            } else if (item.type === 'video') {
                return `
                    <div class="media-grid single">
                        <div class="video-container">
                            <video class="post-video" 
                                   onclick="openMediaViewer('${item.url}', 'video')"
                                   preload="metadata">
                                <source src="${item.url}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="video-controls">
                                <button class="play-pause-btn" onclick="toggleVideoPlayback(this)">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                                <div class="volume-control">
                                    <i class="fas fa-volume-up"></i>
                                    <input type="range" class="volume-slider" min="0" max="100" value="50">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else if (media.length === 2) {
            return `
                <div class="media-grid double">
                    ${media.map(item => {
                        if (item.type === 'image') {
                            return `<img src="${item.url}" alt="${item.name}" class="post-image" onclick="openMediaViewer('${item.url}', 'image')" loading="lazy">`;
                        } else {
                            return `<video src="${item.url}" class="post-video" onclick="openMediaViewer('${item.url}', 'video')" preload="metadata"></video>`;
                        }
                    }).join('')}
                </div>
            `;
        } else {
            return `
                <div class="media-grid multiple">
                    ${media.slice(0, 4).map((item, index) => {
                        const overlay = index === 3 && media.length > 4 ? `<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">+${media.length - 4}</div>` : '';
                        
                        if (item.type === 'image') {
                            return `<div style="position: relative;"><img src="${item.url}" alt="${item.name}" class="post-image" onclick="openMediaViewer('${item.url}', 'image')" loading="lazy">${overlay}</div>`;
                        } else {
                            return `<div style="position: relative;"><video src="${item.url}" class="post-video" onclick="openMediaViewer('${item.url}', 'video')" preload="metadata"></video>${overlay}</div>`;
                        }
                    }).join('')}
                </div>
            `;
        }
    }

    renderPollContent(post) {
        const state = stateManager.getState();
        const hasVoted = state.currentUser && post.pollOptions.some(option => 
            option.voters && option.voters.includes(state.currentUser.userId)
        );

        return `
            <div class="poll-container">
                ${post.pollOptions.map((option, index) => `
                    <div class="poll-option ${hasVoted ? 'voted' : ''}" 
                         onclick="${hasVoted ? '' : `postManager.voteOnPoll('${post.id}', ${index})`}">
                        <div class="poll-option-bar" style="width: ${option.percentage || 0}%"></div>
                        <span class="poll-option-text">${option.text}</span>
                        <span class="poll-option-percentage">${option.percentage || 0}%</span>
                    </div>
                `).join('')}
                <div class="poll-stats">
                    ${utils.formatNumber(post.totalVotes || 0)} votes • ${post.pollActive ? 'Active' : 'Ended'}
                    ${post.pollActive ? '<span class="live-indicator"><div class="live-dot"></div>LIVE</span>' : ''}
                </div>
            </div>
        `;
    }

    renderCommentsForPost(post) {
        if (!post.commentsData || post.commentsData.length === 0) {
            return '<p style="color: #666; text-align: center; padding: 1rem;">No comments yet. Be the first to comment!</p>';
        }

        return post.commentsData.map(comment => commentsSystem.renderComment(comment, post.id)).join('');
    }

    formatPostContent(content, isPremium) {
        if (isPremium) {
            // Apply premium formatting
            content = content.replace(/\*\*(.*?)\*\*/g, '<span class="disco-text">$1</span>');
            
            // Replace premium emojis
            CONFIG.PREMIUM_EMOJIS.forEach(emoji => {
                content = content.replace(new RegExp(emoji, 'g'), `<span class="premium-emoji">${emoji}</span>`);
            });
        }
        
        // Convert URLs to links
        content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        
        // Convert hashtags
        content = content.replace(/#(\w+)/g, '<span style="color: var(--primary-color); cursor: pointer;" onclick="searchHashtag(\'$1\')">#$1</span>');
        
        return content;
    }
}

// Initialize Post Manager
const postManager = new PostManager();

// Community Management
class CommunityManager {
    constructor() {
        this.communities = stateManager.getState().communities;
    }

    async createCommunity(communityData) {
        const state = stateManager.getState();
        
        // Validate community name
        const nameValidation = nameValidator.checkAvailability(communityData.name);
        if (!nameValidation.available) {
            throw new Error(nameValidation.message);
        }

        // Additional community-specific validation
        if (communityData.name.includes(' ')) {
            throw new Error('Community names cannot contain spaces');
        }

        if (communityData.name.length < 3 || communityData.name.length > 21) {
            throw new Error('Community name must be between 3 and 21 characters');
        }

        const newCommunity = {
            id: utils.generateId(),
            name: communityData.name.toLowerCase().replace(/[^a-z0-9-]/g, ''),
            displayName: communityData.displayName,
            description: communityData.description || "",
            type: communityData.type || 'public',
            createdBy: state.currentUser ? state.currentUser.fullName : "Anonymous",
            createdByUserId: state.currentUser ? state.currentUser.userId : "anonymous",
            createdAt: new Date().toISOString(),
            memberCount: 1,
            topics: communityData.topics ? communityData.topics.split(',').map(t => t.trim().toLowerCase()) : [],
            members: [state.currentUser ? state.currentUser.userId : "anonymous"],
            moderators: [state.currentUser ? state.currentUser.userId : "anonymous"],
            rules: [],
            settings: {
                allowPolls: true,
                allowMedia: true,
                requireApproval: communityData.type === 'private',
                allowStories: true
            }
        };

        const updatedCommunities = [...state.communities, newCommunity];
        const updatedUserCreatedCommunities = [...state.userCreatedCommunities, newCommunity.id];
        
        stateManager.setState({ 
            communities: updatedCommunities,
            userCreatedCommunities: updatedUserCreatedCommunities,
            totalCommunities: updatedCommunities.length
        });

        utils.showNotification(`Community "${communityData.displayName}" created successfully!`, 'success');
        this.updateCommunitiesDisplay();
        
        return newCommunity;
    }

    joinCommunity(communityId) {
        const state = stateManager.getState();
        const community = state.communities.find(c => c.id === communityId);
        
        if (!community || !state.currentUser) return;

        const userId = state.currentUser.userId;
        
        if (community.members.includes(userId)) {
            utils.showNotification('You are already a member of this community', 'info');
            return;
        }

        if (community.type === 'private') {
            utils.showNotification('Join request sent! You will be notified when approved.', 'info');
            // In a real app, this would send a request to moderators
            return;
        }

        community.members.push(userId);
        community.memberCount++;

        const updatedUserMemberships = [...state.userMemberships, communityId];
        
        stateManager.setState({ 
            communities: state.communities,
            userMemberships: updatedUserMemberships
        });

        utils.showNotification(`Joined ${community.displayName}!`, 'success');
        this.updateCommunitiesDisplay();
    }

    leaveCommunity(communityId) {
        const state = stateManager.getState();
        const community = state.communities.find(c => c.id === communityId);
        
        if (!community || !state.currentUser) return;

        const userId = state.currentUser.userId;
        
        if (!community.members.includes(userId)) {
            utils.showNotification('You are not a member of this community', 'info');
            return;
        }

        // Check if user is the creator
        if (community.createdByUserId === userId) {
            if (confirm('You are the creator of this community. Leaving will transfer ownership to another moderator. Continue?')) {
                // Transfer ownership logic would go here
            } else {
                return;
            }
        }

        community.members = community.members.filter(id => id !== userId);
        community.memberCount--;

        const updatedUserMemberships = state.userMemberships.filter(id => id !== communityId);
        
        stateManager.setState({ 
            communities: state.communities,
            userMemberships: updatedUserMemberships
        });

        utils.showNotification(`Left ${community.displayName}`, 'info');
        this.updateCommunitiesDisplay();
    }

    deleteCommunity(communityId) {
        const state = stateManager.getState();
        const community = state.communities.find(c => c.id === communityId);
        
        if (!community || !state.currentUser) return;

        if (community.createdByUserId !== state.currentUser.userId) {
            utils.showNotification('Only the community creator can delete the community', 'error');
            return;
        }

        if (confirm(`Are you sure you want to delete "${community.displayName}"? This action cannot be undone.`)) {
            const updatedCommunities = state.communities.filter(c => c.id !== communityId);
            const updatedUserCreatedCommunities = state.userCreatedCommunities.filter(id => id !== communityId);
            const updatedUserMemberships = state.userMemberships.filter(id => id !== communityId);
            
            // Remove community posts
            const updatedPosts = state.posts.filter(post => post.communityId !== communityId);
            
            stateManager.setState({ 
                communities: updatedCommunities,
                userCreatedCommunities: updatedUserCreatedCommunities,
                userMemberships: updatedUserMemberships,
                posts: updatedPosts,
                totalCommunities: updatedCommunities.length
            });

            utils.showNotification(`Community "${community.displayName}" deleted`, 'success');
            this.updateCommunitiesDisplay();
            hideModal('community-detail-modal');
        }
    }

    searchCommunities(query) {
        const state = stateManager.getState();
        
        if (!query || query.length < 2) {
            this.displayCommunities(state.communities);
            return;
        }

        const filteredCommunities = state.communities.filter(community => {
            const searchText = `${community.name} ${community.displayName} ${community.description}`.toLowerCase();
            return searchText.includes(query.toLowerCase());
        });

        this.displayCommunities(filteredCommunities);
    }

    filterCommunities(type) {
        const state = stateManager.getState();
        let filteredCommunities;

        switch (type) {
            case 'public':
                filteredCommunities = state.communities.filter(c => c.type === 'public');
                break;
            case 'private':
                filteredCommunities = state.communities.filter(c => c.type === 'private');
                break;
            default:
                filteredCommunities = state.communities;
        }

        this.displayCommunities(filteredCommunities);
        
        // Update tab buttons
        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        
        const activeBtn = document.querySelector(`[data-tab="${type}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
            activeBtn.setAttribute('aria-selected', 'true');
        }
    }

    displayCommunities(communities) {
        const container = document.getElementById('communitiesBrowseList');
        const noResultsMessage = document.getElementById('noCommunitiesMessage');
        
        if (!container) return;

        if (communities.length === 0) {
            container.innerHTML = '';
            noResultsMessage.classList.remove('hidden');
            return;
        }

        noResultsMessage.classList.add('hidden');
        container.innerHTML = communities.map(community => this.renderCommunityCard(community)).join('');
    }

    renderCommunityCard(community) {
        const state = stateManager.getState();
        const isMember = state.userMemberships.includes(community.id);
        const isCreator = community.createdByUserId === state.currentUser?.userId;
        
        return `
            <div class="community-card" style="background: var(--surface-secondary); border-radius: var(--radius-lg); padding: var(--spacing-md); cursor: pointer;" onclick="showCommunityDetail('${community.id}')">
                <div style="display: flex; align-items: center; margin-bottom: var(--spacing-sm);">
                    <div class="community-icon ${utils.getCommunityColor(community.name)}" style="width: 40px; height: 40px; font-size: var(--font-size-lg);">
                        ${community.displayName.charAt(0)}
                    </div>
                    <div style="margin-left: var(--spacing-md); flex: 1;">
                        <h4 style="margin: 0; color: var(--text-primary);">${community.displayName}</h4>
                        <p style="margin: 0; font-size: var(--font-size-xs); color: var(--text-muted);">r/${community.name}</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: var(--font-size-sm); font-weight: bold; color: var(--primary-color);">
                            ${utils.formatNumber(community.memberCount)}
                        </div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-muted);">members</div>
                    </div>
                </div>
                
                <p style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-md); line-height: 1.4;">
                    ${community.description || 'No description available'}
                </p>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: var(--spacing-xs);">
                        ${community.topics.slice(0, 3).map(topic => 
                            `<span style="background: var(--primary-color); color: white; padding: 2px 6px; border-radius: var(--radius-sm); font-size: 10px;">${topic}</span>`
                        ).join('')}
                        ${community.topics.length > 3 ? `<span style="color: var(--text-muted); font-size: 10px;">+${community.topics.length - 3}</span>` : ''}
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        ${community.type === 'private' ? '<i class="fas fa-lock" style="color: var(--warning-color);" title="Private Community"></i>' : ''}
                        ${isMember ? '<span class="feature-badge"><i class="fas fa-check"></i> Joined</span>' : ''}
                        ${isCreator ? '<span class="premium-badge"><i class="fas fa-crown"></i> Owner</span>' : ''}
                    </div>
                </div>
            </div>
        `;
    }

    showCommunityDetail(communityId) {
        const state = stateManager.getState();
        const community = state.communities.find(c => c.id === communityId);
        
        if (!community) return;

        const isMember = state.userMemberships.includes(communityId);
        const isCreator = community.createdByUserId === state.currentUser?.userId;
        const communityPosts = state.posts.filter(post => post.communityId === communityId).slice(0, 5);

        // Update modal content
        document.getElementById('communityDetailHeader').innerHTML = `
            <div style="display: flex; align-items: center;">
                <div class="community-icon ${utils.getCommunityColor(community.name)}" style="width: 60px; height: 60px; font-size: var(--font-size-2xl); margin-right: var(--spacing-md);">
                    ${community.displayName.charAt(0)}
                </div>
                <div>
                    <h3 style="margin: 0;">${community.displayName}</h3>
                    <p style="margin: 0; color: var(--text-muted);">r/${community.name} • ${community.type} community</p>
                </div>
            </div>
            <button id="closeCommunityDetailModal" class="modal-close" aria-label="Close community detail modal">
                <i class="fas fa-times"></i>
            </button>
        `;

        document.getElementById('communityDetailDescription').textContent = community.description || 'No description available';
        document.getElementById('communityCreator').textContent = community.createdBy;
        document.getElementById('communityCreationDate').textContent = new Date(community.createdAt).toLocaleDateString();
        document.getElementById('communityMemberCount').textContent = utils.formatNumber(community.memberCount);
        document.getElementById('communityType').textContent = community.type.charAt(0).toUpperCase() + community.type.slice(1);

        // Update topics
        const topicsContainer = document.getElementById('communityTopics');
        if (community.topics.length > 0) {
            topicsContainer.innerHTML = community.topics.map(topic => 
                `<span style="display: inline-block; background: var(--primary-color); color: white; padding: 4px 8px; border-radius: var(--radius-sm); font-size: var(--font-size-xs); margin: 2px;">${topic}</span>`
            ).join('');
        } else {
            topicsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: var(--font-size-sm);">No topics specified</p>';
        }

        // Update posts
        const postsContainer = document.getElementById('communityPosts');
        if (communityPosts.length > 0) {
            postsContainer.innerHTML = communityPosts.map(post => `
                <div style="background: var(--surface-color); padding: var(--spacing-sm); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); cursor: pointer;" onclick="showPostDetail('${post.id}')">
                    <h5 style="margin: 0 0 var(--spacing-xs) 0; font-size: var(--font-size-sm);">${post.title}</h5>
                    <p style="margin: 0; font-size: var(--font-size-xs); color: var(--text-muted);">
                        ${post.votes} votes • ${post.comments} comments • ${utils.getTimeAgo(post.timestamp)}
                    </p>
                </div>
            `).join('');
        } else {
            postsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: var(--font-size-sm);">No posts yet</p>';
        }

        // Update buttons
        const joinLeaveButton = document.getElementById('joinLeaveButton');
        const deleteButton = document.getElementById('deleteCommunityButton');

        if (isMember) {
            joinLeaveButton.textContent = 'Leave';
            joinLeaveButton.className = 'btn btn-secondary';
            joinLeaveButton.onclick = () => this.leaveCommunity(communityId);
        } else {
            joinLeaveButton.textContent = community.type === 'private' ? 'Request to Join' : 'Join';
            joinLeaveButton.className = 'btn btn-primary';
            joinLeaveButton.onclick = () => this.joinCommunity(communityId);
        }

        if (isCreator) {
            deleteButton.classList.remove('hidden');
            deleteButton.onclick = () => this.deleteCommunity(communityId);
        } else {
            deleteButton.classList.add('hidden');
        }

        showModal('community-detail-modal');
    }

    updateCommunitiesDisplay() {
        const state = stateManager.getState();
        
        // Update created communities
        const createdList = document.getElementById('createdCommunitiesUL');
        if (createdList) {
            const createdCommunities = state.communities.filter(c => 
                state.userCreatedCommunities.includes(c.id)
            );
            
            if (createdCommunities.length === 0) {
                createdList.innerHTML = '<li style="color: var(--text-muted); font-size: var(--font-size-sm); padding: var(--spacing-sm);">No communities created yet</li>';
            } else {
                createdList.innerHTML = createdCommunities.map(community => `
                    <li>
                        <a href="#" onclick="showCommunityDetail('${community.id}')" style="display: flex; align-items: center;">
                            <div class="community-icon ${utils.getCommunityColor(community.name)}">
                                ${community.displayName.charAt(0)}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${community.displayName}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${utils.formatNumber(community.memberCount)} members</div>
                            </div>
                        </a>
                    </li>
                `).join('');
            }
        }

        // Update joined communities
        const joinedList = document.getElementById('joinedCommunitiesUL');
        if (joinedList) {
            const joinedCommunities = state.communities.filter(c => 
                state.userMemberships.includes(c.id)
            );
            
            if (joinedCommunities.length === 0) {
                joinedList.innerHTML = '<li style="color: var(--text-muted); font-size: var(--font-size-sm); padding: var(--spacing-sm);">No communities joined yet</li>';
            } else {
                joinedList.innerHTML = joinedCommunities.map(community => `
                    <li>
                        <a href="#" onclick="showCommunityDetail('${community.id}')" style="display: flex; align-items: center;">
                            <div class="community-icon ${utils.getCommunityColor(community.name)}">
                                ${community.displayName.charAt(0)}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${community.displayName}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${utils.formatNumber(community.memberCount)} members</div>
                            </div>
                        </a>
                    </li>
                `).join('');
            }
        }

        // Update post community dropdown
        this.updatePostCommunityDropdown();
    }

    updatePostCommunityDropdown() {
        const dropdown = document.getElementById('postCommunity');
        if (!dropdown) return;

        const state = stateManager.getState();
        const userCommunities = state.communities.filter(c => 
            state.userMemberships.includes(c.id) || state.userCreatedCommunities.includes(c.id)
        );

        dropdown.innerHTML = '<option value="">Select a community</option>' + 
            userCommunities.map(community => 
                `<option value="${community.id}">${community.displayName}</option>`
            ).join('');
    }
}

// Initialize Community Manager
const communityManager = new CommunityManager();

// Live Updates System
class LiveUpdatesSystem {
    constructor() {
        this.updateInterval = null;
        this.isActive = false;
    }

    start() {
        if (this.isActive) return;
        
        this.isActive = true;
        this.updateInterval = setInterval(() => {
            this.performLiveUpdates();
        }, CONFIG.LIVE_UPDATE_INTERVAL);
        
        console.log('Live updates started');
    }

    stop() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
        this.isActive = false;
        console.log('Live updates stopped');
    }

    performLiveUpdates() {
        const state = stateManager.getState();
        
        // Simulate live stats updates
        const updates = {
            onlineUsers: this.simulateStatChange(state.onlineUsers, 100000, 150000),
            activePolls: this.simulateStatChange(state.activePolls, 1000, 2000),
            postsToday: this.simulateStatChange(state.postsToday, 40000, 60000),
            liveStories: this.simulateStatChange(state.liveStories, 1500, 3000)
        };

        // Update DOM elements
        this.updateStatElement('onlineUsers', updates.onlineUsers);
        this.updateStatElement('activePolls', updates.activePolls);
        this.updateStatElement('postsToday', updates.postsToday);
        this.updateStatElement('liveStories', updates.liveStories);

        // Update state
        stateManager.setState(updates);

        // Occasionally show update indicator
        if (Math.random() < 0.1) { // 10% chance
            this.showUpdateIndicator();
        }
    }

    simulateStatChange(currentValue, min, max) {
        const change = Math.floor(Math.random() * 21) - 10; // -10 to +10
        const newValue = Math.max(min, Math.min(max, currentValue + change));
        return newValue;
    }

    updateStatElement(elementId, newValue) {
        const element = document.getElementById(elementId);
        if (element) {
            const formattedValue = utils.formatNumber(newValue);
            if (element.textContent !== formattedValue) {
                element.textContent = formattedValue;
                element.style.animation = 'pulse 0.5s ease';
                setTimeout(() => {
                    element.style.animation = '';
                }, 500);
            }
        }
    }

    showUpdateIndicator() {
        const indicator = document.getElementById('update-indicator');
        if (indicator) {
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }
    }
}

// Initialize Live Updates System
const liveUpdatesSystem = new LiveUpdatesSystem();

// Theme Management
class ThemeManager {
    constructor() {
        this.currentTheme = 'dark'; // Default theme
        this.loadTheme();
    }

    toggleTheme() {
        this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        this.applyTheme();
        this.saveTheme();
        
        utils.showNotification(`Switched to ${this.currentTheme} mode`, 'info');
    }

    applyTheme() {
        const root = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        
        if (this.currentTheme === 'light') {
            root.style.setProperty('--background-color', '#ffffff');
            root.style.setProperty('--surface-color', '#f8f9fa');
            root.style.setProperty('--surface-secondary', '#e9ecef');
            root.style.setProperty('--text-primary', '#212529');
            root.style.setProperty('--text-secondary', '#495057');
            root.style.setProperty('--text-muted', '#6c757d');
            root.style.setProperty('--border-color', '#dee2e6');
            
            if (themeToggle) {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                themeToggle.setAttribute('aria-label', 'Switch to dark mode');
            }
        } else {
            root.style.setProperty('--background-color', '#000000');
            root.style.setProperty('--surface-color', '#1a1a1a');
            root.style.setProperty('--surface-secondary', '#2a2a2a');
            root.style.setProperty('--text-primary', '#ffffff');
            root.style.setProperty('--text-secondary', '#cccccc');
            root.style.setProperty('--text-muted', '#666666');
            root.style.setProperty('--border-color', '#404040');
            
            if (themeToggle) {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggle.setAttribute('aria-label', 'Switch to light mode');
            }
        }
    }

    saveTheme() {
        localStorage.setItem('smilex_theme', this.currentTheme);
        stateManager.setState({ darkMode: this.currentTheme === 'dark' });
    }

    loadTheme() {
        const saved = localStorage.getItem('smilex_theme');
        if (saved) {
            this.currentTheme = saved;
        }
        this.applyTheme();
    }
}

// Initialize Theme Manager
const themeManager = new ThemeManager();

// Chat System
class ChatSystem {
    constructor() {
        this.isOpen = false;
        this.messages = [
            {
                id: 1,
                user: 'Support Agent',
                text: 'Hello! How can we help you today?',
                timestamp: new Date(),
                type: 'agent'
            }
        ];
    }

    toggle() {
        this.isOpen = !this.isOpen;
        const container = document.getElementById('chat-container');
        
        if (this.isOpen) {
            container.classList.add('active');
        } else {
            container.classList.remove('active');
        }
    }

    sendMessage(text) {
        if (!text.trim()) return;

        const userMessage = {
            id: Date.now(),
            user: stateManager.getState().currentUser?.fullName || 'User',
            text: text.trim(),
            timestamp: new Date(),
            type: 'user'
        };

        this.messages.push(userMessage);
        this.renderMessages();

        // Simulate agent response
        setTimeout(() => {
            const responses = [
                "Thanks for your message! Our team will get back to you soon.",
                "I understand your concern. Let me help you with that.",
                "That's a great question! Here's what I can tell you...",
                "I'll make sure to pass this along to the right team.",
                "Is there anything else I can help you with today?"
            ];

            const agentMessage = {
                id: Date.now() + 1,
                user: 'Support Agent',
                text: responses[Math.floor(Math.random() * responses.length)],
                timestamp: new Date(),
                type: 'agent'
            };

            this.messages.push(agentMessage);
            this.renderMessages();
        }, 1000 + Math.random() * 2000);

        // Clear input
        const input = document.getElementById('chat-input');
        if (input) input.value = '';
    }

    renderMessages() {
        const container = document.getElementById('chat-messages');
        if (!container) return;

        container.innerHTML = this.messages.map(message => `
            <div class="message ${message.type}">
                <div class="message-user">${message.user}</div>
                <div class="message-text">${message.text}</div>
                <div class="message-time">${utils.getTimeAgo(message.timestamp)}</div>
            </div>
        `).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }
}

// Initialize Chat System
const chatSystem = new ChatSystem();

// Notification System
function updateNotificationBadge() {
    const state = stateManager.getState();
    const badge = document.getElementById('notificationBadge');
    const unreadCount = state.notifications.filter(n => !n.read).length;
    
    if (badge) {
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Global Functions (called from HTML)
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Focus management for accessibility
        const firstFocusable = modal.querySelector('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (firstFocusable) {
            firstFocusable.focus();
        }
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

function showProfileUploadOptions() {
    // This function is called when clicking the profile preview
    // The actual upload options are already visible as buttons
}

function openCamera() {
    profileManager.openCamera();
}

function openFileUpload() {
    document.getElementById('profileImageInput').click();
}

function closeCamera() {
    profileManager.closeCamera();
}

function capturePhoto() {
    profileManager.capturePhoto();
}

function handleProfileImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        profileManager.handleFileUpload(file);
    }
}

function checkNameAvailability(name) {
    const result = nameValidator.checkAvailability(name);
    nameValidator.displayValidation('nameValidation', result);
    
    // Update submit button state
    updateSubmitButtonState();
}

function validateCommunityName(name) {
    const result = nameValidator.checkAvailability(name);
    nameValidator.displayValidation('communityNameValidation', result);
}

function applySuggestion(suggestion) {
    const nameInput = document.getElementById('fullName') || document.getElementById('communityName');
    if (nameInput) {
        nameInput.value = suggestion;
        nameInput.dispatchEvent(new Event('input'));
    }
}

function updateSubmitButtonState() {
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!form || !submitBtn) return;
    
    const requiredFields = form.querySelectorAll('[required]');
    const allValid = Array.from(requiredFields).every(field => {
        if (field.type === 'checkbox') {
            return field.checked;
        }
        return field.value.trim() !== '';
    });
    
    const nameValidation = document.getElementById('nameValidation');
    const nameValid = !nameValidation || nameValidation.classList.contains('name-available');
    
    submitBtn.disabled = !(allValid && nameValid);
}

function performGlobalSearch(query) {
    searchSystem.performSearch(query);
}

function navigateToResult(type, id) {
    searchSystem.hideSearchResults();
    
    switch (type) {
        case 'post':
            showPostDetail(id);
            break;
        case 'community':
            communityManager.showCommunityDetail(id);
            break;
        case 'user':
            // User profile functionality would go here
            utils.showNotification('User profiles coming soon!', 'info');
            break;
    }
}

function searchHashtag(hashtag) {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = `#${hashtag}`;
        performGlobalSearch(`#${hashtag}`);
    }
}

function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (commentsSection) {
        commentsSection.classList.toggle('active');
    }
}

function sharePost(postId) {
    if (navigator.share) {
        navigator.share({
            title: 'Check out this post on SmileX',
            url: window.location.href + `#post-${postId}`
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href + `#post-${postId}`);
        utils.showNotification('Post link copied to clipboard!', 'success');
    }
}

function savePost(postId) {
    utils.showNotification('Post saved!', 'success');
    // Save functionality would be implemented here
}

function showPostDetail(postId) {
    const state = stateManager.getState();
    const post = state.posts.find(p => p.id === postId);
    
    if (!post) return;
    
    const modalContent = document.getElementById('postDetailContent');
    if (modalContent) {
        modalContent.innerHTML = `
            <div class="modal-header">
                <h3>Post Details</h3>
                <button onclick="hideModal('post-detail-modal')" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                ${postManager.renderPost(post)}
            </div>
        `;
    }
    
    showModal('post-detail-modal');
}

function likeComment(commentId) {
    utils.showNotification('Comment liked!', 'success');
    // Like functionality would be implemented here
}

function showReplyInput(commentId, postId) {
    const replyInput = document.getElementById(`reply-input-${commentId}`);
    if (replyInput) {
        replyInput.style.display = replyInput.style.display === 'none' ? 'flex' : 'none';
        if (replyInput.style.display === 'flex') {
            const input = replyInput.querySelector('input');
            if (input) input.focus();
        }
    }
}

function addReply(postId, parentCommentId, replyText, inputElement) {
    commentsSystem.addComment(postId, replyText, inputElement, parentCommentId);
    
    // Hide reply input
    const replyInput = document.getElementById(`reply-input-${parentCommentId}`);
    if (replyInput) {
        replyInput.style.display = 'none';
    }
}

function insertEmoji(emoji) {
    commentsSystem.insertEmoji(emoji);
}

function openMediaViewer(url, type) {
    const content = document.getElementById('mediaViewerContent');
    if (content) {
        if (type === 'image') {
            content.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="Media viewer">`;
        } else if (type === 'video') {
            content.innerHTML = `<video src="${url}" controls style="max-width: 100%; max-height: 100%;" autoplay></video>`;
        }
    }
    showModal('media-viewer-modal');
}

function toggleVideoPlayback(button) {
    const video = button.closest('.video-container').querySelector('video');
    const icon = button.querySelector('i');
    
    if (video.paused) {
        video.play();
        icon.className = 'fas fa-pause';
    } else {
        video.pause();
        icon.className = 'fas fa-play';
    }
}

function createStory() {
    storyManager.createStory();
}

function viewStory(userId) {
    storyManager.viewStory(userId);
}

function searchCommunities(query) {
    communityManager.searchCommunities(query);
}

function filterCommunities(type) {
    communityManager.filterCommunities(type);
}

function showCommunityDetail(communityId) {
    communityManager.showCommunityDetail(communityId);
}

function toggleUserMenu() {
    utils.showNotification('User menu coming soon!', 'info');
}

// Form Handlers
function handleRegistrationSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const userData = {
        fullName: formData.get('fullName'),
        email: formData.get('email'),
        gender: formData.get('gender'),
        country: formData.get('country'),
        ageConsent: formData.get('ageConsent'),
        termsConsent: formData.get('termsConsent'),
        privacyConsent: formData.get('privacyConsent'),
        userId: utils.generateId(),
        createdAt: new Date().toISOString(),
        profileImage: null
    };

    // Store user data
    const state = stateManager.getState();
    const updatedUsers = [...state.registeredUsers, userData];
    
    stateManager.setState({ 
        currentUser: userData,
        registeredUsers: updatedUsers
    });

    // Store in localStorage for persistence
    localStorage.setItem('smilex_user', JSON.stringify(userData));

    // Update UI
    updateUserInterface(userData);
    hideModal('onboardingOverlay');
    
    utils.showNotification(`Welcome to SmileX, ${userData.fullName}!`, 'success');
}

function handleCreatePostSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const postData = {
        postType: formData.get('postType'),
        visibility: formData.get('visibility'),
        community: formData.get('community'),
        title: formData.get('title'),
        content: formData.get('content')
    };

    // Add poll options if it's a poll
    if (postData.postType === 'poll') {
        const pollInputs = document.querySelectorAll('.poll-option-input');
        pollInputs.forEach((input, index) => {
            if (input.value.trim()) {
                postData[`option${index + 1}`] = input.value.trim();
            }
        });
    }

    try {
        postManager.createPost(postData);
        hideModal('create-post-modal');
        event.target.reset();
        
        // Reset form state
        handlePostTypeChange({ target: { value: 'text' } });
        handleVisibilityChange({ target: { value: 'general' } });
        
    } catch (error) {
        utils.showNotification(error.message, 'error');
    }
}

function handleCreateCommunitySubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const communityData = {
        name: formData.get('name'),
        displayName: formData.get('displayName'),
        description: formData.get('description'),
        type: formData.get('type'),
        topics: formData.get('topics')
    };

    try {
        communityManager.createCommunity(communityData);
        hideModal('create-community-modal');
        event.target.reset();
    } catch (error) {
        utils.showNotification(error.message, 'error');
    }
}

function handlePostTypeChange(event) {
    const postType = event.target.value;
    const contentContainer = document.getElementById('contentContainer');
    const pollContainer = document.getElementById('pollOptionsContainer');
    const mediaContainer = document.getElementById('mediaUploadContainer');

    // Reset visibility
    contentContainer.classList.remove('hidden');
    pollContainer.classList.add('hidden');
    mediaContainer.classList.remove('hidden');

    switch (postType) {
        case 'poll':
            pollContainer.classList.remove('hidden');
            mediaContainer.classList.add('hidden');
            break;
        case 'story':
            contentContainer.classList.add('hidden');
            break;
    }
}

function handleVisibilityChange(event) {
    const visibility = event.target.value;
    const communityContainer = document.getElementById('postCommunityContainer');
    
    if (visibility === 'community') {
        communityContainer.classList.remove('hidden');
        communityManager.updatePostCommunityDropdown();
    } else {
        communityContainer.classList.add('hidden');
    }
}

function addPollOption() {
    const container = document.getElementById('pollOptions');
    const currentOptions = container.querySelectorAll('.poll-option-input').length;
    
    if (currentOptions >= CONFIG.MAX_POLL_OPTIONS) {
        utils.showNotification(`Maximum ${CONFIG.MAX_POLL_OPTIONS} options allowed`, 'warning');
        return;
    }
    
    const newOption = document.createElement('input');
    newOption.type = 'text';
    newOption.className = 'form-control poll-option-input';
    newOption.placeholder = `Option ${currentOptions + 1}`;
    newOption.style.marginBottom = 'var(--spacing-sm)';
    
    container.appendChild(newOption);
    newOption.focus();
}

function removeMedia(fileName) {
    mediaManager.removeMedia(fileName);
}

function updateUserInterface(userData) {
    // Update user avatar and initials throughout the UI
    const userInitials = userData.fullName.charAt(0).toUpperCase();
    
    document.querySelectorAll('#userInitial, #createPostUserInitial').forEach(element => {
        element.textContent = userInitials;
    });

    // Update profile image if available
    if (userData.profileImage) {
        document.querySelectorAll('#userAvatar, .user-avatar').forEach(avatar => {
            avatar.innerHTML = `<img src="${userData.profileImage}" alt="Profile picture">`;
        });
    }

    // Update communities display
    communityManager.updateCommunitiesDisplay();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Hide preloader
    setTimeout(() => {
        const preloader = document.getElementById('preloader');
        if (preloader) {
            preloader.style.opacity = '0';
            setTimeout(() => {
                preloader.style.display = 'none';
            }, 500);
        }
    }, 2000);

    // Check for existing user
    const existingUser = localStorage.getItem('smilex_user');
    if (existingUser) {
        try {
            const userData = JSON.parse(existingUser);
            stateManager.setState({ currentUser: userData });
            updateUserInterface(userData);
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    } else {
        // Show onboarding for new users
        setTimeout(() => {
            showModal('onboardingOverlay');
        }, 2500);
    }

    // Form event listeners
    const registrationForm = document.getElementById('registrationForm');
    if (registrationForm) {
        registrationForm.addEventListener('submit', handleRegistrationSubmit);
        
        // Add input listeners for real-time validation
        registrationForm.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', updateSubmitButtonState);
            input.addEventListener('change', updateSubmitButtonState);
        });
    }

    const createPostForm = document.getElementById('createPostForm');
    if (createPostForm) {
        createPostForm.addEventListener('submit', handleCreatePostSubmit);
    }

    const createCommunityForm = document.getElementById('createCommunityForm');
    if (createCommunityForm) {
        createCommunityForm.addEventListener('submit', handleCreateCommunitySubmit);
    }

    // Post type change handler
    const postTypeSelect = document.getElementById('postType');
    if (postTypeSelect) {
        postTypeSelect.addEventListener('change', handlePostTypeChange);
    }

    // Visibility change handler
    const visibilitySelect = document.getElementById('postVisibility');
    if (visibilitySelect) {
        visibilitySelect.addEventListener('change', handleVisibilityChange);
    }

    // Media upload handlers
    const mediaUploadArea = document.getElementById('mediaUploadArea');
    const mediaInput = document.getElementById('mediaInput');
    
    if (mediaUploadArea && mediaInput) {
        mediaUploadArea.addEventListener('click', () => mediaInput.click());
        
        mediaUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            mediaUploadArea.classList.add('dragover');
        });
        
        mediaUploadArea.addEventListener('dragleave', () => {
            mediaUploadArea.classList.remove('dragover');
        });
        
        mediaUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            mediaUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            mediaManager.handleFiles(files);
        });
        
        mediaInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            mediaManager.handleFiles(files);
        });
    }

    // Navigation handlers
    document.getElementById('createPostInput')?.addEventListener('click', () => {
        showModal('create-post-modal');
    });

    document.querySelectorAll('.post-type-button').forEach(button => {
        button.addEventListener('click', () => {
            const postType = button.dataset.postType;
            showModal('create-post-modal');
            
            setTimeout(() => {
                const postTypeSelect = document.getElementById('postType');
                if (postTypeSelect) {
                    postTypeSelect.value = postType;
                    handlePostTypeChange({ target: { value: postType } });
                }
            }, 100);
        });
    });

    document.getElementById('createCommunityBtn')?.addEventListener('click', () => {
        showModal('create-community-modal');
    });

    document.getElementById('browseCommunityBtn')?.addEventListener('click', () => {
        showModal('browse-communities-modal');
        communityManager.displayCommunities(stateManager.getState().communities);
    });

    // Mobile navigation
    document.getElementById('mobileBrowseBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        showModal('browse-communities-modal');
        communityManager.displayCommunities(stateManager.getState().communities);
    });

    document.getElementById('mobileCreatePost')?.addEventListener('click', (e) => {
        e.preventDefault();
        showModal('create-post-modal');
    });

    document.getElementById('mobileCreateCommunity')?.addEventListener('click', (e) => {
        e.preventDefault();
        showModal('create-community-modal');
    });

    // Sort buttons
    document.querySelectorAll('.sort-button[data-sort]').forEach(button => {
        button.addEventListener('click', () => {
            const sortType = button.dataset.sort;
            
            // Update active state
            document.querySelectorAll('.sort-button[data-sort]').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
            });
            
            button.classList.add('active');
            button.setAttribute('aria-pressed', 'true');
            
            // Update state and re-render
            stateManager.setState({ currentSort: sortType });
            postManager.renderPosts();
        });
    });

    // Feed filter
    const feedFilter = document.getElementById('feedFilter');
    if (feedFilter) {
        feedFilter.addEventListener('change', (e) => {
            stateManager.setState({ currentFeedFilter: e.target.value });
            postManager.renderPosts();
        });
    }

    // Theme toggle
    document.getElementById('themeToggle')?.addEventListener('click', () => {
        themeManager.toggleTheme();
    });

    // Chat system
    document.getElementById('chat-toggle-btn')?.addEventListener('click', () => {
        chatSystem.toggle();
    });

    document.getElementById('chat-close-btn')?.addEventListener('click', () => {
        chatSystem.toggle();
    });

    document.getElementById('chat-send-btn')?.addEventListener('click', () => {
        const input = document.getElementById('chat-input');
        if (input) {
            chatSystem.sendMessage(input.value);
        }
    });

    document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            chatSystem.sendMessage(e.target.value);
        }
    });

    // Modal close handlers
    document.querySelectorAll('.modal-close, .overlay').forEach(element => {
        element.addEventListener('click', (e) => {
            if (e.target === element) {
                const modal = element.closest('.modal, .overlay');
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });
    });

    // Story viewer handlers
    document.getElementById('closeStoryViewer')?.addEventListener('click', () => {
        storyManager.closeStoryViewer();
    });

    document.getElementById('closeMediaViewer')?.addEventListener('click', () => {
        hideModal('media-viewer-modal');
    });

    // Community tabs
    document.querySelectorAll('.my-communities-tabs button').forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;
            
            // Update tab states
            document.querySelectorAll('.my-communities-tabs button').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            
            button.classList.add('active');
            button.setAttribute('aria-selected', 'true');
            
            // Show/hide content
            document.querySelectorAll('.communities-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const targetContent = document.getElementById(`${tab}CommunitiesList`);
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
        });
    });

    // Search input handler
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        const debouncedSearch = utils.debounce((query) => {
            performGlobalSearch(query);
        }, 300);
        
        searchInput.addEventListener('input', (e) => {
            debouncedSearch(e.target.value);
        });
        
        searchInput.addEventListener('blur', () => {
            setTimeout(() => {
                searchSystem.hideSearchResults();
            }, 200);
        });
    }

    // Community search handler
    const communitySearchInput = document.getElementById('communitySearchInput');
    if (communitySearchInput) {
        const debouncedCommunitySearch = utils.debounce((query) => {
            searchCommunities(query);
        }, 300);
        
        communitySearchInput.addEventListener('input', (e) => {
            debouncedCommunitySearch(e.target.value);
        });
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        // Escape key closes modals
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal.active, .overlay.active');
            if (activeModal) {
                activeModal.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            // Close emoji picker
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker && emojiPicker.classList.contains('active')) {
                commentsSystem.closeEmojiPicker();
            }
            
            // Close story viewer
            if (storyManager.isViewingStory) {
                storyManager.closeStoryViewer();
            }
        }
        
        // Ctrl/Cmd + K for search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
            }
        }
        
        // Ctrl/Cmd + Enter to submit forms
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                const submitButton = activeModal.querySelector('button[type="submit"], .btn-primary');
                if (submitButton && !submitButton.disabled) {
                    submitButton.click();
                }
            }
        }
    });

    // Click outside to close dropdowns
    document.addEventListener('click', (e) => {
        // Close search results if clicking outside
        if (!e.target.closest('.nav-search')) {
            searchSystem.hideSearchResults();
        }
        
        // Close emoji picker if clicking outside
        if (!e.target.closest('#emojiPicker') && !e.target.closest('.emoji-picker-btn')) {
            commentsSystem.closeEmojiPicker();
        }
    });

    // Initialize components
    postManager.renderPosts();
    communityManager.updateCommunitiesDisplay();
    liveUpdatesSystem.start();
    
    // Update notification badge
    updateNotificationBadge();
    
    // Auto-save functionality
    setInterval(() => {
        // Auto-save draft posts, comments, etc.
        const createPostModal = document.getElementById('create-post-modal');
        if (createPostModal && createPostModal.classList.contains('active')) {
            const formData = new FormData(document.getElementById('createPostForm'));
            const draftData = {
                title: formData.get('title'),
                content: formData.get('content'),
                postType: formData.get('postType'),
                timestamp: new Date().toISOString()
            };
            
            if (draftData.title || draftData.content) {
                localStorage.setItem('smilex_draft_post', JSON.stringify(draftData));
            }
        }
    }, CONFIG.AUTO_SAVE_INTERVAL);

    // Load draft data
    const draftPost = localStorage.getItem('smilex_draft_post');
    if (draftPost) {
        try {
            const draft = JSON.parse(draftPost);
            // Check if draft is recent (within 24 hours)
            const draftAge = Date.now() - new Date(draft.timestamp).getTime();
            if (draftAge < 86400000) { // 24 hours
                // Show notification about draft
                setTimeout(() => {
                    if (confirm('You have an unsaved draft. Would you like to restore it?')) {
                        showModal('create-post-modal');
                        setTimeout(() => {
                            document.getElementById('postTitle').value = draft.title || '';
                            document.getElementById('postContent').value = draft.content || '';
                            document.getElementById('postType').value = draft.postType || 'text';
                        }, 100);
                    } else {
                        localStorage.removeItem('smilex_draft_post');
                    }
                }, 3000);
            } else {
                localStorage.removeItem('smilex_draft_post');
            }
        } catch (error) {
            console.error('Error loading draft:', error);
            localStorage.removeItem('smilex_draft_post');
        }
    }

    // Performance monitoring
    if ('performance' in window) {
        window.addEventListener('load', () => {
            setTimeout(() => {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('SmileX Performance Metrics:', {
                    loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                    domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                    totalTime: perfData.loadEventEnd - perfData.fetchStart
                });
            }, 0);
        });
    }

    // Service Worker registration for PWA functionality
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('ServiceWorker registered successfully');
            })
            .catch(error => {
                console.log('ServiceWorker registration failed');
            });
    }

    // Intersection Observer for infinite scroll
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    if (loadMoreBtn && 'IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Load more posts
                    const state = stateManager.getState();
                    if (state.posts.length > 0) {
                        utils.showNotification('Loading more posts...', 'info');
                        // In a real app, this would fetch more posts from the server
                        setTimeout(() => {
                            utils.showNotification('All posts loaded!', 'success');
                        }, 1000);
                    }
                }
            });
        }, { threshold: 0.1 });
        
        observer.observe(loadMoreBtn);
    }

    // Accessibility improvements
    // Announce dynamic content changes to screen readers
    const announcer = document.createElement('div');
    announcer.setAttribute('aria-live', 'polite');
    announcer.setAttribute('aria-atomic', 'true');
    announcer.className = 'sr-only';
    document.body.appendChild(announcer);

    // Subscribe to state changes for announcements
    stateManager.subscribe((state) => {
        // Announce new posts
        if (state.posts && state.posts.length > 0) {
            const latestPost = state.posts[0];
            if (latestPost.timestamp > Date.now() - 10000) { // Within last 10 seconds
                announcer.textContent = `New post: ${latestPost.title} by ${latestPost.author}`;
            }
        }
    });

    // Focus management for modals
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                const focusableElements = modal.querySelectorAll(
                    'button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (e.shiftKey && document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                } else if (!e.shiftKey && document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        });
    });

    console.log('🎉 SmileX Platform Initialized Successfully!');
    console.log('Features loaded:', {
        'User Registration': '✅',
        'Post Creation': '✅',
        'Community Management': '✅',
        'Live Polls': '✅',
        'Stories': '✅',
        'Advanced Search': '✅',
        'Real-time Updates': '✅',
        'Premium Features': '✅',
        'Live Chat': '✅',
        'Dark Mode': '✅',
        'Accessibility': '✅',
        'Mobile Support': '✅'
    });
});

// Global error handler
window.addEventListener('error', (e) => {
    console.error('SmileX Error:', e.error);
    utils.showNotification('Something went wrong. Please try again.', 'error');
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', (e) => {
    console.error('SmileX Promise Rejection:', e.reason);
    utils.showNotification('An unexpected error occurred.', 'error');
    e.preventDefault();
});

// Visibility change handler for live updates
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        liveUpdatesSystem.stop();
    } else {
        liveUpdatesSystem.start();
        // Refresh data when user returns
        postManager.renderPosts();
        updateNotificationBadge();
    }
});

// Online/offline status
window.addEventListener('online', () => {
    utils.showNotification('Connection restored!', 'success');
    liveUpdatesSystem.start();
});

window.addEventListener('offline', () => {
    utils.showNotification('You are offline. Some features may not work.', 'warning');
    liveUpdatesSystem.stop();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    liveUpdatesSystem.stop();
    
    // Close camera stream if active
    if (profileManager.currentStream) {
        profileManager.closeCamera();
    }
    
    // Save any pending data
    stateManager.saveToStorage();
});

    </script>
</body>
</html>
    