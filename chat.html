<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmileX - Advanced Social Platform</title>
    <meta name="description" content="SmileX - A modern social platform for connecting communities and sharing experiences">
    <meta name="keywords" content="social media, communities, chat, posts, networking">
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Color Variables */
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --accent-color: #00b4db;
            --background-color: #000000;
            --surface-color: #1a1a1a;
            --surface-secondary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #666666;
            --border-color: #404040;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --premium-color: #ffd700;
            
            /* Spacing Variables */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Typography Variables */
            --font-primary: 'Orbitron', sans-serif;
            --font-secondary: 'Poppins', sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 2rem;
            
            /* Border Radius Variables */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            
            /* Shadow Variables */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            /* Transition Variables */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Accessibility Improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Styles for Accessibility */
        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Skip Link for Screen Readers */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: var(--radius-md);
            z-index: 10000;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Preloader Styles */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: var(--transition-slow);
        }

        .preloader-logo {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--spacing-md);
            animation: bounce 2s infinite;
        }

        .preloader-text {
            font-size: var(--font-size-2xl);
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-top: var(--spacing-xl);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Onboarding Modal */
        .onboarding-container {
            background: var(--surface-color);
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: scale(0.9);
            transition: var(--transition-normal);
        }

        .overlay.active .onboarding-container {
            transform: scale(1);
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .onboarding-header h2 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-sm);
            color: var(--primary-color);
        }

        /* Profile Picture Upload */
        .profile-pic-section {
            text-align: center;
            margin: var(--spacing-lg) 0;
        }

        .profile-pic-container {
            position: relative;
            display: inline-block;
            margin-bottom: var(--spacing-md);
        }

        .profile-pic-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-3xl);
            color: white;
            border: 4px solid var(--border-color);
            overflow: hidden;
        }

        .profile-pic-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-pic-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }

        .profile-pic-options {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
        }

        /* Username Validation */
        .username-container {
            position: relative;
        }

        .username-status {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: var(--font-size-sm);
        }

        .username-status.checking {
            color: var(--warning-color);
        }

        .username-status.available {
            color: var(--success-color);
        }

        .username-status.taken {
            color: var(--error-color);
        }

        .username-suggestions {
            margin-top: var(--spacing-xs);
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        .username-suggestion {
            display: inline-block;
            background: var(--surface-secondary);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            margin-right: var(--spacing-xs);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .username-suggestion:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            transition: var(--transition-fast);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .form-control.error {
            border-color: var(--error-color);
        }

        .form-control.success {
            border-color: var(--success-color);
        }

        /* Consent Section */
        .consent-section {
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-md);
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
        }

        .consent-item {
            display: flex;
            align-items: center;
            margin: var(--spacing-sm) 0;
        }

        .consent-item input[type="checkbox"] {
            margin-right: var(--spacing-sm);
            width: 16px;
            height: 16px;
        }

        .consent-item label {
            cursor: pointer;
            user-select: none;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
            gap: var(--spacing-xs);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a0fb8;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-premium {
            background: linear-gradient(45deg, var(--premium-color), #ffed4e);
            color: #000;
            font-weight: bold;
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Navigation */
        nav {
            background: var(--background-color);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
        }

        .logo i {
            margin-right: var(--spacing-sm);
            font-size: var(--font-size-2xl);
        }

        .nav-search {
            position: relative;
            display: none;
        }

        @media (min-width: 768px) {
            .nav-search {
                display: block;
            }
        }

        .nav-search input {
            width: 400px;
            padding: 8px 12px 8px 40px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .nav-search i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
        }

        .search-result-item {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .search-result-item:hover {
            background: var(--surface-secondary);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-button {
            padding: var(--spacing-sm);
            background: var(--surface-color);
            border: none;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .nav-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        .nav-button .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: var(--font-size-sm);
            overflow: hidden;
            cursor: pointer;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Main Layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg) var(--spacing-md);
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }

        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            height: fit-content;
            position: sticky;
            top: 80px;
            display: none;
        }

        @media (min-width: 1024px) {
            .sidebar {
                display: block;
            }
        }

        .sidebar h3 {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: var(--spacing-sm);
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: var(--spacing-sm);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
        }

        .sidebar a:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Community Icons */
        .community-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-size-xs);
            font-weight: bold;
        }

        /* Main Feed */
        .main-feed {
            min-height: 100vh;
        }

        /* Create Post Card */
        .create-post-card {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .create-post-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .create-post-input input {
            flex: 1;
            padding: 12px 16px;
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
            cursor: pointer;
        }

        .post-type-buttons {
            display: flex;
            gap: var(--spacing-sm);
        }

        .post-type-button {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: var(--font-size-sm);
        }

        .post-type-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Sort Buttons */
        .sort-buttons {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-sm);
            overflow-x: auto;
        }

        .sort-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            border: none;
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .sort-button.active {
            background: var(--primary-color);
            color: white;
        }

        .sort-button:not(.active) {
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }

        .sort-button:not(.active):hover {
            background: var(--border-color);
        }

        /* Post Cards */
        .post-card {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
            animation: fadeIn 0.5s ease;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .post-content {
            padding: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-md);
        }

        /* Vote Section */
        .vote-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .vote-button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vote-button:hover {
            background: var(--surface-secondary);
        }

        .vote-button.voted-up {
            color: var(--primary-color);
        }

        .vote-button.voted-down {
            color: var(--secondary-color);
        }

        .vote-count {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Post Main Content */
        .post-main {
            flex: 1;
        }

        .post-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
        }

        .post-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            line-height: 1.4;
        }

        .post-text {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }

        .post-image, .post-video {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            cursor: pointer;
        }

        .media-grid {
            display: grid;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .media-grid.single {
            grid-template-columns: 1fr;
        }

        .media-grid.double {
            grid-template-columns: 1fr 1fr;
        }

        .media-grid.multiple {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Post Actions */
        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-action-buttons {
            display: flex;
            gap: var(--spacing-md);
        }

        .post-action-button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-sm);
            cursor: pointer;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .post-action-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Comments Section */
        .comments-section {
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-lg);
            display: none;
        }

        .comments-section.active {
            display: block;
        }

        .comment-input {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            align-items: center;
        }

        .comment-input input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
        }

        .emoji-picker-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .emoji-picker-btn:hover {
            color: var(--primary-color);
        }

        .comment {
            background: var(--surface-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            position: relative;
        }

        .comment-author {
            font-weight: bold;
            color: var(--primary-color);
            font-size: var(--font-size-xs);
            margin-bottom: var(--spacing-xs);
        }

        .comment-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xs);
        }

        .comment-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 11px;
            color: var(--text-muted);
        }

        .comment-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .comment-action {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .comment-action:hover {
            color: var(--primary-color);
        }

        /* Nested Comments */
        .comment-replies {
            margin-left: var(--spacing-lg);
            margin-top: var(--spacing-sm);
            border-left: 2px solid var(--border-color);
            padding-left: var(--spacing-md);
        }

        .reply-input {
            display: none;
            margin-top: var(--spacing-sm);
        }

        .reply-input.active {
            display: flex;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: var(--font-size-xl);
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--surface-secondary);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* Image/Video Upload Area */
        .media-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            text-align: center;
            margin: var(--spacing-md) 0;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .media-upload-area:hover,
        .media-upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(106, 17, 203, 0.1);
        }

        .media-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-md);
            margin: var(--spacing-md) 0;
        }

        .media-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }

        .media-preview-item {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .media-preview-item img,
        .media-preview-item video {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .media-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Chat Styles */
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            font-size: var(--font-size-xl);
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-fast);
            z-index: 100;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
        }

        .chat-container {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            opacity: 0;
            transition: var(--transition-normal);
            z-index: 99;
            border: 1px solid var(--border-color);
        }

        .chat-container.active {
            transform: translateY(0);
            opacity: 1;
        }

        .chat-header {
            padding: var(--spacing-md);
            background: var(--primary-color);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            color: white;
            font-size: var(--font-size-base);
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
        }

        .message {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
        }

        .message.user {
            background: var(--primary-color);
            margin-left: var(--spacing-lg);
        }

        .message.agent {
            background: var(--surface-secondary);
            margin-right: var(--spacing-lg);
        }

        .message-user {
            font-weight: bold;
            color: var(--primary-color);
            font-size: var(--font-size-xs);
            margin-bottom: var(--spacing-xs);
        }

        .message.user .message-user {
            color: white;
        }

        .message-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xs);
        }

        .message.user .message-text {
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .message.user .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-input-container {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-sm);
        }

        .chat-input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
        }

        .chat-send {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .chat-send:hover {
            background: #5a0fb8;
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 64px;
            z-index: 50;
        }

        @media (min-width: 1024px) {
            .mobile-nav {
                display: none;
            }
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition-fast);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
        }

        .mobile-nav-item.active,
        .mobile-nav-item:hover {
            color: var(--primary-color);
        }

        .mobile-nav-item i {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xs);
        }

        .mobile-nav-item span {
            font-size: 10px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition-normal);
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        /* Poll Styles */
        .poll-container {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
        }

        .poll-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            background: var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .poll-option:hover {
            background: #505050;
        }

        .poll-option.voted {
            cursor: default;
        }

        .poll-option-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            opacity: 0.3;
            transition: width 0.5s ease;
        }

        .poll-option-text,
        .poll-option-percentage {
            position: relative;
            z-index: 1;
        }

        .poll-option-percentage {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .poll-stats {
            margin-top: var(--spacing-sm);
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        /* Premium Features */
        .premium-badge {
            background: linear-gradient(45deg, var(--premium-color), #ffed4e);
            color: #000;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: bold;
            margin-left: var(--spacing-xs);
        }

        .premium-modal {
            max-width: 800px;
        }

        .premium-packages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .premium-package {
            background: var(--surface-secondary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            text-align: center;
            border: 2px solid transparent;
            transition: var(--transition-normal);
        }

        .premium-package.featured {
            border-color: var(--premium-color);
            transform: scale(1.05);
        }

        .premium-package:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .package-name {
            font-size: var(--font-size-xl);
            font-weight: bold;
            margin-bottom: var(--spacing-sm);
        }

        .package-price {
            font-size: var(--font-size-3xl);
            font-weight: bold;
            color: var(--premium-color);
            margin-bottom: var(--spacing-md);
        }

        .package-features {
            list-style: none;
            margin-bottom: var(--spacing-xl);
        }

        .package-features li {
            padding: var(--spacing-xs) 0;
            color: var(--text-secondary);
        }

        .package-features li i {
            color: var(--success-color);
            margin-right: var(--spacing-sm);
        }

        /* Community Colors */
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-green-500 { background-color: var(--success-color); }
        .bg-purple-500 { background-color: var(--primary-color); }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-yellow-500 { background-color: var(--warning-color); }
        .bg-pink-500 { background-color: #ec4899; }
        .bg-indigo-500 { background-color: #6366f1; }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: var(--spacing-md);
        }

        .mt-4 {
            margin-top: var(--spacing-md);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: var(--spacing-md) var(--spacing-sm);
                padding-bottom: 80px;
            }
            
            .post-content {
                padding: var(--spacing-md);
            }
            
            .chat-container {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }

            .modal-content {
                width: 95%;
                margin: var(--spacing-md);
            }

            .nav-search input {
                width: 250px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --text-primary: #ffffff;
                --text-secondary: #ffffff;
                --background-color: #000000;
                --surface-color: #000000;
                --border-color: #ffffff;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Live Features */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--error-color);
            font-size: var(--font-size-xs);
            font-weight: bold;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--error-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Video Player Controls */
        .video-container {
            position: relative;
            display: inline-block;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-container:hover .video-controls {
            opacity: 1;
        }

        .play-pause-btn {
            background: none;
            border: none;
            color: white;
            font-size: var(--font-size-lg);
            cursor: pointer;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.1s ease;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .volume-slider {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        /* Real-time Updates */
        .update-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .update-indicator.show {
            transform: translateX(0);
            opacity: 1;
        }

        /* Advanced Features */
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: bold;
        }

        .trending-indicator {
            color: var(--warning-color);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px var(--warning-color); }
            to { text-shadow: 0 0 20px var(--warning-color), 0 0 30px var(--warning-color); }
        }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            display: none;
            z-index: 100;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-picker.active {
            display: block;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: var(--spacing-xs);
        }

        .emoji-item {
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: center;
            transition: var(--transition-fast);
        }

        .emoji-item:hover {
            background: var(--surface-secondary);
        }

        /* Camera Modal */
        .camera-modal .modal-content {
            max-width: 500px;
        }

        .camera-container {
            position: relative;
            background: #000;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: var(--spacing-md);
        }

        .camera-video {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
        }

        .capture-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--error-color);
            border: 4px solid white;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .capture-btn:hover {
            transform: scale(1.1);
        }

        /* Advanced Search */
        .search-filters {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: none;
        }

        .search-filters.active {
            display: block;
        }

        .filter-group {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .filter-chip {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .filter-chip.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .filter-chip:hover {
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Skip Link for Screen Readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Preloader -->
    <div id="preloader" class="preloader" role="status" aria-label="Loading SmileX">
        <div class="preloader-logo" aria-hidden="true">
            <i class="fas fa-smile-beam"></i>
        </div>
        <div class="preloader-text">SmileX</div>
        <div class="loading-spinner"></div>
        <span class="sr-only">Loading application...</span>
    </div>

    <!-- Onboarding Modal -->
    <div class="overlay" id="onboardingOverlay" role="dialog" aria-labelledby="onboarding-title" aria-modal="true">
        <div class="onboarding-container">
            <header class="onboarding-header">
                <h2 id="onboarding-title">
                    <i class="fas fa-user-circle" aria-hidden="true"></i> 
                    Welcome to SmileX
                </h2>
                <p>Complete your profile to join our community</p>
            </header>

            <form id="registrationForm" novalidate>
                <!-- Profile Picture Section -->
                <div class="profile-pic-section">
                    <div class="profile-pic-container">
                        <div class="profile-pic-preview" id="profilePicPreview">
                            <i class="fas fa-user"></i>
                        </div>
                        <button type="button" class="profile-pic-upload" id="profilePicUploadBtn" aria-label="Upload profile picture">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <div class="profile-pic-options">
                        <button type="button" class="btn btn-secondary" id="uploadFromDevice">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                        <button type="button" class="btn btn-secondary" id="takePhoto">
                            <i class="fas fa-camera"></i> Camera
                        </button>
                    </div>
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                </div>

                <div class="form-group">
                    <label for="fullName" class="form-label">
                        <i class="fas fa-user" aria-hidden="true"></i> Full Name
                    </label>
                    <input type="text" 
                           id="fullName" 
                           name="fullName" 
                           class="form-control" 
                           placeholder="Enter your full name" 
                           required 
                           aria-describedby="fullName-error">
                    <div id="fullName-error" class="sr-only" role="alert"></div>
                </div>

                <div class="form-group">
                    <label for="username" class="form-label">
                        <i class="fas fa-at" aria-hidden="true"></i> Username
                    </label>
                    <div class="username-container">
                        <input type="text" 
                               id="username" 
                               name="username" 
                               class="form-control" 
                               placeholder="Choose a unique username" 
                               required 
                               aria-describedby="username-error">
                        <div class="username-status" id="usernameStatus"></div>
                    </div>
                    <div id="username-error" class="sr-only" role="alert"></div>
                    <div class="username-suggestions" id="usernameSuggestions"></div>
                </div>

                <div class="form-group">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope" aria-hidden="true"></i> Email Address
                    </label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           class="form-control" 
                           placeholder="your.email@example.com" 
                           required 
                           aria-describedby="email-error">
                    <div id="email-error" class="sr-only" role="alert"></div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="gender" class="form-label">
                            <i class="fas fa-venus-mars" aria-hidden="true"></i> Gender
                        </label>
                        <select id="gender" name="gender" class="form-select" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="country" class="form-label">
                            <i class="fas fa-globe" aria-hidden="true"></i> Country
                        </label>
                        <select id="country" name="country" class="form-select" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="IN">India</option>
                            <option value="BR">Brazil</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <fieldset class="consent-section">
                    <legend>
                        <h4><i class="fas fa-shield-alt" aria-hidden="true"></i> Platform Consent</h4>
                    </legend>
                    <div class="consent-item">
                        <input type="checkbox" id="ageConsent" name="ageConsent" required>
                        <label for="ageConsent">I am 13 years or older</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" id="termsConsent" name="termsConsent" required>
                        <label for="termsConsent">I agree to the Terms of Service</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" id="privacyConsent" name="privacyConsent" required>
                        <label for="privacyConsent">I consent to privacy policy</label>
                    </div>
                </fieldset>

                <button type="submit" id="submitBtn" class="btn btn-primary" disabled style="width: 100%;">
                    <i class="fas fa-paper-plane" aria-hidden="true"></i> Join SmileX
                </button>
            </form>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="modal camera-modal" role="dialog" aria-labelledby="camera-title" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 id="camera-title">Take Profile Photo</h3>
                <button id="closeCameraModal" class="modal-close" aria-label="Close camera modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>
            <div class="modal-body">
                <div class="camera-container">
                    <video id="cameraVideo" class="camera-video" autoplay muted></video>
                    <canvas id="cameraCanvas" style="display: none;"></canvas>
                </div>
                <div class="camera-controls">
                    <button id="captureBtn" class="capture-btn" aria-label="Capture photo">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
            </div>
            <footer class="modal-footer">
                <button type="button" id="cancelCamera" class="btn btn-secondary">Cancel</button>
                <button type="button" id="usePhoto" class="btn btn-primary" style="display: none;">Use Photo</button>
            </footer>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav role="navigation" aria-label="Main navigation">
        <div class="nav-container">
            <a href="#" class="logo" aria-label="SmileX Home">
                <i class="fas fa-smile-beam" aria-hidden="true"></i>
                <span>SmileX</span>
            </a>

            <div class="nav-search" role="search">
                <label for="searchInput" class="sr-only">Search Everything</label>
                <input type="text" 
                       id="searchInput" 
                       placeholder="Search posts, communities, users..." 
                       aria-describedby="search-results">
                <i class="fas fa-search" aria-hidden="true"></i>
                <div id="searchResults" class="search-results hidden" role="listbox" aria-label="Search results">
                    <div class="search-filters" id="searchFilters">
                        <div class="filter-group">
                            <div class="filter-chip active" data-filter="all">All</div>
                            <div class="filter-chip" data-filter="posts">Posts</div>
                            <div class="filter-chip" data-filter="communities">Communities</div>
                            <div class="filter-chip" data-filter="users">Users</div>
                        </div>
                    </div>
                    <div id="searchResultsList"></div>
                </div>
            </div>

            <div class="nav-actions">
                <button class="nav-button" 
                        id="notificationBtn" 
                        aria-label="View notifications"
                        title="Notifications">
                    <i class="fas fa-bell" aria-hidden="true"></i>
                    <span class="notification-badge" id="notificationBadge">3</span>
                </button>
                <div class="user-avatar" 
                     id="userAvatar" 
                     role="img" 
                     aria-label="User avatar"
                     title="Profile menu">
                    <span id="userInitial">U</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="Community navigation">
            <section>
                <h3><i class="fas fa-users" aria-hidden="true"></i> My Communities</h3>
                
                <div class="my-communities-tabs" role="tablist">
                    <button class="sort-button active" 
                            role="tab" 
                            aria-selected="true" 
                            aria-controls="createdCommunitiesList" 
                            data-tab="created">
                        Created
                    </button>
                    <button class="sort-button" 
                            role="tab" 
                            aria-selected="false" 
                            aria-controls="joinedCommunitiesList" 
                            data-tab="joined">
                        Joined
                    </button>
                </div>
                
                <div id="createdCommunitiesList" 
                     class="communities-tab-content" 
                     role="tabpanel" 
                     aria-labelledby="created-tab">
                    <ul id="createdCommunitiesUL" role="list"></ul>
                </div>
                
                <div id="joinedCommunitiesList" 
                     class="communities-tab-content hidden" 
                     role="tabpanel" 
                     aria-labelledby="joined-tab">
                    <ul id="joinedCommunitiesUL" role="list"></ul>
                </div>
                
                <button id="createCommunityBtn" 
                        class="btn btn-primary" 
                        style="width: 100%; margin-top: var(--spacing-md);">
                    <i class="fas fa-plus" aria-hidden="true"></i> Create Community
                </button>
            </section>

            <section style="margin-top: var(--spacing-xl);">
                <h3><i class="fas fa-compass" aria-hidden="true"></i> Explore</h3>
                <button id="browseCommunityBtn" class="btn btn-secondary" style="width: 100%;">
                    <i class="fas fa-globe" aria-hidden="true"></i> Browse Communities
                </button>
            </section>
        </aside>

        <!-- Main Feed -->
        <main class="main-feed" role="main" aria-label="Posts feed">
            <!-- Create Post Card -->
            <section class="create-post-card" aria-label="Create new post">
                <div class="create-post-input">
                    <div class="user-avatar" role="img" aria-label="Your avatar">
                        <span id="createPostUserInitial">U</span>
                    </div>
                    <button id="createPostInput" 
                            class="form-control" 
                            style="text-align: left; cursor: pointer; border: none;"
                            aria-label="Create a new post">
                        What's on your mind?
                    </button>
                </div>
                <div class="post-type-buttons" role="group" aria-label="Post type options">
                    <button class="post-type-button" 
                            data-post-type="image" 
                            aria-label="Create image post">
                        <i class="far fa-image" aria-hidden="true"></i> Image
                    </button>
                    <button class="post-type-button" 
                            data-post-type="video" 
                            aria-label="Create video post">
                        <i class="fas fa-video" aria-hidden="true"></i> Video
                    </button>
                    <button class="post-type-button" 
                            data-post-type="text" 
                            aria-label="Create text post">
                        <i class="far fa-file-alt" aria-hidden="true"></i> Text
                    </button>
                    <button class="post-type-button" 
                            data-post-type="poll" 
                            aria-label="Create poll">
                        <i class="fas fa-poll" aria-hidden="true"></i> Poll
                    </button>
                </div>
            </section>

            <!-- Post Sorting -->
            <section class="sort-buttons" role="group" aria-label="Sort posts">
                <button class="sort-button active" 
                        data-sort="hot" 
                        aria-pressed="true">
                    <i class="fas fa-bolt" aria-hidden="true"></i> Hot
                </button>
                <button class="sort-button" 
                        data-sort="new" 
                        aria-pressed="false">
                    <i class="fas fa-certificate" aria-hidden="true"></i> New
                </button>
                <button class="sort-button" 
                        data-sort="top" 
                        aria-pressed="false">
                    <i class="fas fa-arrow-trend-up" aria-hidden="true"></i> Top
                </button>
                <button class="sort-button" 
                        data-sort="trending" 
                        aria-pressed="false">
                    <i class="fas fa-fire trending-indicator" aria-hidden="true"></i> Trending
                </button>
            </section>

            <!-- Feed Filter -->
            <section class="create-post-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        <label for="feedFilter">Viewing:</label>
                        <select id="feedFilter" class="form-select" style="width: auto; margin: 0;">
                            <option value="all">All Posts</option>
                            <option value="general">General Feed</option>
                            <option value="mycommunities">My Communities</option>
                        </select>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        LIVE
                    </div>
                </div>
            </section>

            <!-- Posts Feed -->
            <section id="posts-feed" role="feed" aria-label="Social media posts"></section>

            <!-- Load More Button -->
            <div class="text-center">
                <button id="loadMoreBtn" class="btn btn-secondary">Load more posts</button>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="Discover and premium">
            <section>
                <h3><i class="fas fa-compass" aria-hidden="true"></i> Discover</h3>
                <div id="recommendedCommunities" role="list" aria-label="Recommended communities"></div>
            </section>

            <!-- Live Stats -->
            <section style="background: var(--surface-secondary); border-radius: var(--radius-xl); padding: var(--spacing-lg); margin-top: var(--spacing-xl);">
                <h4 style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    Live Stats
                </h4>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); font-size: var(--font-size-sm);">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Online Users:</span>
                        <span id="onlineUsers" style="color: var(--success-color); font-weight: bold;">127,543</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Active Polls:</span>
                        <span id="activePolls" style="color: var(--primary-color); font-weight: bold;">1,247</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Posts Today:</span>
                        <span id="postsToday" style="color: var(--warning-color); font-weight: bold;">45,678</span>
                    </div>
                </div>
            </section>

            <!-- Premium Ad -->
            <section style="background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); border-radius: var(--radius-xl); padding: var(--spacing-lg); margin-top: var(--spacing-xl); color: white;">
                <div style="display: flex; align-items: center; margin-bottom: var(--spacing-sm);">
                    <i class="fas fa-crown" style="margin-right: var(--spacing-sm);" aria-hidden="true"></i>
                    <h4>SmileX Premium</h4>
                </div>
                <p style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">Unlock exclusive features, ad-free browsing, and premium communities.</p>
                <button id="premiumBtn" class="btn btn-premium" style="width: 100%;">
                    <i class="fas fa-star" aria-hidden="true"></i> UPGRADE NOW
                </button>
            </section>
        </aside>
    </main>

    <!-- Create Post Modal -->
    <div id="create-post-modal" class="modal" role="dialog" aria-labelledby="create-post-title" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 id="create-post-title">Create a post</h3>
                <button id="closeCreatePostModal" 
                        class="modal-close" 
                        aria-label="Close create post modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div class="modal-body">
                <form id="createPostForm" novalidate>
                    <div class="form-group">
                        <label for="postType" class="form-label">Post type</label>
                        <select id="postType" name="postType" class="form-select" required>
                            <option value="text">Text Post</option>
                            <option value="image">Image Post</option>
                            <option value="video">Video Post</option>
                            <option value="poll">Poll</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="postVisibility" class="form-label">Post visibility</label>
                        <select id="postVisibility" name="visibility" class="form-select" required>
                            <option value="general">General (visible to everyone)</option>
                            <option value="community">Community (visible to members)</option>
                        </select>
                    </div>

                    <div class="form-group hidden" id="postCommunityContainer">
                        <label for="postCommunity" class="form-label">Choose a community</label>
                        <select id="postCommunity" name="community" class="form-select">
                            <option value="">Select a community</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="postTitle" class="form-label">Title</label>
                        <input type="text" 
                               id="postTitle" 
                               name="title" 
                               placeholder="Title" 
                               class="form-control" 
                               required>
                    </div>

                    <div class="form-group" id="contentContainer">
                        <label for="postContent" class="form-label">Content</label>
                        <textarea id="postContent" 
                                  name="content" 
                                  placeholder="What are your thoughts?" 
                                  rows="6" 
                                  class="form-control"></textarea>
                    </div>

                    <!-- Poll Options Container -->
                    <div class="form-group hidden" id="pollOptionsContainer">
                        <label class="form-label">Poll Options</label>
                        <div id="pollOptions">
                            <input type="text" 
                                   class="form-control poll-option-input" 
                                   placeholder="Option 1" 
                                   style="margin-bottom: var(--spacing-sm);">
                            <input type="text" 
                                   class="form-control poll-option-input" 
                                   placeholder="Option 2" 
                                   style="margin-bottom: var(--spacing-sm);">
                        </div>
                        <button type="button" 
                                id="addPollOption" 
                                class="btn btn-secondary" 
                                style="margin-top: var(--spacing-sm);">
                            <i class="fas fa-plus" aria-hidden="true"></i> Add Option
                        </button>
                    </div>

                    <div class="form-group" id="mediaUploadContainer">
                        <label class="form-label">Media Upload</label>
                        <div class="media-upload-area" 
                             id="mediaUploadArea" 
                             role="button" 
                             tabindex="0" 
                             aria-label="Click or drag media files here to upload">
                            <i class="fas fa-cloud-upload-alt" 
                               style="font-size: var(--font-size-2xl); color: var(--text-muted); margin-bottom: var(--spacing-sm);" 
                               aria-hidden="true"></i>
                            <p>Click or drag images/videos here to upload</p>
                            <p style="font-size: var(--font-size-xs); color: var(--text-muted);">
                                Supports: JPG, PNG, GIF, MP4, WebM (Max 50MB)
                            </p>
                            <input type="file" 
                                   id="mediaInput" 
                                   accept="image/*,video/*" 
                                   multiple 
                                   style="display: none;" 
                                   aria-label="Select media files to upload">
                        </div>
                        <div id="mediaPreviewContainer" class="media-preview-container" role="list" aria-label="Selected media files"></div>
                    </div>
                </form>
            </div>

            <footer class="modal-footer">
                <button type="button" id="cancelCreatePost" class="btn btn-secondary">Cancel</button>
                <button type="submit" form="createPostForm" class="btn btn-primary">Post</button>
            </footer>
        </div>
    </div>

    <!-- Create Community Modal -->
    <div id="create-community-modal" class="modal" role="dialog" aria-labelledby="create-community-title" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 id="create-community-title">Create a Community</h3>
                <button id="closeCreateCommunityModal" 
                        class="modal-close" 
                        aria-label="Close create community modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div class="modal-body">
                <form id="createCommunityForm" novalidate>
                    <div class="form-group">
                        <label for="communityName" class="form-label">Community Name</label>
                        <input type="text" 
                               id="communityName" 
                               name="name" 
                               placeholder="Enter community name" 
                               class="form-control" 
                               required 
                               aria-describedby="community-name-help">
                        <p id="community-name-help" style="font-size: var(--font-size-xs); color: var(--text-muted); margin-top: var(--spacing-xs);">
                            Community names can't contain spaces or be "smile" or "smilex". Use 3-21 characters.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="communityDisplayName" class="form-label">Display Name</label>
                        <input type="text" 
                               id="communityDisplayName" 
                               name="displayName" 
                               placeholder="Enter display name" 
                               class="form-control" 
                               required>
                    </div>

                    <div class="form-group">
                        <label for="communityDescription" class="form-label">Description</label>
                        <textarea id="communityDescription" 
                                  name="description" 
                                  placeholder="What's your community about?" 
                                  rows="4" 
                                  class="form-control"></textarea>
                    </div>

                    <fieldset class="form-group">
                        <legend class="form-label">Community Type</legend>
                        <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-sm);">
                            <div style="display: flex; align-items: center;">
                                <input type="radio" 
                                       id="typePublic" 
                                       name="type" 
                                       value="public" 
                                       checked 
                                       style="margin-right: var(--spacing-sm);">
                                <label for="typePublic">Public</label>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <input type="radio" 
                                       id="typePrivate" 
                                       name="type" 
                                       value="private" 
                                       style="margin-right: var(--spacing-sm);">
                                <label for="typePrivate">Private</label>
                            </div>
                        </div>
                        <p style="font-size: var(--font-size-xs); color: var(--text-muted); margin-top: var(--spacing-xs);">
                            Private communities require members to be approved by moderators.
                        </p>
                    </fieldset>

                    <div class="form-group">
                        <label for="communityTopics" class="form-label">Community Topics (optional)</label>
                        <input type="text" 
                               id="communityTopics" 
                               name="topics" 
                               placeholder="Enter topics separated by commas" 
                               class="form-control">
                    </div>
                </form>
            </div>

            <footer class="modal-footer">
                <button type="button" id="cancelCreateCommunity" class="btn btn-secondary">Cancel</button>
                <button type="submit" form="createCommunityForm" class="btn btn-primary">Create Community</button>
            </footer>
        </div>
    </div>

    <!-- Browse Communities Modal -->
    <div id="browse-communities-modal" class="modal" role="dialog" aria-labelledby="browse-communities-title" aria-modal="true">
        <div class="modal-content" style="max-width: 800px;">
            <header class="modal-header">
                <h3 id="browse-communities-title">Browse Communities</h3>
                <button id="closeBrowseCommunitiesModal" 
                        class="modal-close" 
                        aria-label="Close browse communities modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div style="padding: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div style="position: relative; flex: 1;">
                        <label for="communitySearchInput" class="sr-only">Search for communities</label>
                        <input type="text" 
                               id="communitySearchInput" 
                               placeholder="Search for communities..." 
                               class="form-control" 
                               style="padding-left: 40px;">
                        <i class="fas fa-search" 
                           style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" 
                           aria-hidden="true"></i>
                    </div>
                    <div style="display: flex; gap: var(--spacing-sm);" role="tablist">
                        <button class="sort-button active" 
                                data-tab="all" 
                                role="tab" 
                                aria-selected="true">All</button>
                        <button class="sort-button" 
                                data-tab="public" 
                                role="tab" 
                                aria-selected="false">Public</button>
                        <button class="sort-button" 
                                data-tab="private" 
                                role="tab" 
                                aria-selected="false">Private</button>
                    </div>
                </div>
            </div>

            <div class="modal-body">
                <div id="communitiesBrowseList" 
                     style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-md);" 
                     role="list" 
                     aria-label="Available communities"></div>
                <div id="noCommunitiesMessage" class="text-center hidden">
                    <i class="fas fa-users" 
                       style="font-size: var(--font-size-3xl); color: var(--text-muted); margin-bottom: var(--spacing-md);" 
                       aria-hidden="true"></i>
                    <p style="color: var(--text-muted);">No communities found</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Community Detail Modal -->
    <div id="community-detail-modal" class="modal" role="dialog" aria-labelledby="community-detail-title" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div id="communityDetailHeader" class="modal-header" style="position: relative;"></div>

            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-xl);">
                    <div>
                        <h3 style="margin-bottom: var(--spacing-md);">About this Community</h3>
                        <div id="communityDetailDescription" 
                             style="color: var(--text-secondary); margin-bottom: var(--spacing-xl);"></div>
                        
                        <h3 style="margin-bottom: var(--spacing-md);">Recent Posts</h3>
                        <div id="communityPosts" role="list" aria-label="Recent community posts"></div>
                    </div>
                    <div>
                        <div style="background: var(--surface-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <h4 style="margin-bottom: var(--spacing-md);">Community Info</h4>
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); font-size: var(--font-size-sm);">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Created by</span>
                                    <span id="communityCreator"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Created</span>
                                    <span id="communityCreationDate"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Members</span>
                                    <span id="communityMemberCount"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Type</span>
                                    <span id="communityType"></span>
                                </div>
                            </div>
                        </div>

                        <div style="background: var(--surface-secondary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                            <h4 style="margin-bottom: var(--spacing-md);">Topics</h4>
                            <div id="communityTopics" role="list" aria-label="Community topics"></div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="modal-footer">
                <button id="closeCommunityDetailModal" class="btn btn-secondary">Close</button>
                <button id="joinLeaveButton" class="btn btn-primary">Join</button>
                <button id="deleteCommunityButton" class="btn hidden" style="background: var(--error-color);">Delete Community</button>
            </footer>
        </div>
    </div>

    <!-- Premium Modal -->
    <div id="premium-modal" class="modal premium-modal" role="dialog" aria-labelledby="premium-title" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 id="premium-title">
                    <i class="fas fa-crown" style="color: var(--premium-color);" aria-hidden="true"></i>
                    SmileX Premium
                </h3>
                <button id="closePremiumModal" 
                        class="modal-close" 
                        aria-label="Close premium modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div class="modal-body">
                <div class="text-center" style="margin-bottom: var(--spacing-xl);">
                    <h4 style="color: var(--premium-color); margin-bottom: var(--spacing-sm);">Unlock the Full SmileX Experience</h4>
                    <p style="color: var(--text-secondary);">Join thousands of premium members and enjoy exclusive features</p>
                </div>

                <div class="premium-packages">
                    <div class="premium-package">
                        <div class="package-name">Basic</div>
                        <div class="package-price">$4.99<span style="font-size: var(--font-size-sm); color: var(--text-muted);">/month</span></div>
                        <ul class="package-features">
                            <li><i class="fas fa-check"></i> Ad-free browsing</li>
                            <li><i class="fas fa-check"></i> Custom themes</li>
                            <li><i class="fas fa-check"></i> Priority support</li>
                            <li><i class="fas fa-check"></i> Extended media uploads</li>
                        </ul>
                        <button class="btn btn-premium" style="width: 100%;">Choose Basic</button>
                    </div>

                    <div class="premium-package featured">
                        <div class="package-name">Pro <span class="premium-badge">POPULAR</span></div>
                        <div class="package-price">$9.99<span style="font-size: var(--font-size-sm); color: var(--text-muted);">/month</span></div>
                        <ul class="package-features">
                            <li><i class="fas fa-check"></i> Everything in Basic</li>
                            <li><i class="fas fa-check"></i> Exclusive communities</li>
                            <li><i class="fas fa-check"></i> Advanced analytics</li>
                            <li><i class="fas fa-check"></i> Custom badges</li>
                            <li><i class="fas fa-check"></i> Early feature access</li>
                        </ul>
                        <button class="btn btn-premium" style="width: 100%;">Choose Pro</button>
                    </div>

                    <div class="premium-package">
                        <div class="package-name">Elite</div>
                        <div class="package-price">$19.99<span style="font-size: var(--font-size-sm); color: var(--text-muted);">/month</span></div>
                        <ul class="package-features">
                            <li><i class="fas fa-check"></i> Everything in Pro</li>
                            <li><i class="fas fa-check"></i> VIP support</li>
                            <li><i class="fas fa-check"></i> Unlimited storage</li>
                            <li><i class="fas fa-check"></i> API access</li>
                            <li><i class="fas fa-check"></i> White-label options</li>
                        </ul>
                        <button class="btn btn-premium" style="width: 100%;">Choose Elite</button>
                    </div>
                </div>

                <div class="text-center" style="margin-top: var(--spacing-xl); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color);">
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">
                        <i class="fas fa-shield-alt" style="color: var(--success-color);"></i>
                        30-day money-back guarantee  Cancel anytime  Secure payment
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Viewer Modal -->
    <div id="media-viewer-modal" class="modal" role="dialog" aria-labelledby="media-viewer-title" aria-modal="true">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 0; background: transparent; box-shadow: none;">
            <div style="position: relative; display: flex; align-items: center; justify-content: center; height: 90vh;">
                <button id="closeMediaViewer" 
                        style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 18px; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>
                <div id="mediaViewerContent" style="max-width: 100%; max-height: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Live Chat Toggle Button -->
    <button id="chat-toggle-btn" 
            class="chat-toggle" 
            aria-label="Toggle live chat" 
            title="Live Chat Support">
        <i class="fas fa-comment-dots" aria-hidden="true"></i>
    </button>

    <!-- Live Chat Container -->
    <div id="chat-container" class="chat-container" role="dialog" aria-labelledby="chat-title">
        <header class="chat-header">
            <h3 id="chat-title">Live Chat Support</h3>
            <button id="chat-close-btn" 
                    class="chat-close" 
                    aria-label="Close chat">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </header>
        <div class="chat-messages" 
             id="chat-messages" 
             role="log" 
             aria-live="polite" 
             aria-label="Chat messages">
            <div class="message agent">
                <div class="message-user">Support Agent</div>
                <div class="message-text">Hello! How can we help you today?</div>
                <div class="message-time">Just now</div>
            </div>
        </div>
        <div class="chat-input-container">
            <label for="chat-input" class="sr-only">Type your message</label>
            <input type="text" 
                   id="chat-input" 
                   class="chat-input" 
                   placeholder="Type your message..." 
                   aria-describedby="chat-send-btn">
            <button id="chat-send-btn" 
                    class="chat-send" 
                    aria-label="Send message">
                <i class="fas fa-paper-plane" aria-hidden="true"></i>
            </button>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" role="navigation" aria-label="Mobile navigation">
        <a href="#" class="mobile-nav-item active" aria-current="page">
            <i class="fas fa-home" aria-hidden="true"></i>
            <span>Home</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileBrowseBtn">
            <i class="fas fa-compass" aria-hidden="true"></i>
            <span>Explore</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileCreatePost">
            <i class="fas fa-plus-circle" aria-hidden="true"></i>
            <span>Create</span>
        </a>
        <a href="#" class="mobile-nav-item">
            <i class="fas fa-bell" aria-hidden="true"></i>
            <span>Notifications</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileCreateCommunity">
            <i class="fas fa-users" aria-hidden="true"></i>
            <span>Community</span>
        </a>
    </nav>

    <!-- Update Indicator -->
    <div id="update-indicator" class="update-indicator">
        <i class="fas fa-sync-alt" aria-hidden="true"></i>
        New content available
    </div>

    <!-- Notification Container -->
    <div id="notification-container" 
         role="status" 
         aria-live="polite" 
         aria-atomic="true" 
         style="position: fixed; top: 20px; right: 20px; z-index: 1001;"></div>

    <script>
        // Enhanced SmileX Social Media Platform - Complete Implementation
        
        // Global Configuration
        const CONFIG = {
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            SUPPORTED_IMAGE_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
            SUPPORTED_VIDEO_TYPES: ['video/mp4', 'video/webm', 'video/ogg'],
            AUTO_SAVE_INTERVAL: 30000, // 30 seconds
            LIVE_UPDATE_INTERVAL: 5000, // 5 seconds
            MAX_POLL_OPTIONS: 6,
            MAX_POST_LENGTH: 10000,
            MAX_COMMENT_LENGTH: 1000,
            RESTRICTED_COMMUNITY_NAMES: ['smile', 'smilex', 'admin', 'moderator', 'official'],
            EMOJI_LIST: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
        };

        // Global State Management
        class StateManager {
            constructor() {
                this.state = {
                    currentUser: null,
                    posts: [],
                    communities: [],
                    userMemberships: [],
                    userCreatedCommunities: [],
                    livePolls: [],
                    uploadedMedia: [],
                    currentSort: 'hot',
                    currentFeedFilter: 'all',
                    currentCommunityTab: 'all',
                    currentCommunity: null,
                    onlineUsers: 127543,
                    activePolls: 1247,
                    postsToday: 45678,
                    isLiveMode: true,
                    searchHistory: [],
                    notifications: [],
                    premiumFeatures: false
                };
                
                this.subscribers = [];
                this.loadFromStorage();
            }

            subscribe(callback) {
                this.subscribers.push(callback);
            }

            setState(updates) {
                this.state = { ...this.state, ...updates };
                this.saveToStorage();
                this.notifySubscribers();
            }

            getState() {
                return { ...this.state };
            }

            notifySubscribers() {
                this.subscribers.forEach(callback => callback(this.state));
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('smileXState');
                    if (stored) {
                        const parsedState = JSON.parse(stored);
                        // Convert timestamp strings back to Date objects
                        if (parsedState.posts) {
                            parsedState.posts = parsedState.posts.map(post => ({
                                ...post,
                                timestamp: new Date(post.timestamp)
                            }));
                        }
                        this.state = { ...this.state, ...parsedState };
                    }
                } catch (error) {
                    console.error('Error loading state from storage:', error);
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem('smileXState', JSON.stringify(this.state));
                } catch (error) {
                    console.error('Error saving state to storage:', error);
                }
            }
        }

        // Initialize State Manager
        const stateManager = new StateManager();

        // Username Validation System
        class UsernameValidator {
            constructor() {
                this.existingUsernames = new Set([
                    'admin', 'moderator', 'smilex', 'smile', 'official', 'support',
                    'help', 'team', 'staff', 'user', 'guest', 'anonymous'
                ]);
                this.checkTimeout = null;
            }

            async checkAvailability(username) {
                return new Promise((resolve) => {
                    // Simulate API call delay
                    setTimeout(() => {
                        const isAvailable = !this.existingUsernames.has(username.toLowerCase()) && 
                                          username.length >= 3 && 
                                          username.length <= 21 &&
                                          /^[a-zA-Z0-9_]+$/.test(username);
                        resolve(isAvailable);
                    }, 500);
                });
            }

            generateSuggestions(username) {
                const suggestions = [];
                const baseUsername = username.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                
                if (baseUsername.length >= 3) {
                    for (let i = 1; i <= 5; i++) {
                        suggestions.push(`${baseUsername}${Math.floor(Math.random() * 1000)}`);
                        suggestions.push(`${baseUsername}_${i}`);
                    }
                }
                
                return suggestions.slice(0, 3);
            }

            async validateUsername(username, statusElement, suggestionsElement) {
                if (!username || username.length < 3) {
                    statusElement.innerHTML = '';
                    suggestionsElement.innerHTML = '';
                    return false;
                }

                statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                statusElement.className = 'username-status checking';

                const isAvailable = await this.checkAvailability(username);

                if (isAvailable) {
                    statusElement.innerHTML = '<i class="fas fa-check"></i>';
                    statusElement.className = 'username-status available';
                    suggestionsElement.innerHTML = '';
                    return true;
                } else {
                    statusElement.innerHTML = '<i class="fas fa-times"></i>';
                    statusElement.className = 'username-status taken';
                    
                    const suggestions = this.generateSuggestions(username);
                    suggestionsElement.innerHTML = `
                        <div>Try these suggestions:</div>
                        ${suggestions.map(suggestion => 
                            `<span class="username-suggestion" onclick="selectUsernameSuggestion('${suggestion}')">${suggestion}</span>`
                        ).join('')}
                    `;
                    return false;
                }
            }
        }

        // Initialize Username Validator
        const usernameValidator = new UsernameValidator();

        // Camera System
        class CameraSystem {
            constructor() {
                this.stream = null;
                this.video = null;
                this.canvas = null;
                this.capturedImage = null;
            }

            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    });
                    
                    this.video = document.getElementById('cameraVideo');
                    this.canvas = document.getElementById('cameraCanvas');
                    
                    if (this.video) {
                        this.video.srcObject = this.stream;
                        return true;
                    }
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    utils.showNotification('Unable to access camera. Please check permissions.', 'error');
                    return false;
                }
            }

            capturePhoto() {
                if (!this.video || !this.canvas) return null;

                const context = this.canvas.getContext('2d');
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                
                context.drawImage(this.video, 0, 0);
                
                this.capturedImage = this.canvas.toDataURL('image/jpeg', 0.8);
                return this.capturedImage;
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
            }

            getCapturedImage() {
                return this.capturedImage;
            }
        }

        // Initialize Camera System
        const cameraSystem = new CameraSystem();

        // Advanced Search System
        class SearchSystem {
            constructor() {
                this.searchHistory = [];
                this.searchFilters = {
                    type: 'all', // all, posts, communities, users
                    timeRange: 'all', // all, today, week, month
                    sortBy: 'relevance' // relevance, recent, popular
                };
            }

            async performSearch(query, filters = {}) {
                const state = stateManager.getState();
                const searchFilters = { ...this.searchFilters, ...filters };
                
                if (!query.trim()) return [];

                // Add to search history
                this.addToHistory(query);

                let results = [];

                // Search posts
                if (searchFilters.type === 'all' || searchFilters.type === 'posts') {
                    const postResults = state.posts.filter(post => 
                        post.title.toLowerCase().includes(query.toLowerCase()) ||
                        post.content.toLowerCase().includes(query.toLowerCase()) ||
                        post.author.toLowerCase().includes(query.toLowerCase())
                    ).map(post => ({
                        type: 'post',
                        id: post.id,
                        title: post.title,
                        content: post.content.substring(0, 100) + '...',
                        author: post.author,
                        timestamp: post.timestamp,
                        votes: post.votes,
                        comments: post.comments
                    }));
                    results.push(...postResults);
                }

                // Search communities
                if (searchFilters.type === 'all' || searchFilters.type === 'communities') {
                    const communityResults = state.communities.filter(community =>
                        community.name.toLowerCase().includes(query.toLowerCase()) ||
                        community.displayName.toLowerCase().includes(query.toLowerCase()) ||
                        (community.description && community.description.toLowerCase().includes(query.toLowerCase())) ||
                        (community.topics && community.topics.some(topic => topic.toLowerCase().includes(query.toLowerCase())))
                    ).map(community => ({
                        type: 'community',
                        id: community.id,
                        name: community.name,
                        displayName: community.displayName,
                        description: community.description,
                        memberCount: community.memberCount,
                        type: community.type
                    }));
                    results.push(...communityResults);
                }

                // Simulate web search for external content
                if (searchFilters.type === 'all' || searchFilters.type === 'web') {
                    const webResults = await this.simulateWebSearch(query);
                    results.push(...webResults);
                }

                return this.sortResults(results, searchFilters.sortBy);
            }

            async simulateWebSearch(query) {
                // Simulate external web search results
                return [
                    {
                        type: 'web',
                        title: `${query} - Wikipedia`,
                        url: `https://en.wikipedia.org/wiki/${encodeURIComponent(query)}`,
                        description: `Learn more about ${query} on Wikipedia...`,
                        source: 'Wikipedia'
                    },
                    {
                        type: 'web',
                        title: `${query} - Latest News`,
                        url: `https://news.google.com/search?q=${encodeURIComponent(query)}`,
                        description: `Latest news and updates about ${query}...`,
                        source: 'Google News'
                    }
                ];
            }

            sortResults(results, sortBy) {
                switch (sortBy) {
                    case 'recent':
                        return results.sort((a, b) => {
                            if (a.timestamp && b.timestamp) {
                                return new Date(b.timestamp) - new Date(a.timestamp);
                            }
                            return 0;
                        });
                    case 'popular':
                        return results.sort((a, b) => {
                            const aScore = (a.votes || 0) + (a.memberCount || 0);
                            const bScore = (b.votes || 0) + (b.memberCount || 0);
                            return bScore - aScore;
                        });
                    case 'relevance':
                    default:
                        return results; // Already sorted by relevance
                }
            }

            addToHistory(query) {
                if (!this.searchHistory.includes(query)) {
                    this.searchHistory.unshift(query);
                    if (this.searchHistory.length > 10) {
                        this.searchHistory.pop();
                    }
                }
            }

            getSearchHistory() {
                return this.searchHistory;
            }
        }

        // Initialize Search System
        const searchSystem = new SearchSystem();

        // Utility Functions
        const utils = {
            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'k';
                }
                return num.toString();
            },

            getTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) {
                    return 'Just now';
                } else if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 2592000) {
                    const days = Math.floor(diffInSeconds / 86400);
                    return `${days} day${days !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 31536000) {
                    const months = Math.floor(diffInSeconds / 2592000);
                    return `${months} month${months !== 1 ? 's' : ''} ago`;
                } else {
                    const years = Math.floor(diffInSeconds / 31536000);
                    return `${years} year${years !== 1 ? 's' : ''} ago`;
                }
            },

            getCommunityColor(name) {
                const colors = [
                    'bg-blue-500', 'bg-red-500', 'bg-green-500', 'bg-purple-500',
                    'bg-gray-500', 'bg-yellow-500', 'bg-pink-500', 'bg-indigo-500'
                ];
                
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                
                return colors[Math.abs(hash) % colors.length];
            },

            generateId() {
                return Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
            },

            validateFile(file) {
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    throw new Error(`File size must be less than ${CONFIG.MAX_FILE_SIZE / (1024 * 1024)}MB`);
                }

                const isImage = CONFIG.SUPPORTED_IMAGE_TYPES.includes(file.type);
                const isVideo = CONFIG.SUPPORTED_VIDEO_TYPES.includes(file.type);

                if (!isImage && !isVideo) {
                    throw new Error('Unsupported file type. Please use JPG, PNG, GIF, MP4, or WebM files.');
                }

                return { isImage, isVideo };
            },

            createMediaPreview(file, onRemove) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const { isImage, isVideo } = utils.validateFile(file);
                        const mediaUrl = e.target.result;
                        
                        const previewItem = document.createElement('div');
                        previewItem.className = 'media-preview-item';
                        
                        if (isImage) {
                            previewItem.innerHTML = `
                                <img src="${mediaUrl}" alt="Preview of ${file.name}" loading="lazy">
                                <button class="media-remove-btn" onclick="removeMedia('${file.name}')" aria-label="Remove ${file.name}">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        } else if (isVideo) {
                            previewItem.innerHTML = `
                                <video src="${mediaUrl}" muted>
                                    <source src="${mediaUrl}" type="${file.type}">
                                    Your browser does not support the video tag.
                                </video>
                                <button class="media-remove-btn" onclick="removeMedia('${file.name}')" aria-label="Remove ${file.name}">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        }
                        
                        resolve({
                            element: previewItem,
                            file: file,
                            url: mediaUrl,
                            type: isImage ? 'image' : 'video'
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 1001;
                    transform: translateX(100%);
                    opacity: 0;
                    transition: all 0.3s ease;
                    max-width: 300px;
                    word-wrap: break-word;
                `;
                
                // Set background color based on type
                switch (type) {
                    case 'success':
                        notification.style.background = '#10b981';
                        break;
                    case 'error':
                        notification.style.background = '#ef4444';
                        break;
                    case 'warning':
                        notification.style.background = '#f59e0b';
                        break;
                    default:
                        notification.style.background = '#6366f1';
                }
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Trigger animation
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                    notification.style.opacity = '1';
                }, 100);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            },

            calculateHotScore(post) {
                const hoursOld = (Date.now() - post.timestamp.getTime()) / (1000 * 60 * 60);
                const score = post.votes / Math.pow(hoursOld + 2, 1.8);
                return score;
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            sanitizeInput(input) {
                const div = document.createElement('div');
                div.textContent = input;
                return div.innerHTML;
            },

            createEmojiPicker() {
                const picker = document.createElement('div');
                picker.className = 'emoji-picker';
                picker.innerHTML = `
                    <div class="emoji-grid">
                        ${CONFIG.EMOJI_LIST.map(emoji => 
                            `<div class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</div>`
                        ).join('')}
                    </div>
                `;
                return picker;
            }
        };

        // Media Management
        class MediaManager {
            constructor() {
                this.uploadedMedia = [];
            }

            async handleFiles(files) {
                const validFiles = [];
                const errors = [];

                for (const file of files) {
                    try {
                        utils.validateFile(file);
                        validFiles.push(file);
                    } catch (error) {
                        errors.push(`${file.name}: ${error.message}`);
                    }
                }

                if (errors.length > 0) {
                    utils.showNotification(`Some files were rejected: ${errors.join(', ')}`, 'warning');
                }

                const previews = await Promise.all(
                    validFiles.map(file => utils.createMediaPreview(file, this.removeMedia.bind(this)))
                );

                this.uploadedMedia.push(...previews);
                this.updatePreviewContainer();
                
                return previews;
            }

            removeMedia(fileName) {
                this.uploadedMedia = this.uploadedMedia.filter(media => media.file.name !== fileName);
                this.updatePreviewContainer();
            }

            updatePreviewContainer() {
                const container = document.getElementById('mediaPreviewContainer');
                if (!container) return;

                container.innerHTML = '';
                this.uploadedMedia.forEach(media => {
                    container.appendChild(media.element);
                });
            }

            clearAll() {
                this.uploadedMedia = [];
                this.updatePreviewContainer();
            }

            getMediaData() {
                return this.uploadedMedia.map(media => ({
                    url: media.url,
                    type: media.type,
                    name: media.file.name
                }));
            }
        }

        // Initialize Media Manager
        const mediaManager = new MediaManager();

        // Make removeMedia globally accessible
        window.removeMedia = (fileName) => {
            mediaManager.removeMedia(fileName);
        };

        // Post Management
        class PostManager {
            constructor() {
                this.posts = stateManager.getState().posts;
            }

            async createPost(postData) {
                const state = stateManager.getState();
                const mediaData = mediaManager.getMediaData();

                // Handle poll creation
                if (postData.postType === 'poll') {
                    return this.createPoll(postData);
                }

                const newPost = {
                    id: utils.generateId(),
                    title: utils.sanitizeInput(postData.title),
                    content: utils.sanitizeInput(postData.content || ""),
                    author: state.currentUser ? state.currentUser.fullName : "Anonymous",
                    authorId: state.currentUser ? state.currentUser.userId : "anonymous",
                    visibility: postData.visibility,
                    votes: 0,
                    comments: 0,
                    timestamp: new Date(),
                    type: this.determinePostType(postData.postType, mediaData),
                    media: mediaData,
                    userVotes: [], // Track who voted
                    commentsData: [],
                    isDefaultMessage: false
                };

                if (postData.visibility === 'community' && postData.community) {
                    const community = state.communities.find(c => c.id === postData.community);
                    if (community) {
                        newPost.community = community.displayName;
                        newPost.communityId = community.id;
                    }
                } else {
                    newPost.community = "General";
                    newPost.communityId = null;
                }

                const updatedPosts = [newPost, ...state.posts];
                stateManager.setState({ 
                    posts: updatedPosts,
                    postsToday: state.postsToday + 1
                });

                mediaManager.clearAll();
                utils.showNotification('Post created successfully!', 'success');
                
                return newPost;
            }

            createPoll(pollData) {
                const state = stateManager.getState();
                const pollOptions = this.extractPollOptions(pollData);

                if (pollOptions.length < 2) {
                    throw new Error('Poll must have at least 2 options');
                }

                const pollId = utils.generateId();
                const newPost = {
                    id: utils.generateId(),
                    title: utils.sanitizeInput(pollData.title),
                    content: utils.sanitizeInput(pollData.content || ""),
                    author: state.currentUser ? state.currentUser.fullName : "Anonymous",
                    authorId: state.currentUser ? state.currentUser.userId : "anonymous",
                    visibility: pollData.visibility,
                    votes: 0,
                    comments: 0,
                    timestamp: new Date(),
                    type: "poll",
                    media: [],
                    pollOptions: pollOptions,
                    pollId: pollId,
                    pollActive: true,
                    totalVotes: 0,
                    userVotes: [],
                    commentsData: [],
                    isDefaultMessage: false
                };

                if (pollData.visibility === 'community' && pollData.community) {
                    const community = state.communities.find(c => c.id === pollData.community);
                    if (community) {
                        newPost.community = community.displayName;
                        newPost.communityId = community.id;
                    }
                } else {
                    newPost.community = "General";
                    newPost.communityId = null;
                }

                // Add to live polls tracking
                const updatedLivePolls = [...state.livePolls, {
                    id: pollId,
                    postId: newPost.id,
                    question: pollData.title,
                    options: pollOptions,
                    active: true,
                    createdBy: state.currentUser ? state.currentUser.userId : "anonymous",
                    totalVotes: 0
                }];

                const updatedPosts = [newPost, ...state.posts];
                stateManager.setState({ 
                    posts: updatedPosts,
                    livePolls: updatedLivePolls,
                    activePolls: state.activePolls + 1,
                    postsToday: state.postsToday + 1
                });

                utils.showNotification('Live poll created successfully!', 'success');
                return newPost;
            }

            extractPollOptions(pollData) {
                const options = [];
                let optionIndex = 1;
                
                // Extract poll options from form data
                while (pollData[`option${optionIndex}`]) {
                    if (pollData[`option${optionIndex}`].trim()) {
                        options.push({
                            text: utils.sanitizeInput(pollData[`option${optionIndex}`].trim()),
                            votes: 0,
                            percentage: 0,
                            voters: []
                        });
                    }
                    optionIndex++;
                }

                // Also check for poll option inputs in the DOM
                const pollInputs = document.querySelectorAll('.poll-option-input');
                pollInputs.forEach(input => {
                    if (input.value.trim() && !options.find(opt => opt.text === input.value.trim())) {
                        options.push({
                            text: utils.sanitizeInput(input.value.trim()),
                            votes: 0,
                            percentage: 0,
                            voters: []
                        });
                    }
                });

                return options;
            }

            determinePostType(selectedType, mediaData) {
                if (selectedType === 'poll') return 'poll';
                if (mediaData.length > 0) {
                    const hasVideo = mediaData.some(media => media.type === 'video');
                    return hasVideo ? 'video' : 'image';
                }
                return 'text';
            }

            voteOnPost(postId, direction) {
                const state = stateManager.getState();
                const post = state.posts.find(p => p.id === postId);
                if (!post || !state.currentUser) return;

                const userId = state.currentUser.userId;
                const existingVote = post.userVotes.find(v => v.userId === userId);

                if (existingVote) {
                    // Remove existing vote
                    post.votes -= existingVote.direction === 'up' ? 1 : -1;
                    post.userVotes = post.userVotes.filter(v => v.userId !== userId);
                    
                    // Add new vote if different direction
                    if (existingVote.direction !== direction) {
                        post.votes += direction === 'up' ? 1 : -1;
                        post.userVotes.push({ userId, direction });
                    }
                } else {
                    // Add new vote
                    post.votes += direction === 'up' ? 1 : -1;
                    post.userVotes.push({ userId, direction });
                }

                stateManager.setState({ posts: state.posts });
                this.updatePostVoteDisplay(postId, post.votes);
            }

            voteOnPoll(postId, optionIndex) {
                const state = stateManager.getState();
                const post = state.posts.find(p => p.id === postId);
                
                if (!post || !post.pollOptions || !post.pollActive || !state.currentUser) {
                    utils.showNotification('Unable to vote on this poll', 'error');
                    return;
                }

                const userId = state.currentUser.userId;
                
                // Check if user has already voted
                const hasVoted = post.pollOptions.some(option => 
                    option.voters && option.voters.includes(userId)
                );

                if (hasVoted) {
                    utils.showNotification('You have already voted in this poll', 'warning');
                    return;
                }

                // Add vote
                if (!post.pollOptions[optionIndex].voters) {
                    post.pollOptions[optionIndex].voters = [];
                }
                
                post.pollOptions[optionIndex].voters.push(userId);
                post.pollOptions[optionIndex].votes++;

                // Recalculate percentages
                const totalVotes = post.pollOptions.reduce((sum, option) => sum + option.votes, 0);
                post.pollOptions.forEach(option => {
                    option.percentage = totalVotes > 0 ? Math.round((option.votes / totalVotes) * 100) : 0;
                });

                post.totalVotes = totalVotes;

                // Update live polls tracking
                const livePoll = state.livePolls.find(p => p.postId === postId);
                if (livePoll) {
                    livePoll.options = post.pollOptions;
                    livePoll.totalVotes = totalVotes;
                }

                stateManager.setState({ 
                    posts: state.posts,
                    livePolls: state.livePolls
                });

                utils.showNotification('Vote recorded!', 'success');
                this.renderPosts();
            }

            addComment(postId, commentText, parentCommentId = null) {
                const state = stateManager.getState();
                const post = state.posts.find(p => p.id === postId);
                
                if (!post || !commentText.trim()) return;

                // Check if this is a default message post and prevent commenting
                if (post.isDefaultMessage) {
                    utils.showNotification('Comments are disabled on default messages', 'warning');
                    return;
                }

                const newComment = {
                    id: utils.generateId(),
                    author: state.currentUser ? state.currentUser.fullName : "Anonymous",
                    authorId: state.currentUser ? state.currentUser.userId : "anonymous",
                    text: utils.sanitizeInput(commentText.trim()),
                    timestamp: new Date(),
                    votes: 0,
                    parentId: parentCommentId,
                    replies: []
                };

                if (!post.commentsData) {
                    post.commentsData = [];
                }
                
                if (parentCommentId) {
                    // This is a reply to another comment
                    const parentComment = this.findCommentById(post.commentsData, parentCommentId);
                    if (parentComment) {
                        if (!parentComment.replies) {
                            parentComment.replies = [];
                        }
                        parentComment.replies.push(newComment);
                    }
                } else {
                    // This is a top-level comment
                    post.commentsData.push(newComment);
                }
                
                post.comments++;

                stateManager.setState({ posts: state.posts });
                utils.showNotification('Comment added!', 'success');
                
                return newComment;
            }

            findCommentById(comments, commentId) {
                for (const comment of comments) {
                    if (comment.id === commentId) {
                        return comment;
                    }
                    if (comment.replies) {
                        const found = this.findCommentById(comment.replies, commentId);
                        if (found) return found;
                    }
                }
                return null;
            }

            updatePostVoteDisplay(postId, newVoteCount) {
                const voteCountElement = document.querySelector(`[data-post-id="${postId}"] .vote-count`);
                if (voteCountElement) {
                    voteCountElement.textContent = utils.formatNumber(newVoteCount);
                }
            }

            sortPosts(posts, sortType) {
                switch (sortType) {
                    case 'new':
                        return [...posts].sort((a, b) => b.timestamp - a.timestamp);
                    case 'top':
                        return [...posts].sort((a, b) => b.votes - a.votes);
                    case 'trending':
                        return [...posts].sort((a, b) => {
                            const aScore = this.calculateTrendingScore(a);
                            const bScore = this.calculateTrendingScore(b);
                            return bScore - aScore;
                        });
                    case 'hot':
                    default:
                        return [...posts].sort((a, b) => {
                            const aScore = utils.calculateHotScore(a);
                            const bScore = utils.calculateHotScore(b);
                            return bScore - aScore;
                        });
                }
            }

            calculateTrendingScore(post) {
                const hoursOld = (Date.now() - post.timestamp.getTime()) / (1000 * 60 * 60);
                const engagementScore = post.votes + (post.comments * 2);
                const recencyBonus = Math.max(0, 24 - hoursOld) / 24;
                return engagementScore * (1 + recencyBonus);
            }

            filterPosts(posts, filterType, userMemberships) {
                switch (filterType) {
                    case 'mycommunities':
                        return posts.filter(post => 
                            post.communityId && userMemberships.includes(post.communityId)
                        );
                    case 'general':
                        return posts.filter(post => 
                            post.visibility === 'general' || !post.communityId
                        );
                    case 'all':
                    default:
                        return posts;
                }
            }

            renderPosts() {
                const state = stateManager.getState();
                const filteredPosts = this.filterPosts(state.posts, state.currentFeedFilter, state.userMemberships);
                const sortedPosts = this.sortPosts(filteredPosts, state.currentSort);
                
                this.displayPosts(sortedPosts);
            }

            displayPosts(posts) {
                const container = document.getElementById('posts-feed');
                
                if (posts.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>No posts to show</h3>
                            <p>Be the first to create a post in this feed!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = posts.map(post => this.createPostHTML(post)).join('');
            }

            createPostHTML(post) {
                const state = stateManager.getState();
                const timeAgo = utils.getTimeAgo(post.timestamp);
                const communityDisplay = post.community && post.community !== 'General' 
                    ? `<a href="#" onclick="viewCommunityDetails('${post.communityId}')" style="color: #8b5cf6; text-decoration: none;">c/${post.community}</a>` 
                    : 'General';

                let contentHTML = '';
                
                if (post.type === 'poll' && post.pollOptions) {
                    contentHTML = this.createPollHTML(post);
                } else {
                    if (post.content) {
                        contentHTML += `<div class="post-text">${post.content}</div>`;
                    }
                    
                    if (post.media && post.media.length > 0) {
                        contentHTML += this.createMediaHTML(post.media);
                    }
                }

                // Determine user's vote status
                const userVote = state.currentUser ? 
                    post.userVotes.find(v => v.userId === state.currentUser.userId) : null;

                return `
                    <article class="post-card" role="article" aria-labelledby="post-title-${post.id}" data-post-id="${post.id}">
                        <div class="post-content">
                            <div class="vote-section" role="group" aria-label="Vote on post">
                                <button class="vote-button ${userVote?.direction === 'up' ? 'voted-up' : ''}" 
                                        onclick="postManager.voteOnPost('${post.id}', 'up')" 
                                        aria-label="Upvote post"
                                        title="Upvote">
                                    <i class="fas fa-arrow-up" aria-hidden="true"></i>
                                </button>
                                <div class="vote-count" aria-live="polite">${utils.formatNumber(post.votes)}</div>
                                <button class="vote-button ${userVote?.direction === 'down' ? 'voted-down' : ''}" 
                                        onclick="postManager.voteOnPost('${post.id}', 'down')" 
                                        aria-label="Downvote post"
                                        title="Downvote">
                                    <i class="fas fa-arrow-down" aria-hidden="true"></i>
                                </button>
                            </div>
                            
                            <div class="post-main">
                                <div class="post-meta">
                                    <span>${communityDisplay}</span>
                                    <span></span>
                                    <span>Posted by ${post.author}</span>
                                    <span></span>
                                    <time datetime="${post.timestamp.toISOString()}">${timeAgo}</time>
                                    ${post.type === 'poll' ? '<span> <i class="fas fa-poll" aria-hidden="true"></i> Live Poll</span>' : ''}
                                    ${this.isTrending(post) ? '<span class="feature-badge trending-indicator"> TRENDING</span>' : ''}
                                    ${post.isDefaultMessage ? '<span class="feature-badge"> DEFAULT</span>' : ''}
                                </div>
                                
                                <h2 class="post-title" id="post-title-${post.id}">${post.title}</h2>
                                
                                ${contentHTML}
                                
                                <div class="post-actions">
                                    <div class="post-action-buttons" role="group" aria-label="Post actions">
                                        <button class="post-action-button" 
                                                onclick="toggleComments('${post.id}')" 
                                                aria-expanded="false"
                                                aria-controls="comments-${post.id}">
                                            <i class="far fa-comment" aria-hidden="true"></i>
                                            <span>${utils.formatNumber(post.comments)} Comments</span>
                                        </button>
                                        <button class="post-action-button" 
                                                onclick="sharePost('${post.id}')"
                                                aria-label="Share post">
                                            <i class="fas fa-share" aria-hidden="true"></i>
                                            <span>Share</span>
                                        </button>
                                        <button class="post-action-button" 
                                                onclick="savePost('${post.id}')"
                                                aria-label="Save post">
                                            <i class="far fa-bookmark" aria-hidden="true"></i>
                                            <span>Save</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="comments-section" id="comments-${post.id}" aria-label="Comments for ${post.title}">
                            ${post.isDefaultMessage ? 
                                '<div style="text-align: center; padding: 1rem; color: #666;"><i class="fas fa-lock"></i> Comments are disabled on default messages</div>' :
                                `<div class="comment-input">
                                    <input type="text" 
                                           placeholder="Add a comment..." 
                                           onkeypress="if(event.key==='Enter') addComment('${post.id}', this.value, this)"
                                           aria-label="Add a comment">
                                    <button class="emoji-picker-btn" onclick="toggleEmojiPicker(this)" aria-label="Add emoji">
                                        <i class="far fa-smile"></i>
                                    </button>
                                    <button onclick="addComment('${post.id}', this.parentElement.querySelector('input').value, this.parentElement.querySelector('input'))" 
                                            class="btn btn-primary"
                                            aria-label="Post comment">
                                        Post
                                    </button>
                                </div>`
                            }
                            <div id="comments-list-${post.id}" role="list" aria-label="Comments list">
                                ${this.renderComments(post.commentsData || [], post.id)}
                            </div>
                        </div>
                    </article>
                `;
            }

            createMediaHTML(mediaArray) {
                if (!mediaArray || mediaArray.length === 0) return '';

                const gridClass = mediaArray.length === 1 ? 'single' : 
                                 mediaArray.length === 2 ? 'double' : 'multiple';

                return `
                    <div class="media-grid ${gridClass}">
                        ${mediaArray.map(media => {
                            if (media.type === 'image') {
                                return `
                                    <img src="${media.url}" 
                                         alt="Post image" 
                                         class="post-image" 
                                         onclick="openMediaViewer('${media.url}', 'image')"
                                         loading="lazy">
                                `;
                            } else if (media.type === 'video') {
                                return `
                                    <div class="video-container">
                                        <video class="post-video" 
                                               onclick="openMediaViewer('${media.url}', 'video')"
                                               preload="metadata">
                                            <source src="${media.url}" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                        <div class="video-controls">
                                            <button class="play-pause-btn" onclick="toggleVideoPlayback(this)">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <div class="progress-bar">
                                                <div class="progress-fill"></div>
                                            </div>
                                            <div class="volume-control">
                                                <i class="fas fa-volume-up"></i>
                                                <input type="range" class="volume-slider" min="0" max="100" value="50">
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            return '';
                        }).join('')}
                    </div>
                `;
            }

            createPollHTML(post) {
                if (!post.pollOptions || !Array.isArray(post.pollOptions)) {
                    return '<div class="post-text">Poll data unavailable</div>';
                }

                const state = stateManager.getState();
                const totalVotes = post.pollOptions.reduce((sum, option) => sum + (option.votes || 0), 0);
                const hasVoted = state.currentUser && post.pollOptions.some(option => 
                    option.voters && option.voters.includes(state.currentUser.userId)
                );

                return `
                    <div class="poll-container" role="group" aria-labelledby="poll-question-${post.id}">
                        <div id="poll-question-${post.id}" class="sr-only">${post.title}</div>
                        ${post.pollOptions.map((option, index) => {
                            const percentage = totalVotes > 0 ? Math.round((option.votes / totalVotes) * 100) : 0;
                            const hasUserVoted = state.currentUser && option.voters && option.voters.includes(state.currentUser.userId);
                            
                            return `
                                <div class="poll-option ${hasVoted ? 'voted' : ''}" 
                                     onclick="${hasVoted ? '' : `postManager.voteOnPoll('${post.id}', ${index})`}"
                                     style="cursor: ${hasVoted ? 'default' : 'pointer'}; opacity: ${hasVoted && !hasUserVoted ? '0.7' : '1'};"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Poll option: ${option.text}. ${option.votes} votes, ${percentage}%"
                                     onkeydown="if(event.key==='Enter' && !${hasVoted}) postManager.voteOnPoll('${post.id}', ${index})">
                                    <div class="poll-option-bar" style="width: ${percentage}%"></div>
                                    <span class="poll-option-text">
                                        ${option.text}
                                        ${hasUserVoted ? ' <i class="fas fa-check" style="color: #10b981; margin-left: 0.25rem;" aria-label="You voted for this option"></i>' : ''}
                                    </span>
                                    <span class="poll-option-percentage">${percentage}% (${option.votes})</span>
                                </div>
                            `;
                        }).join('')}
                        <div class="poll-stats">
                            <span>${utils.formatNumber(totalVotes)} total votes</span>
                            ${post.pollExpiresAt ? `<span>  Expires ${utils.getTimeAgo(new Date(post.pollExpiresAt))}</span>` : ''}
                            ${hasVoted ? '<span>  You have voted</span>' : ''}
                            <span class="live-indicator" style="margin-left: 8px;">
                                <div class="live-dot"></div>
                                LIVE
                            </span>
                        </div>
                    </div>
                `;
            }

            renderComments(comments, postId, level = 0) {
                if (!comments || comments.length === 0) {
                    return level === 0 ? '<p style="color: #666; text-align: center; padding: 1rem;">No comments yet. Be the first to comment!</p>' : '';
                }

                return comments.map(comment => `
                    <div class="comment" role="listitem" style="margin-left: ${level * 20}px;">
                        <div class="comment-author">${comment.author}</div>
                        <div class="comment-text">${comment.text}</div>
                        <div class="comment-meta">
                            <span class="comment-time">${utils.getTimeAgo(comment.timestamp)}</span>
                            <div class="comment-actions">
                                <button class="comment-action" onclick="toggleReplyInput('${comment.id}')">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                                <button class="comment-action" onclick="voteOnComment('${comment.id}', 'up')">
                                    <i class="fas fa-arrow-up"></i> ${comment.votes || 0}
                                </button>
                            </div>
                        </div>
                        <div class="reply-input" id="reply-${comment.id}">
                            <input type="text" 
                                   placeholder="Write a reply..." 
                                   onkeypress="if(event.key==='Enter') addReply('${postId}', '${comment.id}', this.value, this)"
                                   style="flex: 1; margin-right: 8px;">
                            <button onclick="addReply('${postId}', '${comment.id}', this.previousElementSibling.value, this.previousElementSibling)" 
                                    class="btn btn-primary btn-sm">Reply</button>
                        </div>
                        ${comment.replies && comment.replies.length > 0 ? 
                            `<div class="comment-replies">
                                ${this.renderComments(comment.replies, postId, level + 1)}
                            </div>` : ''
                        }
                    </div>
                `).join('');
            }

            isTrending(post) {
                const hoursOld = (Date.now() - post.timestamp.getTime()) / (1000 * 60 * 60);
                const engagementRate = (post.votes + post.comments * 2) / Math.max(hoursOld, 1);
                return engagementRate > 10 && hoursOld < 24;
            }
        }

        // Initialize Post Manager
        const postManager = new PostManager();

        // Community Management
        class CommunityManager {
            constructor() {
                this.communities = stateManager.getState().communities;
            }

            async createCommunity(communityData) {
                const state = stateManager.getState();
                
                // Validate community name
                const communityName = communityData.name.replace(/\s+/g, '').toLowerCase();
                
                // Check for restricted names
                if (CONFIG.RESTRICTED_COMMUNITY_NAMES.includes(communityName)) {
                    throw new Error('This community name is reserved and cannot be used!');
                }
                
                if (state.communities.find(c => c.name.toLowerCase() === communityName)) {
                    throw new Error('Community name already exists!');
                }

                const newCommunity = {
                    id: utils.generateId(),
                    name: communityName,
                    displayName: utils.sanitizeInput(communityData.displayName),
                    description: utils.sanitizeInput(communityData.description),
                    type: communityData.type,
                    createdBy: state.currentUser ? state.currentUser.fullName : "Anonymous",
                    createdByUserId: state.currentUser ? state.currentUser.userId : "anonymous",
                    createdAt: new Date().toISOString(),
                    memberCount: 1,
                    topics: communityData.topics ? communityData.topics.split(',').map(t => utils.sanitizeInput(t.trim())) : [],
                    members: [state.currentUser ? state.currentUser.userId : "anonymous"]
                };

                const updatedCommunities = [...state.communities, newCommunity];
                const updatedMemberships = [...state.userMemberships, newCommunity.id];
                const updatedCreatedCommunities = [...state.userCreatedCommunities, newCommunity.id];

                stateManager.setState({
                    communities: updatedCommunities,
                    userMemberships: updatedMemberships,
                    userCreatedCommunities: updatedCreatedCommunities
                });

                utils.showNotification(`Community "${communityData.displayName}" created successfully!`, 'success');
                return newCommunity;
            }

            joinCommunity(communityId) {
                const state = stateManager.getState();
                
                if (state.userMemberships.includes(communityId)) {
                    utils.showNotification('You are already a member of this community!', 'warning');
                    return;
                }

                const community = state.communities.find(c => c.id === communityId);
                if (!community) return;

                community.memberCount++;
                community.members.push(state.currentUser ? state.currentUser.userId : "anonymous");

                const updatedMemberships = [...state.userMemberships, communityId];

                stateManager.setState({
                    communities: state.communities,
                    userMemberships: updatedMemberships
                });

                utils.showNotification(`Joined ${community.displayName}!`, 'success');
            }

            leaveCommunity(communityId) {
                const state = stateManager.getState();
                
                if (!state.userMemberships.includes(communityId)) {
                    utils.showNotification('You are not a member of this community!', 'warning');
                    return;
                }

                // Don't allow leaving if user is the creator
                if (state.userCreatedCommunities.includes(communityId)) {
                    utils.showNotification('You cannot leave a community you created. Delete it instead.', 'warning');
                    return;
                }

                const community = state.communities.find(c => c.id === communityId);
                if (!community) return;

                community.memberCount = Math.max(0, community.memberCount - 1);
                community.members = community.members.filter(id => id !== (state.currentUser ? state.currentUser.userId : "anonymous"));

                const updatedMemberships = state.userMemberships.filter(id => id !== communityId);

                stateManager.setState({
                    communities: state.communities,
                    userMemberships: updatedMemberships
                });

                utils.showNotification(`Left ${community.displayName}!`, 'success');
            }

            deleteCommunity(communityId) {
                const state = stateManager.getState();
                const community = state.communities.find(c => c.id === communityId);
                
                if (!community) return;

                // Check if user is the creator
                if (community.createdByUserId !== (state.currentUser ? state.currentUser.userId : "anonymous")) {
                    utils.showNotification('You can only delete communities you created!', 'error');
                    return;
                }

                if (!confirm('Are you sure you want to delete this community? This action cannot be undone.')) {
                    return;
                }

                // Remove community and related data
                const updatedCommunities = state.communities.filter(c => c.id !== communityId);
                const updatedPosts = state.posts.filter(p => p.communityId !== communityId);
                const updatedMemberships = state.userMemberships.filter(id => id !== communityId);
                const updatedCreatedCommunities = state.userCreatedCommunities.filter(id => id !== communityId);

                stateManager.setState({
                    communities: updatedCommunities,
                    posts: updatedPosts,
                    userMemberships: updatedMemberships,
                    userCreatedCommunities: updatedCreatedCommunities
                });

                utils.showNotification('Community deleted successfully!', 'success');
            }

            searchCommunities(query) {
                const state = stateManager.getState();
                return state.communities.filter(c => 
                    c.name.toLowerCase().includes(query.toLowerCase()) || 
                    c.displayName.toLowerCase().includes(query.toLowerCase()) ||
                    (c.description && c.description.toLowerCase().includes(query.toLowerCase())) ||
                    (c.topics && c.topics.some(topic => topic.toLowerCase().includes(query.toLowerCase())))
                );
            }

            filterCommunities(communities, filterType) {
                switch (filterType) {
                    case 'public':
                        return communities.filter(c => c.type === 'public');
                    case 'private':
                        return communities.filter(c => c.type === 'private');
                    case 'all':
                    default:
                        return communities;
                }
            }

            updateCommunityLists() {
                const state = stateManager.getState();
                this.updateCreatedCommunities(state);
                this.updateJoinedCommunities(state);
                this.updateRecommendedCommunities(state);
            }

            updateCreatedCommunities(state) {
                const createdCommunitiesUL = document.getElementById('createdCommunitiesUL');
                if (!createdCommunitiesUL) return;

                const createdCommunities = state.communities.filter(c => state.userCreatedCommunities.includes(c.id));
                
                createdCommunitiesUL.innerHTML = createdCommunities.map(community => `
                    <li>
                        <a href="#" onclick="viewCommunityDetails('${community.id}')" style="display: flex; align-items: center; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 8px; transition: all 0.3s ease; text-decoration: none;">
                            <span class="community-icon ${utils.getCommunityColor(community.name)}" style="margin-right: 0.5rem;">
                                ${community.name.charAt(0)}
                            </span>
                            <span style="flex: 1; font-size: 0.9rem;">${community.displayName}</span>
                            ${community.type === 'private' ? '<i class="fas fa-lock" style="font-size: 10px; color: #666; margin-right: 0.25rem;" title="Private community"></i>' : ''}
                            <i class="fas fa-crown" style="font-size: 10px; color: #ffd700;" title="You created this community"></i>
                        </a>
                    </li>
                `).join('');

                if (createdCommunities.length === 0) {
                    createdCommunitiesUL.innerHTML = '<li style="color: #666; font-size: 0.8rem; padding: 0.5rem;">No communities created yet</li>';
                }
            }

            updateJoinedCommunities(state) {
                const joinedCommunitiesUL = document.getElementById('joinedCommunitiesUL');
                if (!joinedCommunitiesUL) return;

                const joinedCommunities = state.communities.filter(c => 
                    state.userMemberships.includes(c.id) && !state.userCreatedCommunities.includes(c.id)
                );
                
                joinedCommunitiesUL.innerHTML = joinedCommunities.map(community => `
                    <li>
                        <a href="#" onclick="viewCommunityDetails('${community.id}')" style="display: flex; align-items: center; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 8px; transition: all 0.3s ease; text-decoration: none;">
                            <span class="community-icon ${utils.getCommunityColor(community.name)}" style="margin-right: 0.5rem;">
                                ${community.name.charAt(0)}
                            </span>
                            <span style="flex: 1; font-size: 0.9rem;">${community.displayName}</span>
                            ${community.type === 'private' ? '<i class="fas fa-lock" style="font-size: 10px; color: #666;" title="Private community"></i>' : ''}
                        </a>
                    </li>
                `).join('');

                if (joinedCommunities.length === 0) {
                    joinedCommunitiesUL.innerHTML = '<li style="color: #666; font-size: 0.8rem; padding: 0.5rem;">No communities joined yet</li>';
                }
            }

            updateRecommendedCommunities(state) {
                const recommendedContainer = document.getElementById('recommendedCommunities');
                if (!recommendedContainer) return;

                const nonMemberCommunities = state.communities.filter(c => 
                    !state.userMemberships.includes(c.id) && c.type === 'public'
                ).slice(0, 3);

                recommendedContainer.innerHTML = nonMemberCommunities.map(community => `
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s ease;" 
                         onclick="viewCommunityDetails('${community.id}')"
                         onmouseover="this.style.background='#333'"
                         onmouseout="this.style.background='#2a2a2a'">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span class="community-icon ${utils.getCommunityColor(community.name)}" style="margin-right: 0.5rem; width: 32px; height: 32px; font-size: 14px;">
                                ${community.name.charAt(0)}
                            </span>
                            <div style="flex: 1;">
                                <h4 style="font-size: 0.9rem; margin: 0;">${community.displayName}</h4>
                                <p style="font-size: 0.7rem; color: #999; margin: 0;">${utils.formatNumber(community.memberCount)} members</p>
                            </div>
                            <span style="background: ${community.type === 'private' ? '#ef4444' : '#10b981'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                                ${community.type}
                            </span>
                        </div>
                        <p style="font-size: 0.75rem; color: #ccc; margin: 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${community.description || 'No description available'}
                        </p>
                    </div>
                `).join('');

                if (nonMemberCommunities.length === 0) {
                    recommendedContainer.innerHTML = '<p style="color: #666; font-size: 0.8rem;">No new communities to discover</p>';
                }
            }
        }

        // Initialize Community Manager
        const communityManager = new CommunityManager();

        // Chat System
        class ChatSystem {
            constructor() {
                this.messages = [];
                this.isOpen = false;
                this.agentResponses = [
                    "Thanks for your message! Our team will get back to you soon.",
                    "I'm here to help! Can you provide more details about your issue?",
                    "That's a great question! Let me connect you with a specialist.",
                    "I understand your concern. We're working on improving that feature.",
                    "Thanks for using SmileX! Is there anything specific I can help you with?",
                    "I appreciate your feedback! We're always looking to improve our platform.",
                    "Let me help you with that. Can you tell me more about what you're experiencing?",
                    "That's an interesting point! Our development team would love to hear about this.",
                    "I'm glad you reached out! Customer satisfaction is our top priority.",
                    "Thanks for being part of the SmileX community! How can I assist you today?"
                ];
            }

            toggleChat() {
                this.isOpen = !this.isOpen;
                const chatContainer = document.getElementById('chat-container');
                const chatToggle = document.getElementById('chat-toggle-btn');
                
                if (this.isOpen) {
                    chatContainer.classList.add('active');
                    chatToggle.innerHTML = '<i class="fas fa-times"></i>';
                    chatToggle.setAttribute('aria-label', 'Close live chat');
                } else {
                    chatContainer.classList.remove('active');
                    chatToggle.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    chatToggle.setAttribute('aria-label', 'Open live chat');
                }
            }

            sendMessage(messageText) {
                if (!messageText.trim()) return;

                const state = stateManager.getState();
                const userMessage = {
                    id: utils.generateId(),
                    sender: state.currentUser ? state.currentUser.fullName : "You",
                    text: utils.sanitizeInput(messageText.trim()),
                    timestamp: new Date(),
                    type: 'user'
                };

                this.messages.push(userMessage);
                this.renderMessages();

                // Simulate agent response
                setTimeout(() => {
                    const agentMessage = {
                        id: utils.generateId(),
                        sender: "Support Agent",
                        text: this.agentResponses[Math.floor(Math.random() * this.agentResponses.length)],
                        timestamp: new Date(),
                        type: 'agent'
                    };

                    this.messages.push(agentMessage);
                    this.renderMessages();
                }, 1000 + Math.random() * 2000); // Random delay between 1-3 seconds
            }

            renderMessages() {
                const messagesContainer = document.getElementById('chat-messages');
                if (!messagesContainer) return;

                messagesContainer.innerHTML = this.messages.map(message => `
                    <div class="message ${message.type}" role="listitem">
                        <div class="message-user">${message.sender}</div>
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${utils.getTimeAgo(message.timestamp)}</div>
                    </div>
                `).join('');

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Initialize Chat System
        const chatSystem = new ChatSystem();

        // Live Updates System
        class LiveUpdatesSystem {
            constructor() {
                this.updateInterval = null;
                this.isActive = false;
            }

            start() {
                if (this.isActive) return;
                
                this.isActive = true;
                this.updateInterval = setInterval(() => {
                    this.performLiveUpdates();
                }, CONFIG.LIVE_UPDATE_INTERVAL);
            }

            stop() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
                this.isActive = false;
            }

            performLiveUpdates() {
                const state = stateManager.getState();
                
                // Simulate live user activity with realistic numbers
                const newOnlineUsers = state.onlineUsers + Math.floor(Math.random() * 200) - 100;
                const newActivePolls = Math.max(0, state.activePolls + Math.floor(Math.random() * 10) - 5);
                const newPostsToday = state.postsToday + Math.floor(Math.random() * 50);

                stateManager.setState({
                    onlineUsers: Math.max(100000, newOnlineUsers), // Keep minimum at 100k
                    activePolls: newActivePolls,
                    postsToday: newPostsToday
                });

                this.updateLiveStats();
                
                // Occasionally show update indicator
                if (Math.random() < 0.1) { // 10% chance
                    this.showUpdateIndicator();
                }
            }

            updateLiveStats() {
                const state = stateManager.getState();
                
                const onlineUsersEl = document.getElementById('onlineUsers');
                const activePollsEl = document.getElementById('activePolls');
                const postsTodayEl = document.getElementById('postsToday');

                if (onlineUsersEl) onlineUsersEl.textContent = utils.formatNumber(state.onlineUsers);
                if (activePollsEl) activePollsEl.textContent = utils.formatNumber(state.activePolls);
                if (postsTodayEl) postsTodayEl.textContent = utils.formatNumber(state.postsToday);
            }

            showUpdateIndicator() {
                const indicator = document.getElementById('update-indicator');
                if (!indicator) return;

                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        }

        // Initialize Live Updates System
        const liveUpdatesSystem = new LiveUpdatesSystem();

        // Global Functions (accessible from HTML)
        window.selectUsernameSuggestion = function(suggestion) {
            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.value = suggestion;
                usernameInput.dispatchEvent(new Event('input'));
            }
        };

        window.toggleComments = function(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            const button = document.querySelector(`[onclick="toggleComments('${postId}')"]`);
            
            if (commentsSection.classList.contains('active')) {
                commentsSection.classList.remove('active');
                button.setAttribute('aria-expanded', 'false');
            } else {
                commentsSection.classList.add('active');
                button.setAttribute('aria-expanded', 'true');
            }
        };

        window.addComment = function(postId, commentText, inputElement) {
            if (!commentText.trim()) return;

            const comment = postManager.addComment(postId, commentText);
            if (comment) {
                inputElement.value = '';
                
                // Update comments display
                const commentsList = document.getElementById(`comments-list-${postId}`);
                if (commentsList) {
                    const post = stateManager.getState().posts.find(p => p.id === postId);
                    if (post) {
                        commentsList.innerHTML = postManager.renderComments(post.commentsData || [], postId);
                    }
                }

                // Update comment count in button
                const commentButton = document.querySelector(`[onclick="toggleComments('${postId}')"] span`);
                if (commentButton) {
                    const post = stateManager.getState().posts.find(p => p.id === postId);
                    if (post) {
                        commentButton.textContent = `${utils.formatNumber(post.comments)} Comments`;
                    }
                }
            }
        };

        window.addReply = function(postId, parentCommentId, replyText, inputElement) {
            if (!replyText.trim()) return;

            const reply = postManager.addComment(postId, replyText, parentCommentId);
            if (reply) {
                inputElement.value = '';
                
                // Hide reply input
                const replyInput = document.getElementById(`reply-${parentCommentId}`);
                if (replyInput) {
                    replyInput.classList.remove('active');
                }
                
                // Update comments display
                const commentsList = document.getElementById(`comments-list-${postId}`);
                if (commentsList) {
                    const post = stateManager.getState().posts.find(p => p.id === postId);
                    if (post) {
                        commentsList.innerHTML = postManager.renderComments(post.commentsData || [], postId);
                    }
                }
            }
        };

        window.toggleReplyInput = function(commentId) {
            const replyInput = document.getElementById(`reply-${commentId}`);
            if (replyInput) {
                replyInput.classList.toggle('active');
                if (replyInput.classList.contains('active')) {
                    const input = replyInput.querySelector('input');
                    if (input) input.focus();
                }
            }
        };

        window.voteOnComment = function(commentId, direction) {
            // Implement comment voting logic
            utils.showNotification('Comment vote recorded!', 'success');
        };

        window.toggleEmojiPicker = function(button) {
            const existingPicker = button.parentElement.querySelector('.emoji-picker');
            
            if (existingPicker) {
                existingPicker.remove();
            } else {
                const picker = utils.createEmojiPicker();
                button.parentElement.style.position = 'relative';
                button.parentElement.appendChild(picker);
                picker.classList.add('active');
            }
        };

        window.insertEmoji = function(emoji) {
            const activeInput = document.activeElement;
            if (activeInput && (activeInput.tagName === 'INPUT' || activeInput.tagName === 'TEXTAREA')) {
                const start = activeInput.selectionStart;
                const end = activeInput.selectionEnd;
                const text = activeInput.value;
                activeInput.value = text.substring(0, start) + emoji + text.substring(end);
                activeInput.selectionStart = activeInput.selectionEnd = start + emoji.length;
                activeInput.focus();
            }
            
            // Close emoji picker
            const picker = document.querySelector('.emoji-picker.active');
            if (picker) {
                picker.remove();
            }
        };

        window.sharePost = function(postId) {
            const state = stateManager.getState();
            const post = state.posts.find(p => p.id === postId);
            
            if (!post) return;

            if (navigator.share) {
                navigator.share({
                    title: post.title,
                    text: post.content,
                    url: window.location.href
                }).catch(console.error);
            } else {
                // Fallback: copy to clipboard
                const shareText = `${post.title}\n\n${post.content}\n\nShared from SmileX`;
                navigator.clipboard.writeText(shareText).then(() => {
                    utils.showNotification('Post copied to clipboard!', 'success');
                }).catch(() => {
                    utils.showNotification('Unable to share post', 'error');
                });
            }
        };

        window.savePost = function(postId) {
            // In a real app, this would save to user's saved posts
            utils.showNotification('Post saved!', 'success');
        };

        window.viewCommunityDetails = function(communityId) {
            const state = stateManager.getState();
            const community = state.communities.find(c => c.id === communityId);
            
            if (!community) return;

            // Set current community and show modal
            stateManager.setState({ currentCommunity: community });
            showCommunityDetailModal(community);
        };

        window.openMediaViewer = function(mediaUrl, mediaType) {
            const modal = document.getElementById('media-viewer-modal');
            const content = document.getElementById('mediaViewerContent');
            
            if (mediaType === 'image') {
                content.innerHTML = `<img src="${mediaUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="Full size image">`;
            } else if (mediaType === 'video') {
                content.innerHTML = `<video src="${mediaUrl}" controls style="max-width: 100%; max-height: 100%;" autoplay>Your browser does not support the video tag.</video>`;
            }
            
            modal.classList.add('active');
        };

        window.toggleVideoPlayback = function(button) {
            const video = button.closest('.video-container').querySelector('video');
            const icon = button.querySelector('i');
            
            if (video.paused) {
                video.play();
                icon.className = 'fas fa-pause';
            } else {
                video.pause();
                icon.className = 'fas fa-play';
            }
        };

        // Initialize Sample Data
        function initializeSampleData() {
            const state = stateManager.getState();
            
            if (state.posts.length === 0) {
                const samplePosts = [
                    {
                        id: utils.generateId(),
                        title: " WELCOME EVERYONE TO SMILEX! ",
                        content: "Welcome, everyone and those viewing this message to explore and have fun on this page, but remember the rules and regulations. This is a fully functional social media platform with real-time features, live polls, media sharing, and community management! Enjoy your experience and connect with amazing people from around the world.",
                        author: "SmileX Team",
                        authorId: "system",
                        community: "SmileX Official",
                        communityId: "c1",
                        visibility: "general",
                        votes: 15420,
                        comments: 3247,
                        timestamp: new Date(Date.now() - 3600000),
                        type: "text",
                        media: [],
                        userVotes: [],
                        commentsData: [
                            {
                                id: utils.generateId(),
                                author: "TechEnthusiast",
                                authorId: "user1",
                                text: "This platform looks amazing! Love the real-time features and the clean interface. ",
                                timestamp: new Date(Date.now() - 1800000),
                                votes: 45,
                                replies: [
                                    {
                                        id: utils.generateId(),
                                        author: "SmileX Team",
                                        authorId: "system",
                                        text: "Thank you! We're constantly working to improve the user experience. ",
                                        timestamp: new Date(Date.now() - 1700000),
                                        votes: 12
                                    }
                                ]
                            },
                            {
                                id: utils.generateId(),
                                author: "DesignGuru",
                                authorId: "user2",
                                text: "The UI is so clean and modern. Great work on the accessibility features too! ",
                                timestamp: new Date(Date.now() - 900000),
                                votes: 32,
                                replies: []
                            }
                        ],
                        isDefaultMessage: true
                    },
                    {
                        id: utils.generateId(),
                        title: " New Gaming Setup Showcase - RTX 4090 Build",
                        content: "Finally completed my dream gaming setup! Featuring RTX 4090, AMD Ryzen 9 7950X, 64GB DDR5 RAM, and custom water cooling. Spent 6 months planning and building this beast. What do you think? Any suggestions for improvements?",
                        author: "GamerPro",
                        authorId: "user_gamer",
                        community: "Gaming Zone",
                        communityId: "c2",
                        visibility: "community",
                        votes: 8743,
                        comments: 1247,
                        timestamp: new Date(Date.now() - 7200000),
                        type: "image",
                        media: [
                            {
                                url: "/placeholder.svg?height=400&width=600",
                                type: "image",
                                name: "gaming-setup.jpg"
                            }
                        ],
                        userVotes: [],
                        commentsData: [],
                        isDefaultMessage: false
                    },
                    {
                        id: utils.generateId(),
                        title: " What programming language should I learn next for AI/ML?",
                        content: "I'm a web developer with 3 years of experience in JavaScript and React. Now I want to dive into AI and machine learning. Which language would you recommend and why?",
                        author: "CodeNewbie",
                        authorId: "user_coder",
                        community: "Tech Talks",
                        communityId: "c3",
                        visibility: "community",
                        votes: 5621,
                        comments: 892,
                        timestamp: new Date(Date.now() - 10800000),
                        type: "poll",
                        media: [],
                        pollOptions: [
                            { text: "Python  (TensorFlow, PyTorch)", votes: 2847, percentage: 45, voters: [] },
                            { text: "R  (Statistical Analysis)", votes: 1265, percentage: 20, voters: [] },
                            { text: "Julia  (High Performance)", votes: 948, percentage: 15, voters: [] },
                            { text: "JavaScript  (TensorFlow.js)", votes: 632, percentage: 10, voters: [] },
                            { text: "C++  (Performance Critical)", votes: 632, percentage: 10, voters: [] }
                        ],
                        pollId: "poll_1",
                        pollActive: true,
                        totalVotes: 6324,
                        userVotes: [],
                        commentsData: [],
                        isDefaultMessage: false
                    },
                    {
                        id: utils.generateId(),
                        title: " Amazing Nature Documentary: Planet Earth III",
                        content: "Just finished watching the latest Planet Earth documentary series. The cinematography is absolutely breathtaking! The way they captured the wildlife behavior in 8K is mind-blowing. Highly recommend for anyone who loves nature and wildlife photography.",
                        author: "NatureLover",
                        authorId: "user_nature",
                        community: "General",
                        visibility: "general",
                        votes: 3247,
                        comments: 456,
                        timestamp: new Date(Date.now() - 14400000),
                        type: "video",
                        media: [
                            {
                                url: "/placeholder.svg?height=300&width=500",
                                type: "video",
                                name: "nature-doc.mp4"
                            }
                        ],
                        userVotes: [],
                        commentsData: [],
                        isDefaultMessage: false
                    },
                    {
                        id: utils.generateId(),
                        title: " Startup Idea: AI-Powered Personal Finance Assistant",
                        content: "Working on a new startup idea - an AI assistant that helps people manage their finances better. It would analyze spending patterns, suggest budget optimizations, and provide personalized investment advice. What features would you want to see?",
                        author: "Entrepreneur",
                        authorId: "user_entrepreneur",
                        community: "Tech Talks",
                        communityId: "c3",
                        visibility: "community",
                        votes: 2156,
                        comments: 324,
                        timestamp: new Date(Date.now() - 18000000),
                        type: "text",
                        media: [],
                        userVotes: [],
                        commentsData: [],
                        isDefaultMessage: false
                    }
                ];

                const sampleCommunities = [
                    {
                        id: "c1",
                        name: "smilex",
                        displayName: "SmileX Official",
                        description: "The official community for SmileX platform updates, announcements, and general discussions. Stay updated with the latest features, connect with the team, and share your feedback to help us improve the platform!",
                        type: "public",
                        createdBy: "SmileX Team",
                        createdByUserId: "system",
                        createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                        memberCount: 127543,
                        topics: ["news", "updates", "announcements", "feedback", "support"],
                        members: ["system"]
                    },
                    {
                        id: "c2",
                        name: "gaming",
                        displayName: "Gaming Zone",
                        description: "A vibrant community for all gamers to share their experiences, tips, discuss the latest releases, showcase setups, and connect with fellow gaming enthusiasts from around the world.",
                        type: "public",
                        createdBy: "GameMaster",
                        createdByUserId: "system",
                        createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                        memberCount: 89763,
                        topics: ["games", "esports", "console", "pc", "mobile", "reviews"],
                        members: ["system"]
                    },
                    {
                        id: "c3",
                        name: "techtalks",
                        displayName: "Tech Talks",
                        description: "Discuss the latest in technology, programming, AI developments, startups, and share knowledge with fellow tech enthusiasts. From coding tutorials to industry insights.",
                        type: "public",
                        createdBy: "TechGuru",
                        createdByUserId: "system",
                        createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                        memberCount: 76214,
                        topics: ["technology", "programming", "ai", "gadgets", "startups", "coding"],
                        members: ["system"]
                    },
                    {
                        id: "c4",
                        name: "artistslounge",
                        displayName: "Artists Lounge",
                        description: "A private community for artists to share their work, get constructive feedback, collaborate on creative projects, and connect with other creative minds.",
                        type: "private",
                        createdBy: "ArtMaster",
                        createdByUserId: "system",
                        createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        memberCount: 12842,
                        topics: ["art", "drawing", "design", "photography", "creative", "portfolio"],
                        members: ["system"]
                    },
                    {
                        id: "c5",
                        name: "fitness",
                        displayName: "Fitness & Health",
                        description: "Share your fitness journey, workout routines, healthy recipes, and motivate each other to achieve health and wellness goals together.",
                        type: "public",
                        createdBy: "FitnessCoach",
                        createdByUserId: "system",
                        createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        memberCount: 54321,
                        topics: ["fitness", "health", "workout", "nutrition", "wellness", "motivation"],
                        members: ["system"]
                    }
                ];

                stateManager.setState({
                    posts: samplePosts,
                    communities: sampleCommunities,
                    onlineUsers: 127543,
                    activePolls: 1247,
                    postsToday: 45678
                });
            }
        }

        // Show Community Detail Modal
        function showCommunityDetailModal(community) {
            const modal = document.getElementById('community-detail-modal');
            const state = stateManager.getState();
            
            // Update modal content
            const header = document.getElementById('communityDetailHeader');
            const description = document.getElementById('communityDetailDescription');
            const creator = document.getElementById('communityCreator');
            const creationDate = document.getElementById('communityCreationDate');
            const memberCount = document.getElementById('communityMemberCount');
            const communityType = document.getElementById('communityType');
            const topics = document.getElementById('communityTopics');
            const joinLeaveButton = document.getElementById('joinLeaveButton');
            const deleteButton = document.getElementById('deleteCommunityButton');
            const communityPosts = document.getElementById('communityPosts');

            header.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span class="community-icon ${utils.getCommunityColor(community.name)}" style="width: 60px; height: 60px; font-size: 24px;">
                        ${community.name.charAt(0)}
                    </span>
                    <div>
                        <h3 id="community-detail-title">${community.displayName}</h3>
                        <p style="color: #999; margin: 0;">c/${community.name}</p>
                    </div>
                </div>
                <button id="closeCommunityDetailModal" class="modal-close" onclick="closeCommunityDetailModal()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            description.textContent = community.description || 'No description available';
            creator.textContent = community.createdBy;
            creationDate.textContent = new Date(community.createdAt).toLocaleDateString();
            memberCount.textContent = utils.formatNumber(community.memberCount);
            communityType.innerHTML = `
                <span style="background: ${community.type === 'private' ? '#ef4444' : '#10b981'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                    ${community.type}
                </span>
            `;

            // Topics
            if (community.topics && community.topics.length > 0) {
                topics.innerHTML = community.topics.map(topic => 
                    `<span style="background: #333; color: #ccc; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin: 2px;">#${topic}</span>`
                ).join('');
            } else {
                topics.innerHTML = '<span style="color: #666;">No topics specified</span>';
            }

            // Join/Leave button
            const isMember = state.userMemberships.includes(community.id);
            const isCreator = state.userCreatedCommunities.includes(community.id);
            
            if (isCreator) {
                joinLeaveButton.style.display = 'none';
                deleteButton.style.display = 'inline-block';
                deleteButton.onclick = () => {
                    communityManager.deleteCommunity(community.id);
                    closeCommunityDetailModal();
                };
            } else {
                joinLeaveButton.style.display = 'inline-block';
                deleteButton.style.display = 'none';
                joinLeaveButton.textContent = isMember ? 'Leave' : 'Join';
                joinLeaveButton.className = isMember ? 'btn btn-secondary' : 'btn btn-primary';
                joinLeaveButton.onclick = () => {
                    if (isMember) {
                        communityManager.leaveCommunity(community.id);
                    } else {
                        communityManager.joinCommunity(community.id);
                    }
                    closeCommunityDetailModal();
                };
            }

            // Recent posts from this community
            const communityPostsList = state.posts.filter(p => p.communityId === community.id).slice(0, 3);
            if (communityPostsList.length > 0) {
                communityPosts.innerHTML = communityPostsList.map(post => `
                    <div style="background: #333; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer;" 
                         onclick="viewPost('${post.id}')">
                        <h5 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">${post.title}</h5>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #999;">
                            <span>by ${post.author}</span>
                            <span>${utils.getTimeAgo(post.timestamp)}</span>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.75rem; color: #999;">
                            <span><i class="fas fa-arrow-up"></i> ${utils.formatNumber(post.votes)}</span>
                            <span><i class="fas fa-comment"></i> ${utils.formatNumber(post.comments)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                communityPosts.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No posts in this community yet</p>';
            }

            modal.classList.add('active');
        }

        window.closeCommunityDetailModal = function() {
            const modal = document.getElementById('community-detail-modal');
            modal.classList.remove('active');
        };

        window.viewPost = function(postId) {
            // In a real app, this would navigate to the specific post
            closeCommunityDetailModal();
            utils.showNotification('Post view feature coming soon!', 'info');
        };

        // Event Listeners Setup
        function setupEventListeners() {
            // Preloader
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const preloader = document.getElementById('preloader');
                    preloader.style.opacity = '0';
                    setTimeout(() => {
                        preloader.style.display = 'none';
                    }, 500);
                }, 1500);
            });

            // Registration Form
            const registrationForm = document.getElementById('registrationForm');
            if (registrationForm) {
                registrationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(registrationForm);
                    const userData = Object.fromEntries(formData.entries());
                    
                    // Validate required fields
                    const requiredFields = ['fullName', 'username', 'email', 'gender', 'country'];
                    const missingFields = requiredFields.filter(field => !userData[field]);
                    
                    if (missingFields.length > 0) {
                        utils.showNotification(`Please fill in all required fields: ${missingFields.join(', ')}`, 'error');
                        return;
                    }

                    // Check consents
                    if (!userData.ageConsent || !userData.termsConsent || !userData.privacyConsent) {
                        utils.showNotification('Please accept all required consents to continue', 'error');
                        return;
                    }

                    // Final username validation
                    const isUsernameValid = await usernameValidator.checkAvailability(userData.username);
                    if (!isUsernameValid) {
                        utils.showNotification('Please choose a different username', 'error');
                        return;
                    }

                    // Create user profile
                    const newUser = {
                        userId: utils.generateId(),
                        fullName: userData.fullName,
                        username: userData.username,
                        email: userData.email,
                        gender: userData.gender,
                        country: userData.country,
                        profilePicture: cameraSystem.getCapturedImage() || null,
                        joinedAt: new Date().toISOString(),
                        isActive: true
                    };

                    stateManager.setState({ currentUser: newUser });
                    
                    // Update UI with user info
                    updateUserInterface(newUser);
                    
                    // Close onboarding modal
                    document.getElementById('onboardingOverlay').classList.remove('active');
                    
                    utils.showNotification(`Welcome to SmileX, ${newUser.fullName}! `, 'success');
                    
                    // Initialize sample data and render
                    initializeSampleData();
                    postManager.renderPosts();
                    communityManager.updateCommunityLists();
                    liveUpdatesSystem.start();
                });

                // Real-time form validation
                const usernameInput = document.getElementById('username');
                const usernameStatus = document.getElementById('usernameStatus');
                const usernameSuggestions = document.getElementById('usernameSuggestions');
                const submitBtn = document.getElementById('submitBtn');

                if (usernameInput) {
                    const debouncedValidation = utils.debounce(async (username) => {
                        const isValid = await usernameValidator.validateUsername(username, usernameStatus, usernameSuggestions);
                        updateSubmitButton();
                    }, 500);

                    usernameInput.addEventListener('input', (e) => {
                        debouncedValidation(e.target.value);
                    });
                }

                // Form validation for submit button
                function updateSubmitButton() {
                    const formData = new FormData(registrationForm);
                    const userData = Object.fromEntries(formData.entries());
                    
                    const isFormValid = userData.fullName && 
                                       userData.username && 
                                       userData.email && 
                                       userData.gender && 
                                       userData.country &&
                                       userData.ageConsent &&
                                       userData.termsConsent &&
                                       userData.privacyConsent &&
                                       usernameStatus.classList.contains('available');

                    submitBtn.disabled = !isFormValid;
                }

                // Add event listeners to all form inputs
                registrationForm.addEventListener('change', updateSubmitButton);
                registrationForm.addEventListener('input', updateSubmitButton);
            }

            // Profile Picture Upload
            const profilePicInput = document.getElementById('profilePicInput');
            const uploadFromDevice = document.getElementById('uploadFromDevice');
            const takePhoto = document.getElementById('takePhoto');
            const profilePicPreview = document.getElementById('profilePicPreview');

            if (uploadFromDevice) {
                uploadFromDevice.addEventListener('click', () => {
                    profilePicInput.click();
                });
            }

            if (profilePicInput) {
                profilePicInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            utils.validateFile(file);
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                profilePicPreview.innerHTML = `<img src="${e.target.result}" alt="Profile preview">`;
                            };
                            reader.readAsDataURL(file);
                        } catch (error) {
                            utils.showNotification(error.message, 'error');
                        }
                    }
                });
            }

            if (takePhoto) {
                takePhoto.addEventListener('click', () => {
                    document.getElementById('camera-modal').classList.add('active');
                    cameraSystem.startCamera();
                });
            }

            // Camera Modal
            const cameraModal = document.getElementById('camera-modal');
            const closeCameraModal = document.getElementById('closeCameraModal');
            const cancelCamera = document.getElementById('cancelCamera');
            const captureBtn = document.getElementById('captureBtn');
            const usePhoto = document.getElementById('usePhoto');

            if (closeCameraModal) {
                closeCameraModal.addEventListener('click', () => {
                    cameraModal.classList.remove('active');
                    cameraSystem.stopCamera();
                });
            }

            if (cancelCamera) {
                cancelCamera.addEventListener('click', () => {
                    cameraModal.classList.remove('active');
                    cameraSystem.stopCamera();
                });
            }

            if (captureBtn) {
                captureBtn.addEventListener('click', () => {
                    const capturedImage = cameraSystem.capturePhoto();
                    if (capturedImage) {
                        usePhoto.style.display = 'inline-block';
                        captureBtn.style.display = 'none';
                    }
                });
            }

            if (usePhoto) {
                usePhoto.addEventListener('click', () => {
                    const capturedImage = cameraSystem.getCapturedImage();
                    if (capturedImage) {
                        profilePicPreview.innerHTML = `<img src="${capturedImage}" alt="Captured profile photo">`;
                        cameraModal.classList.remove('active');
                        cameraSystem.stopCamera();
                    }
                });
            }

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            const searchFilters = document.getElementById('searchFilters');

            if (searchInput) {
                const debouncedSearch = utils.debounce(async (query) => {
                    if (query.trim().length < 2) {
                        searchResults.classList.add('hidden');
                        return;
                    }

                    const results = await searchSystem.performSearch(query, {
                        type: document.querySelector('.filter-chip.active')?.dataset.filter || 'all'
                    });

                    displaySearchResults(results);
                    searchResults.classList.remove('hidden');
                }, 300);

                searchInput.addEventListener('input', (e) => {
                    debouncedSearch(e.target.value);
                });

                searchInput.addEventListener('focus', () => {
                    if (searchInput.value.trim().length >= 2) {
                        searchResults.classList.remove('hidden');
                    }
                });

                // Close search results when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                        searchResults.classList.add('hidden');
                    }
                });
            }

            // Search filters
            if (searchFilters) {
                searchFilters.addEventListener('click', (e) => {
                    if (e.target.classList.contains('filter-chip')) {
                        // Update active filter
                        searchFilters.querySelectorAll('.filter-chip').forEach(chip => {
                            chip.classList.remove('active');
                        });
                        e.target.classList.add('active');

                        // Re-run search with new filter
                        if (searchInput.value.trim().length >= 2) {
                            searchSystem.performSearch(searchInput.value, {
                                type: e.target.dataset.filter
                            }).then(displaySearchResults);
                        }
                    }
                });
            }

            // Create Post Modal
            const createPostModal = document.getElementById('create-post-modal');
            const createPostInput = document.getElementById('createPostInput');
            const closeCreatePostModal = document.getElementById('closeCreatePostModal');
            const cancelCreatePost = document.getElementById('cancelCreatePost');
            const createPostForm = document.getElementById('createPostForm');
            const postTypeButtons = document.querySelectorAll('.post-type-button');
            const mobileCreatePost = document.getElementById('mobileCreatePost');

            // Open create post modal
            [createPostInput, mobileCreatePost].forEach(element => {
                if (element) {
                    element.addEventListener('click', () => {
                        createPostModal.classList.add('active');
                        setupCreatePostModal();
                    });
                }
            });

            postTypeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const postType = button.dataset.postType;
                    createPostModal.classList.add('active');
                    setupCreatePostModal(postType);
                });
            });

            // Close create post modal
            [closeCreatePostModal, cancelCreatePost].forEach(element => {
                if (element) {
                    element.addEventListener('click', () => {
                        createPostModal.classList.remove('active');
                        resetCreatePostForm();
                    });
                }
            });

            // Create post form submission
            if (createPostForm) {
                createPostForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(createPostForm);
                    const postData = Object.fromEntries(formData.entries());
                    
                    try {
                        await postManager.createPost(postData);
                        createPostModal.classList.remove('active');
                        resetCreatePostForm();
                        postManager.renderPosts();
                    } catch (error) {
                        utils.showNotification(error.message, 'error');
                    }
                });
            }

            // Post type change handler
            const postTypeSelect = document.getElementById('postType');
            if (postTypeSelect) {
                postTypeSelect.addEventListener('change', (e) => {
                    updateCreatePostForm(e.target.value);
                });
            }

            // Post visibility change handler
            const postVisibilitySelect = document.getElementById('postVisibility');
            if (postVisibilitySelect) {
                postVisibilitySelect.addEventListener('change', (e) => {
                    const communityContainer = document.getElementById('postCommunityContainer');
                    if (e.target.value === 'community') {
                        communityContainer.classList.remove('hidden');
                        populateCommunitySelect();
                    } else {
                        communityContainer.classList.add('hidden');
                    }
                });
            }

            // Media upload handling
            const mediaUploadArea = document.getElementById('mediaUploadArea');
            const mediaInput = document.getElementById('mediaInput');

            if (mediaUploadArea && mediaInput) {
                // Click to upload
                mediaUploadArea.addEventListener('click', () => {
                    mediaInput.click();
                });

                // Keyboard accessibility
                mediaUploadArea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        mediaInput.click();
                    }
                });

                // File input change
                mediaInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        mediaManager.handleFiles(Array.from(e.target.files));
                    }
                });

                // Drag and drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    mediaUploadArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    mediaUploadArea.addEventListener(eventName, () => {
                        mediaUploadArea.classList.add('dragover');
                    });
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    mediaUploadArea.addEventListener(eventName, () => {
                        mediaUploadArea.classList.remove('dragover');
                    });
                });

                mediaUploadArea.addEventListener('drop', (e) => {
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        mediaManager.handleFiles(files);
                    }
                });
            }

            // Poll option management
            const addPollOption = document.getElementById('addPollOption');
            if (addPollOption) {
                addPollOption.addEventListener('click', () => {
                    const pollOptions = document.getElementById('pollOptions');
                    const optionCount = pollOptions.children.length + 1;
                    
                    if (optionCount <= CONFIG.MAX_POLL_OPTIONS) {
                        const newOption = document.createElement('input');
                        newOption.type = 'text';
                        newOption.className = 'form-control poll-option-input';
                        newOption.placeholder = `Option ${optionCount}`;
                        newOption.style.marginBottom = 'var(--spacing-sm)';
                        pollOptions.appendChild(newOption);
                    } else {
                        utils.showNotification(`Maximum ${CONFIG.MAX_POLL_OPTIONS} options allowed`, 'warning');
                    }
                });
            }

            // Community Management
            const createCommunityBtn = document.getElementById('createCommunityBtn');
            const createCommunityModal = document.getElementById('create-community-modal');
            const closeCreateCommunityModal = document.getElementById('closeCreateCommunityModal');
            const cancelCreateCommunity = document.getElementById('cancelCreateCommunity');
            const createCommunityForm = document.getElementById('createCommunityForm');
            const mobileCreateCommunity = document.getElementById('mobileCreateCommunity');

            // Open create community modal
            [createCommunityBtn, mobileCreateCommunity].forEach(element => {
                if (element) {
                    element.addEventListener('click', () => {
                        createCommunityModal.classList.add('active');
                    });
                }
            });

            // Close create community modal
            [closeCreateCommunityModal, cancelCreateCommunity].forEach(element => {
                if (element) {
                    element.addEventListener('click', () => {
                        createCommunityModal.classList.remove('active');
                        createCommunityForm.reset();
                    });
                }
            });

            // Create community form submission
            if (createCommunityForm) {
                createCommunityForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(createCommunityForm);
                    const communityData = Object.fromEntries(formData.entries());
                    
                    try {
                        await communityManager.createCommunity(communityData);
                        createCommunityModal.classList.remove('active');
                        createCommunityForm.reset();
                        communityManager.updateCommunityLists();
                    } catch (error) {
                        utils.showNotification(error.message, 'error');
                    }
                });
            }

            // Browse Communities
            const browseCommunityBtn = document.getElementById('browseCommunityBtn');
            const browseCommunityModal = document.getElementById('browse-communities-modal');
            const closeBrowseCommunitiesModal = document.getElementById('closeBrowseCommunitiesModal');
            const communitySearchInput = document.getElementById('communitySearchInput');
            const mobileBrowseBtn = document.getElementById('mobileBrowseBtn');

            // Open browse communities modal
            [browseCommunityBtn, mobileBrowseBtn].forEach(element => {
                if (element) {
                    element.addEventListener('click', () => {
                        browseCommunityModal.classList.add('active');
                        displayBrowseCommunities();
                    });
                }
            });

            // Close browse communities modal
            if (closeBrowseCommunitiesModal) {
                closeBrowseCommunitiesModal.addEventListener('click', () => {
                    browseCommunityModal.classList.remove('active');
                });
            }

            // Community search
            if (communitySearchInput) {
                const debouncedCommunitySearch = utils.debounce((query) => {
                    displayBrowseCommunities(query);
                }, 300);

                communitySearchInput.addEventListener('input', (e) => {
                    debouncedCommunitySearch(e.target.value);
                });
            }

            // Community tabs in browse modal
            const communityTabs = document.querySelectorAll('#browse-communities-modal .sort-button');
            communityTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    communityTabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                    
                    // Update display
                    displayBrowseCommunities(communitySearchInput.value, tab.dataset.tab);
                });
            });

            // Community tabs in sidebar
            const sidebarCommunityTabs = document.querySelectorAll('.my-communities-tabs .sort-button');
            sidebarCommunityTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    sidebarCommunityTabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                    
                    // Show/hide content
                    const tabContent = document.querySelectorAll('.communities-tab-content');
                    tabContent.forEach(content => content.classList.add('hidden'));
                    
                    const targetContent = document.getElementById(`${tab.dataset.tab}CommunitiesList`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });

            // Post sorting
            const sortButtons = document.querySelectorAll('.sort-buttons .sort-button');
            sortButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Update active button
                    sortButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.setAttribute('aria-pressed', 'false');
                    });
                    button.classList.add('active');
                    button.setAttribute('aria-pressed', 'true');
                    
                    // Update sort type and re-render
                    const sortType = button.dataset.sort;
                    stateManager.setState({ currentSort: sortType });
                    postManager.renderPosts();
                });
            });

            // Feed filter
            const feedFilter = document.getElementById('feedFilter');
            if (feedFilter) {
                feedFilter.addEventListener('change', (e) => {
                    stateManager.setState({ currentFeedFilter: e.target.value });
                    postManager.renderPosts();
                });
            }

            // Chat system
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');

            if (chatToggleBtn) {
                chatToggleBtn.addEventListener('click', () => {
                    chatSystem.toggleChat();
                });
            }

            if (chatCloseBtn) {
                chatCloseBtn.addEventListener('click', () => {
                    chatSystem.toggleChat();
                });
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && chatInput.value.trim()) {
                        chatSystem.sendMessage(chatInput.value);
                        chatInput.value = '';
                    }
                });
            }

            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', () => {
                    if (chatInput.value.trim()) {
                        chatSystem.sendMessage(chatInput.value);
                        chatInput.value = '';
                    }
                });
            }

            // Premium modal
            const premiumBtn = document.getElementById('premiumBtn');
            const premiumModal = document.getElementById('premium-modal');
            const closePremiumModal = document.getElementById('closePremiumModal');

            if (premiumBtn) {
                premiumBtn.addEventListener('click', () => {
                    premiumModal.classList.add('active');
                });
            }

            if (closePremiumModal) {
                closePremiumModal.addEventListener('click', () => {
                    premiumModal.classList.remove('active');
                });
            }

            // Premium package selection
            const premiumPackages = document.querySelectorAll('.premium-package .btn-premium');
            premiumPackages.forEach(button => {
                button.addEventListener('click', () => {
                    utils.showNotification('Premium upgrade feature coming soon!', 'info');
                    premiumModal.classList.remove('active');
                });
            });

            // Media viewer modal
            const closeMediaViewer = document.getElementById('closeMediaViewer');
            const mediaViewerModal = document.getElementById('media-viewer-modal');

            if (closeMediaViewer) {
                closeMediaViewer.addEventListener('click', () => {
                    mediaViewerModal.classList.remove('active');
                });
            }

            // Close modals when clicking outside
            document.addEventListener('click', (e) => {
                const modals = document.querySelectorAll('.modal.active, .overlay.active');
                modals.forEach(modal => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        
                        // Special handling for camera modal
                        if (modal.id === 'camera-modal') {
                            cameraSystem.stopCamera();
                        }
                    }
                });
            });

            // Keyboard navigation for modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active, .overlay.active');
                    if (activeModal) {
                        activeModal.classList.remove('active');
                        
                        // Special handling for camera modal
                        if (activeModal.id === 'camera-modal') {
                            cameraSystem.stopCamera();
                        }
                    }
                }
            });

            // Load more posts
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => {
                    // In a real app, this would load more posts from the server
                    utils.showNotification('All posts loaded!', 'info');
                    loadMoreBtn.style.display = 'none';
                });
            }

            // Mobile navigation
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            mobileNavItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Update active state
                    mobileNavItems.forEach(navItem => {
                        navItem.classList.remove('active');
                        navItem.removeAttribute('aria-current');
                    });
                    item.classList.add('active');
                    item.setAttribute('aria-current', 'page');
                });
            });
        }

        // Helper Functions for UI Updates
        function updateUserInterface(user) {
            // Update user avatar and initials
            const userAvatars = document.querySelectorAll('.user-avatar span, #userInitial, #createPostUserInitial');
            userAvatars.forEach(avatar => {
                avatar.textContent = user.fullName.charAt(0).toUpperCase();
            });

            // Update profile pictures if available
            if (user.profilePicture) {
                const avatarContainers = document.querySelectorAll('.user-avatar, .profile-pic-preview');
                avatarContainers.forEach(container => {
                    container.innerHTML = `<img src="${user.profilePicture}" alt="${user.fullName}'s profile picture">`;
                });
            }
        }

        function setupCreatePostModal(defaultType = 'text') {
            const postTypeSelect = document.getElementById('postType');
            if (postTypeSelect) {
                postTypeSelect.value = defaultType;
                updateCreatePostForm(defaultType);
            }
            
            populateCommunitySelect();
        }

        function updateCreatePostForm(postType) {
            const contentContainer = document.getElementById('contentContainer');
            const pollOptionsContainer = document.getElementById('pollOptionsContainer');
            const mediaUploadContainer = document.getElementById('mediaUploadContainer');

            // Reset visibility
            contentContainer.classList.remove('hidden');
            pollOptionsContainer.classList.add('hidden');
            mediaUploadContainer.classList.remove('hidden');

            switch (postType) {
                case 'poll':
                    pollOptionsContainer.classList.remove('hidden');
                    mediaUploadContainer.classList.add('hidden');
                    break;
                case 'text':
                    mediaUploadContainer.classList.add('hidden');
                    break;
                case 'image':
                case 'video':
                    // Media upload is already visible
                    break;
            }
        }

        function populateCommunitySelect() {
            const communitySelect = document.getElementById('postCommunity');
            if (!communitySelect) return;

            const state = stateManager.getState();
            const userCommunities = state.communities.filter(c => 
                state.userMemberships.includes(c.id) || state.userCreatedCommunities.includes(c.id)
            );

            communitySelect.innerHTML = '<option value="">Select a community</option>' +
                userCommunities.map(community => 
                    `<option value="${community.id}">${community.displayName}</option>`
                ).join('');
        }

        function resetCreatePostForm() {
            const createPostForm = document.getElementById('createPostForm');
            if (createPostForm) {
                createPostForm.reset();
            }
            
            mediaManager.clearAll();
            updateCreatePostForm('text');
            
            const communityContainer = document.getElementById('postCommunityContainer');
            if (communityContainer) {
                communityContainer.classList.add('hidden');
            }
        }

        function displaySearchResults(results) {
            const searchResultsList = document.getElementById('searchResultsList');
            if (!searchResultsList) return;

            if (results.length === 0) {
                searchResultsList.innerHTML = '<div class="search-result-item">No results found</div>';
                return;
            }

            searchResultsList.innerHTML = results.map(result => {
                switch (result.type) {
                    case 'post':
                        return `
                            <div class="search-result-item" onclick="viewPost('${result.id}')">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-file-alt" style="color: #666;"></i>
                                    <strong>${result.title}</strong>
                                </div>
                                <div style="font-size: 0.8rem; color: #999; margin-bottom: 0.25rem;">
                                    by ${result.author}  ${utils.getTimeAgo(result.timestamp)}
                                </div>
                                <div style="font-size: 0.8rem; color: #ccc;">${result.content}</div>
                            </div>
                        `;
                    case 'community':
                        return `
                            <div class="search-result-item" onclick="viewCommunityDetails('${result.id}')">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-users" style="color: #666;"></i>
                                    <strong>c/${result.name}</strong>
                                    <span style="background: ${result.type === 'private' ? '#ef4444' : '#10b981'}; color: white; padding: 1px 4px; border-radius: 4px; font-size: 10px;">
                                        ${result.type}
                                    </span>
                                </div>
                                <div style="font-size: 0.8rem; color: #999; margin-bottom: 0.25rem;">
                                    ${utils.formatNumber(result.memberCount)} members
                                </div>
                                <div style="font-size: 0.8rem; color: #ccc;">${result.description || 'No description'}</div>
                            </div>
                        `;
                    case 'web':
                        return `
                            <div class="search-result-item" onclick="window.open('${result.url}', '_blank')">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-external-link-alt" style="color: #666;"></i>
                                    <strong>${result.title}</strong>
                                </div>
                                <div style="font-size: 0.8rem; color: #999; margin-bottom: 0.25rem;">
                                    ${result.source}
                                </div>
                                <div style="font-size: 0.8rem; color: #ccc;">${result.description}</div>
                            </div>
                        `;
                    default:
                        return '';
                }
            }).join('');
        }

        function displayBrowseCommunities(searchQuery = '', filterType = 'all') {
            const state = stateManager.getState();
            let communities = state.communities;

            // Apply search filter
            if (searchQuery) {
                communities = communityManager.searchCommunities(searchQuery);
            }

            // Apply type filter
            communities = communityManager.filterCommunities(communities, filterType);

            const communitiesList = document.getElementById('communitiesBrowseList');
            const noCommunitiesMessage = document.getElementById('noCommunitiesMessage');

            if (communities.length === 0) {
                communitiesList.innerHTML = '';
                noCommunitiesMessage.classList.remove('hidden');
                return;
            }

            noCommunitiesMessage.classList.add('hidden');
            communitiesList.innerHTML = communities.map(community => {
                const isMember = state.userMemberships.includes(community.id);
                const isCreator = state.userCreatedCommunities.includes(community.id);

                return `
                    <div style="background: #2a2a2a; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; border: 1px solid #404040;" 
                         onclick="viewCommunityDetails('${community.id}')"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.3)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span class="community-icon ${utils.getCommunityColor(community.name)}" style="width: 48px; height: 48px; font-size: 20px;">
                                    ${community.name.charAt(0)}
                                </span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">${community.displayName}</h4>
                                    <p style="margin: 0; font-size: 0.8rem; color: #999;">c/${community.name}</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${community.type === 'private' ? '<i class="fas fa-lock" style="color: #ef4444;" title="Private community"></i>' : ''}
                                ${isCreator ? '<i class="fas fa-crown" style="color: #ffd700;" title="You created this community"></i>' : ''}
                                ${isMember && !isCreator ? '<i class="fas fa-check-circle" style="color: #10b981;" title="You are a member"></i>' : ''}
                            </div>
                        </div>
                        
                        <p style="color: #ccc; font-size: 0.9rem; line-height: 1.4; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${community.description || 'No description available'}
                        </p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #999;">
                            <span><i class="fas fa-users" style="margin-right: 0.25rem;"></i> ${utils.formatNumber(community.memberCount)} members</span>
                            <span>Created ${new Date(community.createdAt).toLocaleDateString()}</span>
                        </div>
                        
                        ${community.topics && community.topics.length > 0 ? `
                            <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                ${community.topics.slice(0, 3).map(topic => 
                                    `<span style="background: #404040; color: #ccc; padding: 2px 6px; border-radius: 8px; font-size: 10px;">#${topic}</span>`
                                ).join('')}
                                ${community.topics.length > 3 ? `<span style="color: #666; font-size: 10px;">+${community.topics.length - 3} more</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Initialize Application
        function initializeApp() {
            // Check if user is already registered
            const state = stateManager.getState();
            
            if (!state.currentUser) {
                // Show onboarding modal
                document.getElementById('onboardingOverlay').classList.add('active');
            } else {
                // User is already registered, initialize the app
                updateUserInterface(state.currentUser);
                initializeSampleData();
                postManager.renderPosts();
                communityManager.updateCommunityLists();
                liveUpdatesSystem.start();
            }

            // Setup all event listeners
            setupEventListeners();

            // Subscribe to state changes
            stateManager.subscribe((newState) => {
                // Update community lists when state changes
                communityManager.updateCommunityLists();
                
                // Update live stats
                liveUpdatesSystem.updateLiveStats();
            });
        }

        // Start the application when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Service Worker Registration (for PWA capabilities)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Handle online/offline status
        window.addEventListener('online', () => {
            utils.showNotification('Connection restored!', 'success');
            liveUpdatesSystem.start();
        });

        window.addEventListener('offline', () => {
            utils.showNotification('You are offline. Some features may be limited.', 'warning');
            liveUpdatesSystem.stop();
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`SmileX loaded in ${loadTime}ms`);
            }
        });

        // Error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            utils.showNotification('An unexpected error occurred. Please refresh the page.', 'error');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            utils.showNotification('An error occurred while processing your request.', 'error');
        });

        // Accessibility improvements
        document.addEventListener('keydown', (e) => {
            // Add keyboard navigation for custom elements
            if (e.key === 'Tab') {
                // Ensure proper focus management
                const focusableElements = document.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                
                // Add visual focus indicators if needed
                focusableElements.forEach(el => {
                    el.addEventListener('focus', () => {
                        el.style.outline = '2px solid var(--primary-color)';
                        el.style.outlineOffset = '2px';
                    });
                    
                    el.addEventListener('blur', () => {
                        el.style.outline = '';
                        el.style.outlineOffset = '';
                    });
                });
            }
        });

        // Console welcome message
        console.log(`
         Welcome to SmileX! 
        
        A fully functional social media platform with:
         Real-time features and live updates
         Interactive polls and voting
         Responsive design for all devices
         Community management system
         Live chat support
         Advanced search capabilities
         Media sharing and camera integration
         Full accessibility support
         Modern UI with smooth animations
        
        Built with vanilla JavaScript, HTML5, and CSS3
        Version: 2.0.0 Enhanced
        `);

    </script>
</body>
</html>
