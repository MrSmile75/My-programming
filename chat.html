<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smile Xplore - Advanced Social Platform</title>
    <meta name="description" content="Smile Xplore - A modern social platform for connecting communities and sharing experiences">
    <meta name="keywords" content="social media, communities, chat, posts, networking">
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        :root {
            /* Color Variables */
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --accent-color: #00b4db;
            --background-color: #000000;
            --surface-color: #1a1a1a;
            --surface-secondary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #666666;
            --border-color: #404040;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --premium-gold: #ffd700;
            --premium-gradient: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            --online-color: #22c55e;
            --away-color: #f59e0b;
            --busy-color: #ef4444;
            
            /* Spacing Variables */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Typography Variables */
            --font-primary: 'Orbitron', sans-serif;
            --font-secondary: 'Poppins', sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 2rem;
            
            /* Border Radius Variables */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            
            /* Shadow Variables */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            /* Transition Variables */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Accessibility Improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Styles for Accessibility */
        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Skip Link for Screen Readers */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: var(--radius-md);
            z-index: 10000;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Preloader Styles */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: var(--transition-slow);
        }

        .preloader-logo {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--spacing-md);
            animation: bounce 2s infinite;
        }

        .preloader-text {
            font-size: var(--font-size-2xl);
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-top: var(--spacing-xl);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Premium Animations */
        @keyframes disco {
            0% { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
            16% { color: #ff8000; text-shadow: 0 0 10px #ff8000; }
            33% { color: #ffff00; text-shadow: 0 0 10px #ffff00; }
            50% { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
            66% { color: #0080ff; text-shadow: 0 0 10px #0080ff; }
            83% { color: #8000ff; text-shadow: 0 0 10px #8000ff; }
            100% { color: #ff0080; text-shadow: 0 0 10px #ff0080; }
        }

        @keyframes premium-glow {
            0%, 100% { box-shadow: 0 0 20px var(--premium-gold); }
            50% { box-shadow: 0 0 40px var(--premium-gold), 0 0 60px var(--premium-gold); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px var(--warning-color); }
            to { text-shadow: 0 0 20px var(--warning-color), 0 0 30px var(--warning-color); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* Premium Styles */
        .premium-user {
            position: relative;
        }

        .premium-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--premium-gradient);
            color: #000;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: bold;
            animation: premium-glow 2s ease-in-out infinite;
        }

        .disco-text {
            animation: disco 2s linear infinite;
            font-weight: bold;
        }

        .premium-emoji {
            font-size: 1.2em;
            animation: float 2s ease-in-out infinite;
        }

        /* Online Status Indicators */
        .status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--surface-color);
        }

        .status-online { background: var(--online-color); }
        .status-away { background: var(--away-color); }
        .status-busy { background: var(--error-color); }
        .status-offline { background: var(--text-muted); }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            font-size: var(--font-size-xs);
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Modal Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Onboarding Modal */
        .onboarding-container {
            background: var(--surface-color);
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: scale(0.9);
            transition: var(--transition-normal);
        }

        .overlay.active .onboarding-container {
            transform: scale(1);
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .onboarding-header h2 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-sm);
            color: var(--primary-color);
        }

        /* Profile Picture Upload */
        .profile-upload-section {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto var(--spacing-md);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-size-3xl);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .profile-preview:hover {
            transform: scale(1.05);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition-fast);
            border-radius: 50%;
        }

        .profile-preview:hover .profile-upload-overlay {
            opacity: 1;
        }

        .profile-upload-buttons {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            transition: var(--transition-fast);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .name-validation {
            margin-top: var(--spacing-xs);
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .name-available {
            color: var(--success-color);
        }

        .name-taken {
            color: var(--error-color);
        }

        /* Consent Section */
        .consent-section {
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-md);
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
        }

        .consent-item {
            display: flex;
            align-items: center;
            margin: var(--spacing-sm) 0;
        }

        .consent-item input[type="checkbox"] {
            margin-right: var(--spacing-sm);
            width: 16px;
            height: 16px;
        }

        .consent-item label {
            cursor: pointer;
            user-select: none;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
            gap: var(--spacing-xs);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a0fb8;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-premium {
            background: var(--premium-gradient);
            color: #000;
            font-weight: bold;
            animation: premium-glow 2s ease-in-out infinite;
        }

        .btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Navigation */
        nav {
            background: var(--background-color);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
        }

        .logo i {
            margin-right: var(--spacing-sm);
            font-size: var(--font-size-2xl);
        }

        .nav-search {
            position: relative;
            display: none;
        }

        @media (min-width: 768px) {
            .nav-search {
                display: block;
            }
        }

        .nav-search input {
            width: 300px;
            padding: 8px 12px 8px 40px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .nav-search i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
        }

        .search-result-item {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .search-result-item:hover {
            background: var(--surface-secondary);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-type {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: bold;
        }

        .search-result-title {
            font-weight: 500;
            margin: var(--spacing-xs) 0;
        }

        .search-result-description {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-button {
            padding: var(--spacing-sm);
            background: var(--surface-color);
            border: none;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .nav-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: var(--font-size-sm);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-avatar.premium {
            border: 2px solid var(--premium-gold);
            animation: premium-glow 2s ease-in-out infinite;
        }

        /* Main Layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg) var(--spacing-md);
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }

        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            height: fit-content;
            position: sticky;
            top: 80px;
            display: none;
        }

        @media (min-width: 1024px) {
            .sidebar {
                display: block;
            }
        }

        .sidebar h3 {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: var(--spacing-sm);
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: var(--spacing-sm);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
        }

        .sidebar a:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Community Icons */
        .community-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-size-xs);
            font-weight: bold;
        }

        /* Main Feed */
        .main-feed {
            min-height: 100vh;
        }

        /* Create Post Card */
        .create-post-card {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .create-post-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .create-post-input input {
            flex: 1;
            padding: 12px 16px;
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
            cursor: pointer;
        }

        .post-type-buttons {
            display: flex;
            gap: var(--spacing-sm);
        }

        .post-type-button {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: var(--font-size-sm);
        }

        .post-type-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Sort Buttons */
        .sort-buttons {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-sm);
            overflow-x: auto;
        }

        .sort-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            border: none;
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .sort-button.active {
            background: var(--primary-color);
            color: white;
        }

        .sort-button:not(.active) {
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }

        .sort-button:not(.active):hover {
            background: var(--border-color);
        }

        /* Post Cards */
        .post-card {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
            animation: fadeIn 0.5s ease;
            cursor: pointer;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .post-content {
            padding: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-md);
        }

        /* Vote Section */
        .vote-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .vote-button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vote-button:hover {
            background: var(--surface-secondary);
        }

        .vote-button.voted-up {
            color: var(--primary-color);
        }

        .vote-button.voted-down {
            color: var(--secondary-color);
        }

        .vote-count {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Post Main Content */
        .post-main {
            flex: 1;
        }

        .post-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
        }

        .post-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            line-height: 1.4;
        }

        .post-text {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }

        .post-image, .post-video {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            cursor: pointer;
        }

        .media-grid {
            display: grid;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .media-grid.single {
            grid-template-columns: 1fr;
        }

        .media-grid.double {
            grid-template-columns: 1fr 1fr;
        }

        .media-grid.multiple {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Post Actions */
        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-action-buttons {
            display: flex;
            gap: var(--spacing-md);
        }

        .post-action-button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-sm);
            cursor: pointer;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .post-action-button:hover {
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        /* Comments Section */
        .comments-section {
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-lg);
            display: none;
        }

        .comments-section.active {
            display: block;
        }

        .comment-input {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            align-items: center;
        }

        .comment-input input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
        }

        .emoji-picker-btn {
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-sm);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .emoji-picker-btn:hover {
            background: var(--border-color);
            color: var(--primary-color);
        }

        .emoji-picker {
            position: absolute;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: var(--spacing-xs);
            z-index: 100;
            max-width: 300px;
        }

        .emoji-picker.active {
            display: grid;
        }

        .emoji-item {
            padding: var(--spacing-xs);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            text-align: center;
        }

        .emoji-item:hover {
            background: var(--surface-secondary);
        }

        .comment {
            background: var(--surface-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            position: relative;
        }

        .comment.reply {
            margin-left: var(--spacing-xl);
            border-left: 2px solid var(--primary-color);
        }

        .comment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-xs);
        }

        .comment-author {
            font-weight: bold;
            color: var(--primary-color);
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .comment-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .comment-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xs);
        }

        .comment-actions {
            display: flex;
            gap: var(--spacing-md);
            font-size: 11px;
        }

        .comment-action {
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .comment-action:hover {
            color: var(--primary-color);
        }

        /* Precise Timestamp */
        .precise-timestamp {
            font-size: 10px;
            color: var(--text-muted);
            font-family: monospace;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: var(--font-size-xl);
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--surface-secondary);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* Image/Video Upload Area */
        .media-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            text-align: center;
            margin: var(--spacing-md) 0;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .media-upload-area:hover,
        .media-upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(106, 17, 203, 0.1);
        }

        .media-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-md);
            margin: var(--spacing-md) 0;
        }

        .media-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }

        .media-preview-item {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .media-preview-item img,
        .media-preview-item video {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .media-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Enhanced Chat Styles */
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            font-size: var(--font-size-xl);
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-fast);
            z-index: 100;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
        }

        .chat-container {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            opacity: 0;
            transition: var(--transition-normal);
            z-index: 99;
            border: 1px solid var(--border-color);
        }

        .chat-container.active {
            transform: translateY(0);
            opacity: 1;
        }

        .chat-header {
            padding: var(--spacing-md);
            background: var(--primary-color);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            color: white;
            font-size: var(--font-size-base);
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
        }

        .message {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
        }

        .message.user {
            background: var(--primary-color);
            margin-left: var(--spacing-lg);
        }

        .message.agent {
            background: var(--surface-secondary);
            margin-right: var(--spacing-lg);
        }

        .message-user {
            font-weight: bold;
            color: var(--primary-color);
            font-size: var(--font-size-xs);
            margin-bottom: var(--spacing-xs);
        }

        .message.user .message-user {
            color: white;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .message-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xs);
        }

        .message.user .message-text {
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .message.user .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-input-container {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-sm);
        }

        .chat-input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
        }

        .chat-send {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .chat-send:hover {
            background: #5a0fb8;
        }

        /* Direct Messages Panel */
        .dm-panel {
            position: fixed;
            top: 64px;
            right: -400px;
            width: 400px;
            height: calc(100vh - 64px);
            background: var(--surface-color);
            border-left: 1px solid var(--border-color);
            transition: var(--transition-normal);
            z-index: 90;
            display: flex;
            flex-direction: column;
        }

        .dm-panel.active {
            right: 0;
            z-index: 100;
        }

        .dm-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dm-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .dm-tab {
            flex: 1;
            padding: var(--spacing-md);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .dm-tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .dm-content {
            flex: 1;
            overflow-y: auto;
        }

        .dm-list {
            padding: var(--spacing-md);
        }

        .dm-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            margin-bottom: var(--spacing-sm);
        }

        .dm-item:hover {
            background: var(--surface-secondary);
        }

        .dm-item.active {
            background: var(--primary-color);
            color: white;
        }

        .dm-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            position: relative;
        }

        .dm-info {
            flex: 1;
        }

        .dm-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .dm-preview {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        .dm-time {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        .unread-badge {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Group Chat Styles */
        .group-chat-item {
            border-left: 3px solid var(--accent-color);
        }

        .group-members {
            display: flex;
            margin-top: var(--spacing-xs);
        }

        .group-member-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-color);
            margin-right: -5px;
            border: 2px solid var(--surface-color);
        }

        /* Chat Channel Styles */
        .channel-list {
            padding: var(--spacing-md);
        }

        .channel-category {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: bold;
            margin: var(--spacing-lg) 0 var(--spacing-sm) 0;
        }

        .channel-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            margin-bottom: var(--spacing-xs);
        }

        .channel-item:hover {
            background: var(--surface-secondary);
        }

        .channel-item.active {
            background: var(--primary-color);
            color: white;
        }

        .channel-icon {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
        }

        .channel-name {
            flex: 1;
            font-size: var(--font-size-sm);
        }

        .channel-count {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 64px;
            z-index: 50;
        }

        @media (min-width: 1024px) {
            .mobile-nav {
                display: none;
            }
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition-fast);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
        }

        .mobile-nav-item.active,
        .mobile-nav-item:hover {
            color: var(--primary-color);
        }

        .mobile-nav-item i {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xs);
        }

        .mobile-nav-item span {
            font-size: 10px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition-normal);
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        /* Poll Styles */
        .poll-container {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
        }

        .poll-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            background: var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .poll-option:hover {
            background: #505050;
        }

        .poll-option.voted {
            cursor: default;
        }

        .poll-option-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            opacity: 0.3;
            transition: width 0.5s ease;
        }

        .poll-option-text,
        .poll-option-percentage {
            position: relative;
            z-index: 1;
        }

        .poll-option-percentage {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .poll-stats {
            margin-top: var(--spacing-sm);
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        /* Community Colors */
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-green-500 { background-color: var(--success-color); }
        .bg-purple-500 { background-color: var(--primary-color); }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-yellow-500 { background-color: var(--warning-color); }
        .bg-pink-500 { background-color: #ec4899; }
        .bg-indigo-500 { background-color: #6366f1; }

        /* Live Features */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--error-color);
            font-size: var(--font-size-xs);
            font-weight: bold;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--error-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Premium Features */
        .premium-section {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-xl);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .premium-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        .premium-content {
            position: relative;
            z-index: 1;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: var(--spacing-md);
        }

        .mt-4 {
            margin-top: var(--spacing-md);
        }

        /* Feature Badges */
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: bold;
        }

        .trending-indicator {
            color: var(--warning-color);
            animation: glow 2s ease-in-out infinite alternate;
        }

        /* Real-time Activity Indicator */
        .activity-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: bold;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: var(--spacing-md) var(--spacing-sm);
                padding-bottom: 80px;
            }
            
            .post-content {
                padding: var(--spacing-md);
            }
            
            .chat-container {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }

            .modal-content {
                width: 95%;
                margin: var(--spacing-md);
            }

            .dm-panel {
                width: 100vw;
                right: -100vw;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --text-primary: #ffffff;
                --text-secondary: #ffffff;
                --background-color: #000000;
                --surface-color: #000000;
                --border-color: #ffffff;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Ad container styles */
        .ad-container {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .ad-label {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: var(--spacing-xs);
        }

        .ad-content {
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Friend list styles */
        .friend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-xs);
            transition: var(--transition-fast);
        }

        .friend-item:hover {
            background: var(--surface-secondary);
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .friend-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .friend-action-btn {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 4px 8px;
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .friend-action-btn:hover {
            background: var(--surface-secondary);
        }

        .friend-action-btn.delete {
            color: var(--error-color);
        }

        .friend-action-btn.block {
            color: var(--warning-color);
        }

        /* Call buttons */
        .call-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            background: var(--success-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: var(--font-size-sm);
            margin-right: var(--spacing-xs);
        }

        .call-btn.video {
            background: var(--primary-color);
        }

        /* Notification item styles */
        .notification-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .notification-item:hover {
            background: var(--surface-secondary);
        }

        .notification-item.unread {
            background: rgba(106, 17, 203, 0.1);
        }

        .notification-content {
            margin-bottom: var(--spacing-xs);
        }

        .notification-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-xs);
        }

        .notification-time {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        /* Disappearing post indicator */
        .disappearing-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        /* Community verification badge */
        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            background: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: bold;
            margin-left: var(--spacing-xs);
        }

        /* User menu styles */
        .user-menu {
            position: absolute;
            top: 70px;
            right: 20px;
            background: var(--surface-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            width: 200px;
            overflow: hidden;
            display: none;
        }

        .user-menu-item {
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .user-menu-item:hover {
            background: var(--surface-secondary);
        }

        /* Feed selector styles */
        .feed-selector {
            display: flex;
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            overflow-x: auto;
        }

        .feed-option {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition-fast);
        }

        .feed-option.active {
            background: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Skip Link for Screen Readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Preloader -->
    <div id="preloader" class="preloader" role="status" aria-label="Loading Smile Xplore">
        <div class="preloader-logo" aria-hidden="true">
            <i class="fas fa-smile-beam"></i>
        </div>
        <div class="preloader-text">Smile Xplore</div>
        <div class="loading-spinner"></div>
        <span class="sr-only">Loading application...</span>
    </div>

    <!-- Real-time Activity Indicator -->
    <div id="activityIndicator" class="activity-indicator hidden">
        <i class="fas fa-circle live-dot"></i>
        <span id="activityText">Live Activity</span>
    </div>

    <!-- Onboarding Modal -->
    <div class="overlay" id="onboardingOverlay" role="dialog" aria-labelledby="onboarding-title" aria-modal="true">
        <div class="onboarding-container">
            <header class="onboarding-header">
                <h2 id="onboarding-title">
                    <i class="fas fa-user-circle" aria-hidden="true"></i> 
                    Welcome to Smile Xplore
                </h2>
                <p>Complete your profile to join our community</p>
            </header>

            <form id="registrationForm" novalidate>
                <!-- Profile Picture Upload Section -->
                <div class="profile-upload-section">
                    <div class="profile-preview" id="profilePreview">
                        <span id="profileInitial">?</span>
                        <div class="profile-upload-overlay">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="profile-upload-buttons">
                        <button type="button" class="btn btn-secondary" onclick="openFileUpload()">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </div>
                    <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
                </div>

                <div class="form-group">
                    <label for="fullName" class="form-label">
                        <i class="fas fa-user" aria-hidden="true"></i> Full Name
                    </label>
                    <input type="text" 
                           id="fullName" 
                           name="fullName" 
                           class="form-control" 
                           placeholder="Enter your full name" 
                           required>
                    <div id="nameValidation" class="name-validation" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label for="username" class="form-label">
                        <i class="fas fa-at" aria-hidden="true"></i> Username
                    </label>
                    <input type="text" 
                           id="username" 
                           name="username" 
                           class="form-control" 
                           placeholder="Choose a unique username" 
                           required>
                    <div id="usernameValidation" class="name-validation" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope" aria-hidden="true"></i> Email Address
                    </label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           class="form-control" 
                           placeholder="your.email@example.com" 
                           required>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">
                        <i class="fas fa-lock" aria-hidden="true"></i> Password
                    </label>
                    <input type="password" 
                           id="password" 
                           name="password" 
                           class="form-control" 
                           placeholder="Create a secure password" 
                           required
                           minlength="6">
                </div>

                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="gender" class="form-label">
                            <i class="fas fa-venus-mars" aria-hidden="true"></i> Gender
                        </label>
                        <select id="gender" name="gender" class="form-select" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="country" class="form-label">
                            <i class="fas fa-globe" aria-hidden="true"></i> Country
                        </label>
                        <select id="country" name="country" class="form-select" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="IN">India</option>
                            <option value="BR">Brazil</option>
                            <option value="NG">Nigeria</option>
                            <option value="ZA">South Africa</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="birthdate" class="form-label">
                        <i class="fas fa-birthday-cake" aria-hidden="true"></i> Date of Birth
                    </label>
                    <input type="date" 
                           id="birthdate" 
                           name="birthdate" 
                           class="form-control" 
                           required>
                </div>

                <fieldset class="consent-section">
                    <legend>
                        <h4><i class="fas fa-shield-alt" aria-hidden="true"></i> Platform Consent</h4>
                    </legend>
                    <div class="consent-item">
                        <input type="checkbox" id="ageConsent" name="ageConsent" required>
                        <label for="ageConsent">I am 13 years or older</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" id="termsConsent" name="termsConsent" required>
                        <label for="termsConsent">I agree to the Terms of Service</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" id="privacyConsent" name="privacyConsent" required>
                        <label for="privacyConsent">I consent to privacy policy</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" id="marketingConsent" name="marketingConsent">
                        <label for="marketingConsent">I agree to receive marketing communications</label>
                    </div>
                </fieldset>

                <button type="submit" id="submitBtn" class="btn btn-primary" disabled style="width: 100%;">
                    <i class="fas fa-paper-plane" aria-hidden="true"></i> Join Smile Xplore
                </button>
            </form>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav role="navigation" aria-label="Main navigation">
        <div class="nav-container">
            <a href="#" class="logo" aria-label="Smile Xplore Home">
                <i class="fas fa-smile-beam" aria-hidden="true"></i>
                <span>Smile Xplore</span>
            </a>

            <div class="nav-search" role="search">
                <label for="searchInput" class="sr-only">Search Everything</label>
                <input type="text" 
                       id="searchInput" 
                       placeholder="Search posts, communities, users...">
                <i class="fas fa-search" aria-hidden="true"></i>
                <div id="searchResults" class="search-results hidden" role="listbox" aria-label="Search results"></div>
            </div>

            <div class="nav-actions">
                <button class="nav-button" 
                        id="themeToggle" 
                        aria-label="Toggle dark mode"
                        title="Toggle Theme">
                    <i class="fas fa-moon" aria-hidden="true"></i>
                </button>
                <button class="nav-button" 
                        id="notificationBtn" 
                        aria-label="View notifications"
                        title="Notifications">
                    <i class="fas fa-bell" aria-hidden="true"></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <button class="nav-button" 
                        id="dmToggle" 
                        aria-label="Toggle direct messages"
                        title="Direct Messages">
                    <i class="fas fa-envelope" aria-hidden="true"></i>
                    <span class="notification-badge" id="dmBadge" style="display: none;">0</span>
                </button>
                <button class="nav-button" 
                        id="friendsToggle" 
                        aria-label="Toggle friends list"
                        title="Friends">
                    <i class="fas fa-user-friends" aria-hidden="true"></i>
                </button>
                <div class="user-avatar" 
                     id="userAvatar" 
                     role="img" 
                     aria-label="User avatar"
                     onclick="toggleUserMenu()">
                    <span id="userInitial">U</span>
                    <div class="status-indicator status-online"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- User Menu Dropdown -->
    <div id="userMenu" class="user-menu">
        <div class="user-menu-item" onclick="goToProfile()">
            <i class="fas fa-user"></i> Profile
        </div>
        <div class="user-menu-item" onclick="goToSettings()">
            <i class="fas fa-cog"></i> Settings
        </div>
        <div class="user-menu-item" onclick="togglePremium()">
            <i class="fas fa-crown"></i> Premium
        </div>
        <div class="user-menu-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </div>
    </div>

    <!-- Friends Panel -->
    <div id="friendsPanel" class="dm-panel">
        <div class="dm-header">
            <h3><i class="fas fa-user-friends"></i> Friends</h3>
            <button id="closeFriendsPanel" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="dm-tabs">
            <button class="dm-tab active" data-tab="friends">
                <i class="fas fa-user-friends"></i> My Friends
            </button>
            <button class="dm-tab" data-tab="requests">
                <i class="fas fa-user-plus"></i> Requests
            </button>
            <button class="dm-tab" data-tab="suggestions">
                <i class="fas fa-users"></i> Suggestions
            </button>
        </div>

        <div class="dm-content">
            <div class="search-container" style="padding: var(--spacing-md);">
                <input type="text" id="friendSearch" placeholder="Search friends..." class="form-control">
            </div>

            <!-- Friends Tab -->
            <div id="friendsTab" class="dm-list">
                <!-- Friends will be loaded dynamically -->
            </div>

            <!-- Requests Tab -->
            <div id="requestsTab" class="dm-list hidden">
                <!-- Friend requests will be loaded dynamically -->
            </div>

            <!-- Suggestions Tab -->
            <div id="suggestionsTab" class="dm-list hidden">
                <!-- Friend suggestions will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Notifications Panel -->
    <div id="notificationsPanel" class="dm-panel">
        <div class="dm-header">
            <h3><i class="fas fa-bell"></i> Notifications</h3>
            <button id="closeNotificationsPanel" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="dm-tabs">
            <button class="dm-tab active" data-tab="all">
                <i class="fas fa-bell"></i> All
            </button>
            <button class="dm-tab" data-tab="unread">
                <i class="fas fa-circle"></i> Unread
            </button>
        </div>

        <div class="dm-content">
            <div id="notificationsTab" class="dm-list">
                <!-- Notifications will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Direct Messages Panel -->
    <div id="dmPanel" class="dm-panel">
        <div class="dm-header">
            <h3><i class="fas fa-envelope"></i> Messages</h3>
            <button id="closeDmPanel" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="dm-tabs">
            <button class="dm-tab active" data-tab="dms">
                <i class="fas fa-user"></i> Direct Messages
            </button>
            <button class="dm-tab" data-tab="groups">
                <i class="fas fa-users"></i> Groups
            </button>
            <button class="dm-tab" data-tab="channels">
                <i class="fas fa-hashtag"></i> Channels
            </button>
        </div>

        <div class="dm-content">
            <!-- Direct Messages Tab -->
            <div id="dmsTab" class="dm-list">
                <!-- DMs will be loaded dynamically -->
            </div>

            <!-- Group Chats Tab -->
            <div id="groupsTab" class="dm-list hidden">
                <!-- Group chats will be loaded dynamically -->
            </div>

            <!-- Chat Channels Tab -->
            <div id="channelsTab" class="channel-list hidden">
                <!-- Channels will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="Community navigation">
            <section>
                <h3><i class="fas fa-users" aria-hidden="true"></i> My Communities</h3>
                <ul id="communitiesList" role="list">
                    <!-- Communities will be loaded dynamically -->
                </ul>
                <button id="createCommunityBtn" 
                        class="btn btn-primary" 
                        style="width: 100%; margin-top: var(--spacing-md);">
                    <i class="fas fa-plus" aria-hidden="true"></i> Create Community
                </button>
            </section>

            <section style="margin-top: var(--spacing-xl);">
                <h3><i class="fas fa-compass" aria-hidden="true"></i> Explore</h3>
                <button id="browseCommunityBtn" class="btn btn-secondary" style="width: 100%;">
                    <i class="fas fa-globe" aria-hidden="true"></i> Browse Communities
                </button>
            </section>

            <!-- Online Friends -->
            <section style="margin-top: var(--spacing-xl);">
                <h3><i class="fas fa-user-friends" aria-hidden="true"></i> Online Friends</h3>
                <div id="onlineFriendsList" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    <!-- Online friends will be loaded dynamically -->
                </div>
            </section>
        </aside>

        <!-- Main Feed -->
        <main class="main-feed" role="main" aria-label="Posts feed">
            <!-- Feed Selector -->
            <section class="feed-selector" role="group" aria-label="Select feed">
                <button class="feed-option active" data-feed="following">
                    <i class="fas fa-user-check"></i> Following
                </button>
                <button class="feed-option" data-feed="general">
                    <i class="fas fa-globe"></i> General
                </button>
                <button class="feed-option" data-feed="live">
                    <i class="fas fa-broadcast-tower"></i> Live
                </button>
                <button class="feed-option" data-feed="trending">
                    <i class="fas fa-fire"></i> Trending
                </button>
            </section>

            <!-- Create Post Card -->
            <section class="create-post-card" aria-label="Create new post">
                <div class="create-post-input">
                    <div class="user-avatar" role="img" aria-label="Your avatar">
                        <span id="createPostUserInitial">U</span>
                        <div class="status-indicator status-online"></div>
                    </div>
                    <button id="createPostInput" 
                            class="form-control" 
                            style="text-align: left; cursor: pointer; border: none;"
                            aria-label="Create a new post">
                        What's on your mind?
                    </button>
                </div>
                <div class="post-type-buttons" role="group" aria-label="Post type options">
                    <button class="post-type-button" 
                            data-post-type="image" 
                            aria-label="Create image post">
                        <i class="far fa-image" aria-hidden="true"></i> Image
                    </button>
                    <button class="post-type-button" 
                            data-post-type="video" 
                            aria-label="Create video post">
                        <i class="fas fa-video" aria-hidden="true"></i> Video
                    </button>
                    <button class="post-type-button" 
                            data-post-type="text" 
                            aria-label="Create text post">
                        <i class="far fa-file-alt" aria-hidden="true"></i> Text
                    </button>
                    <button class="post-type-button" 
                            data-post-type="poll" 
                            aria-label="Create poll">
                        <i class="fas fa-poll" aria-hidden="true"></i> Poll
                    </button>
                    <button class="post-type-button" 
                            data-post-type="live-chat" 
                            aria-label="Create live post"
                            id="livePostButton"
                            style="display: none;">
                        <i class="fas fa-broadcast-tower" aria-hidden="true"></i> Live
                    </button>
                </div>
            </section>

            <!-- Post Sorting -->
            <section class="sort-buttons" role="group" aria-label="Sort posts">
                <button class="sort-button active" 
                        data-sort="hot" 
                        aria-pressed="true">
                    <i class="fas fa-bolt" aria-hidden="true"></i> Hot
                </button>
                <button class="sort-button" 
                        data-sort="new" 
                        aria-pressed="false">
                    <i class="fas fa-certificate" aria-hidden="true"></i> New
                </button>
                <button class="sort-button" 
                        data-sort="top" 
                        aria-pressed="false">
                    <i class="fas fa-arrow-trend-up" aria-hidden="true"></i> Top
                </button>
                <button class="sort-button" 
                        data-sort="trending" 
                        aria-pressed="false">
                    <i class="fas fa-fire trending-indicator" aria-hidden="true"></i> Trending
                </button>
            </section>

            <!-- Posts Feed -->
            <section id="posts-feed" role="feed" aria-label="Social media posts">
                <!-- Posts will be loaded dynamically -->
            </section>

            <!-- Load More Button -->
            <div class="text-center">
                <button id="loadMoreBtn" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> Load more posts
                </button>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="Discover and premium">
            <!-- Live Stats -->
            <section style="background: var(--surface-secondary); border-radius: var(--radius-xl); padding: var(--spacing-lg);">
                <h4 style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    Live Stats
                    <span class="live-indicator"><div class="live-dot"></div></span>
                </h4>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); font-size: var(--font-size-sm);">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Online Users:</span>
                        <span id="onlineUsers" style="color: var(--success-color); font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Active Chats:</span>
                        <span id="activeChats" style="color: var(--primary-color); font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Live Posts:</span>
                        <span id="activePolls" style="color: var(--accent-color); font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Posts Today:</span>
                        <span id="postsToday" style="color: var(--warning-color); font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Communities:</span>
                        <span id="totalCommunities" style="color: var(--secondary-color); font-weight: bold;">0</span>
                    </div>
                </div>
            </section>

            <!-- Trending Channels -->
            <section style="background: var(--surface-secondary); border-radius: var(--radius-xl); padding: var(--spacing-lg); margin-top: var(--spacing-lg);">
                <h4 style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <i class="fas fa-fire trending-indicator" aria-hidden="true"></i>
                    Trending Channels
                </h4>
                <div id="trendingChannels" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    <!-- Trending channels will be loaded dynamically -->
                </div>
            </section>

            <!-- Premium Section -->
            <section class="premium-section">
                <div class="premium-content">
                    <div style="display: flex; align-items: center; margin-bottom: var(--spacing-sm);">
                        <i class="fas fa-crown" style="margin-right: var(--spacing-sm); color: var(--premium-gold);" aria-hidden="true"></i>
                        <h4>Smile Xplore Premium</h4>
                        <span class="premium-badge" style="margin-left: var(--spacing-sm);">
                            <i class="fas fa-star"></i> VIP
                        </span>
                    </div>
                    <p style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">
                        Unlock exclusive features: <span class="disco-text">Disco Text</span>, 
                        <span class="premium-emoji"></span> Premium Emojis, 
                        Priority DMs, Group Chat creation, Custom channels, 
                        Ad-free experience, and more!
                    </p>
                    <button id="premiumBtn" class="btn btn-premium" style="width: 100%;">
                        <i class="fas fa-crown"></i> UPGRADE TO PREMIUM
                    </button>
                </div>
            </section>

            <!-- Ad Container -->
            <div class="ad-container hidden" id="sidebarAd">
                <div class="ad-label">Sponsored</div>
                <div class="ad-content">
                    <p>Your ad could be here</p>
                </div>
            </div>
        </aside>
    </main>

    <!-- Create Post Modal -->
    <div id="create-post-modal" class="modal" role="dialog" aria-labelledby="create-post-title" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 id="create-post-title">Create a post</h3>
                <button id="closeCreatePostModal" 
                        class="modal-close" 
                        aria-label="Close create post modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div class="modal-body">
                <form id="createPostForm" novalidate>
                    <div class="form-group">
                        <label for="postCommunity" class="form-label">Community</label>
                        <select id="postCommunity" name="community" class="form-select" required>
                            <option value="general">General</option>
                            <!-- Communities will be loaded dynamically -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="postType" class="form-label">Post type</label>
                        <select id="postType" name="postType" class="form-select" required>
                            <option value="text">Text Post</option>
                            <option value="image">Image Post</option>
                            <option value="video">Video Post</option>
                            <option value="poll">Poll</option>
                            <option value="live-chat" id="livePostOption">Live Chat Event</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="postTitle" class="form-label">Title</label>
                        <input type="text" 
                               id="postTitle" 
                               name="title" 
                               placeholder="Title" 
                               class="form-control" 
                               required>
                    </div>

                    <div class="form-group" id="contentContainer">
                        <label for="postContent" class="form-label">Content</label>
                        <textarea id="postContent" 
                                  name="content" 
                                  placeholder="What are your thoughts?" 
                                  rows="6" 
                                  class="form-control"></textarea>
                    </div>

                    <!-- Poll Options Container -->
                    <div class="form-group hidden" id="pollOptionsContainer">
                        <label class="form-label">Poll Options</label>
                        <div id="pollOptions">
                            <input type="text" 
                                   class="form-control poll-option-input" 
                                   placeholder="Option 1" 
                                   style="margin-bottom: var(--spacing-sm);">
                            <input type="text" 
                                   class="form-control poll-option-input" 
                                   placeholder="Option 2" 
                                   style="margin-bottom: var(--spacing-sm);">
                        </div>
                        <button type="button" 
                                id="addPollOption" 
                                class="btn btn-secondary" 
                                style="margin-top: var(--spacing-sm);">
                            <i class="fas fa-plus" aria-hidden="true"></i> Add Option
                        </button>
                    </div>

                    <!-- Live Chat Event Container -->
                    <div class="form-group hidden" id="liveChatContainer">
                        <label for="chatChannel" class="form-label">Chat Channel</label>
                        <input type="text" 
                               id="chatChannel" 
                               name="chatChannel" 
                               placeholder="Enter channel name (e.g., tech-discussion)" 
                               class="form-control">
                        <div style="margin-top: var(--spacing-sm); font-size: var(--font-size-xs); color: var(--text-muted);">
                            This will create a live chat event that others can join in real-time.
                        </div>
                    </div>

                    <div class="form-group" id="mediaUploadContainer">
                        <label class="form-label">Media Upload</label>
                        <div class="media-upload-area" 
                             id="mediaUploadArea" 
                             role="button" 
                             tabindex="0" 
                             aria-label="Click or drag media files here to upload">
                            <i class="fas fa-cloud-upload-alt" 
                               style="font-size: var(--font-size-2xl); color: var(--text-muted); margin-bottom: var(--spacing-sm);" 
                               aria-hidden="true"></i>
                            <p>Click or drag images/videos here to upload</p>
                            <p style="font-size: var(--font-size-xs); color: var(--text-muted);">
                                Supports: JPG, PNG, GIF, MP4, WebM (Max 50MB)
                            </p>
                            <input type="file" 
                                   id="mediaInput" 
                                   accept="image/*,video/*" 
                                   multiple 
                                   style="display: none;" 
                                   aria-label="Select media files to upload">
                        </div>
                        <div id="mediaPreviewContainer" class="media-preview-container" role="list" aria-label="Selected media files"></div>
                    </div>
                </form>
            </div>

            <footer class="modal-footer">
                <button type="button" id="cancelCreatePost" class="btn btn-secondary">Cancel</button>
                <button type="submit" form="createPostForm" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Post
                </button>
            </footer>
        </div>
    </div>

    <!-- Create Community Modal -->
    <div id="create-community-modal" class="modal" role="dialog" aria-labelledby="create-community-title" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 id="create-community-title">Create a Community</h3>
                <button id="closeCreateCommunityModal" 
                        class="modal-close" 
                        aria-label="Close create community modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </header>

            <div class="modal-body">
                <form id="createCommunityForm" novalidate>
                    <div class="form-group">
                        <label for="communityName" class="form-label">Community Name</label>
                        <input type="text" 
                               id="communityName" 
                               name="name" 
                               placeholder="Enter community name" 
                               class="form-control" 
                               required>
                        <div id="communityNameValidation" class="name-validation" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label for="communityDescription" class="form-label">Description</label>
                        <textarea id="communityDescription" 
                                  name="description" 
                                  placeholder="What's your community about?" 
                                  rows="4" 
                                  class="form-control"></textarea>
                    </div>

                    <fieldset class="form-group">
                        <legend class="form-label">Community Type</legend>
                        <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-sm);">
                            <div style="display: flex; align-items: center;">
                                <input type="radio" 
                                       id="typePublic" 
                                       name="type" 
                                       value="public" 
                                       checked 
                                       style="margin-right: var(--spacing-sm);">
                                <label for="typePublic">Public</label>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <input type="radio" 
                                       id="typePrivate" 
                                       name="type" 
                                       value="private" 
                                       style="margin-right: var(--spacing-sm);">
                                <label for="typePrivate">Private</label>
                            </div>
                        </div>
                    </fieldset>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="enableChatChannels" name="enableChatChannels" style="margin-right: var(--spacing-sm);">
                            Enable Chat Channels
                        </label>
                        <div style="font-size: var(--font-size-xs); color: var(--text-muted); margin-top: var(--spacing-xs);">
                            Allow real-time chat channels within this community
                        </div>
                    </div>
                </form>
            </div>

            <footer class="modal-footer">
                <button type="button" id="cancelCreateCommunity" class="btn btn-secondary">Cancel</button>
                <button type="submit" form="createCommunityForm" class="btn btn-primary">
                    <i class="fas fa-users"></i> Create Community
                </button>
            </footer>
        </div>
    </div>

    <!-- Enhanced Chat Container -->
    <div id="chat-container" class="chat-container" role="dialog" aria-labelledby="chat-title">
        <header class="chat-header">
            <h3 id="chat-title">
                <i class="fas fa-hashtag"></i> 
                <span id="currentChannelName">general</span>
                <span class="live-indicator"><div class="live-dot"></div></span>
            </h3>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                <span style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.7);">
                    <i class="fas fa-users"></i> <span id="channelUserCount">0</span> online
                </span>
                <button id="chat-close-btn" 
                        class="chat-close" 
                        aria-label="Close chat">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
        </header>
        <div class="chat-messages" 
             id="chat-messages" 
             role="log" 
             aria-live="polite" 
             aria-label="Chat messages">
            <!-- Messages will be loaded dynamically -->
        </div>
        <div class="chat-input-container">
            <label for="chat-input" class="sr-only">Type your message</label>
            <input type="text" 
                   id="chat-input" 
                   class="chat-input" 
                   placeholder="Type your message...">
            <button id="emoji-btn" 
                    class="emoji-picker-btn" 
                    aria-label="Add emoji">
                <i class="far fa-smile"></i>
            </button>
            <button id="chat-send-btn" 
                    class="chat-send" 
                    aria-label="Send message">
                <i class="fas fa-paper-plane" aria-hidden="true"></i>
            </button>
        </div>
    </div>

    <!-- Live Chat Toggle Button -->
    <button id="chat-toggle-btn" 
            class="chat-toggle" 
            aria-label="Toggle live chat" 
            title="Live Chat Channels">
        <i class="fas fa-comments" aria-hidden="true"></i>
        <span class="notification-badge" id="chatBadge" style="display: none;">0</span>
    </button>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" role="navigation" aria-label="Mobile navigation">
        <a href="#" class="mobile-nav-item active" aria-current="page">
            <i class="fas fa-home" aria-hidden="true"></i>
            <span>Home</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileBrowseBtn">
            <i class="fas fa-compass" aria-hidden="true"></i>
            <span>Explore</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileCreatePost">
            <i class="fas fa-plus-circle" aria-hidden="true"></i>
            <span>Create</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileDmToggle">
            <i class="fas fa-envelope" aria-hidden="true"></i>
            <span>Messages</span>
            <span class="notification-badge" id="mobileDmBadge" style="display: none;">0</span>
        </a>
        <a href="#" class="mobile-nav-item" id="mobileChatToggle">
            <i class="fas fa-comments" aria-hidden="true"></i>
            <span>Chat</span>
        </a>
    </nav>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global Configuration
        const CONFIG = {
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            SUPPORTED_IMAGE_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
            SUPPORTED_VIDEO_TYPES: ['video/mp4', 'video/webm', 'video/ogg'],
            MAX_POLL_OPTIONS: 6,
            MAX_POST_LENGTH: 10000,
            PREMIUM_EMOJIS: ['', '', '', '', '', '', '', '', '', ''],
            CHAT_UPDATE_INTERVAL: 1000, // 1 second
            ACTIVITY_UPDATE_INTERVAL: 5000, // 5 seconds
            MAX_CHAT_MESSAGES: 100,
            POST_LIFETIME: 90, // days
            LIVE_POST_LIFETIME: 1, // day
            CHAT_LIFETIME: 7 // days
        };

        // Global State
        let currentUser = null;
        let posts = [];
        let communities = [];
        let directMessages = [];
        let groupChats = [];
        let chatChannels = [];
        let friends = [];
        let friendRequests = [];
        let notifications = [];
        let isLiveMode = true;
        let currentChannel = 'general';
        let onlineUsers = new Set();
        let typingUsers = new Set();
        let postViewCount = 0;
        let adInterval;
        let unsubscribeFunctions = [];

        // Initialize Firebase Authentication state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                console.log("User is signed in:", user.uid);
                checkUserProfile(user.uid);
            } else {
                // User is signed out
                console.log("User is signed out");
                showOnboarding();
            }
        });

        // Check if user has completed profile
        async function checkUserProfile(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    currentUser = { uid: userId, ...userDoc.data() };
                    initializeApp();
                } else {
                    showOnboarding();
                }
            } catch (error) {
                console.error("Error checking user profile:", error);
                showOnboarding();
            }
        }

        // Show onboarding modal
        function showOnboarding() {
            setTimeout(() => {
                const preloader = document.getElementById('preloader');
                if (preloader) {
                    preloader.style.display = 'none';
                }
                showModal('onboardingOverlay');
            }, 1000);
        }

        // Initialize the app after user is authenticated
        function initializeApp() {
            // Update UI with user data
            updateUserInterface(currentUser);
            
            // Load user data
            loadUserData();
            
            // Set up real-time listeners
            setupRealtimeListeners();
            
            // Hide preloader
            const preloader = document.getElementById('preloader');
            if (preloader) {
                preloader.style.display = 'none';
            }
            
            // Check if user is premium and update UI accordingly
            if (currentUser.isPremium) {
                enablePremiumFeatures();
            }
            
            // Start ad interval
            startAdInterval();
            
            console.log(' Smile Xplore Advanced Platform Initialized Successfully!');
        }

        // Enhanced Registration Handler with Firebase Auth
        async function handleRegistrationSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const fullName = formData.get('fullName');
            const username = formData.get('username');
            const gender = formData.get('gender');
            const country = formData.get('country');
            const birthdate = formData.get('birthdate');
            
            try {
                // Create user with Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Create user profile in Firestore
                const userData = {
                    uid: user.uid,
                    email: email,
                    fullName: fullName,
                    username: username,
                    gender: gender,
                    country: country,
                    birthdate: birthdate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    isPremium: false,
                    status: 'online',
                    profileImage: null,
                    postCount: 0,
                    friendCount: 0
                };
                
                await db.collection('users').doc(user.uid).set(userData);
                
                // Upload profile image if selected
                const profileImageInput = document.getElementById('profileImageInput');
                if (profileImageInput.files.length > 0) {
                    await uploadProfileImage(user.uid, profileImageInput.files[0]);
                }
                
                currentUser = userData;
                hideModal('onboardingOverlay');
                initializeApp();
                
                showNotification(`Welcome to Smile Xplore, ${fullName}!`, 'success');
            } catch (error) {
                console.error("Error creating user:", error);
                showNotification(`Registration failed: ${error.message}`, 'error');
            }
        }

        // Upload profile image to Firebase Storage
        async function uploadProfileImage(userId, file) {
            try {
                const storageRef = storage.ref();
                const profileImagesRef = storageRef.child(`profileImages/${userId}`);
                const snapshot = await profileImagesRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                // Update user document with profile image URL
                await db.collection('users').doc(userId).update({
                    profileImage: downloadURL
                });
                
                currentUser.profileImage = downloadURL;
                updateProfileImage(downloadURL);
                
            } catch (error) {
                console.error("Error uploading profile image:", error);
                showNotification("Failed to upload profile image", 'error');
            }
        }

        // Update profile image in UI
        function updateProfileImage(imageUrl) {
            const profilePreview = document.getElementById('profilePreview');
            if (profilePreview) {
                profilePreview.innerHTML = `
                    <img src="${imageUrl}" alt="Profile picture">
                    <div class="profile-upload-overlay">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            }
            
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.innerHTML = `
                    <img src="${imageUrl}" alt="Profile picture">
                    <div class="status-indicator status-online"></div>
                `;
            }
        }

        // Post Creation with Firestore
        async function handleCreatePostSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const title = formData.get('title');
            const content = formData.get('content') || "";
            const postType = formData.get('postType');
            const community = formData.get('community');
            const chatChannel = formData.get('chatChannel');
            
            try {
                const postData = {
                    title: title,
                    content: content,
                    authorId: currentUser.uid,
                    authorName: currentUser.fullName,
                    authorUsername: currentUser.username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: postType,
                    community: community,
                    votes: 0,
                    comments: 0,
                    isLive: postType === 'live-chat',
                    expiresAt: calculateExpirationDate(postType),
                    // For polls
                    options: postType === 'poll' ? getPollOptions() : [],
                    // For live chats
                    channel: postType === 'live-chat' ? chatChannel : null
                };
                
                // Add media files if any
                const mediaFiles = await uploadMediaFiles();
                if (mediaFiles.length > 0) {
                    postData.media = mediaFiles;
                }
                
                // Add to Firestore
                const docRef = await db.collection('posts').add(postData);
                
                // Update user's post count
                await db.collection('users').doc(currentUser.uid).update({
                    postCount: firebase.firestore.FieldValue.increment(1)
                });
                
                hideModal('create-post-modal');
                event.target.reset();
                
                showNotification('Post created successfully!', 'success');
                
            } catch (error) {
                console.error("Error creating post:", error);
                showNotification("Failed to create post", 'error');
            }
        }

        // Calculate expiration date based on post type
        function calculateExpirationDate(postType) {
            const now = new Date();
            let expirationDate;
            
            switch (postType) {
                case 'live-chat':
                    expirationDate = new Date(now.getTime() + (CONFIG.LIVE_POST_LIFETIME * 24 * 60 * 60 * 1000));
                    break;
                default:
                    expirationDate = new Date(now.getTime() + (CONFIG.POST_LIFETIME * 24 * 60 * 60 * 1000));
            }
            
            return expirationDate;
        }

        // Upload media files to Firebase Storage
        async function uploadMediaFiles() {
            const mediaInput = document.getElementById('mediaInput');
            const files = mediaInput.files;
            const uploadedFiles = [];
            
            if (files.length === 0) return uploadedFiles;
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const storageRef = storage.ref();
                    const mediaRef = storageRef.child(`posts/${currentUser.uid}/${Date.now()}_${file.name}`);
                    const snapshot = await mediaRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    uploadedFiles.push({
                        url: downloadURL,
                        type: file.type.startsWith('image/') ? 'image' : 'video',
                        name: file.name
                    });
                }
            } catch (error) {
                console.error("Error uploading media:", error);
                showNotification("Failed to upload some media files", 'error');
            }
            
            return uploadedFiles;
        }

        // Get poll options from form
        function getPollOptions() {
            const options = [];
            const optionInputs = document.querySelectorAll('.poll-option-input');
            
            optionInputs.forEach(input => {
                if (input.value.trim() !== '') {
                    options.push({
                        text: input.value.trim(),
                        votes: 0
                    });
                }
            });
            
            return options;
        }

        // Community Creation with Firestore
        async function handleCreateCommunitySubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const name = formData.get('name');
            const description = formData.get('description');
            const type = formData.get('type');
            const enableChatChannels = formData.get('enableChatChannels') === 'on';
            
            // Check if community name is available
            const isAvailable = await checkCommunityNameAvailability(name);
            if (!isAvailable) {
                showNotification("Community name is already taken", 'error');
                return;
            }
            
            try {
                const communityData = {
                    name: name,
                    description: description,
                    type: type,
                    enableChatChannels: enableChatChannels,
                    createdBy: currentUser.uid,
                    createdByName: currentUser.fullName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    memberCount: 1,
                    isVerified: false,
                    postCount: 0
                };
                
                // Add to Firestore
                const docRef = await db.collection('communities').add(communityData);
                
                // Add creator as member
                await db.collection('communityMembers').add({
                    communityId: docRef.id,
                    userId: currentUser.uid,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'admin'
                });
                
                hideModal('create-community-modal');
                event.target.reset();
                
                showNotification(`Community "${name}" created successfully!`, 'success');
                
            } catch (error) {
                console.error("Error creating community:", error);
                showNotification("Failed to create community", 'error');
            }
        }

        // Check if community name is available
        async function checkCommunityNameAvailability(name) {
            try {
                const snapshot = await db.collection('communities')
                    .where('name', '==', name)
                    .get();
                
                return snapshot.empty;
            } catch (error) {
                console.error("Error checking community name:", error);
                return false;
            }
        }

        // Setup real-time listeners for posts, messages, etc.
        function setupRealtimeListeners() {
            // Clear any existing listeners
            unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
            unsubscribeFunctions = [];
            
            // Listen for new posts
            const postsUnsubscribe = db.collection('posts')
                .where('expiresAt', '>', new Date())
                .orderBy('expiresAt')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            addPostToFeed(change.doc.data(), change.doc.id);
                        }
                        if (change.type === 'modified') {
                            updatePostInFeed(change.doc.data(), change.doc.id);
                        }
                        if (change.type === 'removed') {
                            removePostFromFeed(change.doc.id);
                        }
                    });
                });
            unsubscribeFunctions.push(postsUnsubscribe);
            
            // Listen for new messages in current channel
            const messagesUnsubscribe = db.collection('messages')
                .where('channel', '==', currentChannel)
                .orderBy('timestamp', 'desc')
                .limit(CONFIG.MAX_CHAT_MESSAGES)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            addMessageToChat(change.doc.data());
                        }
                    });
                });
            unsubscribeFunctions.push(messagesUnsubscribe);
            
            // Listen for user status changes
            const usersUnsubscribe = db.collection('users')
                .where('status', 'in', ['online', 'away', 'busy'])
                .onSnapshot(snapshot => {
                    updateOnlineUsers(snapshot.docs.map(doc => doc.data()));
                });
            unsubscribeFunctions.push(usersUnsubscribe);
            
            // Listen for community updates
            const communitiesUnsubscribe = db.collection('communities')
                .where('memberCount', '>=', 0)
                .orderBy('memberCount', 'desc')
                .limit(10)
                .onSnapshot(snapshot => {
                    communities = [];
                    snapshot.forEach(doc => {
                        communities.push({ id: doc.id, ...doc.data() });
                    });
                    updateCommunitiesDisplay();
                    updateTrendingChannels();
                });
            unsubscribeFunctions.push(communitiesUnsubscribe);
            
            // Listen for live stats updates
            const statsUnsubscribe = db.collection('stats')
                .doc('platform')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        updateLiveStats(doc.data());
                    }
                });
            unsubscribeFunctions.push(statsUnsubscribe);
            
            // Listen for friend requests
            if (currentUser) {
                const friendRequestsUnsubscribe = db.collection('friendRequests')
                    .where('toUserId', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .onSnapshot(snapshot => {
                        friendRequests = [];
                        snapshot.forEach(doc => {
                            friendRequests.push({ id: doc.id, ...doc.data() });
                        });
                        updateFriendRequests();
                    });
                unsubscribeFunctions.push(friendRequestsUnsubscribe);
                
                // Listen for friends
                const friendsUnsubscribe = db.collection('friends')
                    .where('userId', '==', currentUser.uid)
                    .onSnapshot(snapshot => {
                        friends = [];
                        snapshot.forEach(doc => {
                            friends.push({ id: doc.id, ...doc.data() });
                        });
                        updateFriendsList();
                    });
                unsubscribeFunctions.push(friendsUnsubscribe);
                
                // Listen for notifications
                const notificationsUnsubscribe = db.collection('notifications')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .onSnapshot(snapshot => {
                        notifications = [];
                        snapshot.forEach(doc => {
                            notifications.push({ id: doc.id, ...doc.data() });
                        });
                        updateNotifications();
                    });
                unsubscribeFunctions.push(notificationsUnsubscribe);
            }
        }

        // Add post to feed
        function addPostToFeed(postData, postId) {
            const postsFeed = document.getElementById('posts-feed');
            
            // Create post element
            const postElement = createPostElement(postData, postId);
            
            // Insert at the beginning of the feed
            postsFeed.insertBefore(postElement, postsFeed.firstChild);
            
            // Increment post view count and check for ads
            postViewCount++;
            checkAdDisplay();
        }

        // Update post in feed
        function updatePostInFeed(postData, postId) {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            if (postElement) {
                const newPostElement = createPostElement(postData, postId);
                postElement.parentNode.replaceChild(newPostElement, postElement);
            }
        }

        // Remove post from feed
        function removePostFromFeed(postId) {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            if (postElement) {
                postElement.remove();
            }
        }

        // Create post element from post data
        function createPostElement(postData, postId) {
            const postElement = document.createElement('article');
            postElement.className = 'post-card';
            postElement.setAttribute('role', 'article');
            postElement.setAttribute('data-post-id', postId);
            
            // Calculate time remaining
            const expiresAt = postData.expiresAt.toDate();
            const now = new Date();
            const timeRemaining = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
            
            // Build post HTML
            postElement.innerHTML = `
                <div class="post-content">
                    <div class="vote-section" role="group" aria-label="Vote on post">
                        <button class="vote-button" aria-label="Upvote post" onclick="votePost('${postId}', 'up')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <div class="vote-count" aria-label="Vote count">${postData.votes}</div>
                        <button class="vote-button" aria-label="Downvote post" onclick="votePost('${postId}', 'down')">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    
                    <div class="post-main">
                        <div class="post-meta">
                            <span class="community-icon bg-purple-500">${postData.community.charAt(0)}</span>
                            <span>${postData.community}</span>
                            <span></span>
                            <span>Posted by ${postData.authorName}</span>
                            ${postData.authorPremium ? '<span class="premium-badge"><i class="fas fa-crown"></i> Premium</span>' : ''}
                            <span></span>
                            <time>${getTimeAgo(postData.timestamp.toDate())}</time>
                            ${postData.isLive ? '<span class="live-indicator"><div class="live-dot"></div>LIVE</span>' : ''}
                        </div>
                        
                        <h2 class="post-title">${postData.title}</h2>
                        
                        ${postData.content ? `<div class="post-text">${postData.content}</div>` : ''}
                        
                        ${postData.media ? renderMedia(postData.media) : ''}
                        
                        ${postData.type === 'poll' ? renderPoll(postData.options, postId) : ''}
                        
                        <div class="disappearing-indicator">
                            <i class="fas fa-hourglass-half"></i> 
                            This ${postData.isLive ? 'live post' : 'post'} will disappear in ${timeRemaining} ${timeRemaining === 1 ? 'day' : 'days'}
                        </div>
                        
                        <div class="post-actions">
                            <div class="post-action-buttons">
                                <button class="post-action-button" aria-label="View comments" onclick="toggleComments('${postId}')">
                                    <i class="far fa-comment"></i>
                                    <span>${postData.comments} Comments</span>
                                </button>
                                <button class="post-action-button" aria-label="Share post">
                                    <i class="fas fa-share"></i>
                                    <span>Share</span>
                                </button>
                                <button class="post-action-button" aria-label="Save post">
                                    <i class="far fa-bookmark"></i>
                                    <span>Save</span>
                                </button>
                                <button class="post-action-button" aria-label="Send direct message" onclick="startDM('${postData.authorId}')">
                                    <i class="fas fa-envelope"></i>
                                    <span>DM</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="comments-section" id="comments-${postId}"></div>
            `;
            
            return postElement;
        }

        // Render media for post
        function renderMedia(media) {
            if (media.length === 0) return '';
            
            if (media.length === 1) {
                const item = media[0];
                if (item.type === 'image') {
                    return `<img src="${item.url}" alt="Post image" class="post-image">`;
                } else {
                    return `<video src="${item.url}" controls class="post-video"></video>`;
                }
            }
            
            let html = '<div class="media-grid ';
            if (media.length === 2) html += 'double';
            else if (media.length > 2) html += 'multiple';
            html += '">';
            
            media.forEach(item => {
                if (item.type === 'image') {
                    html += `<img src="${item.url}" alt="Post image">`;
                } else {
                    html += `<video src="${item.url}" controls></video>`;
                }
            });
            
            html += '</div>';
            return html;
        }

        // Render poll for post
        function renderPoll(options, postId) {
            let html = '<div class="poll-container">';
            
            options.forEach((option, index) => {
                const totalVotes = options.reduce((sum, opt) => sum + (opt.votes || 0), 0);
                const percentage = totalVotes > 0 ? Math.round((option.votes / totalVotes) * 100) : 0;
                html += `
                    <div class="poll-option" onclick="votePoll('${postId}', ${index})">
                        <div class="poll-option-bar" style="width: ${percentage}%"></div>
                        <span class="poll-option-text">${option.text}</span>
                        <span class="poll-option-percentage">${percentage}%</span>
                    </div>
                `;
            });
            
            const totalVotes = options.reduce((sum, opt) => sum + (opt.votes || 0), 0);
            html += `
                <div class="poll-stats">
                    ${totalVotes} votes  Active <span class="live-indicator"><div class="live-dot"></div>LIVE</span>
                </div>
            </div>
            `;
            
            return html;
        }

        // Vote on a post
        async function votePost(postId, direction) {
            if (!currentUser) return;
            
            try {
                // Check if user already voted
                const voteDoc = await db.collection('postVotes')
                    .where('postId', '==', postId)
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                if (!voteDoc.empty) {
                    showNotification("You've already voted on this post", 'info');
                    return;
                }
                
                // Record the vote
                await db.collection('postVotes').add({
                    postId: postId,
                    userId: currentUser.uid,
                    direction: direction,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update post vote count
                const updateData = {};
                if (direction === 'up') {
                    updateData.votes = firebase.firestore.FieldValue.increment(1);
                } else {
                    updateData.votes = firebase.firestore.FieldValue.increment(-1);
                }
                
                await db.collection('posts').doc(postId).update(updateData);
                
                showNotification(`Post ${direction === 'up' ? 'upvoted' : 'downvoted'}!`, 'success');
                
            } catch (error) {
                console.error("Error voting on post:", error);
                showNotification("Failed to vote on post", 'error');
            }
        }

        // Vote on a poll option
        async function votePoll(postId, optionIndex) {
            if (!currentUser) return;
            
            try {
                // Check if user already voted on this poll
                const voteDoc = await db.collection('pollVotes')
                    .where('postId', '==', postId)
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                if (!voteDoc.empty) {
                    showNotification("You've already voted on this poll", 'info');
                    return;
                }
                
                // Record the vote
                await db.collection('pollVotes').add({
                    postId: postId,
                    userId: currentUser.uid,
                    optionIndex: optionIndex,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update poll option vote count
                const postDoc = await db.collection('posts').doc(postId).get();
                const postData = postDoc.data();
                const options = postData.options;
                
                if (optionIndex >= 0 && optionIndex < options.length) {
                    options[optionIndex].votes = (options[optionIndex].votes || 0) + 1;
                    
                    await db.collection('posts').doc(postId).update({
                        options: options
                    });
                }
                
                showNotification("Vote recorded!", 'success');
                
            } catch (error) {
                console.error("Error voting on poll:", error);
                showNotification("Failed to vote on poll", 'error');
            }
        }

        // Toggle comments section
        async function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            
            if (commentsSection.classList.contains('active')) {
                commentsSection.classList.remove('active');
                return;
            }
            
            commentsSection.classList.add('active');
            
            // Load comments if not already loaded
            if (commentsSection.innerHTML === '') {
                await loadComments(postId, commentsSection);
            }
        }

        // Load comments for a post
        async function loadComments(postId, container) {
            try {
                const snapshot = await db.collection('comments')
                    .where('postId', '==', postId)
                    .orderBy('timestamp', 'asc')
                    .get();
                
                let html = '';
                
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    html += `
                        <div class="comment">
                            <div class="comment-header">
                                <div class="comment-author">${comment.authorName}</div>
                                <div class="comment-time">${getTimeAgo(comment.timestamp.toDate())}</div>
                            </div>
                            <div class="comment-text">${comment.text}</div>
                            <div class="comment-actions">
                                <span class="comment-action" onclick="likeComment('${doc.id}')">Like</span>
                                <span class="comment-action" onclick="replyToComment('${doc.id}', '${comment.authorName}')">Reply</span>
                            </div>
                        </div>
                    `;
                });
                
                // Add comment input
                html += `
                    <div class="comment-input">
                        <div class="user-avatar" style="width: 32px; height: 32px; font-size: 12px;">
                            ${currentUser.username.charAt(0)}
                        </div>
                        <input type="text" placeholder="Add a comment..." id="comment-input-${postId}">
                        <button class="btn btn-primary" onclick="addComment('${postId}')">Post</button>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading comments:", error);
                container.innerHTML = '<p>Error loading comments</p>';
            }
        }

        // Add a comment to a post
        async function addComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            
            if (!text) return;
            
            try {
                await db.collection('comments').add({
                    postId: postId,
                    authorId: currentUser.uid,
                    authorName: currentUser.fullName,
                    authorUsername: currentUser.username,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0
                });
                
                // Update post comment count
                await db.collection('posts').doc(postId).update({
                    comments: firebase.firestore.FieldValue.increment(1)
                });
                
                input.value = '';
                showNotification("Comment added!", 'success');
                
            } catch (error) {
                console.error("Error adding comment:", error);
                showNotification("Failed to add comment", 'error');
            }
        }

        // Start a direct message with a user
        async function startDM(userId) {
            if (!currentUser || userId === currentUser.uid) return;
            
            try {
                // Check if conversation already exists
                const conversationQuery = await db.collection('conversations')
                    .where('participants', 'array-contains', currentUser.uid)
                    .get();
                
                let conversationId = null;
                
                conversationQuery.forEach(doc => {
                    const data = doc.data();
                    if (data.participants.includes(userId)) {
                        conversationId = doc.id;
                    }
                });
                
                if (!conversationId) {
                    // Create new conversation
                    const conversationData = {
                        participants: [currentUser.uid, userId],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: null,
                        lastMessageTime: null
                    };
                    
                    const docRef = await db.collection('conversations').add(conversationData);
                    conversationId = docRef.id;
                }
                
                // Open DM panel and switch to this conversation
                toggleDMPanel();
                switchToConversation(conversationId);
                
            } catch (error) {
                console.error("Error starting DM:", error);
                showNotification("Failed to start conversation", 'error');
            }
        }

        // Send a direct message
        async function sendDirectMessage(conversationId, message) {
            if (!currentUser || !message.trim()) return;
            
            try {
                // Add message to conversation
                await db.collection('messages').add({
                    conversationId: conversationId,
                    senderId: currentUser.uid,
                    senderName: currentUser.fullName,
                    text: message.trim(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + (CONFIG.CHAT_LIFETIME * 24 * 60 * 60 * 1000))
                });
                
                // Update conversation last message
                await db.collection('conversations').doc(conversationId).update({
                    lastMessage: message.trim(),
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification("Message sent!", 'success');
                
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification("Failed to send message", 'error');
            }
        }

        // Enable premium features for user
        async function enablePremiumFeatures() {
            // Show live post button
            const livePostButton = document.getElementById('livePostButton');
            const livePostOption = document.getElementById('livePostOption');
            
            if (livePostButton) livePostButton.style.display = 'flex';
            if (livePostOption) livePostOption.style.display = 'block';
            
            // Add premium badge to user avatar
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.classList.add('premium');
            }
            
            // Hide ads for premium users
            document.getElementById('adContainer').classList.add('hidden');
            document.getElementById('sidebarAd').classList.add('hidden');
            
            // Enable premium emojis and features
            showNotification("Premium features activated!", 'success');
        }

        // Upgrade to premium
        async function upgradeToPremium() {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    isPremium: true,
                    premiumSince: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentUser.isPremium = true;
                enablePremiumFeatures();
                
                showNotification("Welcome to Smile Xplore Premium!", 'success');
                
            } catch (error) {
                console.error("Error upgrading to premium:", error);
                showNotification("Failed to upgrade to premium", 'error');
            }
        }

        // Start ad interval
        function startAdInterval() {
            // Show ad after every 3 posts viewed
            adInterval = setInterval(() => {
                checkAdDisplay();
            }, 30000); // Check every 30 seconds
        }

        // Check if should display ad
        function checkAdDisplay() {
            if (currentUser && currentUser.isPremium) {
                // Premium users don't see ads
                document.getElementById('adContainer').classList.add('hidden');
                document.getElementById('sidebarAd').classList.add('hidden');
                return;
            }
            
            if (postViewCount >= 3) {
                document.getElementById('adContainer').classList.remove('hidden');
                document.getElementById('sidebarAd').classList.remove('hidden');
                postViewCount = 0; // Reset counter
            }
        }

        // Logout user
        async function logout() {
            try {
                // Update user status to offline
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        status: 'offline',
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Clear all real-time listeners
                unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
                unsubscribeFunctions = [];
                
                // Sign out from Firebase
                await auth.signOut();
                
                // Clear local state
                currentUser = null;
                posts = [];
                communities = [];
                directMessages = [];
                
                // Show onboarding
                showOnboarding();
                
                showNotification("Logged out successfully", 'info');
                
            } catch (error) {
                console.error("Error logging out:", error);
                showNotification("Failed to logout", 'error');
            }
        }

        // Load user data from Firestore
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Load user's communities
                const communitiesSnapshot = await db.collection('communityMembers')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                const communityIds = [];
                communitiesSnapshot.forEach(doc => {
                    communityIds.push(doc.data().communityId);
                });
                
                if (communityIds.length > 0) {
                    const communitiesData = await db.collection('communities')
                        .where(firebase.firestore.FieldPath.documentId(), 'in', communityIds)
                        .get();
                    
                    communities = [];
                    communitiesData.forEach(doc => {
                        communities.push({ id: doc.id, ...doc.data() });
                    });
                    
                    updateCommunitiesDisplay();
                }
                
                // Load user's conversations
                const conversationsSnapshot = await db.collection('conversations')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('lastMessageTime', 'desc')
                    .get();
                
                directMessages = [];
                conversationsSnapshot.forEach(doc => {
                    directMessages.push({ id: doc.id, ...doc.data() });
                });
                
                // Update UI with loaded data
                updateUIWithUserData();
                
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        // Update UI with loaded user data
        function updateUIWithUserData() {
            // Update communities list
            updateCommunitiesDisplay();
            
            // Update notifications badge
            updateNotificationBadge();
            
            // Update online status
            updateOnlineStatus();
            
            // Update friends list
            updateFriendsList();
            
            // Update direct messages
            updateDirectMessages();
        }

        // Update communities display
        function updateCommunitiesDisplay() {
            const communitiesList = document.getElementById('communitiesList');
            const postCommunitySelect = document.getElementById('postCommunity');
            
            if (!communitiesList) return;
            
            if (communities.length === 0) {
                communitiesList.innerHTML = '<li style="color: var(--text-muted); padding: var(--spacing-sm);">No communities yet</li>';
                
                if (postCommunitySelect) {
                    // Keep only the default option
                    while (postCommunitySelect.options.length > 1) {
                        postCommunitySelect.remove(1);
                    }
                }
                return;
            }
            
            let communitiesHtml = '';
            let selectOptionsHtml = '';
            
            communities.forEach(community => {
                communitiesHtml += `
                    <li>
                        <a href="#" style="display: flex; align-items: center;">
                            <div class="community-icon bg-purple-500">${community.name.charAt(0)}</div>
                            <div>
                                <div style="font-weight: 500;">${community.name}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${formatNumber(community.memberCount)} members</div>
                            </div>
                        </a>
                    </li>
                `;
                
                selectOptionsHtml += `<option value="${community.name}">${community.name}</option>`;
            });
            
            communitiesList.innerHTML = communitiesHtml;
            
            if (postCommunitySelect) {
                // Keep the default option
                const defaultOption = postCommunitySelect.options[0];
                postCommunitySelect.innerHTML = '';
                postCommunitySelect.appendChild(defaultOption);
                
                // Add community options
                communities.forEach(community => {
                    const option = document.createElement('option');
                    option.value = community.name;
                    option.textContent = community.name;
                    postCommunitySelect.appendChild(option);
                });
            }
        }

        // Update notification badge
        function updateNotificationBadge() {
            const unreadNotifications = notifications.filter(n => !n.read);
            const notificationBadge = document.getElementById('notificationBadge');
            
            if (unreadNotifications.length > 0) {
                notificationBadge.textContent = unreadNotifications.length;
                notificationBadge.style.display = 'flex';
            } else {
                notificationBadge.style.display = 'none';
            }
        }

        // Update online status
        async function updateOnlineStatus() {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    status: 'online',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating online status:", error);
            }
        }

        // Update friends list
        function updateFriendsList() {
            const friendsTab = document.getElementById('friendsTab');
            const onlineFriendsList = document.getElementById('onlineFriendsList');
            
            if (!friendsTab || !onlineFriendsList) return;
            
            // Filter online friends
            const onlineFriends = friends.filter(friend => 
                friend.status && friend.status !== 'offline' && friend.status !== 'invisible'
            );
            
            let friendsHtml = '';
            let onlineFriendsHtml = '';
            
            friends.forEach(friend => {
                friendsHtml += `
                    <div class="friend-item">
                        <div class="friend-info">
                            <div class="user-avatar" style="width: 32px; height: 32px; font-size: 12px;">
                                ${friend.friendName.charAt(0)}
                                <div class="status-indicator status-${friend.status || 'offline'}"></div>
                            </div>
                            <div>
                                <div class="dm-name">${friend.friendName}</div>
                                <div class="dm-preview">${friend.status === 'online' ? 'Online now' : friend.status || 'Offline'}</div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="call-btn" title="Voice call" onclick="startCall('${friend.friendId}', false)">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="call-btn video" title="Video call" onclick="startCall('${friend.friendId}', true)">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="friend-action-btn block" title="Block" onclick="blockUser('${friend.friendId}')">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button class="friend-action-btn delete" title="Remove friend" onclick="removeFriend('${friend.friendId}')">
                                <i class="fas fa-user-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            onlineFriends.forEach(friend => {
                onlineFriendsHtml += `
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs);">
                        <div class="user-avatar" style="width: 24px; height: 24px; font-size: 10px;">
                            ${friend.friendName.charAt(0)}
                            <div class="status-indicator status-${friend.status}"></div>
                        </div>
                        <span style="font-size: var(--font-size-sm);">${friend.friendName}</span>
                    </div>
                `;
            });
            
            friendsTab.innerHTML = friendsHtml || '<div class="text-center" style="padding: var(--spacing-md); color: var(--text-muted);">No friends yet</div>';
            onlineFriendsList.innerHTML = onlineFriendsHtml || '<div class="text-center" style="padding: var(--spacing-md); color: var(--text-muted);">No online friends</div>';
        }

        // Update direct messages
        function updateDirectMessages() {
            const dmsTab = document.getElementById('dmsTab');
            
            if (!dmsTab) return;
            
            let dmsHtml = '';
            
            directMessages.forEach(conversation => {
                // Get the other participant
                const otherParticipantId = conversation.participants.find(id => id !== currentUser.uid);
                // This would need additional user data lookup in a real app
                const participantName = "User"; // Placeholder
                
                dmsHtml += `
                    <div class="dm-item" onclick="switchToConversation('${conversation.id}')">
                        <div class="dm-avatar">
                            ${participantName.charAt(0)}
                            <div class="status-indicator status-online"></div>
                        </div>
                        <div class="dm-info">
                            <div class="dm-name">${participantName}</div>
                            <div class="dm-preview">${conversation.lastMessage || 'No messages yet'}</div>
                        </div>
                        <div class="dm-time">${conversation.lastMessageTime ? getTimeAgo(conversation.lastMessageTime.toDate()) : ''}</div>
                    </div>
                `;
            });
            
            dmsTab.innerHTML = dmsHtml || '<div class="text-center" style="padding: var(--spacing-md); color: var(--text-muted);">No messages yet</div>';
        }

        // Update friend requests
        function updateFriendRequests() {
            const requestsTab = document.getElementById('requestsTab');
            
            if (!requestsTab) return;
            
            let requestsHtml = '';
            
            friendRequests.forEach(request => {
                requestsHtml += `
                    <div class="friend-item">
                        <div class="friend-info">
                            <div class="user-avatar" style="width: 32px; height: 32px; font-size: 12px;">
                                ${request.fromUserName.charAt(0)}
                                <div class="status-indicator status-online"></div>
                            </div>
                            <div>
                                <div class="dm-name">${request.fromUserName}</div>
                                <div class="dm-preview">Wants to be your friend</div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="acceptFriendRequest('${request.id}')">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="declineFriendRequest('${request.id}')">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                `;
            });
            
            requestsTab.innerHTML = requestsHtml || '<div class="text-center" style="padding: var(--spacing-md); color: var(--text-muted);">No friend requests</div>';
        }

        // Update notifications
        function updateNotifications() {
            const notificationsTab = document.getElementById('notificationsTab');
            
            if (!notificationsTab) return;
            
            let notificationsHtml = '';
            
            notifications.forEach(notification => {
                notificationsHtml += `
                    <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="handleNotification('${notification.id}')">
                        <div class="notification-content">
                            ${notification.message}
                        </div>
                        <div class="notification-time">${getTimeAgo(notification.timestamp.toDate())}</div>
                    </div>
                `;
            });
            
            notificationsTab.innerHTML = notificationsHtml || '<div class="text-center" style="padding: var(--spacing-md); color: var(--text-muted);">No notifications</div>';
        }

        // Update live stats
        function updateLiveStats(stats) {
            document.getElementById('onlineUsers').textContent = formatNumber(stats.onlineUsers || 0);
            document.getElementById('activeChats').textContent = formatNumber(stats.activeChats || 0);
            document.getElementById('activePolls').textContent = formatNumber(stats.activePolls || 0);
            document.getElementById('postsToday').textContent = formatNumber(stats.postsToday || 0);
            document.getElementById('totalCommunities').textContent = formatNumber(stats.totalCommunities || 0);
        }

        // Update trending channels
        function updateTrendingChannels() {
            const trendingChannels = document.getElementById('trendingChannels');
            
            if (!trendingChannels) return;
            
            let channelsHtml = '';
            
            // Get top 5 communities by member count
            const topCommunities = [...communities]
                .sort((a, b) => b.memberCount - a.memberCount)
                .slice(0, 5);
            
            topCommunities.forEach(community => {
                channelsHtml += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-sm); background: var(--surface-color); border-radius: var(--radius-md); cursor: pointer;" onclick="joinChannel('${community.name}')">
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <i class="fas fa-hashtag" style="color: var(--primary-color);"></i>
                            <span style="font-weight: 500;">${community.name}</span>
                        </div>
                        <span style="color: var(--success-color); font-size: var(--font-size-xs);">${formatNumber(community.memberCount)} members</span>
                    </div>
                `;
            });
            
            trendingChannels.innerHTML = channelsHtml || '<div class="text-center" style="padding: var(--spacing-md); color: var(--text-muted);">No communities yet</div>';
        }

        // Update online users
        function updateOnlineUsers(users) {
            onlineUsers = new Set(users.map(user => user.uid));
            
            // Update online friends list
            updateFriendsList();
        }

        // Add message to chat
        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chat-messages');
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.senderId === currentUser.uid ? 'user' : ''}`;
            
            messageElement.innerHTML = `
                <div class="message-user">
                    ${message.senderId === currentUser.uid ? '<span class="premium-badge" style="margin-right: 5px;"><i class="fas fa-crown"></i></span>' : ''}
                    ${message.senderName}
                </div>
                <div class="message-text">${message.text}</div>
                <div class="message-time">${getTimeAgo(message.timestamp.toDate())}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes}m ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours}h ago`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days}d ago`;
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = message;
            
            // Add style based on type
            switch (type) {
                case 'success':
                    notification.style.background = 'var(--success-color)';
                    break;
                case 'error':
                    notification.style.background = 'var(--error-color)';
                    break;
                case 'warning':
                    notification.style.background = 'var(--warning-color)';
                    break;
                default:
                    notification.style.background = 'var(--primary-color)';
            }
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            if (userMenu.style.display === 'block') {
                userMenu.style.display = 'none';
            } else {
                userMenu.style.display = 'block';
            }
        }

        function toggleDMPanel() {
            const dmPanel = document.getElementById('dmPanel');
            dmPanel.classList.toggle('active');
        }

        function toggleFriendsPanel() {
            const friendsPanel = document.getElementById('friendsPanel');
            friendsPanel.classList.toggle('active');
        }

        function toggleNotificationsPanel() {
            const notificationsPanel = document.getElementById('notificationsPanel');
            notificationsPanel.classList.toggle('active');
        }

        function switchToConversation(conversationId) {
            // Implementation for switching to a specific conversation
            console.log("Switching to conversation:", conversationId);
        }

        function joinChannel(channelName) {
            currentChannel = channelName;
            document.getElementById('currentChannelName').textContent = channelName;
            document.getElementById('chat-container').classList.add('active');
            
            // Reattach listener for the new channel
            const messagesUnsubscribe = db.collection('messages')
                .where('channel', '==', channelName)
                .orderBy('timestamp', 'desc')
                .limit(CONFIG.MAX_CHAT_MESSAGES)
                .onSnapshot(snapshot => {
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        addMessageToChat(doc.data());
                    });
                });
            
            // Replace the messages unsubscribe function
            const index = unsubscribeFunctions.findIndex(fn => fn.name === 'messagesUnsubscribe');
            if (index !== -1) {
                unsubscribeFunctions[index]();
                unsubscribeFunctions[index] = messagesUnsubscribe;
            }
        }

        function startCall(userId, isVideo) {
            showNotification(`${isVideo ? 'Video' : 'Voice'} call started with user`, 'info');
        }

        function blockUser(userId) {
            showNotification('User blocked', 'info');
        }

        function removeFriend(userId) {
            showNotification('Friend removed', 'info');
        }

        function acceptFriendRequest(requestId) {
            showNotification('Friend request accepted', 'success');
        }

        function declineFriendRequest(requestId) {
            showNotification('Friend request declined', 'info');
        }

        function handleNotification(notificationId) {
            showNotification('Notification handled', 'info');
        }

        function goToProfile() {
            showNotification('Profile page would open here', 'info');
        }

        function goToSettings() {
            showNotification('Settings page would open here', 'info');
        }

        // Initialize all functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set up Firebase auth state listener
            // Already set up at the top of the script
            
            // Set up event listeners for forms
            document.getElementById('registrationForm')?.addEventListener('submit', handleRegistrationSubmit);
            document.getElementById('createPostForm')?.addEventListener('submit', handleCreatePostSubmit);
            document.getElementById('createCommunityForm')?.addEventListener('submit', handleCreateCommunitySubmit);
            
            // Set up other event listeners
            document.getElementById('premiumBtn')?.addEventListener('click', upgradeToPremium);
            document.getElementById('dmToggle')?.addEventListener('click', toggleDMPanel);
            document.getElementById('friendsToggle')?.addEventListener('click', toggleFriendsPanel);
            document.getElementById('notificationBtn')?.addEventListener('click', toggleNotificationsPanel);
            document.getElementById('closeDmPanel')?.addEventListener('click', toggleDMPanel);
            document.getElementById('closeFriendsPanel')?.addEventListener('click', toggleFriendsPanel);
            document.getElementById('closeNotificationsPanel')?.addEventListener('click', toggleNotificationsPanel);
            document.getElementById('chat-close-btn')?.addEventListener('click', () => {
                document.getElementById('chat-container').classList.remove('active');
            });
            document.getElementById('chat-send-btn')?.addEventListener('click', () => {
                const input = document.getElementById('chat-input');
                if (input.value.trim()) {
                    // In a real app, this would send the message to the current channel
                    addMessageToChat({
                        senderId: currentUser?.uid || 'unknown',
                        senderName: currentUser?.fullName || 'You',
                        text: input.value,
                        timestamp: new Date()
                    });
                    input.value = '';
                }
            });
            document.getElementById('createPostInput')?.addEventListener('click', () => {
                showModal('create-post-modal');
            });
            document.getElementById('createCommunityBtn')?.addEventListener('click', () => {
                showModal('create-community-modal');
            });
            document.getElementById('browseCommunityBtn')?.addEventListener('click', () => {
                showNotification('Community browser would open here', 'info');
            });
            document.getElementById('loadMoreBtn')?.addEventListener('click', () => {
                showNotification('Loading more posts...', 'info');
            });
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal, .overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal(modal.id);
                    }
                });
            });
            
            // Close modals with close buttons
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', () => {
                    const modal = button.closest('.modal, .overlay');
                    if (modal) {
                        hideModal(modal.id);
                    }
                });
            });
            
            // Tab switching
            document.querySelectorAll('.dm-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Update active tab
                    document.querySelectorAll('.dm-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show appropriate content
                    document.querySelectorAll('.dm-list, .channel-list').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    document.getElementById(`${tabName}Tab`).classList.remove('hidden');
                });
            });
            
            // Feed switching
            document.querySelectorAll('.feed-option').forEach(option => {
                option.addEventListener('click', () => {
                    const feed = option.dataset.feed;
                    
                    // Update active feed
                    document.querySelectorAll('.feed-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    
                    // Show appropriate feed content
                    showNotification(`Showing ${feed} feed`, 'info');
                });
            });
            
            // Post type switching
            document.getElementById('postType')?.addEventListener('change', (e) => {
                const postType = e.target.value;
                const contentContainer = document.getElementById('contentContainer');
                const pollContainer = document.getElementById('pollOptionsContainer');
                const mediaContainer = document.getElementById('mediaUploadContainer');
                const liveChatContainer = document.getElementById('liveChatContainer');
                
                // Reset visibility
                contentContainer.classList.remove('hidden');
                pollContainer.classList.add('hidden');
                mediaContainer.classList.remove('hidden');
                liveChatContainer.classList.add('hidden');
                
                if (postType === 'poll') {
                    pollContainer.classList.remove('hidden');
                    mediaContainer.classList.add('hidden');
                } else if (postType === 'live-chat') {
                    liveChatContainer.classList.remove('hidden');
                    mediaContainer.classList.add('hidden');
                }
            });
            
            // Add poll option
            document.getElementById('addPollOption')?.addEventListener('click', () => {
                const pollOptions = document.getElementById('pollOptions');
                const optionCount = pollOptions.querySelectorAll('.poll-option-input').length;
                
                if (optionCount >= CONFIG.MAX_POLL_OPTIONS) {
                    showNotification(`Maximum ${CONFIG.MAX_POLL_OPTIONS} options allowed`, 'warning');
                    return;
                }
                
                const newOption = document.createElement('input');
                newOption.type = 'text';
                newOption.className = 'form-control poll-option-input';
                newOption.placeholder = `Option ${optionCount + 1}`;
                newOption.style.marginBottom = 'var(--spacing-sm)';
                
                pollOptions.appendChild(newOption);
            });
            
            // Theme toggle
            document.getElementById('themeToggle')?.addEventListener('click', () => {
                const isDark = document.documentElement.style.getPropertyValue('--background-color') === '#000000';
                
                if (isDark) {
                    // Switch to light theme
                    document.documentElement.style.setProperty('--background-color', '#ffffff');
                    document.documentElement.style.setProperty('--surface-color', '#f8f9fa');
                    document.documentElement.style.setProperty('--surface-secondary', '#e9ecef');
                    document.documentElement.style.setProperty('--text-primary', '#212529');
                    document.documentElement.style.setProperty('--text-secondary', '#495057');
                    document.documentElement.style.setProperty('--text-muted', '#6c757d');
                    document.documentElement.style.setProperty('--border-color', '#dee2e6');
                    
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    // Switch to dark theme
                    document.documentElement.style.setProperty('--background-color', '#000000');
                    document.documentElement.style.setProperty('--surface-color', '#1a1a1a');
                    document.documentElement.style.setProperty('--surface-secondary', '#2a2a2a');
                    document.documentElement.style.setProperty('--text-primary', '#ffffff');
                    document.documentElement.style.setProperty('--text-secondary', '#cccccc');
                    document.documentElement.style.setProperty('--text-muted', '#666666');
                    document.documentElement.style.setProperty('--border-color', '#404040');
                    
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
                }
            });
            
            // Mobile navigation
            document.getElementById('mobileCreatePost')?.addEventListener('click', (e) => {
                e.preventDefault();
                showModal('create-post-modal');
            });
            
            document.getElementById('mobileDmToggle')?.addEventListener('click', (e) => {
                e.preventDefault();
                toggleDMPanel();
            });
            
            document.getElementById('mobileChatToggle')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('chat-container').classList.toggle('active');
            });
            
            // Profile image upload
            document.getElementById('profileImageInput')?.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        document.getElementById('profilePreview').innerHTML = `
                            <img src="${event.target.result}" alt="Profile preview">
                            <div class="profile-upload-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        `;
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Media upload
            document.getElementById('mediaUploadArea')?.addEventListener('click', () => {
                document.getElementById('mediaInput').click();
            });
            
            document.getElementById('mediaInput')?.addEventListener('change', (e) => {
                const files = e.target.files;
                const container = document.getElementById('mediaPreviewContainer');
                container.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        const item = document.createElement('div');
                        item.className = 'media-preview-item';
                        
                        if (file.type.startsWith('image/')) {
                            item.innerHTML = `
                                <img src="${event.target.result}" alt="Preview">
                                <button class="media-remove-btn" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        } else if (file.type.startsWith('video/')) {
                            item.innerHTML = `
                                <video src="${event.target.result}" muted></video>
                                <button class="media-remove-btn" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        }
                        
                        container.appendChild(item);
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Initialize with some sample data for demonstration
            setTimeout(() => {
                // Simulate loading of some initial data
                if (!currentUser) {
                    updateLiveStats({
                        onlineUsers: 127543,
                        activeChats: 2847,
                        activePolls: 1247,
                        postsToday: 45678,
                        totalCommunities: 8934
                    });
                    
                    // Add some sample posts for demonstration
                    const samplePosts = [
                        {
                            title: "Welcome to Smile Xplore!",
                            content: "This is a sample post to demonstrate the platform. In a real application, you would see posts from other users here.",
                            authorName: "Smile Xplore Team",
                            authorUsername: "smilexplore",
                            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000),
                            community: "general",
                            votes: 42,
                            comments: 7,
                            type: "text",
                            isLive: false,
                            expiresAt: new Date(Date.now() + 89 * 24 * 60 * 60 * 1000)
                        },
                        {
                            title: "What's your favorite feature?",
                            content: "Let us know what you think about the platform so far!",
                            authorName: "Community Manager",
                            authorUsername: "cmgr",
                            timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000),
                            community: "feedback",
                            votes: 18,
                            comments: 3,
                            type: "text",
                            isLive: false,
                            expiresAt: new Date(Date.now() + 89 * 24 * 60 * 60 * 1000),
                            options: [
                                { text: "Real-time chat", votes: 12 },
                                { text: "Community features", votes: 8 },
                                { text: "User profiles", votes: 5 }
                            ]
                        }
                    ];
                    
                    samplePosts.forEach((post, index) => {
                        setTimeout(() => {
                            addPostToFeed(post, `sample-${index}`);
                        }, index * 500);
                    });
                }
            }, 2000);
            
            console.log('Smile Xplore platform initialized');
        });
    </script>
</body>
</html>