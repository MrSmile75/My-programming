<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 Story Hub - Premium Reading Experience</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
    :root {
        --primary-color: #6a11cb;
        --secondary-color: #2575fc;
        --accent-color: #ff6b6b;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --error-color: #dc3545;
        --dark-bg: #0a0a0a;
        --card-bg: #1a1a1a;
        --text-primary: #ffffff;
        --text-secondary: #b3b3b3;
        --border-radius: 15px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --shadow: 0 10px 30px rgba(0,0,0,0.3);
        --premium-gold: #ffd700;
        --premium-gradient: linear-gradient(135deg, #ffd700, #ff8c00, #ff4500);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1a2e 50%, #16213e 100%);
        color: var(--text-primary);
        font-family: 'Orbitron', sans-serif;
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--dark-bg);
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
    }

    /* Header Styles */
    .cosmic-header {
        position: relative;
        background: linear-gradient(135deg, var(--dark-bg) 0%, var(--primary-color) 100%);
        padding: 2rem 0;
        overflow: hidden;
        box-shadow: var(--shadow);
    }

    .star-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }

    .star {
        position: absolute;
        background: rgba(255,255,255,0.8);
        border-radius: 50%;
        animation: moveRight linear infinite, twinkle 2s infinite alternate;
    }

    @keyframes moveRight {
        from { transform: translateX(-10px); }
        to { transform: translateX(100vw); }
    }

    @keyframes twinkle {
        0% { opacity: 0.3; }
        100% { opacity: 1; }
    }

    .header-content {
        position: relative;
        z-index: 10;
    }

    .logo-text {
        font-family: 'Orbitron', sans-serif;
        font-weight: 700;
        background: linear-gradient(45deg, var(--secondary-color), #fff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 30px rgba(37, 117, 252, 0.5);
    }

    .search-container {
        position: relative;
    }

    .search-input {
        background: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.2);
        color: var(--text-primary);
        border-radius: 25px;
        padding: 12px 50px 12px 20px;
        transition: var(--transition);
        backdrop-filter: blur(10px);
    }

    .search-input:focus {
        background: rgba(255,255,255,0.15);
        border-color: var(--secondary-color);
        box-shadow: 0 0 20px rgba(37, 117, 252, 0.3);
        color: var(--text-primary);
    }

    .search-input::placeholder {
        color: var(--text-secondary);
    }

    .search-btn {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--secondary-color);
        font-size: 18px;
        cursor: pointer;
        transition: var(--transition);
    }

    .search-btn:hover {
        transform: translateY(-50%) scale(1.1);
        color: var(--primary-color);
    }

    /* Status Indicators */
    .status-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: var(--transition);
    }

    .status-indicator.show {
        opacity: 1;
        transform: translateX(0);
    }

    .status-indicator.warning {
        background: var(--warning-color);
    }

    .status-indicator.error {
        background: var(--error-color);
    }

    /* Book Counter */
    .book-counter {
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--card-bg);
        color: var(--text-primary);
        padding: 10px 20px;
        border-radius: 25px;
        border: 2px solid var(--secondary-color);
        font-size: 14px;
        z-index: 1000;
    }

    /* API Source Indicators */
    .api-sources {
        position: fixed;
        top: 130px;
        right: 20px;
        background: var(--card-bg);
        border: 2px solid var(--secondary-color);
        border-radius: 15px;
        padding: 15px;
        z-index: 1000;
        min-width: 200px;
    }

    .api-source {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 12px;
    }

    .api-source:last-child {
        margin-bottom: 0;
    }

    .api-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .api-status.active {
        background: var(--success-color);
        box-shadow: 0 0 10px var(--success-color);
    }

    .api-status.loading {
        background: var(--warning-color);
        animation: pulse 1s infinite;
    }

    .api-status.error {
        background: var(--error-color);
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Auto-load indicator */
    .auto-load-indicator {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card-bg);
        color: var(--text-primary);
        padding: 15px 25px;
        border-radius: 25px;
        border: 2px solid var(--secondary-color);
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 10px;
    }

    .auto-load-indicator.show {
        display: flex;
    }

    .auto-load-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(37, 117, 252, 0.3);
        border-top: 2px solid var(--secondary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* Story Cards */
    .story-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        overflow: hidden;
        transition: var(--transition);
        border: 2px solid transparent;
        cursor: pointer;
        height: 100%;
        position: relative;
    }

    .story-card:hover {
        transform: translateY(-10px) scale(1.02);
        border-color: var(--secondary-color);
        box-shadow: 0 20px 40px rgba(37, 117, 252, 0.2);
    }

    .story-card-img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        transition: var(--transition);
    }

    .story-card:hover .story-card-img {
        transform: scale(1.05);
    }

    .story-card-body {
        padding: 20px;
    }

    .story-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-primary);
        line-height: 1.4;
        height: 40px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .story-author {
        color: var(--text-secondary);
        font-size: 13px;
        margin-bottom: 10px;
    }

    .story-description-container {
        max-height: 120px;
        overflow-y: auto;
        margin-bottom: 15px;
        padding-right: 5px;
    }

    .story-description {
        color: var(--text-secondary);
        font-size: 13px;
        line-height: 1.4;
        margin: 0;
    }

    .story-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-size: 11px;
        color: var(--text-secondary);
    }

    .story-genre {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
    }

    .api-badge {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 9px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .embed-status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        z-index: 10;
    }

    .embed-available {
        background: var(--success-color);
        color: white;
    }

    .embed-unavailable {
        background: var(--error-color);
        color: white;
    }

    .embed-checking {
        background: var(--warning-color);
        color: white;
        animation: pulse 1s infinite;
    }

    .story-actions {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
    }

    .preview-btn {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .preview-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .read-btn {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
    }

    .read-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
    }

    .read-btn:disabled {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
        cursor: not-allowed;
        opacity: 0.5;
    }

    .read-btn:disabled:hover {
        transform: none;
        box-shadow: none;
    }

    /* Read Options Modal */
    .read-options-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
    }

    .read-options-modal-overlay.show {
        display: flex;
    }

    .read-options-modal {
        background: var(--card-bg);
        width: 90%;
        max-width: 500px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 2px solid var(--secondary-color);
        overflow: hidden;
        animation: modalFadeIn 0.3s ease forwards;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .read-options-header {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .read-options-title {
        color: white;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }

    .close-modal {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        transition: var(--transition);
        padding: 5px;
    }

    .close-modal:hover {
        transform: scale(1.1);
        color: var(--accent-color);
    }

    .read-options-body {
        padding: 25px;
    }

    .read-option-btn {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 20px;
        margin-bottom: 15px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: var(--text-primary);
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
    }

    .read-option-btn:last-child {
        margin-bottom: 0;
    }

    .read-option-btn:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-3px);
        border-color: var(--secondary-color);
        box-shadow: 0 10px 25px rgba(37, 117, 252, 0.2);
    }

    .read-option-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: rgba(255, 255, 255, 0.02);
    }

    .read-option-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        border-radius: 50%;
        margin-right: 20px;
        color: white;
        font-size: 20px;
        flex-shrink: 0;
    }

    .read-option-text {
        flex: 1;
    }

    .read-option-title {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 16px;
    }

    .read-option-desc {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.4;
    }

    /* Embed Reader */
    .embed-reader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--dark-bg);
        z-index: 10000;
    }

    .embed-reader.active {
        display: block;
    }

    .embed-header {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .embed-title {
        color: white;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }

    .embed-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        transition: var(--transition);
        padding: 5px;
    }

    .embed-close:hover {
        transform: scale(1.1);
        color: var(--accent-color);
    }

    .embed-content {
        height: calc(100vh - 70px);
        width: 100%;
    }

    .embed-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }

    /* Story Reading Page */
    .story-reading-page {
        display: none;
        min-height: 100vh;
        background: var(--dark-bg);
        padding: 20px 0;
    }

    .story-reading-page.active {
        display: block;
    }

    .story-reading-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        padding: 30px 0;
        margin-bottom: 30px;
        border-radius: var(--border-radius);
    }

    .story-cover-section {
        display: flex;
        gap: 30px;
        align-items: flex-start;
        margin-bottom: 30px;
    }

    .story-cover-image {
        width: 200px;
        height: 300px;
        object-fit: cover;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .story-info {
        flex: 1;
    }

    .story-reading-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        color: white;
    }

    .story-reading-author {
        font-size: 1.2rem;
        color: rgba(255,255,255,0.8);
        margin-bottom: 15px;
    }

    .story-reading-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .meta-item {
        background: rgba(255,255,255,0.1);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        color: white;
    }

    .story-reading-description {
        background: var(--card-bg);
        padding: 25px;
        border-radius: var(--border-radius);
        margin-bottom: 30px;
        border: 2px solid rgba(255,255,255,0.1);
    }

    .story-content-section {
        background: var(--card-bg);
        padding: 30px;
        border-radius: var(--border-radius);
        border: 2px solid rgba(255,255,255,0.1);
        line-height: 1.8;
    }

    .chapter {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .chapter:last-child {
        border-bottom: none;
    }

    .chapter h3 {
        color: var(--secondary-color);
        margin-bottom: 15px;
        font-size: 1.3rem;
    }

    .chapter p {
        margin-bottom: 15px;
        text-align: justify;
    }

    .back-to-stories {
        background: linear-gradient(45deg, var(--accent-color), var(--primary-color));
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        margin-bottom: 20px;
    }

    .back-to-stories:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    /* Loading States */
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        flex-direction: column;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(37, 117, 252, 0.3);
        border-top: 3px solid var(--secondary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        color: var(--text-secondary);
        font-size: 16px;
    }

    /* Search Results Info */
    .search-info {
        text-align: center;
        margin: 20px 0;
        color: var(--text-secondary);
    }

    .search-info.active {
        color: var(--secondary-color);
        font-weight: 600;
    }

    /* No Results */
    .no-results {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .no-results i {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    /* Premium Features */
    .premium-badge {
        background: var(--premium-gradient);
        color: black;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: bold;
        margin-left: 5px;
    }

    .premium-feature {
        position: relative;
        border: 2px solid var(--premium-gold);
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    .premium-feature::before {
        content: "PREMIUM";
        position: absolute;
        top: -10px;
        right: 10px;
        background: var(--premium-gradient);
        color: black;
        padding: 2px 8px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: bold;
        z-index: 10;
    }

    .user-menu {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 0 10px rgba(37, 117, 252, 0.5);
    }

    .user-avatar:hover {
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(37, 117, 252, 0.8);
    }

    .user-dropdown {
        position: absolute;
        top: 50px;
        left: 0;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 15px;
        min-width: 250px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: none;
        z-index: 1000;
    }

    .user-dropdown.show {
        display: block;
    }

    .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-info-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 15px;
        font-size: 18px;
    }

    .user-details {
        flex: 1;
    }

    .user-name {
        font-weight: 600;
        margin-bottom: 3px;
    }

    .user-status {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .premium-status {
        background: var(--premium-gradient);
        color: black;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
    }

    .user-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }

    .stat-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 10px;
        border-radius: 8px;
        text-align: center;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 3px;
    }

    .stat-label {
        font-size: 11px;
        color: var(--text-secondary);
    }

    .user-menu-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .menu-action {
        background: rgba(255, 255, 255, 0.05);
        border: none;
        color: var(--text-primary);
        padding: 10px 15px;
        border-radius: 8px;
        text-align: left;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .menu-action:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .menu-action i {
        width: 20px;
    }

    .upgrade-btn {
        background: var(--premium-gradient);
        color: black;
        font-weight: 600;
    }

    .upgrade-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
    }

    /* Premium Modal */
    .premium-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
    }

    .premium-modal.show {
        display: flex;
    }

    .premium-modal-content {
        background: var(--card-bg);
        width: 90%;
        max-width: 800px;
        border-radius: var(--border-radius);
        box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        border: 2px solid var(--premium-gold);
        overflow: hidden;
        animation: modalFadeIn 0.5s ease forwards;
    }

    .premium-modal-header {
        background: var(--premium-gradient);
        padding: 25px;
        text-align: center;
        position: relative;
    }

    .premium-modal-title {
        color: black;
        font-size: 28px;
        font-weight: 700;
        margin: 0;
    }

    .premium-modal-subtitle {
        color: rgba(0, 0, 0, 0.8);
        font-size: 16px;
        margin-top: 10px;
    }

    .premium-modal-body {
        padding: 30px;
    }

    .premium-features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .premium-feature-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(255, 215, 0, 0.3);
    }

    .premium-feature-icon {
        width: 50px;
        height: 50px;
        background: var(--premium-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        font-size: 20px;
        color: black;
    }

    .premium-feature-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--premium-gold);
    }

    .premium-feature-desc {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    .premium-cta {
        text-align: center;
        padding: 20px;
        background: rgba(255, 215, 0, 0.1);
        border-radius: 12px;
    }

    .premium-price {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 10px;
        background: var(--premium-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .premium-price-desc {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 20px;
    }

    .purchase-btn {
        background: var(--premium-gradient);
        color: black;
        border: none;
        padding: 15px 40px;
        border-radius: 30px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .purchase-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
    }

    .premium-modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: black;
        font-size: 24px;
        cursor: pointer;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .cosmic-header {
            text-align: center;
            padding: 1.5rem 0;
        }

        .search-container {
            margin-top: 1rem;
        }

        .search-input {
            width: 100%;
        }

        .book-counter {
            top: 70px;
            right: 10px;
            padding: 8px 15px;
            font-size: 12px;
        }

        .api-sources {
            top: 110px;
            right: 10px;
            padding: 10px;
            min-width: 150px;
        }

        .story-cover-section {
            flex-direction: column;
            text-align: center;
        }

        .story-cover-image {
            width: 150px;
            height: 225px;
            margin: 0 auto;
        }

        .story-reading-title {
            font-size: 2rem;
        }

        .story-reading-meta {
            flex-direction: column;
            gap: 10px;
        }

        .read-options-modal {
            width: 95%;
            margin: 20px;
        }

        .read-option-btn {
            padding: 15px;
        }

        .read-option-icon {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            font-size: 18px;
        }

        .premium-features-grid {
            grid-template-columns: 1fr;
        }

        .user-dropdown {
            min-width: 200px;
        }

        .user-stats {
            grid-template-columns: 1fr;
        }
    }

    /* Animation Classes */
    .fade-in {
        animation: fadeIn 0.6s ease forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    </style>
</head>
<body>
    <!-- Status Indicator -->
    <div id="status-indicator" class="status-indicator">
        <i class="fas fa-check"></i> Loading books...
    </div>

    <!-- Book Counter -->
    <div id="book-counter" class="book-counter">
        <i class="fas fa-book"></i> <span id="book-count">0</span> books loaded
    </div>

    <!-- API Sources Status -->
    <div id="api-sources" class="api-sources">
        <div class="api-source">
            <div class="api-status" id="openlibrary-status"></div>
            <span>Open Library</span>
        </div>
        <div class="api-source">
            <div class="api-status" id="internetarchive-status"></div>
            <span>Internet Archive</span>
        </div>
        <div class="api-source">
            <div class="api-status" id="gutenberg-status"></div>
            <span>Project Gutenberg</span>
        </div>
    </div>

    <!-- Auto-load Indicator -->
    <div id="auto-load-indicator" class="auto-load-indicator">
        <div class="auto-load-spinner"></div>
        <span>Loading more books...</span>
    </div>

    <!-- Read Options Modal -->
    <div id="read-options-modal-overlay" class="read-options-modal-overlay">
        <div class="read-options-modal">
            <div class="read-options-header">
                <h3 class="read-options-title" id="read-options-story-title">Choose Reading Option</h3>
                <button class="close-modal" id="close-read-options">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="read-options-body">
                <button class="read-option-btn" id="read-embed-btn" style="display: none;">
                    <div class="read-option-icon">
                        <i class="fas fa-book-reader"></i>
                    </div>
                    <div class="read-option-text">
                        <div class="read-option-title">Read with Embed</div>
                        <div class="read-option-desc">Read using Open Library's embedded reader for the best experience</div>
                    </div>
                </button>
                <button class="read-option-btn" id="read-source-btn">
                    <div class="read-option-icon">
                        <i class="fas fa-external-link-alt"></i>
                    </div>
                    <div class="read-option-text">
                        <div class="read-option-title">Read from Source</div>
                        <div class="read-option-desc">Open the original source website in a new tab</div>
                    </div>
                </button>
                <button class="read-option-btn" id="read-web-btn">
                    <div class="read-option-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="read-option-text">
                        <div class="read-option-title">See on Web</div>
                        <div class="read-option-desc">See about story content here</div>
                    </div>
                </button>
                <button class="read-option-btn" id="read-archive-btn">
                    <div class="read-option-icon">
                        <i class="fas fa-archive"></i>
                    </div>
                    <div class="read-option-text">
                        <div class="read-option-title">Internet Archive</div>
                        <div class="read-option-desc">Access scanned pages and digital collections</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Embed Reader -->
    <div id="embed-reader" class="embed-reader">
        <div class="embed-header">
            <h3 class="embed-title" id="embed-reader-title">Reading...</h3>
            <button class="embed-close" id="embed-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="embed-content">
            <iframe id="embed-iframe" class="embed-iframe" src=""></iframe>
        </div>
    </div>

    <!-- User Menu -->
    <div class="user-menu">
        <div class="user-avatar" id="user-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="user-dropdown" id="user-dropdown">
            <div class="user-info">
                <div class="user-info-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="user-name">Guest User</div>
                    <div class="user-status">
                        <span id="user-status-text">Free Account</span>
                        <span class="premium-status" id="premium-status" style="display: none;">PREMIUM</span>
                    </div>
                </div>
            </div>
            
            <div class="user-stats" id="user-stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="stat-pages">0</div>
                    <div class="stat-label">Pages Read</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-streak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-goal">0%</div>
                    <div class="stat-label">Goal Progress</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-badges">0</div>
                    <div class="stat-label">Badges</div>
                </div>
            </div>
            
            <div class="user-menu-actions">
                <button class="menu-action" id="my-library-btn">
                    <i class="fas fa-bookmark"></i> My Library
                </button>
                <button class="menu-action" id="my-notes-btn">
                    <i class="fas fa-sticky-note"></i> My Notes
                </button>
                <button class="menu-action" id="reading-stats-btn">
                    <i class="fas fa-chart-line"></i> Reading Stats
                </button>
                <button class="menu-action" id="premium-features-btn">
                    <i class="fas fa-crown"></i> Premium Features
                </button>
                <button class="menu-action upgrade-btn" id="upgrade-btn">
                    <i class="fas fa-gem"></i> Upgrade to Premium
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Modal -->
    <div class="premium-modal" id="premium-modal">
        <div class="premium-modal-content">
            <div class="premium-modal-header">
                <h2 class="premium-modal-title">Unlock Premium Reading Experience</h2>
                <p class="premium-modal-subtitle">Get access to all premium features for 30 days</p>
                <button class="premium-modal-close" id="premium-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="premium-modal-body">
                <div class="premium-features-grid">
                    <div class="premium-feature-item">
                        <div class="premium-feature-icon">
                            <i class="fas fa-infinity"></i>
                        </div>
                        <h3 class="premium-feature-title">Unlimited Access</h3>
                        <p class="premium-feature-desc">Read unlimited books with continuous loading and no restrictions</p>
                    </div>
                    
                    <div class="premium-feature-item">
                        <div class="premium-feature-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h3 class="premium-feature-title">Advanced Statistics</h3>
                        <p class="premium-feature-desc">Track pages read, reading streaks, and get personalized reading goals</p>
                    </div>
                    
                    <div class="premium-feature-item">
                        <div class="premium-feature-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3 class="premium-feature-title">AI Recommendations</h3>
                        <p class="premium-feature-desc">Get personalized book recommendations based on your reading preferences</p>
                    </div>
                    
                    <div class="premium-feature-item">
                        <div class="premium-feature-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <h3 class="premium-feature-title">Enhanced Library</h3>
                        <p class="premium-feature-desc">Create unlimited collections, export lists, and get AI summaries</p>
                    </div>
                    
                    <div class="premium-feature-item">
                        <div class="premium-feature-icon">
                            <i class="fas fa-pen-fancy"></i>
                        </div>
                        <h3 class="premium-feature-title">Smart Notes</h3>
                        <p class="premium-feature-desc">AI-generated chapter summaries, discussion questions, and advanced note-taking</p>
                    </div>
                    
                    <div class="premium-feature-item">
                        <div class="premium-feature-icon">
                            <i class="fas fa-library"></i>
                        </div>
                        <h3 class="premium-feature-title">Library Integration</h3>
                        <p class="premium-feature-desc">Find books at nearby libraries and get availability alerts</p>
                    </div>
                </div>
                
                <div class="premium-cta">
                    <div class="premium-price">$9.99</div>
                    <div class="premium-price-desc">One-time payment for 30 days of premium access</div>
                    <button class="purchase-btn" id="purchase-premium-btn">
                        Get Premium
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Stories Page -->
    <div id="main-page">
        <!-- Header -->
        <header class="cosmic-header">
            <div class="star-background" id="starField"></div>
            <div class="container header-content">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-5">
                            <span class="logo-text">📚 STORY HUB</span>
                        </h1>
                        <p class="lead text-white-50">
                            Discover and explore narratives and stories.
                        </p>
                    </div>
                    <div class="col-md-4 search-container">
                        <div class="position-relative">
                            <input 
                                type="text" 
                                id="searchInput" 
                                class="form-control search-input" 
                                placeholder="Search exact titles, authors, topics..."
                            >
                            <button id="searchButton" class="search-btn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mt-5">
            <!-- Search Info -->
            <div id="search-info" class="search-info">
                Loading books from source...
            </div>

            <div class="row" id="storiesContainer">
                <!-- Books will be loaded here -->
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-container" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading more books...</div>
            </div>
        </div>
    </div>

    <!-- Story Reading Page -->
    <div id="story-reading-page" class="story-reading-page">
        <div class="container">
            <button class="back-to-stories" onclick="storyHub.backToStories()">
                <i class="fas fa-arrow-left"></i> Back to Books
            </button>

            <div class="story-reading-header">
                <div class="story-cover-section">
                    <img id="reading-cover" class="story-cover-image" src="/placeholder.svg?height=300&width=200" alt="Book Cover">
                    <div class="story-info">
                        <h1 id="reading-title" class="story-reading-title">Book Title</h1>
                        <p id="reading-author" class="story-reading-author">by Author Name</p>
                        <div class="story-reading-meta">
                            <span id="reading-genre" class="meta-item">Genre</span>
                            <span id="reading-year" class="meta-item">Year</span>
                            <span id="reading-source" class="meta-item">Source</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="story-reading-description">
                <h3><i class="fas fa-info-circle"></i> Description</h3>
                <p id="reading-description">Book description will appear here...</p>
            </div>

            <div class="story-content-section">
                <h3><i class="fas fa-book-open"></i> Content</h3>
                <div id="reading-content">
                    <!-- Book content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class SmartStoryHub {
            constructor() {
                // Configuration
                this.CACHE_DURATION = 30 * 60 * 1000; // 30 minutes
                this.REQUEST_DELAY = 800; // 800ms between requests
                this.MAX_RETRIES = 3;
                this.AUTO_LOAD_INTERVAL = 4000; // Load new books every 4 seconds
                this.BOOKS_PER_LOAD = 15; // Number of books to load per batch
                
                // API Configuration
                this.APIs = {
                    openLibrary: {
                        name: 'Open Library',
                        searchUrl: 'https://openlibrary.org/search.json',
                        worksUrl: 'https://openlibrary.org/works',
                        editionsUrl: 'https://openlibrary.org/works',
                        embedUrl: 'https://openlibrary.org/embed',
                        transform: this.transformOpenLibraryBook.bind(this),
                        status: 'ready',
                        currentPage: 1
                    },
                    internetArchive: {
                        name: 'Internet Archive',
                        searchUrl: 'https://archive.org/advancedsearch.php',
                        transform: this.transformInternetArchiveBook.bind(this),
                        status: 'ready',
                        currentPage: 1
                    },
                    gutenberg: {
                        name: 'Project Gutenberg',
                        searchUrl: 'https://gutendex.com/books',
                        transform: this.transformGutenbergBook.bind(this),
                        status: 'ready',
                        currentPage: 1
                    }
                };
                
                // Popular search topics for infinite loading
                this.searchTopics = [
                    'fiction', 'adventure', 'mystery', 'romance', 'fantasy', 'science',
                    'history', 'biography', 'drama', 'comedy', 'thriller', 'horror',
                    'poetry', 'philosophy', 'art', 'music', 'travel', 'nature',
                    'technology', 'space', 'ocean', 'mountain', 'forest', 'city',
                    'love', 'friendship', 'family', 'courage', 'hope', 'dreams',
                    'classic', 'literature', 'novel', 'story', 'tale', 'book',
                    'education', 'learning', 'knowledge', 'wisdom', 'culture',
                    'society', 'human', 'life', 'world', 'universe', 'earth'
                ];
                
                // State management
                this.cache = new Map();
                this.embedValidationCache = new Map();
                this.lastRequestTime = 0;
                this.isLoading = false;
                this.allBooks = new Map();
                this.searchResults = new Map();
                this.currentBook = null;
                this.bookCount = 0;
                this.currentTopicIndex = 0;
                this.autoLoadTimer = null;
                this.isSearchMode = false;
                
                // User management
                this.user = {
                    isPremium: false,
                    premiumExpiry: null,
                    name: 'Guest User',
                    stats: {
                        pagesRead: 0,
                        readingStreak: 0,
                        goalProgress: 0,
                        badges: 0
                    },
                    savedBooks: [],
                    collections: []
                };
                
                // Initialize
                this.init();
            }

            async init() {
                console.log('🚀 Initializing Smart Story Hub with Premium Features...');
                this.loadUserData();
                this.setupEventListeners();
                this.createStarBackground();
                this.updateAPIStatus();
                this.updateUserInterface();
                this.startInfiniteLoading();
                console.log('✅ Smart Story Hub initialized successfully!');
            }

            loadUserData() {
                const savedUserData = localStorage.getItem('storyHubUser');
                if (savedUserData) {
                    try {
                        const userData = JSON.parse(savedUserData);
                        this.user = { ...this.user, ...userData };
                        
                        // Check if premium is still valid
                        if (this.user.premiumExpiry) {
                            const expiryDate = new Date(this.user.premiumExpiry);
                            const now = new Date();
                            if (now > expiryDate) {
                                this.user.isPremium = false;
                                this.user.premiumExpiry = null;
                                this.saveUserData();
                            }
                        }
                    } catch (e) {
                        console.error('Error loading user data:', e);
                    }
                }
            }

            saveUserData() {
                localStorage.setItem('storyHubUser', JSON.stringify(this.user));
            }

            setupEventListeners() {
                // Search functionality
                const searchInput = document.getElementById('searchInput');
                const searchButton = document.getElementById('searchButton');

                if (searchInput && searchButton) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.performExactSearch();
                        }
                    });

                    searchButton.addEventListener('click', () => {
                        this.performExactSearch();
                    });

                    // Clear search when input is empty
                    searchInput.addEventListener('input', (e) => {
                        if (e.target.value.trim() === '') {
                            this.clearSearch();
                        }
                    });
                }

                // Modal event listeners
                this.setupModalEventListeners();

                // Embed reader event listeners
                const embedCloseBtn = document.getElementById('embed-close-btn');
                if (embedCloseBtn) {
                    embedCloseBtn.addEventListener('click', () => this.closeEmbedReader());
                }

                // Infinite scroll
                window.addEventListener('scroll', this.throttle(() => {
                    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                        if (!this.isSearchMode && this.user.isPremium) {
                            this.loadMoreBooks();
                        }
                    }
                }, 1000));

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeReadOptions();
                        this.closeEmbedReader();
                        this.backToStories();
                        this.hideUserDropdown();
                    }
                });

                // User menu
                const userAvatar = document.getElementById('user-avatar');
                const userDropdown = document.getElementById('user-dropdown');
                
                if (userAvatar) {
                    userAvatar.addEventListener('click', (e) => {
                        e.stopPropagation();
                        userDropdown.classList.toggle('show');
                    });
                }

                document.addEventListener('click', () => {
                    this.hideUserDropdown();
                });

                // Premium features
                const upgradeBtn = document.getElementById('upgrade-btn');
                const premiumFeaturesBtn = document.getElementById('premium-features-btn');
                const premiumModal = document.getElementById('premium-modal');
                const premiumModalClose = document.getElementById('premium-modal-close');
                const purchasePremiumBtn = document.getElementById('purchase-premium-btn');

                if (upgradeBtn) {
                    upgradeBtn.addEventListener('click', () => {
                        this.showPremiumModal();
                    });
                }

                if (premiumFeaturesBtn) {
                    premiumFeaturesBtn.addEventListener('click', () => {
                        this.showPremiumModal();
                    });
                }

                if (premiumModalClose) {
                    premiumModalClose.addEventListener('click', () => {
                        this.hidePremiumModal();
                    });
                }

                if (purchasePremiumBtn) {
                    purchasePremiumBtn.addEventListener('click', () => {
                        this.purchasePremium();
                    });
                }

                // Other menu buttons
                const myLibraryBtn = document.getElementById('my-library-btn');
                const myNotesBtn = document.getElementById('my-notes-btn');
                const readingStatsBtn = document.getElementById('reading-stats-btn');

                if (myLibraryBtn) {
                    myLibraryBtn.addEventListener('click', () => {
                        this.showFeatureRestriction('My Library');
                    });
                }

                if (myNotesBtn) {
                    myNotesBtn.addEventListener('click', () => {
                        this.showFeatureRestriction('My Notes');
                    });
                }

                if (readingStatsBtn) {
                    readingStatsBtn.addEventListener('click', () => {
                        this.showFeatureRestriction('Reading Stats');
                    });
                }
            }

            hideUserDropdown() {
                const userDropdown = document.getElementById('user-dropdown');
                if (userDropdown) {
                    userDropdown.classList.remove('show');
                }
            }

            showPremiumModal() {
                const premiumModal = document.getElementById('premium-modal');
                if (premiumModal) {
                    premiumModal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            }

            hidePremiumModal() {
                const premiumModal = document.getElementById('premium-modal');
                if (premiumModal) {
                    premiumModal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            }

            purchasePremium() {
                // Simulate premium purchase
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 30);
                
                this.user.isPremium = true;
                this.user.premiumExpiry = expiryDate.toISOString();
                this.saveUserData();
                this.updateUserInterface();
                this.hidePremiumModal();
                
                this.showStatus('🎉 Welcome to Premium! Enjoy unlimited reading for 30 days.', 'success');
                
                // Start infinite loading for premium users
                this.startInfiniteLoading();
            }

            showFeatureRestriction(featureName) {
                if (!this.user.isPremium) {
                    this.showStatus(`🔒 ${featureName} is a Premium feature. Upgrade to access.`, 'warning');
                    this.showPremiumModal();
                } else {
                    this.showStatus(`✨ ${featureName} will be available soon!`, 'success');
                }
            }

            updateUserInterface() {
                // Update user name
                const userName = document.getElementById('user-name');
                if (userName) {
                    userName.textContent = this.user.name;
                }
                
                // Update premium status
                const premiumStatus = document.getElementById('premium-status');
                const userStatusText = document.getElementById('user-status-text');
                const upgradeBtn = document.getElementById('upgrade-btn');
                
                if (this.user.isPremium) {
                    if (premiumStatus) premiumStatus.style.display = 'inline';
                    if (userStatusText) userStatusText.textContent = 'Premium Account';
                    if (upgradeBtn) upgradeBtn.textContent = 'Manage Premium';
                    
                    // Show stats for premium users
                    const userStats = document.getElementById('user-stats');
                    if (userStats) userStats.style.display = 'grid';
                    
                    // Update stats values
                    this.updateUserStats();
                } else {
                    if (premiumStatus) premiumStatus.style.display = 'none';
                    if (userStatusText) userStatusText.textContent = 'Free Account';
                    if (upgradeBtn) upgradeBtn.textContent = 'Upgrade to Premium';
                    
                    // Hide stats for free users
                    const userStats = document.getElementById('user-stats');
                    if (userStats) userStats.style.display = 'none';
                }
            }

            updateUserStats() {
                document.getElementById('stat-pages').textContent = this.user.stats.pagesRead;
                document.getElementById('stat-streak').textContent = this.user.stats.readingStreak;
                document.getElementById('stat-goal').textContent = `${this.user.stats.goalProgress}%`;
                document.getElementById('stat-badges').textContent = this.user.stats.badges;
            }

            setupModalEventListeners() {
                const closeModalBtn = document.getElementById('close-read-options');
                const modalOverlay = document.getElementById('read-options-modal-overlay');
                const readEmbedBtn = document.getElementById('read-embed-btn');
                const readSourceBtn = document.getElementById('read-source-btn');
                const readWebBtn = document.getElementById('read-web-btn');
                const readArchiveBtn = document.getElementById('read-archive-btn');

                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', () => this.closeReadOptions());
                }

                if (modalOverlay) {
                    modalOverlay.addEventListener('click', (e) => {
                        if (e.target === modalOverlay) {
                            this.closeReadOptions();
                        }
                    });
                }

                if (readEmbedBtn) {
                    readEmbedBtn.addEventListener('click', () => this.readWithEmbed());
                }

                if (readSourceBtn) {
                    readSourceBtn.addEventListener('click', () => this.readFromSource());
                }

                if (readWebBtn) {
                    readWebBtn.addEventListener('click', () => this.readOnWeb());
                }

                if (readArchiveBtn) {
                    readArchiveBtn.addEventListener('click', () => this.readFromArchive());
                }
            }

            createStarBackground() {
                const starField = document.getElementById('starField');
                if (!starField) return;

                const starCount = Math.floor(window.innerWidth / 20);
                
                for (let i = 0; i < starCount; i++) {
                    const star = document.createElement('div');
                    star.classList.add('star');
                    
                    const y = Math.random() * 200;
                    const size = Math.random() * 2 + 1;
                    const duration = (Math.random() * 10 + 5) + 's';
                    
                    star.style.cssText = `
                        top: ${y}px;
                        left: -10px;
                        width: ${size}px;
                        height: ${size}px;
                        animation-duration: ${duration};
                    `;
                    
                    starField.appendChild(star);
                    
                    star.addEventListener('animationend', () => {
                        star.remove();
                        if (starField.children.length < starCount) {
                            this.createStarBackground();
                        }
                    });
                }
            }

            startInfiniteLoading() {
                console.log('📚 Loading books with embed validation...');
                this.updateSearchInfo('Loading books with embed validation...');
                
                // Only start continuous loading for premium users
                if (this.user.isPremium) {
                    // Load initial batch
                    this.loadBooksFromAllAPIs();
                    
                    // Set up continuous loading
                    this.autoLoadTimer = setInterval(() => {
                        if (!this.isSearchMode && !this.isLoading) {
                            this.loadBooksFromAllAPIs();
                        }
                    }, this.AUTO_LOAD_INTERVAL);
                } else {
                    // For free users, just load one batch
                    this.loadBooksFromAllAPIs();
                    this.updateSearchInfo('Free accounts can search books. Upgrade to Premium for unlimited reading.');
                }
            }

            stopInfiniteLoading() {
                if (this.autoLoadTimer) {
                    clearInterval(this.autoLoadTimer);
                    this.autoLoadTimer = null;
                }
            }

            async loadBooksFromAllAPIs() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.showAutoLoadIndicator(true);
                
                try {
                    // Get current search topic for variety
                    const topic = this.searchTopics[this.currentTopicIndex];
                    this.currentTopicIndex = (this.currentTopicIndex + 1) % this.searchTopics.length;
                    
                    // Load from multiple APIs simultaneously
                    const promises = [
                        this.loadFromOpenLibrary(topic),
                        this.loadFromInternetArchive(topic),
                        this.loadFromGutenberg(topic)
                    ];
                    
                    const results = await Promise.allSettled(promises);
                    
                    let newBooksCount = 0;
                    results.forEach((result, index) => {
                        const apiKeys = ['openLibrary', 'internetArchive', 'gutenberg'];
                        const apiKey = apiKeys[index];
                        
                        if (result.status === 'fulfilled' && result.value.length > 0) {
                            const addedCount = this.addBooksToDisplay(result.value);
                            newBooksCount += addedCount;
                            this.setAPIStatus(apiKey, 'active');
                            console.log(`📖 Loaded ${addedCount} books from ${this.APIs[apiKey].name}`);
                        } else {
                            this.setAPIStatus(apiKey, 'error');
                        }
                    });
                    
                    if (newBooksCount > 0) {
                        this.showStatus(`Loaded ${newBooksCount} new books`, 'success');
                    }
                    
                } catch (error) {
                    console.error('❌ Error loading books:', error);
                    this.showStatus('Error loading some books', 'warning');
                } finally {
                    this.isLoading = false;
                    this.showAutoLoadIndicator(false);
                }
            }

            async loadFromOpenLibrary(query) {
                try {
                    this.setAPIStatus('openLibrary', 'loading');
                    const page = this.APIs.openLibrary.currentPage;
                    const url = `${this.APIs.openLibrary.searchUrl}?q=${encodeURIComponent(query)}&limit=${this.BOOKS_PER_LOAD}&page=${page}`;
                    const response = await this.makeAPIRequest(url);
                    
                    this.APIs.openLibrary.currentPage++;
                    
                    if (response.docs && response.docs.length > 0) {
                        return response.docs.map(this.APIs.openLibrary.transform).filter(book => book.title);
                    }
                    return [];
                } catch (error) {
                    console.error('❌ Open Library loading error:', error);
                    this.setAPIStatus('openLibrary', 'error');
                    return [];
                }
            }

            async loadFromInternetArchive(query) {
                try {
                    this.setAPIStatus('internetArchive', 'loading');
                    const page = this.APIs.internetArchive.currentPage;
                    const url = `${this.APIs.internetArchive.searchUrl}?q=${encodeURIComponent(query)}&fl=identifier,title,creator,description,date,subject&rows=${this.BOOKS_PER_LOAD}&page=${page}&output=json`;
                    const response = await this.makeAPIRequest(url);
                    
                    this.APIs.internetArchive.currentPage++;
                    
                    if (response.response && response.response.docs && response.response.docs.length > 0) {
                        return response.response.docs.map(this.APIs.internetArchive.transform).filter(book => book.title);
                    }
                    return [];
                } catch (error) {
                    console.error('❌ Internet Archive loading error:', error);
                    this.setAPIStatus('internetArchive', 'error');
                    return [];
                }
            }

            async loadFromGutenberg(query) {
                try {
                    this.setAPIStatus('gutenberg', 'loading');
                    const page = this.APIs.gutenberg.currentPage;
                    const url = `${this.APIs.gutenberg.searchUrl}?search=${encodeURIComponent(query)}&page=${page}`;
                    const response = await this.makeAPIRequest(url);
                    
                    this.APIs.gutenberg.currentPage++;
                    
                    if (response.results && response.results.length > 0) {
                        return response.results.map(this.APIs.gutenberg.transform).filter(book => book.title);
                    }
                    return [];
                } catch (error) {
                    console.error('❌ Project Gutenberg loading error:', error);
                    this.setAPIStatus('gutenberg', 'error');
                    return [];
                }
            }

            // ✅ ENHANCED OPEN LIBRARY EMBED VALIDATION
            async checkOpenLibraryEmbedAvailability(book) {
                const cacheKey = `embed_${book.id}`;
                
                // Check cache first
                if (this.embedValidationCache.has(cacheKey)) {
                    return this.embedValidationCache.get(cacheKey);
                }

                try {
                    // Only validate Open Library books
                    if (book.source !== 'Open Library' || !book.rawData?.key) {
                        this.embedValidationCache.set(cacheKey, false);
                        return false;
                    }

                    const workId = book.rawData.key.replace('/works/', '');
                    
                    // Step 1: Check if work exists and has basic info
                    const workUrl = `${this.APIs.openLibrary.worksUrl}/${workId}.json`;
                    const workData = await this.makeAPIRequest(workUrl);
                    
                    if (!workData || (!workData.description && !workData.covers && !workData.subjects)) {
                        console.log(`❌ Work ${workId} lacks basic info for embedding`);
                        this.embedValidationCache.set(cacheKey, false);
                        return false;
                    }

                    // Step 2: Check editions for borrowable or readable status
                    const editionsUrl = `${this.APIs.openLibrary.editionsUrl}/${workId}/editions.json`;
                    const editionsData = await this.makeAPIRequest(editionsUrl);
                    
                    if (!editionsData || !editionsData.entries || editionsData.entries.length === 0) {
                        console.log(`❌ No editions found for work ${workId}`);
                        this.embedValidationCache.set(cacheKey, false);
                        return false;
                    }

                    // Step 3: Check if any edition is borrowable or has full preview
                    let isEmbeddable = false;
                    
                    for (const edition of editionsData.entries) {
                        // Check for borrowable status
                        if (edition.availability && edition.availability.status === "borrowable") {
                            console.log(`✅ Found borrowable edition for ${workId}`);
                            isEmbeddable = true;
                            break;
                        }
                        
                        // Check for full preview
                        if (edition.preview === "full") {
                            console.log(`✅ Found full preview edition for ${workId}`);
                            isEmbeddable = true;
                            break;
                        }
                        
                        // Check for readable status in ocaid (Internet Archive ID)
                        if (edition.ocaid) {
                            console.log(`✅ Found Internet Archive edition for ${workId}`);
                            isEmbeddable = true;
                            break;
                        }
                    }

                    if (!isEmbeddable) {
                        console.log(`❌ No embeddable editions found for work ${workId}`);
                    }

                    this.embedValidationCache.set(cacheKey, isEmbeddable);
                    return isEmbeddable;
                    
                } catch (error) {
                    console.error(`❌ Embed validation error for ${book.id}:`, error);
                    this.embedValidationCache.set(cacheKey, false);
                    return false;
                }
            }

            async performExactSearch() {
                const searchInput = document.getElementById('searchInput');
                if (!searchInput) return;

                const query = searchInput.value.trim();
                if (!query) {
                    this.showStatus('Please enter a search term', 'warning');
                    return;
                }
                
                console.log(`🔍 Performing exact search for: "${query}"`);
                this.isSearchMode = true;
                this.stopInfiniteLoading();
                this.clearResults();
                this.showLoading(true);
                this.updateSearchInfo(`Searching for exact matches: "${query}"...`, true);
                
                try {
                    // Search all APIs simultaneously
                    const searchPromises = [
                        this.searchOpenLibrary(query),
                        this.searchInternetArchive(query),
                        this.searchGutenberg(query)
                    ];

                    const results = await Promise.allSettled(searchPromises);
                    let totalResults = 0;

                    results.forEach((result, index) => {
                        const apiKeys = ['openLibrary', 'internetArchive', 'gutenberg'];
                        const apiKey = apiKeys[index];
                        
                        if (result.status === 'fulfilled' && result.value.length > 0) {
                            this.displaySearchResults(result.value);
                            totalResults += result.value.length;
                            this.setAPIStatus(apiKey, 'active');
                        } else {
                            this.setAPIStatus(apiKey, 'error');
                        }
                    });

                    if (totalResults === 0) {
                        this.showNoResults(query);
                    } else {
                        this.updateSearchInfo(`Found ${totalResults} exact matches for "${query}"`, true);
                        this.showStatus(`Found ${totalResults} books matching "${query}"`, 'success');
                    }

                } catch (error) {
                    console.error('❌ Search error:', error);
                    this.showStatus('Search failed. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            clearSearch() {
                this.isSearchMode = false;
                this.searchResults.clear();
                this.clearResults();
                
                if (this.user.isPremium) {
                    this.updateSearchInfo('Resuming continuous book loading...');
                    this.startInfiniteLoading();
                } else {
                    this.updateSearchInfo('Free accounts can search books. Upgrade to Premium for unlimited reading.');
                    this.loadBooksFromAllAPIs();
                }
            }

            loadMoreBooks() {
                if (!this.isLoading && !this.isSearchMode && this.user.isPremium) {
                    this.loadBooksFromAllAPIs();
                }
            }

            async searchOpenLibrary(query) {
                try {
                    this.setAPIStatus('openLibrary', 'loading');
                    const url = `${this.APIs.openLibrary.searchUrl}?q=${encodeURIComponent(query)}&limit=20`;
                    const response = await this.makeAPIRequest(url);
                    
                    if (response.docs && response.docs.length > 0) {
                        const exactMatches = response.docs.filter(book => 
                            this.isExactMatch(book.title, query) || 
                            this.isExactMatch(book.author_name?.[0], query) ||
                            (book.subject && book.subject.some(subject => this.isExactMatch(subject, query)))
                        );
                        
                        return exactMatches.map(this.APIs.openLibrary.transform);
                    }
                    return [];
                } catch (error) {
                    console.error('❌ Open Library search error:', error);
                    this.setAPIStatus('openLibrary', 'error');
                    return [];
                }
            }

            async searchInternetArchive(query) {
                try {
                    this.setAPIStatus('internetArchive', 'loading');
                    const url = `${this.APIs.internetArchive.searchUrl}?q=${encodeURIComponent(query)}&fl=identifier,title,creator,description,date,subject&rows=20&page=1&output=json`;
                    const response = await this.makeAPIRequest(url);
                    
                    if (response.response && response.response.docs && response.response.docs.length > 0) {
                        const exactMatches = response.response.docs.filter(book => 
                            this.isExactMatch(book.title, query) || 
                            this.isExactMatch(book.creator, query) ||
                            (book.subject && book.subject.some && book.subject.some(subject => this.isExactMatch(subject, query)))
                        );
                        
                        return exactMatches.map(this.APIs.internetArchive.transform);
                    }
                    return [];
                } catch (error) {
                    console.error('❌ Internet Archive search error:', error);
                    this.setAPIStatus('internetArchive', 'error');
                    return [];
                }
            }

            async searchGutenberg(query) {
                try {
                    this.setAPIStatus('gutenberg', 'loading');
                    const url = `${this.APIs.gutenberg.searchUrl}?search=${encodeURIComponent(query)}`;
                    const response = await this.makeAPIRequest(url);
                    
                    if (response.results && response.results.length > 0) {
                        const exactMatches = response.results.filter(book => 
                            this.isExactMatch(book.title, query) || 
                            (book.authors && book.authors.some(author => this.isExactMatch(author.name, query))) ||
                            (book.subjects && book.subjects.some(subject => this.isExactMatch(subject, query)))
                        );
                        
                        return exactMatches.map(this.APIs.gutenberg.transform);
                    }
                    return [];
                } catch (error) {
                    console.error('❌ Project Gutenberg search error:', error);
                    this.setAPIStatus('gutenberg', 'error');
                    return [];
                }
            }

            isExactMatch(text, query) {
                if (!text || !query) return false;
                return text.toLowerCase().includes(query.toLowerCase());
            }

            async makeAPIRequest(url, useCache = true) {
                // Check cache first
                if (useCache && this.cache.has(url)) {
                    const cached = this.cache.get(url);
                    const now = Date.now();
                    if (now - cached.timestamp < this.CACHE_DURATION) {
                        return cached.data;
                    }
                }

                // Rate limiting
                const now = Date.now();
                const timeSinceLastRequest = now - this.lastRequestTime;
                if (timeSinceLastRequest < this.REQUEST_DELAY) {
                    await new Promise(resolve => 
                        setTimeout(resolve, this.REQUEST_DELAY - timeSinceLastRequest)
                    );
                }

                // Make request with retry logic
                for (let attempt = 1; attempt <= this.MAX_RETRIES; attempt++) {
                    try {
                        this.lastRequestTime = Date.now();
                        
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        
                        // Cache the response
                        this.cache.set(url, {
                            data: data,
                            timestamp: now
                        });

                        return data;

                    } catch (error) {
                        console.error(`❌ Attempt ${attempt} failed for ${url}:`, error);
                        if (attempt === this.MAX_RETRIES) {
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                }
            }

            transformOpenLibraryBook(book) {
                const author = book.author_name?.[0] || 'Unknown Author';
                const publishYear = book.first_publish_year || 'Unknown';
                const subject = book.subject?.[0] || 'General';
                
                let description = '';
                if (book.first_sentence && book.first_sentence.length > 0) {
                    description = book.first_sentence.join(' ');
                } else {
                    description = `A book by ${author}, published in ${publishYear}. Subject: ${subject}.`;
                }

                return {
                    id: `ol_${book.key?.replace('/works/', '') || Math.random().toString(36)}`,
                    title: book.title || 'Untitled',
                    author: author,
                    description: description,
                    genre: subject,
                    publishYear: publishYear,
                    coverImage: book.cover_i 
                        ? `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg`
                        : `https://via.placeholder.com/300x400/1a1a1a/6a11cb?text=${encodeURIComponent(book.title?.substring(0, 20) || 'Book')}`,
                    source: 'Open Library',
                    sourceUrl: book.key ? `https://openlibrary.org${book.key}` : null,
                    embedUrl: book.key ? `https://openlibrary.org/embed${book.key}` : null,
                    archiveUrl: null,
                    rawData: book,
                    embedStatus: 'unchecked' // Will be checked when user tries to read
                };
            }

            transformInternetArchiveBook(book) {
                const author = book.creator || 'Unknown Author';
                const publishYear = book.date || 'Unknown';
                const subject = Array.isArray(book.subject) ? book.subject[0] : (book.subject || 'Archive');
                
                const description = book.description || `An archived work by ${author}. Available through Internet Archive.`;

                return {
                    id: `ia_${book.identifier}`,
                    title: book.title || 'Untitled Archive',
                    author: author,
                    description: description,
                    genre: subject,
                    publishYear: publishYear,
                    coverImage: `https://archive.org/services/img/${book.identifier}`,
                    source: 'Internet Archive',
                    sourceUrl: `https://archive.org/details/${book.identifier}`,
                    embedUrl: `https://archive.org/embed/${book.identifier}`,
                    archiveUrl: `https://archive.org/details/${book.identifier}`,
                    rawData: book,
                    embedStatus: 'available' // Internet Archive generally supports embedding
                };
            }

            transformGutenbergBook(book) {
                const author = book.authors?.[0]?.name || 'Unknown Author';
                const subject = book.subjects?.[0] || 'Classic Literature';
                const publishYear = book.authors?.[0]?.birth_year || 'Classic';
                
                const description = `A classic work from Project Gutenberg by ${author}. ${book.subjects ? 'Subjects: ' + book.subjects.slice(0, 3).join(', ') + '.' : ''}`;

                return {
                    id: `gb_${book.id}`,
                    title: book.title || 'Untitled Classic',
                    author: author,
                    description: description,
                    genre: subject,
                    publishYear: publishYear,
                    coverImage: book.formats?.['image/jpeg'] || 
                        `https://via.placeholder.com/300x400/1a1a1a/2575fc?text=${encodeURIComponent(book.title?.substring(0, 20) || 'Classic')}`,
                    source: 'Project Gutenberg',
                    sourceUrl: `https://www.gutenberg.org/ebooks/${book.id}`,
                    embedUrl: null, // Gutenberg doesn't support embedding
                    archiveUrl: null,
                    textUrl: book.formats?.['text/plain'] || book.formats?.['text/html'],
                    rawData: book,
                    embedStatus: 'unavailable' // Gutenberg doesn't support embedding
                };
            }

            addBooksToDisplay(books) {
                let addedCount = 0;
                
                books.forEach(book => {
                    if (!this.allBooks.has(book.id)) {
                        this.allBooks.set(book.id, book);
                        this.displaySingleBook(book);
                        addedCount++;
                        this.bookCount++;
                    }
                });
                
                this.updateBookCounter();
                return addedCount;
            }

            displaySearchResults(books) {
                books.forEach(book => {
                    if (!this.searchResults.has(book.id)) {
                        this.searchResults.set(book.id, book);
                        this.displaySingleBook(book);
                    }
                });
            }

            displaySingleBook(book) {
                const container = document.getElementById('storiesContainer');
                if (!container) return;

                const bookCard = this.createBookCard(book);
                container.appendChild(bookCard);
                
                // Start embed validation for Open Library books
                if (book.source === 'Open Library' && book.embedStatus === 'unchecked') {
                    this.validateAndUpdateEmbedStatus(book.id);
                }
            }

            async validateAndUpdateEmbedStatus(bookId) {
                const book = this.allBooks.get(bookId) || this.searchResults.get(bookId);
                if (!book) return;

                // Update UI to show checking status
                this.updateEmbedStatusBadge(bookId, 'checking');
                
                try {
                    const isEmbeddable = await this.checkOpenLibraryEmbedAvailability(book);
                    
                    // Update book object
                    book.embedStatus = isEmbeddable ? 'available' : 'unavailable';
                    
                    // Update UI
                    this.updateEmbedStatusBadge(bookId, book.embedStatus);
                    this.updateReadButton(bookId, book.embedStatus);
                    
                    console.log(`📚 Embed validation for "${book.title}": ${book.embedStatus}`);
                    
                } catch (error) {
                    console.error(`❌ Embed validation failed for ${bookId}:`, error);
                    book.embedStatus = 'unavailable';
                    this.updateEmbedStatusBadge(bookId, 'unavailable');
                    this.updateReadButton(bookId, 'unavailable');
                }
            }

            updateEmbedStatusBadge(bookId, status) {
                const bookCard = document.querySelector(`[data-book-id="${bookId}"]`);
                if (!bookCard) return;

                let badge = bookCard.querySelector('.embed-status-badge');
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'embed-status-badge';
                    bookCard.querySelector('.story-card').appendChild(badge);
                }

                switch (status) {
                    case 'checking':
                        badge.className = 'embed-status-badge embed-checking';
                        badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking';
                        break;
                    case 'available':
                        badge.className = 'embed-status-badge embed-available';
                        badge.innerHTML = '<i class="fas fa-check"></i> Embeddable';
                        break;
                    case 'unavailable':
                        badge.className = 'embed-status-badge embed-unavailable';
                        badge.innerHTML = '<i class="fas fa-times"></i> No Embed';
                        break;
                }
            }

            updateReadButton(bookId, embedStatus) {
                const bookCard = document.querySelector(`[data-book-id="${bookId}"]`);
                if (!bookCard) return;

                const readBtn = bookCard.querySelector('.read-btn');
                if (!readBtn) return;

                if (embedStatus === 'unavailable') {
                    readBtn.disabled = false; // Enable button for unavailable embeds
                    readBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> Read Source';
                    readBtn.title = 'Read from original source';
                } else {
                    readBtn.disabled = false;
                    readBtn.innerHTML = '<i class="fas fa-book-open"></i> Read';
                    readBtn.title = 'Click to see reading options';
                }
            }

            createBookCard(book) {
                const col = document.createElement('div');
                col.className = 'col-lg-3 col-md-4 col-sm-6 mb-4';
                col.setAttribute('data-book-id', book.id);
                
                // Determine if read button should show different text for unavailable embeds
                const isEmbedUnavailable = book.embedStatus === 'unavailable';
                const readBtnClass = 'action-btn read-btn';
                const readBtnContent = isEmbedUnavailable ? '<i class="fas fa-external-link-alt"></i> Read Source' : '<i class="fas fa-book-open"></i> Read';
                
                col.innerHTML = `
                    <div class="story-card fade-in">
                        <img src="${book.coverImage}" 
                             class="story-card-img" 
                             alt="${book.title} cover"
                             loading="lazy"
                             onerror="this.src='https://via.placeholder.com/300x400/1a1a1a/6a11cb?text=Book+Cover'">
                        <div class="story-card-body">
                            <h5 class="story-title">${book.title}</h5>
                            <p class="story-author">by ${book.author}</p>
                            <div class="story-meta">
                                <span class="story-genre">${book.genre}</span>
                                <span class="api-badge">${book.source}</span>
                            </div>
                            <div class="story-description-container">
                                <p class="story-description">${book.description}</p>
                            </div>
                            <div class="story-actions">
                                <button class="action-btn preview-btn" onclick="storyHub.previewBook('${book.id}')">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button class="${readBtnClass}" onclick="storyHub.showReadOptions('${book.id}')">
                                    ${readBtnContent}
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                col.dataset.bookData = JSON.stringify(book);
                return col;
            }

            async showReadOptions(bookId) {
                const book = this.allBooks.get(bookId) || this.searchResults.get(bookId);
                if (!book) return;

                this.currentBook = book;
                
                // Set the book title in the modal
                const titleElement = document.getElementById('read-options-story-title');
                if (titleElement) {
                    titleElement.textContent = `"${book.title}"`;
                }
                
                // Configure read options based on embed availability
                const embedBtn = document.getElementById('read-embed-btn');
                const archiveBtn = document.getElementById('read-archive-btn');
                
                if (embedBtn) {
                    if (book.embedStatus === 'available' || book.source === 'Internet Archive') {
                        embedBtn.style.display = 'flex';
                        embedBtn.disabled = false;
                        embedBtn.innerHTML = `
                            <div class="read-option-icon">
                                <i class="fas fa-book-reader"></i>
                            </div>
                            <div class="read-option-text">
                                <div class="read-option-title">Read with Embed</div>
                                <div class="read-option-desc">Read using embedded reader - verified as available</div>
                            </div>
                        `;
                    } else if (book.embedStatus === 'checking') {
                        embedBtn.style.display = 'flex';
                        embedBtn.disabled = true;
                        embedBtn.innerHTML = `
                            <div class="read-option-icon">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div class="read-option-text">
                                <div class="read-option-title">Checking Embed Availability...</div>
                                <div class="read-option-desc">Please wait while we verify if this book can be embedded</div>
                            </div>
                        `;
                        
                        // Re-check embed availability
                        this.validateAndUpdateEmbedStatus(bookId).then(() => {
                            // Refresh modal if still open
                            if (this.currentBook && this.currentBook.id === bookId) {
                                this.showReadOptions(bookId);
                            }
                        });
                    } else {
                        // Hide embed option for unavailable books
                        embedBtn.style.display = 'none';
                    }
                }
                
                if (archiveBtn) {
                    archiveBtn.style.display = book.archiveUrl ? 'flex' : 'none';
                }
                
                // Show the modal
                const modal = document.getElementById('read-options-modal-overlay');
                if (modal) {
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
                
                console.log(`📖 Showing read options for: ${book.title} (Embed: ${book.embedStatus})`);
            }

            closeReadOptions() {
                const modal = document.getElementById('read-options-modal-overlay');
                if (modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            }

            readWithEmbed() {
                if (!this.currentBook) {
                    this.showStatus('No book selected', 'error');
                    return;
                }

                // Double-check embed availability
                if (this.currentBook.embedStatus !== 'available' && this.currentBook.source !== 'Internet Archive') {
                    this.showStatus('This book is not available to embed', 'warning');
                    return;
                }

                if (!this.currentBook.embedUrl) {
                    this.showStatus('Embed URL not available for this book', 'warning');
                    return;
                }

                const embedReader = document.getElementById('embed-reader');
                const embedIframe = document.getElementById('embed-iframe');
                const embedTitle = document.getElementById('embed-reader-title');
                
                if (embedReader && embedIframe && embedTitle) {
                    embedTitle.textContent = `Reading: ${this.currentBook.title}`;
                    embedIframe.src = this.currentBook.embedUrl;
                    embedReader.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    this.showStatus(`Opening verified embedded reader for "${this.currentBook.title}"`, 'success');
                    console.log(`📚 Opening validated embed reader: ${this.currentBook.embedUrl}`);
                }
                
                this.closeReadOptions();
            }

            closeEmbedReader() {
                const embedReader = document.getElementById('embed-reader');
                const embedIframe = document.getElementById('embed-iframe');
                
                if (embedReader) {
                    embedReader.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
                
                if (embedIframe) {
                    embedIframe.src = '';
                }
            }

            readFromSource() {
                if (!this.currentBook || !this.currentBook.sourceUrl) {
                    this.showStatus('Source URL not available', 'warning');
                    return;
                }

                window.open(this.currentBook.sourceUrl, '_blank');
                this.showStatus(`Opening "${this.currentBook.title}" from ${this.currentBook.source}`, 'success');
                console.log(`🔗 Opening source: ${this.currentBook.sourceUrl}`);
                this.closeReadOptions();
            }

            readFromArchive() {
                if (!this.currentBook || !this.currentBook.archiveUrl) {
                    this.showStatus('Archive URL not available', 'warning');
                    return;
                }

                window.open(this.currentBook.archiveUrl, '_blank');
                this.showStatus(`Opening "${this.currentBook.title}" from Internet Archive`, 'success');
                console.log(`🏛️ Opening archive: ${this.currentBook.archiveUrl}`);
                this.closeReadOptions();
            }

            readOnWeb() {
                if (!this.currentBook) return;

                // For unembeddable books, redirect to source instead of showing web view
                if (this.currentBook.embedStatus === 'unavailable' && this.currentBook.sourceUrl) {
                    this.readFromSource();
                    return;
                }

                this.openBookReadingPage(this.currentBook);
                this.closeReadOptions();
            }

            openBookReadingPage(book) {
                this.currentBook = book;
                
                // Hide main page and show reading page
                const mainPage = document.getElementById('main-page');
                const readingPage = document.getElementById('story-reading-page');
                
                if (mainPage) mainPage.style.display = 'none';
                if (readingPage) readingPage.classList.add('active');
                
                // Populate reading page with book data
                const elements = {
                    'reading-cover': book.coverImage,
                    'reading-title': book.title,
                    'reading-author': `by ${book.author}`,
                    'reading-genre': book.genre,
                    'reading-year': book.publishYear,
                    'reading-source': book.source,
                    'reading-description': book.description
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (id === 'reading-cover') {
                            element.src = value;
                            element.alt = `${book.title} cover`;
                        } else {
                            element.textContent = value;
                        }
                    }
                });
                
                // Load content
                this.loadBookContent(book);
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                this.showStatus(`Reading "${book.title}" on web`, 'success');
                console.log(`📚 Opening book reading page for: ${book.title}`);
            }

            async loadBookContent(book) {
                const contentDiv = document.getElementById('reading-content');
                if (!contentDiv) return;

                contentDiv.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading content...</div></div>';

                try {
                    let content = '';
                    
                    if (book.textUrl && book.source === 'Project Gutenberg') {
                        // Try to fetch text content for Gutenberg books
                        try {
                            const response = await fetch(book.textUrl);
                            const text = await response.text();
                            content = this.formatTextContent(text);
                        } catch (error) {
                            console.error('Error fetching text content:', error);
                            content = this.generateSampleContent(book);
                        }
                    } else {
                        content = this.generateSampleContent(book);
                    }

                    contentDiv.innerHTML = content;
                } catch (error) {
                    console.error('Error loading book content:', error);
                    contentDiv.innerHTML = `
                        <div class="chapter">
                            <h3>Content Loading Error</h3>
                            <p>Unable to load the full content. Please try reading from the source or using the embed option if available.</p>
                            <p><strong>Available options:</strong></p>
                            <ul>
                                <li>Click "Back to Books" and try "Read from Source"</li>
                                ${book.embedStatus === 'available' ? '<li>Use the embedded reader if available</li>' : ''}
                                <li>Visit the Internet Archive link if available</li>
                            </ul>
                        </div>
                    `;
                }
            }

            formatTextContent(text) {
                // Basic text formatting for display
                const paragraphs = text.split('\n\n').filter(p => p.trim().length > 0);
                let formattedContent = '';
                
                paragraphs.slice(0, 50).forEach((paragraph, index) => { // Limit to first 50 paragraphs
                    if (paragraph.trim().length > 0) {
                        if (paragraph.toUpperCase() === paragraph && paragraph.length < 100) {
                            // Likely a chapter title
                            formattedContent += `<h3>${paragraph.trim()}</h3>`;
                        } else {
                            formattedContent += `<p>${paragraph.trim()}</p>`;
                        }
                    }
                });

                if (paragraphs.length > 50) {
                    formattedContent += '<p><em>Content truncated. Please use "Read from Source" for the complete text.</em></p>';
                }

                return formattedContent || '<p>Content could not be formatted properly. Please try reading from the source.</p>';
            }

            generateSampleContent(book) {
                const embedInfo = book.embedStatus === 'available' 
                    ? '<li><strong>Embedded Reader:</strong> Use the built-in reader (verified as available)</li>'
                    : '';

                return `
                    <div class="chapter">
                        <h3>About This Book</h3>
                        <p><strong>${book.title}</strong> by ${book.author} is available through ${book.source}.</p>
                        <p>${book.description}</p>
                        <p><strong>Genre:</strong> ${book.genre}</p>
                        <p><strong>Published:</strong> ${book.publishYear}</p>
                        <p><strong>Embed Status:</strong> ${book.embedStatus === 'available' ? '✅ Available for embedding' : '❌ Not available for embedding'}</p>
                        
                        <h3>Reading Options</h3>
                        <p>To read the complete content of this book, please use one of the following options:</p>
                        <ul>
                            <li><strong>Read from Source:</strong> Visit the original ${book.source} page</li>
                            ${embedInfo}
                            ${book.archiveUrl ? '<li><strong>Internet Archive:</strong> Access the archived version with additional features</li>' : ''}
                        </ul>
                        
                        <p><em>This preview shows book information. The full content is available through the source links above.</em></p>
                    </div>
                `;
            }

            backToStories() {
                const mainPage = document.getElementById('main-page');
                const readingPage = document.getElementById('story-reading-page');
                
                if (mainPage) mainPage.style.display = 'block';
                if (readingPage) readingPage.classList.remove('active');
                
                console.log('🔙 Returning to book collection');
            }

            previewBook(bookId) {
                const book = this.allBooks.get(bookId) || this.searchResults.get(bookId);
                if (book) {
                    const embedStatusText = book.embedStatus === 'available' ? ' (Embeddable)' : 
                                          book.embedStatus === 'unavailable' ? ' (No Embed)' : ' (Checking...)';
                    this.showStatus(`Preview: "${book.title}" by ${book.author} - ${book.genre} (${book.source})${embedStatusText}`, 'success');
                    
                    // Scroll to the book card
                    const bookElement = document.querySelector(`[data-book-id="${bookId}"]`);
                    if (bookElement) {
                        bookElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }

            clearResults() {
                const container = document.getElementById('storiesContainer');
                if (container) {
                    container.innerHTML = '';
                }
                if (this.isSearchMode) {
                    this.searchResults.clear();
                } else {
                    this.allBooks.clear();
                    this.bookCount = 0;
                    this.updateBookCounter();
                }
            }

            showNoResults(query) {
                const container = document.getElementById('storiesContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="no-results">
                                <i class="fas fa-search"></i>
                                <h3>No matches found for "${query}"</h3>
                                <p>Try searching for different terms or browse our collection.</p>
                                <p><strong>Search tips:</strong></p>
                                <ul style="text-align: left; display: inline-block;">
                                    <li>Try searching for classic literature or well-known authors</li>
                                    <li>Search by genre like "adventure", "mystery", or "romance"</li>
                                    <li>Use broader terms like "fiction" or "history"</li>
                                    <li>Check spelling and try different variations</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }

            updateSearchInfo(message, isActive = false) {
                const searchInfo = document.getElementById('search-info');
                if (searchInfo) {
                    searchInfo.textContent = message;
                    searchInfo.className = isActive ? 'search-info active' : 'search-info';
                }
            }

            updateBookCounter() {
                const counter = document.getElementById('book-count');
                if (counter) {
                    counter.textContent = this.bookCount;
                }
            }

            updateAPIStatus() {
                Object.keys(this.APIs).forEach(apiKey => {
                    const statusId = apiKey.toLowerCase().replace('library', 'library').replace('archive', 'archive');
                    const statusElement = document.getElementById(`${statusId}-status`);
                    if (statusElement) {
                        statusElement.className = `api-status ${this.APIs[apiKey].status}`;
                    }
                });
            }

            setAPIStatus(apiKey, status) {
                this.APIs[apiKey].status = status;
                const statusId = apiKey.toLowerCase().replace('library', 'library').replace('archive', 'archive');
                const statusElement = document.getElementById(`${statusId}-status`);
                if (statusElement) {
                    statusElement.className = `api-status ${status}`;
                }
            }

            showAutoLoadIndicator(show) {
                const indicator = document.getElementById('auto-load-indicator');
                if (indicator) {
                    if (show) {
                        indicator.classList.add('show');
                    } else {
                        indicator.classList.remove('show');
                    }
                }
            }

            showLoading(show) {
                const spinner = document.getElementById('loadingSpinner');
                if (spinner) {
                    spinner.style.display = show ? 'flex' : 'none';
                }
            }

            showStatus(message, type = 'success') {
                const indicator = document.getElementById('status-indicator');
                if (!indicator) return;

                const icons = {
                    success: 'check',
                    warning: 'exclamation-triangle',
                    error: 'times'
                };
                
                indicator.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${message}`;
                indicator.className = `status-indicator ${type}`;
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 4000);
            }

            throttle(func, delay) {
                let timeoutId;
                let lastExecTime = 0;
                return function (...args) {
                    const currentTime = Date.now();
                    
                    if (currentTime - lastExecTime > delay) {
                        func.apply(this, args);
                        lastExecTime = currentTime;
                    } else {
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => {
                            func.apply(this, args);
                            lastExecTime = Date.now();
                        }, delay - (currentTime - lastExecTime));
                    }
                };
            }
        }

        // Initialize the Smart Story Hub
        const storyHub = new SmartStoryHub();

        console.log("🚀 Smart Story Hub: Discover books with Premium Features!");

        // Security measures
        document.addEventListener("keydown", function(e) {
            if ((e.key === 'F12') || 
                (e.ctrlKey && (e.key === 'u' || e.key === 'U')) || 
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i'))) {
                e.preventDefault();
            }
        });

        let devtoolsOpen = false;
        setInterval(function() {
            const width = window.outerWidth - window.innerWidth > 100;
            const height = window.outerHeight - window.innerHeight > 100;
            if ((width || height) && !devtoolsOpen) {
                devtoolsOpen = true;
            }
            if (!(width || height) && devtoolsOpen) {
                devtoolsOpen = false;
            }
        }, 1000);

        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>