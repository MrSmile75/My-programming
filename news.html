<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Continuous Online Quiz Challenge</title>
    <style>
        /* Previous CSS remains the same */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .quiz-container {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div id="username-modal">
        <div class="username-form">
            <h2>Enter Your Username</h2>
            <input type="text" id="username-input" placeholder="Username">
            <button onclick="startQuiz()">Start Quiz</button>
        </div>
    </div>

    <div class="quiz-container" id="quiz-container" style="display:none;">
        <div class="score-display" id="score-display">Score: 0</div>
        <div class="question" id="question-text">Loading question...</div>
        <div class="options" id="options-container"></div>
        <div id="leaderboard">
            <h3>Global Leaderboard</h3>
            <div id="leaderboard-entries"></div>
        </div>
    </div>

    <script>
    class AdvancedQuizApp {
        constructor() {
            this.score = 0;
            this.username = '';
            this.leaderboard = [];
            this.questionCategories = [
                'science', 'history', 'geography', 'sports', 
                'movies', 'music', 'technology', 'general'
            ];
            this.apiEndpoint = 'https://opentdb.com/api.php';
        }

        async fetchQuestion() {
            try {
                // Randomly select a category
                const randomCategory = this.questionCategories[
                    Math.floor(Math.random() * this.questionCategories.length)
                ];

                // Dynamic API call with category and difficulty
                const response = await fetch(
                    `${this.apiEndpoint}?amount=1&category=${this.getCategoryCode(randomCategory)}&type=multiple`
                );
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    return this.processQuestion(data.results[0]);
                }
            } catch (error) {
                console.error('Question fetch error:', error);
                this.displayErrorQuestion();
            }
        }

        getCategoryCode(category) {
            const categoryMap = {
                'science': 17,
                'history': 23,
                'geography': 22,
                'sports': 21,
                'movies': 11,
                'music': 12,
                'technology': 18,
                'general': 9
            };
            return categoryMap[category] || 9;
        }

        processQuestion(questionData) {
            // Decode HTML entities
            const decodeHTML = (html) => {
                const txt = document.createElement('textarea');
                txt.innerHTML = html;
                return txt.value;
            };

            // Combine correct and incorrect options
            const allOptions = [
                ...questionData.incorrect_answers, 
                questionData.correct_answer
            ];

            // Shuffle options
            const shuffledOptions = this.shuffleArray(allOptions);

            return {
                question: decodeHTML(questionData.question),
                options: shuffledOptions.map(decodeHTML),
                correctAnswer: decodeHTML(questionData.correct_answer)
            };
        }

        shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        displayErrorQuestion() {
            document.getElementById('question-text').innerHTML = 
                'Network Error. Generating Backup Question...';
            this.generateBackupQuestion();
        }

        generateBackupQuestion() {
            const backupQuestions = [
                {
                    question: "What is 2 + 2?",
                    options: ["3", "4", "5", "6"],
                    correctAnswer: "4"
                }
                // Add more backup questions
            ];

            const randomBackup = backupQuestions[
                Math.floor(Math.random() * backupQuestions.length)
            ];

            this.renderQuestion(randomBackup);
        }

        async renderQuestion(questionData) {
            const questionText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');

            questionText.innerHTML = questionData.question;
            optionsContainer.innerHTML = '';

            questionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.innerHTML = option;
                button.classList.add('option-btn');
                button.onclick = () => this.checkAnswer(
                    option, 
                    questionData.correctAnswer
                );
                optionsContainer.appendChild(button);
            });
        }

        checkAnswer(selectedOption, correctAnswer) {
            if (selectedOption === correctAnswer) {
                this.score++;
                this.playCorrectSound();
            } else {
                this.score = Math.max(0, this.score - 1);
                this.playWrongSound();
            }

            this.updateScoreDisplay();
            this.continueQuiz();
        }

        async continueQuiz() {
            const nextQuestion = await this.fetchQuestion();
            this.renderQuestion(nextQuestion);
        }

        updateScoreDisplay() {
            document.getElementById('score-display').innerHTML = 
                `Score: ${this.score} | Category: Random`;
        }

        playCorrectSound() {
            // Implement sound effects if desired
            console.log('Correct Answer!');
        }

        playWrongSound() {
            // Implement sound effects if desired
            console.log('Wrong Answer!');
        }

        initLeaderboard() {
            // Implement real-time leaderboard logic
            // Could integrate with Firebase or similar
        }
    }

    const quizApp = new AdvancedQuizApp();

    function startQuiz() {
        const username = document.getElementById('username-input').value;
        if (username) {
            quizApp.username = username;
            document.getElementById('username-modal').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            quizApp.fetchQuestion().then(question => {
                quizApp.renderQuestion(question);
            });
        }
    }
    </script>
</body>
</html>
